Update Log

Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/TimetableModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class TimetableModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    // class wise information save
    public function classwise_save($data)
    {
        $branchID = $this->application_model->get_branch_id();
        $sectionID = $data['section_id'];
        $classID = $data['class_id'];
        $sessionID = get_session_id();
        $day = $data['day'];
        $arrayItems = $this->request->getPost('timetable');
        if (!empty($arrayItems)) {
            foreach ($arrayItems as $key => $value) {
                if (!isset($value['break'])) {
                    $subjectID = $value['subject'];
                    $teacherID = $value['teacher'];
                    $break = false;
                } else {
                    $subjectID = 0;
                    $teacherID = 0;
                    $break = true;
                }
                $timeStart = date("H:i:s", strtotime($value['time_start']));
                $timeEnd = date("H:i:s", strtotime($value['time_end']));
                $roomNumber = $value['class_room'];
                if (!empty($timeStart) && !empty($timeEnd)) {
                    $arrayRoutine = array('class_id' => $classID, 'section_id' => $sectionID, 'subject_id' => $subjectID, 'teacher_id' => $teacherID, 'time_start' => $timeStart, 'time_end' => $timeEnd, 'class_room' => $roomNumber, 'session_id' => $sessionID, 'branch_id' => $branchID, 'break' => $break, 'day' => $day);
                    if ($data['old_id'][$key] == 0) {
                        $builder->insert('timetable_class', $arrayRoutine);
                    } else {
                        $builder->where('id', $data['old_id'][$key]);
                        $builder->update('timetable_class', $arrayRoutine);
                    }
                }
            }
        }
        $arrayI = isset($data['i']) ? $data['i'] : array();
        $preserve_array = isset($data['old_id']) ? $data['old_id'] : array();
        $deleteArray = array_diff($arrayI, $preserve_array);
        if (!empty($deleteArray)) {
            $builder->where_in('id', $deleteArray);
            $builder->delete('timetable_class');
        }
    }
    public function getExamTimetableList($classID, $sectionID, $branchID)
    {
        $sessionID = get_session_id();
        $builder->select('t.*,b.name as branch_name');
        $builder->from('timetable_exam as t');
        $builder->join('branch as b', 'b.id = t.branch_id', 'left');
        $builder->where('t.branch_id', $branchID);
        $builder->where('t.class_id', $classID);
        $builder->where('t.section_id', $sectionID);
        $builder->where('t.session_id', $sessionID);
        $builder->order_by('t.id', 'asc');
        $builder->group_by('t.exam_id');
        return $builder->get()->result_array();
    }
    public function getSubjectExam($classID, $sectionID, $examID, $branchID)
    {
        $sessionID = get_session_id();
        $sql = "SELECT sa.*, s.name as subject_name, te.time_start, te.time_end, te.hall_id, te.exam_date, te.mark_distribution FROM subject_assign as sa\r\n        LEFT JOIN subject as s ON s.id = sa.subject_id LEFT JOIN timetable_exam as te ON te.class_id = sa.class_id and te.section_id = sa.section_id and\r\n        te.subject_id = sa.subject_id and te.session_id = sa.session_id and te.exam_id = " . $db->escape($examID) . " WHERE sa.class_id = " . $db->escape($classID) . " AND sa.section_id = " . $db->escape($sectionID) . " AND sa.branch_id = " . $db->escape($branchID) . " AND sa.session_id = " . $db->escape($sessionID);
        $query = $db->query($sql);
        return $query->getResultArray();
    }
    public function getExamTimetableByModal($examID, $classID, $sectionID, $branchID = '')
    {
        $sessionID = get_session_id();
        $builder->select('t.*,s.name as subject_name,eh.hall_no');
        $builder->from('timetable_exam as t');
        $builder->join('subject as s', 's.id = t.subject_id', 'left');
        $builder->join('exam_hall as eh', 'eh.id = t.hall_id', 'left');
        if (!empty($branchID)) {
            $builder->where('t.branch_id', $branchID);
        } else if (!is_superadmin_loggedin()) {
            $this->db->table('t.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->where('t.exam_id', $examID);
        $builder->where('t.class_id', $classID);
        $builder->where('t.section_id', $sectionID);
        $builder->where('t.session_id', $sessionID);
        return $builder->get();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class TimetableModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    // class wise information save
    public function classwise_save($data)
    {
        $branchID = $this->applicationModel->get_branch_id();
        $sectionID = $data['section_id'];
        $classID = $data['class_id'];
        $sessionID = get_session_id();
        $day = $data['day'];
        $arrayItems = $this->request->getPost('timetable');
        if (!empty($arrayItems)) {
            foreach ($arrayItems as $key => $value) {
                if (!isset($value['break'])) {
                    $subjectID = $value['subject'];
                    $teacherID = $value['teacher'];
                    $break = false;
                } else {
                    $subjectID = 0;
                    $teacherID = 0;
                    $break = true;
                }
                $timeStart = date("H:i:s", strtotime($value['time_start']));
                $timeEnd = date("H:i:s", strtotime($value['time_end']));
                $roomNumber = $value['class_room'];
                if (!empty($timeStart) && !empty($timeEnd)) {
                    $arrayRoutine = array('class_id' => $classID, 'section_id' => $sectionID, 'subject_id' => $subjectID, 'teacher_id' => $teacherID, 'time_start' => $timeStart, 'time_end' => $timeEnd, 'class_room' => $roomNumber, 'session_id' => $sessionID, 'branch_id' => $branchID, 'break' => $break, 'day' => $day);
                    if ($data['old_id'][$key] == 0) {
                        $builder->insert('timetable_class', $arrayRoutine);
                    } else {
                        $builder->where('id', $data['old_id'][$key]);
                        $builder->update('timetable_class', $arrayRoutine);
                    }
                }
            }
        }
        $arrayI = isset($data['i']) ? $data['i'] : array();
        $preserve_array = isset($data['old_id']) ? $data['old_id'] : array();
        $deleteArray = array_diff($arrayI, $preserve_array);
        if (!empty($deleteArray)) {
            $builder->where_in('id', $deleteArray);
            $builder->delete('timetable_class');
        }
    }
    public function getExamTimetableList($classID, $sectionID, $branchID)
    {
        $sessionID = get_session_id();
        $builder->select('t.*,b.name as branch_name');
        $builder->from('timetable_exam as t');
        $builder->join('branch as b', 'b.id = t.branch_id', 'left');
        $builder->where('t.branch_id', $branchID);
        $builder->where('t.class_id', $classID);
        $builder->where('t.section_id', $sectionID);
        $builder->where('t.session_id', $sessionID);
        $builder->order_by('t.id', 'asc');
        $builder->group_by('t.exam_id');
        return $builder->get()->result_array();
    }
    public function getSubjectExam($classID, $sectionID, $examID, $branchID)
    {
        $sessionID = get_session_id();
        $sql = "SELECT sa.*, s.name as subject_name, te.time_start, te.time_end, te.hall_id, te.exam_date, te.mark_distribution FROM subject_assign as sa\r\n        LEFT JOIN subject as s ON s.id = sa.subject_id LEFT JOIN timetable_exam as te ON te.class_id = sa.class_id and te.section_id = sa.section_id and\r\n        te.subject_id = sa.subject_id and te.session_id = sa.session_id and te.exam_id = " . $db->escape($examID) . " WHERE sa.class_id = " . $db->escape($classID) . " AND sa.section_id = " . $db->escape($sectionID) . " AND sa.branch_id = " . $db->escape($branchID) . " AND sa.session_id = " . $db->escape($sessionID);
        $query = $db->query($sql);
        return $query->getResultArray();
    }
    public function getExamTimetableByModal($examID, $classID, $sectionID, $branchID = '')
    {
        $sessionID = get_session_id();
        $builder->select('t.*,s.name as subject_name,eh.hall_no');
        $builder->from('timetable_exam as t');
        $builder->join('subject as s', 's.id = t.subject_id', 'left');
        $builder->join('exam_hall as eh', 'eh.id = t.hall_id', 'left');
        if (!empty($branchID)) {
            $builder->where('t.branch_id', $branchID);
        } else if (!is_superadmin_loggedin()) {
            $this->db->table('t.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->where('t.exam_id', $examID);
        $builder->where('t.class_id', $classID);
        $builder->where('t.section_id', $sectionID);
        $builder->where('t.session_id', $sessionID);
        return $builder->get();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/HostelModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class HostelModel extends Model
{
    protected $db;
    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    public function hostel_save($data)
    {
        $arrayData = array('name' => $data['name'], 'category_id' => $data['category_id'], 'address' => $data['hostel_address'], 'watchman' => $data['watchman_name'], 'remarks' => $data['remarks'], 'branch_id' => $this->application_model->get_branch_id());
        if (!isset($data['hostel_id'])) {
            $builder->insert('hostel', $arrayData);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['hostel_id']);
            $builder->update('hostel', $arrayData);
        }
    }
    public function category_save($data)
    {
        $arrayData = array('name' => $data['category_name'], 'type' => $data['type'], 'description' => $data['description'], 'branch_id' => $this->application_model->get_branch_id());
        if (!isset($data['category_id'])) {
            $builder->insert('hostel_category', $arrayData);
        } else {
            $builder->where('id', $data['category_id']);
            $builder->update('hostel_category', $arrayData);
        }
    }
    public function room_save($data)
    {
        $arrayData = array('name' => $data['name'], 'hostel_id' => $data['hostel_id'], 'category_id' => $data['category_id'], 'no_beds' => $data['number_of_beds'], 'bed_fee' => $data['bed_fee'], 'remarks' => $data['remarks'], 'branch_id' => $this->application_model->get_branch_id());
        if (!isset($data['room_id'])) {
            $builder->insert('hostel_room', $arrayData);
        } else {
            $builder->where('id', $data['room_id']);
            $builder->update('hostel_room', $arrayData);
        }
    }
    // allocation report with student name
    public function allocation_report($classID, $sectionID, $branchID)
    {
        $sql = "SELECT s.first_name, s.last_name, s.register_no, e.branch_id, e.id as enroll_id, h.name as hostel_name, r.name as room_name, r.bed_fee, rc.name as room_category\r\n        FROM student as s INNER JOIN enroll as e ON e.student_id = s.id INNER JOIN hostel as h ON h.id = s.hostel_id INNER JOIN hostel_room as r ON r.id = s.room_id LEFT JOIN\r\n        hostel_category as rc ON rc.id = r.category_id WHERE s.hostel_id != 0 AND s.room_id != 0 AND e.branch_id = " . $db->escape($branchID) . " AND e.class_id = " . $db->escape($classID) . " AND e.section_id = " . $db->escape($sectionID);
        $query = $db->query($sql)->result_array();
        return $query;
    }
    // get hostel information by hostel id and room id
    public function get_student_hostel($hostel_id, $room_id)
    {
        $builder->select('h.name as hostel_name,h.watchman,h.category_id,h.address,hc.name as hcategory_name,rc.name as rcategory_name,hr.name as room_name,hr.no_beds,hr.bed_fee');
        $builder->from('hostel as h');
        $builder->join('hostel_category as hc', 'hc.id = h.category_id', 'left');
        $builder->join('hostel_room as hr', 'hr.hostel_id = h.id', 'left');
        $builder->join('hostel_category as rc', 'rc.id = hr.category_id', 'left');
        $builder->where('hr.id', $room_id);
        $builder->where('h.id', $hostel_id);
        return $builder->get()->row();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class HostelModel extends Model
{
    protected $db;
    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    public function hostel_save($data)
    {
        $arrayData = array('name' => $data['name'], 'category_id' => $data['category_id'], 'address' => $data['hostel_address'], 'watchman' => $data['watchman_name'], 'remarks' => $data['remarks'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (!isset($data['hostel_id'])) {
            $builder->insert('hostel', $arrayData);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['hostel_id']);
            $builder->update('hostel', $arrayData);
        }
    }
    public function category_save($data)
    {
        $arrayData = array('name' => $data['category_name'], 'type' => $data['type'], 'description' => $data['description'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (!isset($data['category_id'])) {
            $builder->insert('hostel_category', $arrayData);
        } else {
            $builder->where('id', $data['category_id']);
            $builder->update('hostel_category', $arrayData);
        }
    }
    public function room_save($data)
    {
        $arrayData = array('name' => $data['name'], 'hostel_id' => $data['hostel_id'], 'category_id' => $data['category_id'], 'no_beds' => $data['number_of_beds'], 'bed_fee' => $data['bed_fee'], 'remarks' => $data['remarks'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (!isset($data['room_id'])) {
            $builder->insert('hostel_room', $arrayData);
        } else {
            $builder->where('id', $data['room_id']);
            $builder->update('hostel_room', $arrayData);
        }
    }
    // allocation report with student name
    public function allocation_report($classID, $sectionID, $branchID)
    {
        $sql = "SELECT s.first_name, s.last_name, s.register_no, e.branch_id, e.id as enroll_id, h.name as hostel_name, r.name as room_name, r.bed_fee, rc.name as room_category\r\n        FROM student as s INNER JOIN enroll as e ON e.student_id = s.id INNER JOIN hostel as h ON h.id = s.hostel_id INNER JOIN hostel_room as r ON r.id = s.room_id LEFT JOIN\r\n        hostel_category as rc ON rc.id = r.category_id WHERE s.hostel_id != 0 AND s.room_id != 0 AND e.branch_id = " . $db->escape($branchID) . " AND e.class_id = " . $db->escape($classID) . " AND e.section_id = " . $db->escape($sectionID);
        $query = $db->query($sql)->result_array();
        return $query;
    }
    // get hostel information by hostel id and room id
    public function get_student_hostel($hostel_id, $room_id)
    {
        $builder->select('h.name as hostel_name,h.watchman,h.category_id,h.address,hc.name as hcategory_name,rc.name as rcategory_name,hr.name as room_name,hr.no_beds,hr.bed_fee');
        $builder->from('hostel as h');
        $builder->join('hostel_category as hc', 'hc.id = h.category_id', 'left');
        $builder->join('hostel_room as hr', 'hr.hostel_id = h.id', 'left');
        $builder->join('hostel_category as rc', 'rc.id = hr.category_id', 'left');
        $builder->where('hr.id', $room_id);
        $builder->where('h.id', $hostel_id);
        return $builder->get()->row();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/StudentModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class StudentModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    // moderator student all information
    public function save($data = array(), $getBranch = array())
    {
        $hostelID = empty($data['hostel_id']) ? 0 : $data['hostel_id'];
        $roomID = empty($data['room_id']) ? 0 : $data['room_id'];
        $previous_details = array('school_name' => $this->request->getPost('school_name'), 'qualification' => $this->request->getPost('qualification'), 'remarks' => $this->request->getPost('previous_remarks'));
        if (empty($previous_details)) {
            $previous_details = "";
        } else {
            $previous_details = json_encode($previous_details);
        }
        $inser_data1 = array('register_no' => $this->request->getPost('register_no'), 'admission_date' => !empty($data['admission_date']) ? date("Y-m-d", strtotime($data['admission_date'])) : "", 'first_name' => $this->request->getPost('first_name'), 'last_name' => $this->request->getPost('last_name'), 'gender' => $this->request->getPost('gender'), 'birthday' => !empty($data['birthday']) ? date("Y-m-d", strtotime($data['birthday'])) : "", 'religion' => $this->request->getPost('religion'), 'caste' => $this->request->getPost('caste'), 'blood_group' => $this->request->getPost('blood_group'), 'mother_tongue' => $this->request->getPost('mother_tongue'), 'current_address' => $this->request->getPost('current_address'), 'permanent_address' => $this->request->getPost('permanent_address'), 'city' => $this->request->getPost('city'), 'state' => $this->request->getPost('state'), 'mobileno' => $this->request->getPost('mobileno'), 'category_id' => isset($data['category_id']) ? $data['category_id'] : 0, 'email' => $this->request->getPost('email'), 'parent_id' => $this->request->getPost('parent_id'), 'route_id' => empty($this->request->getPost('route_id')) ? 0 : $this->request->getPost('route_id'), 'vehicle_id' => empty($this->request->getPost('vehicle_id')) ? 0 : $this->request->getPost('vehicle_id'), 'hostel_id' => $hostelID, 'room_id' => $roomID, 'previous_details' => $previous_details, 'photo' => $this->uploadImage('student'));
        // moderator guardian all information
        if (!isset($data['student_id']) && empty($data['student_id'])) {
            if (!isset($data['guardian_chk'])) {
                // add new guardian all information in db
                if (!empty($data['grd_name']) || !empty($data['father_name'])) {
                    $arrayParent = array('name' => $this->request->getPost('grd_name'), 'relation' => $this->request->getPost('grd_relation'), 'father_name' => $this->request->getPost('father_name'), 'mother_name' => $this->request->getPost('mother_name'), 'occupation' => $this->request->getPost('grd_occupation'), 'income' => $this->request->getPost('grd_income'), 'education' => $this->request->getPost('grd_education'), 'email' => $this->request->getPost('grd_email'), 'mobileno' => $this->request->getPost('grd_mobileno'), 'address' => $this->request->getPost('grd_address'), 'city' => $this->request->getPost('grd_city'), 'state' => $this->request->getPost('grd_state'), 'branch_id' => $this->application_model->get_branch_id(), 'photo' => $this->uploadImage('parent', 'guardian_photo'));
                    $builder->insert('parent', $arrayParent);
                    $parentID = $builder->insert_id();
                    // save guardian login credential information in the database
                    if ($getBranch['grd_generate'] == 1) {
                        $grd_username = $getBranch['grd_username_prefix'] . $parentID;
                        $grd_password = $getBranch['grd_default_password'];
                    } else {
                        $grd_username = $data['grd_username'];
                        $grd_password = $data['grd_password'];
                    }
                    $parent_credential = array('username' => $grd_username, 'role' => 6, 'user_id' => $parentID, 'password' => $this->app_lib->pass_hashed($grd_password));
                    $builder->insert('login_credential', $parent_credential);
                } else {
                    $parentID = 0;
                }
            } else {
                $parentID = $data['parent_id'];
            }
            $inser_data1['parent_id'] = $parentID;
            // insert student all information in the database
            $builder->insert('student', $inser_data1);
            $student_id = $builder->insert_id();
            // save student login credential information in the database
            if ($getBranch['stu_generate'] == 1) {
                $stu_username = $getBranch['stu_username_prefix'] . $student_id;
                $stu_password = $getBranch['stu_default_password'];
            } else {
                $stu_username = $data['username'];
                $stu_password = $data['password'];
            }
            $inser_data2 = array('user_id' => $student_id, 'username' => $stu_username, 'role' => 7, 'password' => $this->app_lib->pass_hashed($stu_password));
            $builder->insert('login_credential', $inser_data2);
            // return student information
            $studentData = array('student_id' => $student_id, 'email' => $this->request->getPost('email'), 'username' => $stu_username, 'password' => $stu_password);
            if (!empty($data['grd_name']) || !empty($data['father_name'])) {
                // send parent account activate email
                $emailData = array('name' => $this->request->getPost('grd_name'), 'username' => $grd_username, 'password' => $grd_password, 'user_role' => 6, 'email' => $this->request->getPost('grd_email'));
                $this->email_model->sentStaffRegisteredAccount($emailData);
            }
            return $studentData;
        } else {
            // update student all information in the database
            $inser_data1['parent_id'] = $data['parent_id'];
            $builder->where('id', $data['student_id']);
            $builder->update('student', $inser_data1);
            // update login credential information in the database
            $builder->where('user_id', $data['student_id']);
            $builder->where('role', 7);
            $this->db->table('login_credential', array('username' => $data['username']))->update();
        }
    }
    public function csvImport($row = array(), $classID = '', $sectionID = '', $branchID = '')
    {
        // getting existing father data
        if ($row['GuardianUsername'] !== '') {
            $getParent = $builder->select('parent.id')->from('login_credential')->join('parent', 'parent.id = login_credential.user_id', 'left')->where(array('parent.branch_id' => $branchID, 'login_credential.username' => $row['GuardianUsername']))->get()->row_array();
        }
        // getting branch settings
        $getSettings = $builder->select('*')->where('id', $branchID)->from('branch')->get()->row_array();
        if (isset($getParent) && count($getParent)) {
            $parentID = $getParent['id'];
        } else {
            // add new guardian all information in db
            $arrayParent = array('name' => $row['GuardianName'], 'relation' => $row['GuardianRelation'], 'father_name' => $row['FatherName'], 'mother_name' => $row['MotherName'], 'occupation' => $row['GuardianOccupation'], 'mobileno' => $row['GuardianMobileNo'], 'address' => $row['GuardianAddress'], 'email' => $row['GuardianEmail'], 'branch_id' => $branchID, 'photo' => 'defualt.png');
            $builder->insert('parent', $arrayParent);
            $parentID = $builder->insert_id();
            // save guardian login credential information in the database
            if ($getSettings['grd_generate'] == 1) {
                $grd_username = $getSettings['grd_username_prefix'] . $parentID;
                $grd_password = $getSettings['grd_default_password'];
            } else {
                $grd_username = $row['GuardianUsername'];
                $grd_password = $row['GuardianPassword'];
            }
            $parent_credential = array('username' => $grd_username, 'role' => 6, 'user_id' => $parentID, 'password' => $this->app_lib->pass_hashed($grd_password));
            $builder->insert('login_credential', $parent_credential);
        }
        $inser_data1 = array('first_name' => $row['FirstName'], 'last_name' => $row['LastName'], 'blood_group' => $row['BloodGroup'], 'gender' => $row['Gender'], 'birthday' => date("Y-m-d", strtotime($row['Birthday'])), 'mother_tongue' => $row['MotherTongue'], 'religion' => $row['Religion'], 'parent_id' => $parentID, 'caste' => $row['Caste'], 'mobileno' => $row['Phone'], 'city' => $row['City'], 'state' => $row['State'], 'current_address' => $row['PresentAddress'], 'permanent_address' => $row['PermanentAddress'], 'category_id' => $row['CategoryID'], 'admission_date' => date("Y-m-d", strtotime($row['AdmissionDate'])), 'register_no' => $row['RegisterNo'], 'photo' => 'defualt.png', 'email' => $row['StudentEmail']);
        //save all student information in the database file
        $builder->insert('student', $inser_data1);
        $studentID = $builder->insert_id();
        // save student login credential information in the database
        if ($getSettings['stu_generate'] == 1) {
            $stu_username = $getSettings['stu_username_prefix'] . $studentID;
            $stu_password = $getSettings['stu_default_password'];
        } else {
            $stu_username = $row['StudentUsername'];
            $stu_password = $row['StudentPassword'];
        }
        //save student login credential
        $inser_data2 = array('username' => $stu_username, 'role' => 7, 'user_id' => $studentID, 'password' => $this->app_lib->pass_hashed($stu_password));
        $builder->insert('login_credential', $inser_data2);
        //save student enroll information in the database file
        $arrayEnroll = array('student_id' => $studentID, 'class_id' => $classID, 'section_id' => $sectionID, 'branch_id' => $branchID, 'roll' => $row['Roll'], 'session_id' => get_session_id());
        $builder->insert('enroll', $arrayEnroll);
    }
    public function getFeeProgress($id)
    {
        $builder->select('IFNULL(SUM(gd.amount), 0) as totalfees,IFNULL(SUM(p.amount), 0) as totalpay,IFNULL(SUM(p.discount),0) as totaldiscount');
        $builder->from('fee_allocation as a');
        $builder->join('fee_groups_details as gd', 'gd.fee_groups_id = a.group_id', 'inner');
        $builder->join('fee_payment_history as p', 'p.allocation_id = a.id and p.type_id = gd.fee_type_id', 'left');
        $builder->where('a.student_id', $id);
        $this->db->table('a.session_id', get_session_id())->where();
        $r = $builder->get()->row_array();
        $total_amount = floatval($r['totalfees']);
        $total_paid = floatval($r['totalpay'] + $r['totaldiscount']);
        if ($total_paid != 0) {
            $percentage = $total_paid / $total_amount * 100;
            return number_format($percentage);
        } else {
            return 0;
        }
    }
    public function getStudentList($classID = '', $sectionID = '', $branchID = '', $deactivate = false, $start = '', $end = '')
    {
        $builder->select('e.*,s.photo, CONCAT_WS(" ", s.first_name, s.last_name) as fullname,s.register_no,s.gender,s.admission_date,s.parent_id,s.email,s.blood_group,s.birthday,l.active,c.name as class_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('login_credential as l', 'l.user_id = s.id and l.role = 7', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id=se.id', 'left');
        if (!empty($classID)) {
            $builder->where('e.class_id', $classID);
        }
        if (!empty($start) && !empty($end)) {
            $builder->where('s.admission_date >=', $start);
            $builder->where('s.admission_date <=', $end);
        }
        $builder->where('e.branch_id', $branchID);
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->order_by('s.id', 'ASC');
        if ($sectionID != 'all' && !empty($sectionID)) {
            $builder->where('e.section_id', $sectionID);
        }
        if ($deactivate == true) {
            $builder->where('l.active', 0);
        }
        return $builder->get();
    }
    public function getSearchStudentList($search_text)
    {
        $builder->select('e.*,s.photo,s.first_name,s.last_name,s.register_no,s.parent_id,s.email,s.blood_group,s.birthday,c.name as class_name,se.name as section_name,sp.name as parent_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'left');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id=se.id', 'left');
        $builder->join('parent as sp', 'sp.id = s.parent_id', 'left');
        $this->db->table('e.session_id', get_session_id())->where();
        if (!is_superadmin_loggedin()) {
            $this->db->table('e.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->group_start();
        $builder->like('s.first_name', $search_text);
        $builder->or_like('s.last_name', $search_text);
        $builder->or_like('s.register_no', $search_text);
        $builder->or_like('s.email', $search_text);
        $builder->or_like('e.roll', $search_text);
        $builder->or_like('s.blood_group', $search_text);
        $builder->or_like('sp.name', $search_text);
        $builder->group_end();
        $builder->order_by('s.id', 'desc');
        return $builder->get();
    }
    public function getSingleStudent($id = '', $enroll = false)
    {
        $builder->select('s.*,l.username,l.active,e.class_id,e.section_id,e.id as enrollid,e.roll,e.branch_id,e.session_id,c.name as class_name,se.name as section_name,sc.name as category_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'left');
        $builder->join('login_credential as l', 'l.user_id = s.id and l.role = 7', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->join('student_category as sc', 's.category_id=sc.id', 'left');
        if ($enroll == true) {
            $builder->where('e.id', $id);
        } else {
            $builder->where('s.id', $id);
        }
        $this->db->table('e.session_id', get_session_id())->where();
        if (!is_superadmin_loggedin()) {
            $this->db->table('e.branch_id', get_loggedin_branch_id())->where();
        }
        $query = $builder->get();
        if ($query->num_rows() == 0) {
            show_404();
        }
        return $query->row_array();
    }
    public function regSerNumber($school_id = '')
    {
        $registerNoPrefix = '';
        if (!empty($school_id)) {
            $schoolconfig = $db->table('branch')->get('branch')->row();
            if ($schoolconfig->reg_prefix_enable == 1) {
                $registerNoPrefix = $schoolconfig->institution_code . $schoolconfig->reg_start_from;
                $last_registerNo = $this->app_lib->studentLastRegID($school_id);
                if (!empty($last_registerNo)) {
                    $last_registerNo_digit = str_replace($schoolconfig->institution_code, "", $last_registerNo->register_no);
                    if (!is_numeric($last_registerNo_digit)) {
                        $last_registerNo_digit = $schoolconfig->reg_start_from;
                    } else {
                        $last_registerNo_digit = $last_registerNo_digit + 1;
                    }
                    $registerNoPrefix = $schoolconfig->institution_code . sprintf("%0" . $schoolconfig->reg_prefix_digit . "d", $last_registerNo_digit);
                } else {
                    $registerNoPrefix = $schoolconfig->institution_code . sprintf("%0" . $schoolconfig->reg_prefix_digit . "d", $schoolconfig->reg_start_from);
                }
            }
            return $registerNoPrefix;
        } else {
            $config = $db->table('global_settings')->get('global_settings')->row();
            if ($config->reg_prefix == 'on') {
                $prefix = $config->institution_code;
            }
            $result = $builder->select("max(id) as id")->get('student')->row_array();
            $id = $result["id"];
            if (!empty($id)) {
                $maxNum = str_pad($id + 1, 5, '0', STR_PAD_LEFT);
            } else {
                $maxNum = '00001';
            }
            return $prefix . $maxNum;
        }
    }
    public function getDisableReason($student_id = '')
    {
        $builder->select("rd.*,disable_reason.name as reason");
        $builder->from('disable_reason_details as rd');
        $builder->join('disable_reason', 'disable_reason.id = rd.reason_id', 'left');
        $builder->where('student_id', $student_id);
        $builder->order_by('rd.id', 'DESC');
        $builder->limit(1);
        $row = $builder->get()->row();
        return $row;
    }
    public function getSiblingList($parent_id = '', $student_id = '')
    {
        $builder->select('s.photo, s.register_no, CONCAT_WS(" ",s.first_name, s.last_name) as fullname,s.gender,s.mobileno,e.roll,e.branch_id,c.name as class_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->where_not_in('s.id', $student_id);
        $builder->where('s.parent_id', $parent_id);
        $builder->order_by('s.id', 'ASC');
        $query = $builder->get();
        return $query->getResult();
    }
    public function getParentList($class_id = '', $section_id = '', $branch_id = '')
    {
        $builder->select('p.name as g_name,p.father_name,p.mother_name,p.occupation,count(s.parent_id) as child,p.mobileno,s.parent_id');
        $builder->from('student as s');
        $builder->join('enroll as e', 'e.student_id = s.id', 'inner');
        $builder->join('parent as p', 'p.id = s.parent_id', 'inner');
        $builder->where('e.class_id', $class_id);
        if ($section_id != 'all') {
            $builder->where('e.section_id', $section_id);
        }
        $builder->where('e.branch_id', $branch_id);
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->order_by('s.id', 'ASC');
        $builder->group_by('p.id');
        $query = $builder->get();
        return $query->getResultArray();
    }
    public function getSiblingListByClass($parent_id = '', $class_id = '', $section_id = '')
    {
        $builder->select('s.register_no,e.id as enroll_id,CONCAT_WS(" ",s.first_name, s.last_name) as fullname,s.gender,c.name as class_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->where('e.class_id', $class_id);
        if ($section_id != 'all') {
            $builder->where('e.section_id', $section_id);
        }
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->where('s.parent_id', $parent_id);
        $builder->order_by('s.id', 'ASC');
        $query = $builder->get();
        return $query->getResult();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class StudentModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    // moderator student all information
    public function save($data = array(), $getBranch = array())
    {
        $hostelID = empty($data['hostel_id']) ? 0 : $data['hostel_id'];
        $roomID = empty($data['room_id']) ? 0 : $data['room_id'];
        $previous_details = array('school_name' => $this->request->getPost('school_name'), 'qualification' => $this->request->getPost('qualification'), 'remarks' => $this->request->getPost('previous_remarks'));
        if (empty($previous_details)) {
            $previous_details = "";
        } else {
            $previous_details = json_encode($previous_details);
        }
        $inser_data1 = array('register_no' => $this->request->getPost('register_no'), 'admission_date' => !empty($data['admission_date']) ? date("Y-m-d", strtotime($data['admission_date'])) : "", 'first_name' => $this->request->getPost('first_name'), 'last_name' => $this->request->getPost('last_name'), 'gender' => $this->request->getPost('gender'), 'birthday' => !empty($data['birthday']) ? date("Y-m-d", strtotime($data['birthday'])) : "", 'religion' => $this->request->getPost('religion'), 'caste' => $this->request->getPost('caste'), 'blood_group' => $this->request->getPost('blood_group'), 'mother_tongue' => $this->request->getPost('mother_tongue'), 'current_address' => $this->request->getPost('current_address'), 'permanent_address' => $this->request->getPost('permanent_address'), 'city' => $this->request->getPost('city'), 'state' => $this->request->getPost('state'), 'mobileno' => $this->request->getPost('mobileno'), 'category_id' => isset($data['category_id']) ? $data['category_id'] : 0, 'email' => $this->request->getPost('email'), 'parent_id' => $this->request->getPost('parent_id'), 'route_id' => empty($this->request->getPost('route_id')) ? 0 : $this->request->getPost('route_id'), 'vehicle_id' => empty($this->request->getPost('vehicle_id')) ? 0 : $this->request->getPost('vehicle_id'), 'hostel_id' => $hostelID, 'room_id' => $roomID, 'previous_details' => $previous_details, 'photo' => $this->uploadImage('student'));
        // moderator guardian all information
        if (!isset($data['student_id']) && empty($data['student_id'])) {
            if (!isset($data['guardian_chk'])) {
                // add new guardian all information in db
                if (!empty($data['grd_name']) || !empty($data['father_name'])) {
                    $arrayParent = array('name' => $this->request->getPost('grd_name'), 'relation' => $this->request->getPost('grd_relation'), 'father_name' => $this->request->getPost('father_name'), 'mother_name' => $this->request->getPost('mother_name'), 'occupation' => $this->request->getPost('grd_occupation'), 'income' => $this->request->getPost('grd_income'), 'education' => $this->request->getPost('grd_education'), 'email' => $this->request->getPost('grd_email'), 'mobileno' => $this->request->getPost('grd_mobileno'), 'address' => $this->request->getPost('grd_address'), 'city' => $this->request->getPost('grd_city'), 'state' => $this->request->getPost('grd_state'), 'branch_id' => $this->applicationModel->get_branch_id(), 'photo' => $this->uploadImage('parent', 'guardian_photo'));
                    $builder->insert('parent', $arrayParent);
                    $parentID = $builder->insert_id();
                    // save guardian login credential information in the database
                    if ($getBranch['grd_generate'] == 1) {
                        $grd_username = $getBranch['grd_username_prefix'] . $parentID;
                        $grd_password = $getBranch['grd_default_password'];
                    } else {
                        $grd_username = $data['grd_username'];
                        $grd_password = $data['grd_password'];
                    }
                    $parent_credential = array('username' => $grd_username, 'role' => 6, 'user_id' => $parentID, 'password' => $this->app_lib->pass_hashed($grd_password));
                    $builder->insert('login_credential', $parent_credential);
                } else {
                    $parentID = 0;
                }
            } else {
                $parentID = $data['parent_id'];
            }
            $inser_data1['parent_id'] = $parentID;
            // insert student all information in the database
            $builder->insert('student', $inser_data1);
            $student_id = $builder->insert_id();
            // save student login credential information in the database
            if ($getBranch['stu_generate'] == 1) {
                $stu_username = $getBranch['stu_username_prefix'] . $student_id;
                $stu_password = $getBranch['stu_default_password'];
            } else {
                $stu_username = $data['username'];
                $stu_password = $data['password'];
            }
            $inser_data2 = array('user_id' => $student_id, 'username' => $stu_username, 'role' => 7, 'password' => $this->app_lib->pass_hashed($stu_password));
            $builder->insert('login_credential', $inser_data2);
            // return student information
            $studentData = array('student_id' => $student_id, 'email' => $this->request->getPost('email'), 'username' => $stu_username, 'password' => $stu_password);
            if (!empty($data['grd_name']) || !empty($data['father_name'])) {
                // send parent account activate email
                $emailData = array('name' => $this->request->getPost('grd_name'), 'username' => $grd_username, 'password' => $grd_password, 'user_role' => 6, 'email' => $this->request->getPost('grd_email'));
                $this->email_model->sentStaffRegisteredAccount($emailData);
            }
            return $studentData;
        } else {
            // update student all information in the database
            $inser_data1['parent_id'] = $data['parent_id'];
            $builder->where('id', $data['student_id']);
            $builder->update('student', $inser_data1);
            // update login credential information in the database
            $builder->where('user_id', $data['student_id']);
            $builder->where('role', 7);
            $this->db->table('login_credential', array('username' => $data['username']))->update();
        }
    }
    public function csvImport($row = array(), $classID = '', $sectionID = '', $branchID = '')
    {
        // getting existing father data
        if ($row['GuardianUsername'] !== '') {
            $getParent = $builder->select('parent.id')->from('login_credential')->join('parent', 'parent.id = login_credential.user_id', 'left')->where(array('parent.branch_id' => $branchID, 'login_credential.username' => $row['GuardianUsername']))->get()->row_array();
        }
        // getting branch settings
        $getSettings = $builder->select('*')->where('id', $branchID)->from('branch')->get()->row_array();
        if (isset($getParent) && count($getParent)) {
            $parentID = $getParent['id'];
        } else {
            // add new guardian all information in db
            $arrayParent = array('name' => $row['GuardianName'], 'relation' => $row['GuardianRelation'], 'father_name' => $row['FatherName'], 'mother_name' => $row['MotherName'], 'occupation' => $row['GuardianOccupation'], 'mobileno' => $row['GuardianMobileNo'], 'address' => $row['GuardianAddress'], 'email' => $row['GuardianEmail'], 'branch_id' => $branchID, 'photo' => 'defualt.png');
            $builder->insert('parent', $arrayParent);
            $parentID = $builder->insert_id();
            // save guardian login credential information in the database
            if ($getSettings['grd_generate'] == 1) {
                $grd_username = $getSettings['grd_username_prefix'] . $parentID;
                $grd_password = $getSettings['grd_default_password'];
            } else {
                $grd_username = $row['GuardianUsername'];
                $grd_password = $row['GuardianPassword'];
            }
            $parent_credential = array('username' => $grd_username, 'role' => 6, 'user_id' => $parentID, 'password' => $this->app_lib->pass_hashed($grd_password));
            $builder->insert('login_credential', $parent_credential);
        }
        $inser_data1 = array('first_name' => $row['FirstName'], 'last_name' => $row['LastName'], 'blood_group' => $row['BloodGroup'], 'gender' => $row['Gender'], 'birthday' => date("Y-m-d", strtotime($row['Birthday'])), 'mother_tongue' => $row['MotherTongue'], 'religion' => $row['Religion'], 'parent_id' => $parentID, 'caste' => $row['Caste'], 'mobileno' => $row['Phone'], 'city' => $row['City'], 'state' => $row['State'], 'current_address' => $row['PresentAddress'], 'permanent_address' => $row['PermanentAddress'], 'category_id' => $row['CategoryID'], 'admission_date' => date("Y-m-d", strtotime($row['AdmissionDate'])), 'register_no' => $row['RegisterNo'], 'photo' => 'defualt.png', 'email' => $row['StudentEmail']);
        //save all student information in the database file
        $builder->insert('student', $inser_data1);
        $studentID = $builder->insert_id();
        // save student login credential information in the database
        if ($getSettings['stu_generate'] == 1) {
            $stu_username = $getSettings['stu_username_prefix'] . $studentID;
            $stu_password = $getSettings['stu_default_password'];
        } else {
            $stu_username = $row['StudentUsername'];
            $stu_password = $row['StudentPassword'];
        }
        //save student login credential
        $inser_data2 = array('username' => $stu_username, 'role' => 7, 'user_id' => $studentID, 'password' => $this->app_lib->pass_hashed($stu_password));
        $builder->insert('login_credential', $inser_data2);
        //save student enroll information in the database file
        $arrayEnroll = array('student_id' => $studentID, 'class_id' => $classID, 'section_id' => $sectionID, 'branch_id' => $branchID, 'roll' => $row['Roll'], 'session_id' => get_session_id());
        $builder->insert('enroll', $arrayEnroll);
    }
    public function getFeeProgress($id)
    {
        $builder->select('IFNULL(SUM(gd.amount), 0) as totalfees,IFNULL(SUM(p.amount), 0) as totalpay,IFNULL(SUM(p.discount),0) as totaldiscount');
        $builder->from('fee_allocation as a');
        $builder->join('fee_groups_details as gd', 'gd.fee_groups_id = a.group_id', 'inner');
        $builder->join('fee_payment_history as p', 'p.allocation_id = a.id and p.type_id = gd.fee_type_id', 'left');
        $builder->where('a.student_id', $id);
        $this->db->table('a.session_id', get_session_id())->where();
        $r = $builder->get()->row_array();
        $total_amount = floatval($r['totalfees']);
        $total_paid = floatval($r['totalpay'] + $r['totaldiscount']);
        if ($total_paid != 0) {
            $percentage = $total_paid / $total_amount * 100;
            return number_format($percentage);
        } else {
            return 0;
        }
    }
    public function getStudentList($classID = '', $sectionID = '', $branchID = '', $deactivate = false, $start = '', $end = '')
    {
        $builder->select('e.*,s.photo, CONCAT_WS(" ", s.first_name, s.last_name) as fullname,s.register_no,s.gender,s.admission_date,s.parent_id,s.email,s.blood_group,s.birthday,l.active,c.name as class_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('login_credential as l', 'l.user_id = s.id and l.role = 7', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id=se.id', 'left');
        if (!empty($classID)) {
            $builder->where('e.class_id', $classID);
        }
        if (!empty($start) && !empty($end)) {
            $builder->where('s.admission_date >=', $start);
            $builder->where('s.admission_date <=', $end);
        }
        $builder->where('e.branch_id', $branchID);
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->order_by('s.id', 'ASC');
        if ($sectionID != 'all' && !empty($sectionID)) {
            $builder->where('e.section_id', $sectionID);
        }
        if ($deactivate == true) {
            $builder->where('l.active', 0);
        }
        return $builder->get();
    }
    public function getSearchStudentList($search_text)
    {
        $builder->select('e.*,s.photo,s.first_name,s.last_name,s.register_no,s.parent_id,s.email,s.blood_group,s.birthday,c.name as class_name,se.name as section_name,sp.name as parent_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'left');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id=se.id', 'left');
        $builder->join('parent as sp', 'sp.id = s.parent_id', 'left');
        $this->db->table('e.session_id', get_session_id())->where();
        if (!is_superadmin_loggedin()) {
            $this->db->table('e.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->group_start();
        $builder->like('s.first_name', $search_text);
        $builder->or_like('s.last_name', $search_text);
        $builder->or_like('s.register_no', $search_text);
        $builder->or_like('s.email', $search_text);
        $builder->or_like('e.roll', $search_text);
        $builder->or_like('s.blood_group', $search_text);
        $builder->or_like('sp.name', $search_text);
        $builder->group_end();
        $builder->order_by('s.id', 'desc');
        return $builder->get();
    }
    public function getSingleStudent($id = '', $enroll = false)
    {
        $builder->select('s.*,l.username,l.active,e.class_id,e.section_id,e.id as enrollid,e.roll,e.branch_id,e.session_id,c.name as class_name,se.name as section_name,sc.name as category_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'left');
        $builder->join('login_credential as l', 'l.user_id = s.id and l.role = 7', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->join('student_category as sc', 's.category_id=sc.id', 'left');
        if ($enroll == true) {
            $builder->where('e.id', $id);
        } else {
            $builder->where('s.id', $id);
        }
        $this->db->table('e.session_id', get_session_id())->where();
        if (!is_superadmin_loggedin()) {
            $this->db->table('e.branch_id', get_loggedin_branch_id())->where();
        }
        $query = $builder->get();
        if ($query->num_rows() == 0) {
            show_404();
        }
        return $query->row_array();
    }
    public function regSerNumber($school_id = '')
    {
        $registerNoPrefix = '';
        if (!empty($school_id)) {
            $schoolconfig = $db->table('branch')->get('branch')->row();
            if ($schoolconfig->reg_prefix_enable == 1) {
                $registerNoPrefix = $schoolconfig->institution_code . $schoolconfig->reg_start_from;
                $last_registerNo = $this->app_lib->studentLastRegID($school_id);
                if (!empty($last_registerNo)) {
                    $last_registerNo_digit = str_replace($schoolconfig->institution_code, "", $last_registerNo->register_no);
                    if (!is_numeric($last_registerNo_digit)) {
                        $last_registerNo_digit = $schoolconfig->reg_start_from;
                    } else {
                        $last_registerNo_digit = $last_registerNo_digit + 1;
                    }
                    $registerNoPrefix = $schoolconfig->institution_code . sprintf("%0" . $schoolconfig->reg_prefix_digit . "d", $last_registerNo_digit);
                } else {
                    $registerNoPrefix = $schoolconfig->institution_code . sprintf("%0" . $schoolconfig->reg_prefix_digit . "d", $schoolconfig->reg_start_from);
                }
            }
            return $registerNoPrefix;
        } else {
            $config = $db->table('global_settings')->get('global_settings')->row();
            if ($config->reg_prefix == 'on') {
                $prefix = $config->institution_code;
            }
            $result = $builder->select("max(id) as id")->get('student')->row_array();
            $id = $result["id"];
            if (!empty($id)) {
                $maxNum = str_pad($id + 1, 5, '0', STR_PAD_LEFT);
            } else {
                $maxNum = '00001';
            }
            return $prefix . $maxNum;
        }
    }
    public function getDisableReason($student_id = '')
    {
        $builder->select("rd.*,disable_reason.name as reason");
        $builder->from('disable_reason_details as rd');
        $builder->join('disable_reason', 'disable_reason.id = rd.reason_id', 'left');
        $builder->where('student_id', $student_id);
        $builder->order_by('rd.id', 'DESC');
        $builder->limit(1);
        $row = $builder->get()->row();
        return $row;
    }
    public function getSiblingList($parent_id = '', $student_id = '')
    {
        $builder->select('s.photo, s.register_no, CONCAT_WS(" ",s.first_name, s.last_name) as fullname,s.gender,s.mobileno,e.roll,e.branch_id,c.name as class_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->where_not_in('s.id', $student_id);
        $builder->where('s.parent_id', $parent_id);
        $builder->order_by('s.id', 'ASC');
        $query = $builder->get();
        return $query->getResult();
    }
    public function getParentList($class_id = '', $section_id = '', $branch_id = '')
    {
        $builder->select('p.name as g_name,p.father_name,p.mother_name,p.occupation,count(s.parent_id) as child,p.mobileno,s.parent_id');
        $builder->from('student as s');
        $builder->join('enroll as e', 'e.student_id = s.id', 'inner');
        $builder->join('parent as p', 'p.id = s.parent_id', 'inner');
        $builder->where('e.class_id', $class_id);
        if ($section_id != 'all') {
            $builder->where('e.section_id', $section_id);
        }
        $builder->where('e.branch_id', $branch_id);
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->order_by('s.id', 'ASC');
        $builder->group_by('p.id');
        $query = $builder->get();
        return $query->getResultArray();
    }
    public function getSiblingListByClass($parent_id = '', $class_id = '', $section_id = '')
    {
        $builder->select('s.register_no,e.id as enroll_id,CONCAT_WS(" ",s.first_name, s.last_name) as fullname,s.gender,c.name as class_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->where('e.class_id', $class_id);
        if ($section_id != 'all') {
            $builder->where('e.section_id', $section_id);
        }
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->where('s.parent_id', $parent_id);
        $builder->order_by('s.id', 'ASC');
        $query = $builder->get();
        return $query->getResult();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/TestimonialModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class TestimonialModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // test save and update function
    public function save($data)
    {
        $insert_testimonial = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['name'], 'surname' => $data['surname'], 'description' => $data['description'], 'rank' => $data['rank'], 'created_by' => get_loggedin_user_id(), 'image' => $this->upload_image());
        if (isset($data['testimonial_id']) && !empty($data['testimonial_id'])) {
            $builder->where('id', $data['testimonial_id']);
            $builder->update('front_cms_testimonial', $insert_testimonial);
        } else {
            $builder->insert('front_cms_testimonial', $insert_testimonial);
        }
    }
    // upload home slider image
    public function upload_image()
    {
        $prev_image = $this->request->getPost('old_photo');
        $image = $_FILES['photo']['name'];
        $return_image = '';
        if ($image != '') {
            $destination = './uploads/frontend/testimonial/';
            $extension = pathinfo($image, PATHINFO_EXTENSION);
            $image_path = 'user-' . time() . '.' . $extension;
            move_uploaded_file($_FILES['photo']['tmp_name'], $destination . $image_path);
            // need to unlink previous testimonial image
            if ($prev_image != '') {
                if (file_exists($destination . $prev_image)) {
                    @unlink($destination . $prev_image);
                }
            }
            $return_image = $image_path;
        } else {
            $return_image = $prev_image;
        }
        return $return_image;
    }
    public function get_image_url($file_path = '')
    {
        $path = 'uploads/frontend/testimonial/' . $file_path;
        if (empty($file_path) || !file_exists($path)) {
            $image_url = base_url('uploads/app_image/defualt.png');
        } else {
            $image_url = base_url($path);
        }
        return $image_url;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class TestimonialModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // test save and update function
    public function save($data)
    {
        $insert_testimonial = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['name'], 'surname' => $data['surname'], 'description' => $data['description'], 'rank' => $data['rank'], 'created_by' => get_loggedin_user_id(), 'image' => $this->upload_image());
        if (isset($data['testimonial_id']) && !empty($data['testimonial_id'])) {
            $builder->where('id', $data['testimonial_id']);
            $builder->update('front_cms_testimonial', $insert_testimonial);
        } else {
            $builder->insert('front_cms_testimonial', $insert_testimonial);
        }
    }
    // upload home slider image
    public function upload_image()
    {
        $prev_image = $this->request->getPost('old_photo');
        $image = $_FILES['photo']['name'];
        $return_image = '';
        if ($image != '') {
            $destination = './uploads/frontend/testimonial/';
            $extension = pathinfo($image, PATHINFO_EXTENSION);
            $image_path = 'user-' . time() . '.' . $extension;
            move_uploaded_file($_FILES['photo']['tmp_name'], $destination . $image_path);
            // need to unlink previous testimonial image
            if ($prev_image != '') {
                if (file_exists($destination . $prev_image)) {
                    @unlink($destination . $prev_image);
                }
            }
            $return_image = $image_path;
        } else {
            $return_image = $prev_image;
        }
        return $return_image;
    }
    public function get_image_url($file_path = '')
    {
        $path = 'uploads/frontend/testimonial/' . $file_path;
        if (empty($file_path) || !file_exists($path)) {
            $image_url = base_url('uploads/app_image/defualt.png');
        } else {
            $image_url = base_url($path);
        }
        return $image_url;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/CardManageModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class CardManageModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getList($type = 1)
    {
        $builder->select('card_templete.*,branch.name as branchname');
        $builder->from('card_templete');
        $builder->join('branch', 'branch.id = card_templete.branch_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('card_templete.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->where('card_templete.card_type', $type);
        $builder->order_by('card_templete.id', 'ASC');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function save($data)
    {
        $userType = $data['card_type'] == 2 ? 1 : $data['user_type'];
        $background_file = '';
        $oldBackground_file = $this->request->getPost('old_background_file');
        if (isset($_FILES["background_file"]) && !empty($_FILES['background_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("background_file")) {
                // need to unlink previous photo
                if (!empty($oldBackground_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldBackground_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $background_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldBackground_file)) {
            $background_file = $oldBackground_file;
        }
        $logo_file = '';
        $oldLogo_file = $this->request->getPost('old_logo_file');
        if (isset($_FILES["logo_file"]) && !empty($_FILES['logo_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("logo_file")) {
                // need to unlink previous photo
                if (!empty($oldLogo_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldLogo_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $logo_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldLogo_file)) {
            $logo_file = $oldLogo_file;
        }
        $signature_file = '';
        $oldSignature_file = $this->request->getPost('old_signature_file');
        if (isset($_FILES["signature_file"]) && !empty($_FILES['signature_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("signature_file")) {
                // need to unlink previous photo
                if (!empty($oldSignature_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldSignature_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $signature_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldSignature_file)) {
            $signature_file = $oldSignature_file;
        }
        if ($userType == 1) {
            $qrCode = $data['stu_qr_code'];
        } else {
            $qrCode = $data['emp_qr_code'];
        }
        $arrayLive = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['card_name'], 'card_type' => $data['card_type'], 'user_type' => $userType, 'layout_width' => $data['layout_width'], 'layout_height' => $data['layout_height'], 'qr_code' => $qrCode, 'photo_style' => $data['photo_style'], 'photo_size' => empty($data['photo_size']) ? 100 : $data['photo_size'], 'top_space' => empty($data['top_space']) ? 0 : $data['top_space'], 'bottom_space' => empty($data['bottom_space']) ? 0 : $data['bottom_space'], 'right_space' => empty($data['right_space']) ? 0 : $data['right_space'], 'left_space' => empty($data['left_space']) ? 0 : $data['left_space'], 'background' => $background_file, 'logo' => $logo_file, 'signature' => $signature_file, 'content' => $this->request->getPost('content', false));
        if (!isset($data['templete_id'])) {
            $builder->insert('card_templete', $arrayLive);
        } else {
            $builder->where('id', $data['templete_id']);
            $builder->update('card_templete', $arrayLive);
        }
    }
    public function tagsList($roleID = "", $admit_card = false)
    {
        $arrayTags = array();
        $arrayTags[] = '{name}';
        $arrayTags[] = '{gender}';
        if ($roleID == 1) {
            $arrayTags[] = '{father_name}';
            $arrayTags[] = '{mother_name}';
            $arrayTags[] = '{student_photo}';
            $arrayTags[] = '{register_no}';
            $arrayTags[] = '{roll}';
            $arrayTags[] = '{admission_date}';
            $arrayTags[] = '{class}';
            $arrayTags[] = '{section}';
            $arrayTags[] = '{category}';
            $arrayTags[] = '{caste}';
        }
        if ($roleID == 2) {
            $arrayTags[] = '{staff_photo}';
            $arrayTags[] = '{joining_date}';
            $arrayTags[] = '{designation}';
            $arrayTags[] = '{department}';
            $arrayTags[] = '{qualification}';
            $arrayTags[] = '{total_experience}';
        }
        if ($admit_card == true) {
            $arrayTags[] = '{exam_name}';
            $arrayTags[] = '{subject_list_table}';
        }
        $arrayTags[] = '{religion}';
        $arrayTags[] = '{blood_group}';
        $arrayTags[] = '{birthday}';
        $arrayTags[] = '{email}';
        $arrayTags[] = '{mobileno}';
        $arrayTags[] = '{present_address}';
        $arrayTags[] = '{permanent_address}';
        $arrayTags[] = '{logo}';
        $arrayTags[] = '{signature}';
        $arrayTags[] = '{qr_code}';
        $arrayTags[] = '{institute_name}';
        $arrayTags[] = '{institute_email}';
        $arrayTags[] = '{institute_address}';
        $arrayTags[] = '{institute_mobile_no}';
        $arrayTags[] = '{print_date}';
        if ($admit_card == false) {
            $arrayTags[] = '{expiry_date}';
        }
        return $arrayTags;
    }
    public function tagsReplace($roleID, $userID, $templete, $print_date, $expiry_date)
    {
        $body = $templete['content'];
        $photo_size = $templete['photo_size'];
        $photo_style = $templete['photo_style'];
        $tags = $this->tagsList($roleID);
        if ($roleID == 1) {
            $userDetails = $this->getStudent($userID);
        } else if ($roleID == 2) {
            $userDetails = $this->getStaff($userID);
        }
        $arr = array('{', '}');
        foreach ($tags as $tag) {
            $field = str_replace($arr, '', $tag);
            if ($roleID == 1) {
                if ($field == 'student_photo') {
                    $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('student', $userDetails['photo']) . '" style="width: auto; max-height:' . $photo_size . '">';
                    $body = str_replace($tag, $photo, $body);
                } else if ($field == 'logo') {
                    if (!empty($templete['logo'])) {
                        $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                        $body = str_replace($tag, $logo_ph, $body);
                    }
                } else if ($field == 'signature') {
                    if (!empty($templete['signature'])) {
                        $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                        $body = str_replace($tag, $signature_ph, $body);
                    }
                } else if ($field == 'qr_code') {
                    if (!empty($templete['qr_code'])) {
                        $qr_code = $templete['qr_code'];
                        if ($qr_code == 'attendance') {
                            $qrData = str_replace('=', '', base64_encode('s-' . $userDetails['attendance']));
                        } else {
                            $qrData = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                        }
                        $params['savename'] = 'uploads/qr_code/stu_' . substr(hash('sha256', mt_rand() . microtime()), 0, 20) . '.png';
                        $params['level'] = 'M';
                        $params['size'] = 3;
                        $params['data'] = $qrData;
                        $qrCode = $this->ciqrcode->generate($params);
                        $photo = '<img src="' . base_url($qrCode) . '">';
                        $body = str_replace($tag, $photo, $body);
                    }
                } else if ($field == 'present_address') {
                    $body = str_replace($tag, $userDetails['current_address'], $body);
                } else if ($field == 'print_date') {
                    $body = str_replace($tag, _d($print_date), $body);
                } else if ($field == 'expiry_date') {
                    $body = str_replace($tag, _d($expiry_date), $body);
                } else if ($field == 'birthday') {
                    $body = str_replace($tag, _d($userDetails[$field]), $body);
                } else {
                    $body = str_replace($tag, $userDetails[$field], $body);
                }
            }
            if ($roleID == 2) {
                if ($field == 'staff_photo') {
                    $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('staff', $userDetails['photo']) . '" style="width: auto; max-height:' . $photo_size . '">';
                    $body = str_replace($tag, $photo, $body);
                } else if ($field == 'logo') {
                    if (!empty($templete['logo'])) {
                        $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                        $body = str_replace($tag, $logo_ph, $body);
                    }
                } else if ($field == 'signature') {
                    if (!empty($templete['signature'])) {
                        $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                        $body = str_replace($tag, $signature_ph, $body);
                    }
                } else if ($field == 'print_date') {
                    $body = str_replace($tag, _d($print_date), $body);
                } else if ($field == 'expiry_date') {
                    $body = str_replace($tag, _d($expiry_date), $body);
                } else if ($field == 'qr_code') {
                    if (!empty($templete['qr_code'])) {
                        $qr_code = $templete['qr_code'];
                        if ($qr_code == 'attendance') {
                            $qrData = str_replace('=', '', base64_encode('e-' . $userDetails['id']));
                        } else {
                            $qrData = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                        }
                        $params['savename'] = 'uploads/qr_code/sta_' . substr(hash('sha256', mt_rand() . microtime()), 0, 20) . '.png';
                        $params['level'] = 'M';
                        $params['size'] = 3;
                        $params['data'] = $qrData;
                        $qrCode = $this->ciqrcode->generate($params);
                        $photo = '<img src="' . base_url($qrCode) . '">';
                        $body = str_replace($tag, $photo, $body);
                    }
                } else if ($field == 'gender') {
                    $body = str_replace($tag, $userDetails['sex'], $body);
                } else if ($field == 'joining_date') {
                    $body = str_replace($tag, _d($userDetails[$field]), $body);
                } else if ($field == 'birthday') {
                    $body = str_replace($tag, _d($userDetails[$field]), $body);
                } else {
                    $body = str_replace($tag, $userDetails[$field], $body);
                }
            }
        }
        return $body;
    }
    public function admitCardTagsReplace($userID, $templete, $print_date, $exam_id)
    {
        $body = $templete['content'];
        $photo_size = $templete['photo_size'];
        $photo_style = $templete['photo_style'];
        $tags = $this->tagsList(1, true);
        $userDetails = $this->getStudent($userID);
        $arr = array('{', '}');
        foreach ($tags as $tag) {
            $field = str_replace($arr, '', $tag);
            if ($field == 'student_photo') {
                $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('student', $userDetails['photo']) . '" width="' . $photo_size . '">';
                $body = str_replace($tag, $photo, $body);
            } else if ($field == 'exam_name') {
                $body = str_replace($tag, $this->application_model->exam_name_by_id($exam_id), $body);
            } else if ($field == 'subject_list_table') {
                $body = str_replace($tag, $this->tableHtml($exam_id, $userDetails['class_id'], $userDetails['section_id'], $userDetails['branch_id']), $body);
            } else if ($field == 'logo') {
                if (!empty($templete['logo'])) {
                    $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                    $body = str_replace($tag, $logo_ph, $body);
                }
            } else if ($field == 'signature') {
                if (!empty($templete['signature'])) {
                    $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                    $body = str_replace($tag, $signature_ph, $body);
                }
            } else if ($field == 'qr_code') {
                if (!empty($templete['qr_code'])) {
                    $qr_code = $templete['qr_code'];
                    $params['savename'] = 'uploads/qr_code/stu_' . $userDetails['id'] . '.png';
                    $params['level'] = 'M';
                    $params['size'] = 2;
                    $params['data'] = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                    $qrCode = $this->ciqrcode->generate($params);
                    $photo = '<img src="' . base_url($qrCode) . '">';
                    $body = str_replace($tag, $photo, $body);
                }
            } else if ($field == 'present_address') {
                $body = str_replace($tag, $userDetails['current_address'], $body);
            } else if ($field == 'print_date') {
                $body = str_replace($tag, _d($print_date), $body);
            } else {
                $body = str_replace($tag, $userDetails[$field], $body);
            }
        }
        return $body;
    }
    public function getStudent($id)
    {
        $builder->select('s.*,CONCAT_WS(" ",s.first_name, s.last_name) as name,e.roll,e.id as attendance,e.class_id,e.section_id,e.branch_id,e.session_id,c.name as class,se.name as section,sc.name as category,p.father_name,p.mother_name,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id and e.session_id = ' . $db->escape(get_session_id()), 'left');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->join('student_category as sc', 's.category_id=sc.id', 'left');
        $builder->join('parent as p', 'p.id=s.parent_id', 'left');
        $builder->join('branch as br', 'br.id = e.branch_id', 'left');
        $builder->where('e.id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
    public function getStaff($id)
    {
        $builder->select('s.*,s.department as deid,s.designation as desid,staff_department.name as department,staff_designation.name as designation,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('staff as s');
        $builder->join('staff_department', 'staff_department.id = s.department', 'left');
        $builder->join('staff_designation', 'staff_designation.id = s.designation', 'left');
        $builder->join('branch as br', 'br.id = s.branch_id', 'left');
        $builder->where('s.id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
    public function tableHtml($examID, $classID, $sectionID, $branchID = '')
    {
        $html = '';
        $html .= '<table class="table table-bordered table-condensed">';
        $html .= '<thead>';
        $html .= '<tr>';
        $html .= '<th>Subject</th>';
        $html .= '<th>Date</th>';
        $html .= '<th>Time</th>';
        $html .= '<th>Hall Room</th>';
        $html .= '</tr>';
        $html .= '</thead>';
        $html .= '<tbody>';
        $timetables = $this->timetable_model->getExamTimetableByModal($examID, $classID, $sectionID, $branchID);
        if (count($timetables->result_array())) {
            foreach ($timetables->result_array() as $row) {
                $html .= '<tr>';
                $html .= '<td>' . $row['subject_name'] . '</td>';
                $html .= '<td>' . _d($row['exam_date']) . '</td>';
                $html .= '<td>' . $row['time_start'] . ' To ' . $row['time_end'] . '</td>';
                $html .= '<td>' . $row['hall_no'] . '</td>';
                $html .= '</tr>';
            }
        } else {
            $html .= '<tr> <td colspan="5"> <h5 class="text-danger text-center">' . translate('no_information_available') . '</h5> </td></tr>';
        }
        $html .= '</tbody>';
        $html .= '</table>';
        return $html;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class CardManageModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getList($type = 1)
    {
        $builder->select('card_templete.*,branch.name as branchname');
        $builder->from('card_templete');
        $builder->join('branch', 'branch.id = card_templete.branch_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('card_templete.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->where('card_templete.card_type', $type);
        $builder->order_by('card_templete.id', 'ASC');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function save($data)
    {
        $userType = $data['card_type'] == 2 ? 1 : $data['user_type'];
        $background_file = '';
        $oldBackground_file = $this->request->getPost('old_background_file');
        if (isset($_FILES["background_file"]) && !empty($_FILES['background_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("background_file")) {
                // need to unlink previous photo
                if (!empty($oldBackground_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldBackground_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $background_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldBackground_file)) {
            $background_file = $oldBackground_file;
        }
        $logo_file = '';
        $oldLogo_file = $this->request->getPost('old_logo_file');
        if (isset($_FILES["logo_file"]) && !empty($_FILES['logo_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("logo_file")) {
                // need to unlink previous photo
                if (!empty($oldLogo_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldLogo_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $logo_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldLogo_file)) {
            $logo_file = $oldLogo_file;
        }
        $signature_file = '';
        $oldSignature_file = $this->request->getPost('old_signature_file');
        if (isset($_FILES["signature_file"]) && !empty($_FILES['signature_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("signature_file")) {
                // need to unlink previous photo
                if (!empty($oldSignature_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldSignature_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $signature_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldSignature_file)) {
            $signature_file = $oldSignature_file;
        }
        if ($userType == 1) {
            $qrCode = $data['stu_qr_code'];
        } else {
            $qrCode = $data['emp_qr_code'];
        }
        $arrayLive = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['card_name'], 'card_type' => $data['card_type'], 'user_type' => $userType, 'layout_width' => $data['layout_width'], 'layout_height' => $data['layout_height'], 'qr_code' => $qrCode, 'photo_style' => $data['photo_style'], 'photo_size' => empty($data['photo_size']) ? 100 : $data['photo_size'], 'top_space' => empty($data['top_space']) ? 0 : $data['top_space'], 'bottom_space' => empty($data['bottom_space']) ? 0 : $data['bottom_space'], 'right_space' => empty($data['right_space']) ? 0 : $data['right_space'], 'left_space' => empty($data['left_space']) ? 0 : $data['left_space'], 'background' => $background_file, 'logo' => $logo_file, 'signature' => $signature_file, 'content' => $this->request->getPost('content', false));
        if (!isset($data['templete_id'])) {
            $builder->insert('card_templete', $arrayLive);
        } else {
            $builder->where('id', $data['templete_id']);
            $builder->update('card_templete', $arrayLive);
        }
    }
    public function tagsList($roleID = "", $admit_card = false)
    {
        $arrayTags = array();
        $arrayTags[] = '{name}';
        $arrayTags[] = '{gender}';
        if ($roleID == 1) {
            $arrayTags[] = '{father_name}';
            $arrayTags[] = '{mother_name}';
            $arrayTags[] = '{student_photo}';
            $arrayTags[] = '{register_no}';
            $arrayTags[] = '{roll}';
            $arrayTags[] = '{admission_date}';
            $arrayTags[] = '{class}';
            $arrayTags[] = '{section}';
            $arrayTags[] = '{category}';
            $arrayTags[] = '{caste}';
        }
        if ($roleID == 2) {
            $arrayTags[] = '{staff_photo}';
            $arrayTags[] = '{joining_date}';
            $arrayTags[] = '{designation}';
            $arrayTags[] = '{department}';
            $arrayTags[] = '{qualification}';
            $arrayTags[] = '{total_experience}';
        }
        if ($admit_card == true) {
            $arrayTags[] = '{exam_name}';
            $arrayTags[] = '{subject_list_table}';
        }
        $arrayTags[] = '{religion}';
        $arrayTags[] = '{blood_group}';
        $arrayTags[] = '{birthday}';
        $arrayTags[] = '{email}';
        $arrayTags[] = '{mobileno}';
        $arrayTags[] = '{present_address}';
        $arrayTags[] = '{permanent_address}';
        $arrayTags[] = '{logo}';
        $arrayTags[] = '{signature}';
        $arrayTags[] = '{qr_code}';
        $arrayTags[] = '{institute_name}';
        $arrayTags[] = '{institute_email}';
        $arrayTags[] = '{institute_address}';
        $arrayTags[] = '{institute_mobile_no}';
        $arrayTags[] = '{print_date}';
        if ($admit_card == false) {
            $arrayTags[] = '{expiry_date}';
        }
        return $arrayTags;
    }
    public function tagsReplace($roleID, $userID, $templete, $print_date, $expiry_date)
    {
        $body = $templete['content'];
        $photo_size = $templete['photo_size'];
        $photo_style = $templete['photo_style'];
        $tags = $this->tagsList($roleID);
        if ($roleID == 1) {
            $userDetails = $this->getStudent($userID);
        } else if ($roleID == 2) {
            $userDetails = $this->getStaff($userID);
        }
        $arr = array('{', '}');
        foreach ($tags as $tag) {
            $field = str_replace($arr, '', $tag);
            if ($roleID == 1) {
                if ($field == 'student_photo') {
                    $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('student', $userDetails['photo']) . '" style="width: auto; max-height:' . $photo_size . '">';
                    $body = str_replace($tag, $photo, $body);
                } else if ($field == 'logo') {
                    if (!empty($templete['logo'])) {
                        $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                        $body = str_replace($tag, $logo_ph, $body);
                    }
                } else if ($field == 'signature') {
                    if (!empty($templete['signature'])) {
                        $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                        $body = str_replace($tag, $signature_ph, $body);
                    }
                } else if ($field == 'qr_code') {
                    if (!empty($templete['qr_code'])) {
                        $qr_code = $templete['qr_code'];
                        if ($qr_code == 'attendance') {
                            $qrData = str_replace('=', '', base64_encode('s-' . $userDetails['attendance']));
                        } else {
                            $qrData = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                        }
                        $params['savename'] = 'uploads/qr_code/stu_' . substr(hash('sha256', mt_rand() . microtime()), 0, 20) . '.png';
                        $params['level'] = 'M';
                        $params['size'] = 3;
                        $params['data'] = $qrData;
                        $qrCode = $this->ciqrcode->generate($params);
                        $photo = '<img src="' . base_url($qrCode) . '">';
                        $body = str_replace($tag, $photo, $body);
                    }
                } else if ($field == 'present_address') {
                    $body = str_replace($tag, $userDetails['current_address'], $body);
                } else if ($field == 'print_date') {
                    $body = str_replace($tag, _d($print_date), $body);
                } else if ($field == 'expiry_date') {
                    $body = str_replace($tag, _d($expiry_date), $body);
                } else if ($field == 'birthday') {
                    $body = str_replace($tag, _d($userDetails[$field]), $body);
                } else {
                    $body = str_replace($tag, $userDetails[$field], $body);
                }
            }
            if ($roleID == 2) {
                if ($field == 'staff_photo') {
                    $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('staff', $userDetails['photo']) . '" style="width: auto; max-height:' . $photo_size . '">';
                    $body = str_replace($tag, $photo, $body);
                } else if ($field == 'logo') {
                    if (!empty($templete['logo'])) {
                        $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                        $body = str_replace($tag, $logo_ph, $body);
                    }
                } else if ($field == 'signature') {
                    if (!empty($templete['signature'])) {
                        $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                        $body = str_replace($tag, $signature_ph, $body);
                    }
                } else if ($field == 'print_date') {
                    $body = str_replace($tag, _d($print_date), $body);
                } else if ($field == 'expiry_date') {
                    $body = str_replace($tag, _d($expiry_date), $body);
                } else if ($field == 'qr_code') {
                    if (!empty($templete['qr_code'])) {
                        $qr_code = $templete['qr_code'];
                        if ($qr_code == 'attendance') {
                            $qrData = str_replace('=', '', base64_encode('e-' . $userDetails['id']));
                        } else {
                            $qrData = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                        }
                        $params['savename'] = 'uploads/qr_code/sta_' . substr(hash('sha256', mt_rand() . microtime()), 0, 20) . '.png';
                        $params['level'] = 'M';
                        $params['size'] = 3;
                        $params['data'] = $qrData;
                        $qrCode = $this->ciqrcode->generate($params);
                        $photo = '<img src="' . base_url($qrCode) . '">';
                        $body = str_replace($tag, $photo, $body);
                    }
                } else if ($field == 'gender') {
                    $body = str_replace($tag, $userDetails['sex'], $body);
                } else if ($field == 'joining_date') {
                    $body = str_replace($tag, _d($userDetails[$field]), $body);
                } else if ($field == 'birthday') {
                    $body = str_replace($tag, _d($userDetails[$field]), $body);
                } else {
                    $body = str_replace($tag, $userDetails[$field], $body);
                }
            }
        }
        return $body;
    }
    public function admitCardTagsReplace($userID, $templete, $print_date, $exam_id)
    {
        $body = $templete['content'];
        $photo_size = $templete['photo_size'];
        $photo_style = $templete['photo_style'];
        $tags = $this->tagsList(1, true);
        $userDetails = $this->getStudent($userID);
        $arr = array('{', '}');
        foreach ($tags as $tag) {
            $field = str_replace($arr, '', $tag);
            if ($field == 'student_photo') {
                $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('student', $userDetails['photo']) . '" width="' . $photo_size . '">';
                $body = str_replace($tag, $photo, $body);
            } else if ($field == 'exam_name') {
                $body = str_replace($tag, $this->applicationModel->exam_name_by_id($exam_id), $body);
            } else if ($field == 'subject_list_table') {
                $body = str_replace($tag, $this->tableHtml($exam_id, $userDetails['class_id'], $userDetails['section_id'], $userDetails['branch_id']), $body);
            } else if ($field == 'logo') {
                if (!empty($templete['logo'])) {
                    $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                    $body = str_replace($tag, $logo_ph, $body);
                }
            } else if ($field == 'signature') {
                if (!empty($templete['signature'])) {
                    $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                    $body = str_replace($tag, $signature_ph, $body);
                }
            } else if ($field == 'qr_code') {
                if (!empty($templete['qr_code'])) {
                    $qr_code = $templete['qr_code'];
                    $params['savename'] = 'uploads/qr_code/stu_' . $userDetails['id'] . '.png';
                    $params['level'] = 'M';
                    $params['size'] = 2;
                    $params['data'] = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                    $qrCode = $this->ciqrcode->generate($params);
                    $photo = '<img src="' . base_url($qrCode) . '">';
                    $body = str_replace($tag, $photo, $body);
                }
            } else if ($field == 'present_address') {
                $body = str_replace($tag, $userDetails['current_address'], $body);
            } else if ($field == 'print_date') {
                $body = str_replace($tag, _d($print_date), $body);
            } else {
                $body = str_replace($tag, $userDetails[$field], $body);
            }
        }
        return $body;
    }
    public function getStudent($id)
    {
        $builder->select('s.*,CONCAT_WS(" ",s.first_name, s.last_name) as name,e.roll,e.id as attendance,e.class_id,e.section_id,e.branch_id,e.session_id,c.name as class,se.name as section,sc.name as category,p.father_name,p.mother_name,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id and e.session_id = ' . $db->escape(get_session_id()), 'left');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->join('student_category as sc', 's.category_id=sc.id', 'left');
        $builder->join('parent as p', 'p.id=s.parent_id', 'left');
        $builder->join('branch as br', 'br.id = e.branch_id', 'left');
        $builder->where('e.id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
    public function getStaff($id)
    {
        $builder->select('s.*,s.department as deid,s.designation as desid,staff_department.name as department,staff_designation.name as designation,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('staff as s');
        $builder->join('staff_department', 'staff_department.id = s.department', 'left');
        $builder->join('staff_designation', 'staff_designation.id = s.designation', 'left');
        $builder->join('branch as br', 'br.id = s.branch_id', 'left');
        $builder->where('s.id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
    public function tableHtml($examID, $classID, $sectionID, $branchID = '')
    {
        $html = '';
        $html .= '<table class="table table-bordered table-condensed">';
        $html .= '<thead>';
        $html .= '<tr>';
        $html .= '<th>Subject</th>';
        $html .= '<th>Date</th>';
        $html .= '<th>Time</th>';
        $html .= '<th>Hall Room</th>';
        $html .= '</tr>';
        $html .= '</thead>';
        $html .= '<tbody>';
        $timetables = $this->timetable_model->getExamTimetableByModal($examID, $classID, $sectionID, $branchID);
        if (count($timetables->result_array())) {
            foreach ($timetables->result_array() as $row) {
                $html .= '<tr>';
                $html .= '<td>' . $row['subject_name'] . '</td>';
                $html .= '<td>' . _d($row['exam_date']) . '</td>';
                $html .= '<td>' . $row['time_start'] . ' To ' . $row['time_end'] . '</td>';
                $html .= '<td>' . $row['hall_no'] . '</td>';
                $html .= '</tr>';
            }
        } else {
            $html .= '<tr> <td colspan="5"> <h5 class="text-danger text-center">' . translate('no_information_available') . '</h5> </td></tr>';
        }
        $html .= '</tbody>';
        $html .= '</table>';
        return $html;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/SmsModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class SmsModel extends Model
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
        $this->clickatell = service('clickatell');
        $this->twilio = service('twilio');
        $this->msg91 = service('msg91');
        $this->bulk = service('bulk');
        $this->textlocal = service('textlocal');
        $this->smscountry = service('smscountry');
        $this->bulksmsbd = service('bulksmsbd');
        $this->custom_sms = service('customSms');
    }
    // common function for sending sms
    public function send_sms($data = '', $id = '')
    {
        $branchID = $this->application_model->get_branch_id();
        $sms_api = $this->application_model->smsServiceProvider($branchID);
        $template = $builder->getWhere('sms_template_details', array('template_id' => $id, 'branch_id' => $branchID))->row_array();
        if (!empty($template) && ($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
            $student = $this->application_model->getstudentdetails($data['student_id']);
            $text = str_replace('{name}', $student['first_name'] . ' ' . $student['last_name'], $template['template_body']);
            $text = str_replace('{register_no}', $student['register_no'], $text);
            $text = str_replace('{admission_date}', $student['admission_date'], $text);
            $text = str_replace('{class}', $student['class_name'], $text);
            $text = str_replace('{section}', $student['section_name'], $text);
            $text = str_replace('{roll}', $student['roll'], $text);
            if ($id == 2) {
                $text = str_replace('{paid_amount}', $data['amount'], $text);
                $text = str_replace('{paid_date}', _d($data['paid_date']), $text);
            }
            if ($id == 4 || $id == 5) {
                $exam = $db->table('exam')->get('exam')->row();
                $subject_name = $db->table('subject')->get('subject')->row()->name;
                if (!empty($exam->term_id)) {
                    $term_name = $db->table('exam_term')->get('exam_term')->row()->name;
                }
                $text = str_replace('{exam_name}', $exam->name, $text);
                $text = str_replace('{term_name}', $term_name, $text);
                $text = str_replace('{subject}', $subject_name, $text);
                if (!empty($data['mark'])) {
                    $text = str_replace('{marks}', $data['mark'], $text);
                }
            }
            if ($template['notify_student'] == 1) {
                if (!empty($student['mobileno'])) {
                    $this->_send($sms_api, $student['mobileno'], $text, $template['dlt_template_id']);
                }
            }
            if ($template['notify_parent'] == 1) {
                if (!empty($student['parent_id'])) {
                    $parent = $db->table('parent')->get('parent')->row_array();
                    if (!empty($parent['mobileno'])) {
                        $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function alumniEvent($arrayData = [])
    {
        $sms_api = $this->application_model->smsServiceProvider($arrayData['branch_id']);
        $template = $builder->getWhere('sms_template_details', array('template_id' => 11, 'branch_id' => $arrayData['branch_id']))->row_array();
        if (!empty($template) && $template['notify_student'] == 1 && $sms_api != 'disabled') {
            $text = str_replace('{student_name}', $arrayData['name'], $template['template_body']);
            $text = str_replace('{start_date}', $arrayData['from_date'], $text);
            $text = str_replace('{end_date}', $arrayData['to_date'], $text);
            $text = str_replace('{event_title}', $arrayData['event_title'], $text);
            if (!empty($arrayData['mobile_no'])) {
                $this->_send($sms_api, $arrayData['mobile_no'], $text, $template['dlt_template_id']);
            }
        }
    }
    public function feeReminder($stuData, $remData)
    {
        $sms_api = $this->application_model->smsServiceProvider($remData['branch_id']);
        if ($sms_api != 'disabled') {
            $text = str_replace('{guardian_name}', $stuData['guardian_name'], $remData['message']);
            $text = str_replace('{child_name}', $stuData['child_name'], $text);
            $text = str_replace('{due_date}', $stuData['due_date'], $text);
            $text = str_replace('{due_amount}', $stuData['balance_amount'], $text);
            $text = str_replace('{fee_type}', $stuData['type_name'], $text);
            if ($remData['student'] == 1) {
                if (!empty($stuData['child_mobileno'])) {
                    $this->_send($sms_api, $stuData['child_mobileno'], $text, $remData['dlt_template_id']);
                }
            }
            if ($remData['guardian'] == 1) {
                if (!empty($stuData['guardian_mobileno'])) {
                    $this->_send($sms_api, $stuData['guardian_mobileno'], $text, $remData['dlt_template_id']);
                }
            }
        }
    }
    public function sendHomework($data)
    {
        $template = $builder->getWhere('sms_template_details', array('template_id' => 6, 'branch_id' => $data['branch_id']))->row_array();
        $sms_api = $this->application_model->smsServiceProvider($data['branch_id']);
        if (($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
            $text = str_replace('{name}', $data['fullname'], $template['template_body']);
            $text = str_replace('{register_no}', $data['register_no'], $text);
            $text = str_replace('{admission_date}', $data['admission_date'], $text);
            $text = str_replace('{class}', $data['class_name'], $text);
            $text = str_replace('{section}', $data['section_name'], $text);
            $text = str_replace('{date_of_homework}', $data['date_of_homework'], $text);
            $text = str_replace('{date_of_submission}', $data['date_of_submission'], $text);
            $text = str_replace('{subject}', get_type_name_by_id('subject', $data['subject_id']), $text);
            if ($template['notify_student'] == 1) {
                if (!empty($data['mobileno'])) {
                    $this->_send($sms_api, $data['mobileno'], $text, $template['dlt_template_id']);
                }
            }
            if ($template['notify_parent'] == 1) {
                if (!empty($data['parent_id'])) {
                    $parent = $db->table('parent')->get('parent')->row_array();
                    if (!empty($parent['mobileno'])) {
                        $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function sendLiveClass($data)
    {
        $template = $builder->getWhere('sms_template_details', array('template_id' => 7, 'branch_id' => $data['branch_id']))->row_array();
        $sms_api = $this->application_model->smsServiceProvider($data['branch_id']);
        if (($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
            $text = str_replace('{name}', $data['fullname'], $template['template_body']);
            $text = str_replace('{roll}', $data['roll'], $text);
            $text = str_replace('{register_no}', $data['register_no'], $text);
            $text = str_replace('{admission_date}', $data['admission_date'], $text);
            $text = str_replace('{class}', $data['class_name'], $text);
            $text = str_replace('{section}', $data['section_name'], $text);
            $text = str_replace('{date_of_live_class}', $data['date_of_live_class'], $text);
            $text = str_replace('{start_time}', $data['start_time'], $text);
            $text = str_replace('{end_time}', $data['end_time'], $text);
            $text = str_replace('{host_by}', $data['host_by'], $text);
            if ($template['notify_student'] == 1) {
                if (!empty($data['mobileno'])) {
                    $this->_send($sms_api, $data['mobileno'], $text, $template['dlt_template_id']);
                }
            }
            if ($template['notify_parent'] == 1) {
                if (!empty($data['parent_id'])) {
                    $parent = $db->table('parent')->get('parent')->row_array();
                    if (!empty($parent['mobileno'])) {
                        $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function sendOnlineExam($data)
    {
        $template = $builder->getWhere('sms_template_details', array('template_id' => 8, 'branch_id' => $data['branch_id']))->row_array();
        $sms_api = $this->application_model->smsServiceProvider($data['branch_id']);
        if (($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
            $text = str_replace('{name}', $data['fullname'], $template['template_body']);
            $text = str_replace('{roll}', $data['roll'], $text);
            $text = str_replace('{register_no}', $data['register_no'], $text);
            $text = str_replace('{admission_date}', $data['admission_date'], $text);
            $text = str_replace('{class}', $data['class_name'], $text);
            $text = str_replace('{section}', $data['section_name'], $text);
            $text = str_replace('{exam_title}', $data['exam_title'], $text);
            $text = str_replace('{start_time}', $data['start_time'], $text);
            $text = str_replace('{end_time}', $data['end_time'], $text);
            $text = str_replace('{time_duration}', $data['time_duration'], $text);
            $text = str_replace('{attempt}', $data['attempt'], $text);
            $text = str_replace('{passing_mark}', $data['passing_mark'], $text);
            $text = str_replace('{exam_fee}', $data['exam_fee'], $text);
            if ($template['notify_student'] == 1) {
                if (!empty($data['mobileno'])) {
                    $this->_send($sms_api, $data['mobileno'], $text, $template['dlt_template_id']);
                }
            }
            if ($template['notify_parent'] == 1) {
                if (!empty($data['parent_id'])) {
                    $parent = $db->table('parent')->get('parent')->row_array();
                    if (!empty($parent['mobileno'])) {
                        $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function sendBirthdayStudentWishes($data)
    {
        $student = $this->application_model->getstudentdetails($data['student_id']);
        if (!empty($student)) {
            $template = $builder->getWhere('sms_template_details', array('template_id' => 9, 'branch_id' => $student['branch_id']))->row_array();
            $sms_api = $this->application_model->smsServiceProvider($student['branch_id']);
            if (!empty($template) && ($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
                $text = str_replace('{name}', $student['first_name'] . ' ' . $student['last_name'], $template['template_body']);
                $text = str_replace('{register_no}', $student['register_no'], $text);
                $text = str_replace('{admission_date}', $student['admission_date'], $text);
                $text = str_replace('{class}', $student['class_name'], $text);
                $text = str_replace('{section}', $student['section_name'], $text);
                $text = str_replace('{roll}', $student['roll'], $text);
                $text = str_replace('{birthday}', _d($student['birthday']), $text);
                if ($template['notify_student'] == 1) {
                    if (!empty($student['mobileno'])) {
                        $this->_send($sms_api, $student['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
                if ($template['notify_parent'] == 1) {
                    if (!empty($student['parent_id'])) {
                        $parent = $db->table('parent')->get('parent')->row_array();
                        if (!empty($parent['mobileno'])) {
                            $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                        }
                    }
                }
            }
        }
    }
    public function sendBirthdayStaffWishes($data)
    {
        $branchID = $this->application_model->get_branch_id();
        $sql = "SELECT `name`,`birthday`,`joining_date`,`mobileno`,`branch_id` FROM `staff` WHERE `id` = " . $db->escape($data['staff_id']) . " AND `branch_id` = " . $db->escape($branchID);
        $staff = $db->query($sql)->row_array();
        if (!empty($staff)) {
            $template = $builder->getWhere('sms_template_details', array('template_id' => 10, 'branch_id' => $staff['branch_id']))->row_array();
            $sms_api = $this->application_model->smsServiceProvider($staff['branch_id']);
            if (!empty($template) && ($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
                $text = str_replace('{name}', $staff['name'], $template['template_body']);
                $text = str_replace('{joining_date}', $staff['joining_date'], $text);
                $text = str_replace('{birthday}', _d($staff['birthday']), $text);
                if ($template['notify_student'] == 1) {
                    if (!empty($staff['mobileno'])) {
                        $this->_send($sms_api, $staff['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function _send($sms_api, $receiver, $text, $dlt_template_id = '')
    {
        if ($sms_api == 2) {
            $res = $this->clickatell->send_message($receiver, $text);
        } elseif ($sms_api == 1) {
            $res = $this->twilio->sms($receiver, $text);
        } elseif ($sms_api == 4) {
            $res = $this->bulk->send($receiver, $text);
        } elseif ($sms_api == 3) {
            $res = $this->msg91->send($receiver, $text, $dlt_template_id);
        } elseif ($sms_api == 5) {
            $res = $this->textlocal->sendSms($receiver, $text);
        } elseif ($sms_api == 6) {
            $res = $this->smscountry->send($receiver, $text);
        } elseif ($sms_api == 7) {
            $res = $this->bulksmsbd->send($receiver, $text);
        } elseif ($sms_api == 8) {
            $res = $this->custom_sms->send($receiver, $text, $dlt_template_id);
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class SmsModel extends Model
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
        $this->clickatell = service('clickatell');
        $this->twilio = service('twilio');
        $this->msg91 = service('msg91');
        $this->bulk = service('bulk');
        $this->textlocal = service('textlocal');
        $this->smscountry = service('smscountry');
        $this->bulksmsbd = service('bulksmsbd');
        $this->custom_sms = service('customSms');
    }
    // common function for sending sms
    public function send_sms($data = '', $id = '')
    {
        $branchID = $this->applicationModel->get_branch_id();
        $sms_api = $this->applicationModel->smsServiceProvider($branchID);
        $template = $builder->getWhere('sms_template_details', array('template_id' => $id, 'branch_id' => $branchID))->row_array();
        if (!empty($template) && ($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
            $student = $this->applicationModel->getstudentdetails($data['student_id']);
            $text = str_replace('{name}', $student['first_name'] . ' ' . $student['last_name'], $template['template_body']);
            $text = str_replace('{register_no}', $student['register_no'], $text);
            $text = str_replace('{admission_date}', $student['admission_date'], $text);
            $text = str_replace('{class}', $student['class_name'], $text);
            $text = str_replace('{section}', $student['section_name'], $text);
            $text = str_replace('{roll}', $student['roll'], $text);
            if ($id == 2) {
                $text = str_replace('{paid_amount}', $data['amount'], $text);
                $text = str_replace('{paid_date}', _d($data['paid_date']), $text);
            }
            if ($id == 4 || $id == 5) {
                $exam = $db->table('exam')->get('exam')->row();
                $subject_name = $db->table('subject')->get('subject')->row()->name;
                if (!empty($exam->term_id)) {
                    $term_name = $db->table('exam_term')->get('exam_term')->row()->name;
                }
                $text = str_replace('{exam_name}', $exam->name, $text);
                $text = str_replace('{term_name}', $term_name, $text);
                $text = str_replace('{subject}', $subject_name, $text);
                if (!empty($data['mark'])) {
                    $text = str_replace('{marks}', $data['mark'], $text);
                }
            }
            if ($template['notify_student'] == 1) {
                if (!empty($student['mobileno'])) {
                    $this->_send($sms_api, $student['mobileno'], $text, $template['dlt_template_id']);
                }
            }
            if ($template['notify_parent'] == 1) {
                if (!empty($student['parent_id'])) {
                    $parent = $db->table('parent')->get('parent')->row_array();
                    if (!empty($parent['mobileno'])) {
                        $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function alumniEvent($arrayData = [])
    {
        $sms_api = $this->applicationModel->smsServiceProvider($arrayData['branch_id']);
        $template = $builder->getWhere('sms_template_details', array('template_id' => 11, 'branch_id' => $arrayData['branch_id']))->row_array();
        if (!empty($template) && $template['notify_student'] == 1 && $sms_api != 'disabled') {
            $text = str_replace('{student_name}', $arrayData['name'], $template['template_body']);
            $text = str_replace('{start_date}', $arrayData['from_date'], $text);
            $text = str_replace('{end_date}', $arrayData['to_date'], $text);
            $text = str_replace('{event_title}', $arrayData['event_title'], $text);
            if (!empty($arrayData['mobile_no'])) {
                $this->_send($sms_api, $arrayData['mobile_no'], $text, $template['dlt_template_id']);
            }
        }
    }
    public function feeReminder($stuData, $remData)
    {
        $sms_api = $this->applicationModel->smsServiceProvider($remData['branch_id']);
        if ($sms_api != 'disabled') {
            $text = str_replace('{guardian_name}', $stuData['guardian_name'], $remData['message']);
            $text = str_replace('{child_name}', $stuData['child_name'], $text);
            $text = str_replace('{due_date}', $stuData['due_date'], $text);
            $text = str_replace('{due_amount}', $stuData['balance_amount'], $text);
            $text = str_replace('{fee_type}', $stuData['type_name'], $text);
            if ($remData['student'] == 1) {
                if (!empty($stuData['child_mobileno'])) {
                    $this->_send($sms_api, $stuData['child_mobileno'], $text, $remData['dlt_template_id']);
                }
            }
            if ($remData['guardian'] == 1) {
                if (!empty($stuData['guardian_mobileno'])) {
                    $this->_send($sms_api, $stuData['guardian_mobileno'], $text, $remData['dlt_template_id']);
                }
            }
        }
    }
    public function sendHomework($data)
    {
        $template = $builder->getWhere('sms_template_details', array('template_id' => 6, 'branch_id' => $data['branch_id']))->row_array();
        $sms_api = $this->applicationModel->smsServiceProvider($data['branch_id']);
        if (($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
            $text = str_replace('{name}', $data['fullname'], $template['template_body']);
            $text = str_replace('{register_no}', $data['register_no'], $text);
            $text = str_replace('{admission_date}', $data['admission_date'], $text);
            $text = str_replace('{class}', $data['class_name'], $text);
            $text = str_replace('{section}', $data['section_name'], $text);
            $text = str_replace('{date_of_homework}', $data['date_of_homework'], $text);
            $text = str_replace('{date_of_submission}', $data['date_of_submission'], $text);
            $text = str_replace('{subject}', get_type_name_by_id('subject', $data['subject_id']), $text);
            if ($template['notify_student'] == 1) {
                if (!empty($data['mobileno'])) {
                    $this->_send($sms_api, $data['mobileno'], $text, $template['dlt_template_id']);
                }
            }
            if ($template['notify_parent'] == 1) {
                if (!empty($data['parent_id'])) {
                    $parent = $db->table('parent')->get('parent')->row_array();
                    if (!empty($parent['mobileno'])) {
                        $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function sendLiveClass($data)
    {
        $template = $builder->getWhere('sms_template_details', array('template_id' => 7, 'branch_id' => $data['branch_id']))->row_array();
        $sms_api = $this->applicationModel->smsServiceProvider($data['branch_id']);
        if (($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
            $text = str_replace('{name}', $data['fullname'], $template['template_body']);
            $text = str_replace('{roll}', $data['roll'], $text);
            $text = str_replace('{register_no}', $data['register_no'], $text);
            $text = str_replace('{admission_date}', $data['admission_date'], $text);
            $text = str_replace('{class}', $data['class_name'], $text);
            $text = str_replace('{section}', $data['section_name'], $text);
            $text = str_replace('{date_of_live_class}', $data['date_of_live_class'], $text);
            $text = str_replace('{start_time}', $data['start_time'], $text);
            $text = str_replace('{end_time}', $data['end_time'], $text);
            $text = str_replace('{host_by}', $data['host_by'], $text);
            if ($template['notify_student'] == 1) {
                if (!empty($data['mobileno'])) {
                    $this->_send($sms_api, $data['mobileno'], $text, $template['dlt_template_id']);
                }
            }
            if ($template['notify_parent'] == 1) {
                if (!empty($data['parent_id'])) {
                    $parent = $db->table('parent')->get('parent')->row_array();
                    if (!empty($parent['mobileno'])) {
                        $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function sendOnlineExam($data)
    {
        $template = $builder->getWhere('sms_template_details', array('template_id' => 8, 'branch_id' => $data['branch_id']))->row_array();
        $sms_api = $this->applicationModel->smsServiceProvider($data['branch_id']);
        if (($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
            $text = str_replace('{name}', $data['fullname'], $template['template_body']);
            $text = str_replace('{roll}', $data['roll'], $text);
            $text = str_replace('{register_no}', $data['register_no'], $text);
            $text = str_replace('{admission_date}', $data['admission_date'], $text);
            $text = str_replace('{class}', $data['class_name'], $text);
            $text = str_replace('{section}', $data['section_name'], $text);
            $text = str_replace('{exam_title}', $data['exam_title'], $text);
            $text = str_replace('{start_time}', $data['start_time'], $text);
            $text = str_replace('{end_time}', $data['end_time'], $text);
            $text = str_replace('{time_duration}', $data['time_duration'], $text);
            $text = str_replace('{attempt}', $data['attempt'], $text);
            $text = str_replace('{passing_mark}', $data['passing_mark'], $text);
            $text = str_replace('{exam_fee}', $data['exam_fee'], $text);
            if ($template['notify_student'] == 1) {
                if (!empty($data['mobileno'])) {
                    $this->_send($sms_api, $data['mobileno'], $text, $template['dlt_template_id']);
                }
            }
            if ($template['notify_parent'] == 1) {
                if (!empty($data['parent_id'])) {
                    $parent = $db->table('parent')->get('parent')->row_array();
                    if (!empty($parent['mobileno'])) {
                        $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function sendBirthdayStudentWishes($data)
    {
        $student = $this->applicationModel->getstudentdetails($data['student_id']);
        if (!empty($student)) {
            $template = $builder->getWhere('sms_template_details', array('template_id' => 9, 'branch_id' => $student['branch_id']))->row_array();
            $sms_api = $this->applicationModel->smsServiceProvider($student['branch_id']);
            if (!empty($template) && ($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
                $text = str_replace('{name}', $student['first_name'] . ' ' . $student['last_name'], $template['template_body']);
                $text = str_replace('{register_no}', $student['register_no'], $text);
                $text = str_replace('{admission_date}', $student['admission_date'], $text);
                $text = str_replace('{class}', $student['class_name'], $text);
                $text = str_replace('{section}', $student['section_name'], $text);
                $text = str_replace('{roll}', $student['roll'], $text);
                $text = str_replace('{birthday}', _d($student['birthday']), $text);
                if ($template['notify_student'] == 1) {
                    if (!empty($student['mobileno'])) {
                        $this->_send($sms_api, $student['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
                if ($template['notify_parent'] == 1) {
                    if (!empty($student['parent_id'])) {
                        $parent = $db->table('parent')->get('parent')->row_array();
                        if (!empty($parent['mobileno'])) {
                            $this->_send($sms_api, $parent['mobileno'], $text, $template['dlt_template_id']);
                        }
                    }
                }
            }
        }
    }
    public function sendBirthdayStaffWishes($data)
    {
        $branchID = $this->applicationModel->get_branch_id();
        $sql = "SELECT `name`,`birthday`,`joining_date`,`mobileno`,`branch_id` FROM `staff` WHERE `id` = " . $db->escape($data['staff_id']) . " AND `branch_id` = " . $db->escape($branchID);
        $staff = $db->query($sql)->row_array();
        if (!empty($staff)) {
            $template = $builder->getWhere('sms_template_details', array('template_id' => 10, 'branch_id' => $staff['branch_id']))->row_array();
            $sms_api = $this->applicationModel->smsServiceProvider($staff['branch_id']);
            if (!empty($template) && ($template['notify_student'] == 1 || $template['notify_parent'] == 1) && $sms_api != 'disabled') {
                $text = str_replace('{name}', $staff['name'], $template['template_body']);
                $text = str_replace('{joining_date}', $staff['joining_date'], $text);
                $text = str_replace('{birthday}', _d($staff['birthday']), $text);
                if ($template['notify_student'] == 1) {
                    if (!empty($staff['mobileno'])) {
                        $this->_send($sms_api, $staff['mobileno'], $text, $template['dlt_template_id']);
                    }
                }
            }
        }
    }
    public function _send($sms_api, $receiver, $text, $dlt_template_id = '')
    {
        if ($sms_api == 2) {
            $res = $this->clickatell->send_message($receiver, $text);
        } elseif ($sms_api == 1) {
            $res = $this->twilio->sms($receiver, $text);
        } elseif ($sms_api == 4) {
            $res = $this->bulk->send($receiver, $text);
        } elseif ($sms_api == 3) {
            $res = $this->msg91->send($receiver, $text, $dlt_template_id);
        } elseif ($sms_api == 5) {
            $res = $this->textlocal->sendSms($receiver, $text);
        } elseif ($sms_api == 6) {
            $res = $this->smscountry->send($receiver, $text);
        } elseif ($sms_api == 7) {
            $res = $this->bulksmsbd->send($receiver, $text);
        } elseif ($sms_api == 8) {
            $res = $this->custom_sms->send($receiver, $text, $dlt_template_id);
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/MarksheetTemplateModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class MarksheetTemplateModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getList()
    {
        $builder->select('marksheet_template.*,branch.name as branchname');
        $builder->from('marksheet_template');
        $builder->join('branch', 'branch.id = marksheet_template.branch_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('marksheet_template.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('marksheet_template.id', 'ASC');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function save($data)
    {
        $arrayLive = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['marksheet_template_name'], 'page_layout' => $data['page_layout'], 'photo_style' => $data['photo_style'], 'photo_size' => empty($data['photo_size']) ? 100 : $data['photo_size'], 'top_space' => empty($data['top_space']) ? 0 : $data['top_space'], 'bottom_space' => empty($data['bottom_space']) ? 0 : $data['bottom_space'], 'right_space' => empty($data['right_space']) ? 0 : $data['right_space'], 'left_space' => empty($data['left_space']) ? 0 : $data['left_space'], 'background' => $this->fileupload('background_file', './uploads/marksheet/', $this->request->getPost('old_background_file')), 'logo' => $this->fileupload('logo_file', './uploads/marksheet/', $this->request->getPost('old_logo_file')), 'left_signature' => $this->fileupload('left_signature_file', './uploads/marksheet/', $this->request->getPost('old_left_signature_file')), 'middle_signature' => $this->fileupload('middle_signature_file', './uploads/marksheet/', $this->request->getPost('old_middle_signature_file')), 'right_signature' => $this->fileupload('right_signature_file', './uploads/marksheet/', $this->request->getPost('old_right_signature_file')), 'header_content' => $this->request->getPost('header_content', false), 'footer_content' => $this->request->getPost('footer_content', false), 'attendance_percentage' => isset($_POST['attendance_percentage']) ? 1 : 0, 'grading_scale' => isset($_POST['grading_scale']) ? 1 : 0, 'position' => isset($_POST['position']) ? 1 : 0, 'cumulative_average' => isset($_POST['cumulative_average']) ? 1 : 0, 'class_average' => isset($_POST['class_average']) ? 1 : 0, 'subject_position' => isset($_POST['subject_position']) ? 1 : 0, 'remark' => isset($_POST['remark']) ? 1 : 0, 'result' => isset($_POST['result']) ? 1 : 0);
        if (!isset($data['marksheet_template_id'])) {
            $builder->insert('marksheet_template', $arrayLive);
        } else {
            $builder->where('id', $data['marksheet_template_id']);
            $builder->update('marksheet_template', $arrayLive);
        }
    }
    public function tagsList()
    {
        $arrayTags = array();
        $arrayTags[] = '{name}';
        $arrayTags[] = '{gender}';
        $arrayTags[] = '{father_name}';
        $arrayTags[] = '{mother_name}';
        $arrayTags[] = '{student_photo}';
        $arrayTags[] = '{register_no}';
        $arrayTags[] = '{academic_session}';
        $arrayTags[] = '{roll}';
        $arrayTags[] = '{admission_date}';
        $arrayTags[] = '{class}';
        $arrayTags[] = '{section}';
        $arrayTags[] = '{category}';
        $arrayTags[] = '{caste}';
        $arrayTags[] = '{religion}';
        $arrayTags[] = '{blood_group}';
        $arrayTags[] = '{birthday}';
        $arrayTags[] = '{email}';
        $arrayTags[] = '{mobileno}';
        $arrayTags[] = '{present_address}';
        $arrayTags[] = '{permanent_address}';
        $arrayTags[] = '{exam_name}';
        $arrayTags[] = '{left_signature}';
        $arrayTags[] = '{middle_signature}';
        $arrayTags[] = '{right_signature}';
        $arrayTags[] = '{print_date}';
        $arrayTags[] = '{principal_comments}';
        $arrayTags[] = '{teacher_comments}';
        $arrayTags[] = '{logo}';
        $arrayTags[] = '{institute_name}';
        $arrayTags[] = '{institute_email}';
        $arrayTags[] = '{institute_address}';
        $arrayTags[] = '{institute_mobile_no}';
        return $arrayTags;
    }
    public function tagsReplace($studentData = '', $template = '', $extendsData = [], $header_content = '')
    {
        $body = $template[$header_content];
        $photo_size = $template['photo_size'];
        $photo_style = $template['photo_style'];
        $tags = $this->tagsList();
        $userDetails = $studentData;
        $arr = array('{', '}');
        foreach ($tags as $tag) {
            $field = str_replace($arr, '', $tag);
            if ($field == 'student_photo') {
                $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('student', $userDetails['photo']) . '" height="' . $photo_size . '">';
                $body = str_replace($tag, $photo, $body);
            } else if ($field == 'logo') {
                if (!empty($template['logo'])) {
                    $logo_ph = '<img src="' . base_url('uploads/marksheet/' . $template['logo']) . '">';
                    $body = str_replace($tag, $logo_ph, $body);
                }
            } else if ($field == 'left_signature') {
                if (!empty($template['left_signature'])) {
                    $signature_ph = '<img src="' . base_url('uploads/marksheet/' . $template['left_signature']) . '">';
                    $body = str_replace($tag, $signature_ph, $body);
                }
            } else if ($field == 'middle_signature') {
                if (!empty($template['middle_signature'])) {
                    $signature_ph = '<img src="' . base_url('uploads/marksheet/' . $template['middle_signature']) . '">';
                    $body = str_replace($tag, $signature_ph, $body);
                }
            } else if ($field == 'right_signature') {
                if (!empty($template['right_signature'])) {
                    $signature_ph = '<img src="' . base_url('uploads/marksheet/' . $template['right_signature']) . '">';
                    $body = str_replace($tag, $signature_ph, $body);
                }
            } else if ($field == 'present_address') {
                $body = str_replace($tag, $userDetails['current_address'], $body);
            } else if ($field == 'academic_session') {
                if (!empty($extendsData['schoolYear'])) {
                    $body = str_replace($tag, $extendsData['schoolYear'], $body);
                }
            } else if ($field == 'print_date') {
                if (!empty($extendsData['print_date'])) {
                    $body = str_replace($tag, _d($extendsData['print_date']), $body);
                }
            } else if ($field == 'exam_name') {
                if (!empty($extendsData['exam_name'])) {
                    $body = str_replace($tag, $extendsData['exam_name'], $body);
                }
            } else if ($field == 'principal_comments') {
                if (!empty($extendsData['principal_comments'])) {
                    $body = str_replace($tag, $extendsData['principal_comments'], $body);
                } else {
                    $body = str_replace($tag, "", $body);
                }
            } else if ($field == 'teacher_comments') {
                if (!empty($extendsData['teacher_comments'])) {
                    $body = str_replace($tag, $extendsData['teacher_comments'], $body);
                } else {
                    $body = str_replace($tag, "", $body);
                }
            } else {
                $body = str_replace($tag, $userDetails[$field], $body);
            }
        }
        return $body;
    }
    public function getTemplate($templateID = '', $branchID = '')
    {
        return $db->table('marksheet_template')->get('marksheet_template')->row_array();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class MarksheetTemplateModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getList()
    {
        $builder->select('marksheet_template.*,branch.name as branchname');
        $builder->from('marksheet_template');
        $builder->join('branch', 'branch.id = marksheet_template.branch_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('marksheet_template.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('marksheet_template.id', 'ASC');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function save($data)
    {
        $arrayLive = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['marksheet_template_name'], 'page_layout' => $data['page_layout'], 'photo_style' => $data['photo_style'], 'photo_size' => empty($data['photo_size']) ? 100 : $data['photo_size'], 'top_space' => empty($data['top_space']) ? 0 : $data['top_space'], 'bottom_space' => empty($data['bottom_space']) ? 0 : $data['bottom_space'], 'right_space' => empty($data['right_space']) ? 0 : $data['right_space'], 'left_space' => empty($data['left_space']) ? 0 : $data['left_space'], 'background' => $this->fileupload('background_file', './uploads/marksheet/', $this->request->getPost('old_background_file')), 'logo' => $this->fileupload('logo_file', './uploads/marksheet/', $this->request->getPost('old_logo_file')), 'left_signature' => $this->fileupload('left_signature_file', './uploads/marksheet/', $this->request->getPost('old_left_signature_file')), 'middle_signature' => $this->fileupload('middle_signature_file', './uploads/marksheet/', $this->request->getPost('old_middle_signature_file')), 'right_signature' => $this->fileupload('right_signature_file', './uploads/marksheet/', $this->request->getPost('old_right_signature_file')), 'header_content' => $this->request->getPost('header_content', false), 'footer_content' => $this->request->getPost('footer_content', false), 'attendance_percentage' => isset($_POST['attendance_percentage']) ? 1 : 0, 'grading_scale' => isset($_POST['grading_scale']) ? 1 : 0, 'position' => isset($_POST['position']) ? 1 : 0, 'cumulative_average' => isset($_POST['cumulative_average']) ? 1 : 0, 'class_average' => isset($_POST['class_average']) ? 1 : 0, 'subject_position' => isset($_POST['subject_position']) ? 1 : 0, 'remark' => isset($_POST['remark']) ? 1 : 0, 'result' => isset($_POST['result']) ? 1 : 0);
        if (!isset($data['marksheet_template_id'])) {
            $builder->insert('marksheet_template', $arrayLive);
        } else {
            $builder->where('id', $data['marksheet_template_id']);
            $builder->update('marksheet_template', $arrayLive);
        }
    }
    public function tagsList()
    {
        $arrayTags = array();
        $arrayTags[] = '{name}';
        $arrayTags[] = '{gender}';
        $arrayTags[] = '{father_name}';
        $arrayTags[] = '{mother_name}';
        $arrayTags[] = '{student_photo}';
        $arrayTags[] = '{register_no}';
        $arrayTags[] = '{academic_session}';
        $arrayTags[] = '{roll}';
        $arrayTags[] = '{admission_date}';
        $arrayTags[] = '{class}';
        $arrayTags[] = '{section}';
        $arrayTags[] = '{category}';
        $arrayTags[] = '{caste}';
        $arrayTags[] = '{religion}';
        $arrayTags[] = '{blood_group}';
        $arrayTags[] = '{birthday}';
        $arrayTags[] = '{email}';
        $arrayTags[] = '{mobileno}';
        $arrayTags[] = '{present_address}';
        $arrayTags[] = '{permanent_address}';
        $arrayTags[] = '{exam_name}';
        $arrayTags[] = '{left_signature}';
        $arrayTags[] = '{middle_signature}';
        $arrayTags[] = '{right_signature}';
        $arrayTags[] = '{print_date}';
        $arrayTags[] = '{principal_comments}';
        $arrayTags[] = '{teacher_comments}';
        $arrayTags[] = '{logo}';
        $arrayTags[] = '{institute_name}';
        $arrayTags[] = '{institute_email}';
        $arrayTags[] = '{institute_address}';
        $arrayTags[] = '{institute_mobile_no}';
        return $arrayTags;
    }
    public function tagsReplace($studentData = '', $template = '', $extendsData = [], $header_content = '')
    {
        $body = $template[$header_content];
        $photo_size = $template['photo_size'];
        $photo_style = $template['photo_style'];
        $tags = $this->tagsList();
        $userDetails = $studentData;
        $arr = array('{', '}');
        foreach ($tags as $tag) {
            $field = str_replace($arr, '', $tag);
            if ($field == 'student_photo') {
                $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('student', $userDetails['photo']) . '" height="' . $photo_size . '">';
                $body = str_replace($tag, $photo, $body);
            } else if ($field == 'logo') {
                if (!empty($template['logo'])) {
                    $logo_ph = '<img src="' . base_url('uploads/marksheet/' . $template['logo']) . '">';
                    $body = str_replace($tag, $logo_ph, $body);
                }
            } else if ($field == 'left_signature') {
                if (!empty($template['left_signature'])) {
                    $signature_ph = '<img src="' . base_url('uploads/marksheet/' . $template['left_signature']) . '">';
                    $body = str_replace($tag, $signature_ph, $body);
                }
            } else if ($field == 'middle_signature') {
                if (!empty($template['middle_signature'])) {
                    $signature_ph = '<img src="' . base_url('uploads/marksheet/' . $template['middle_signature']) . '">';
                    $body = str_replace($tag, $signature_ph, $body);
                }
            } else if ($field == 'right_signature') {
                if (!empty($template['right_signature'])) {
                    $signature_ph = '<img src="' . base_url('uploads/marksheet/' . $template['right_signature']) . '">';
                    $body = str_replace($tag, $signature_ph, $body);
                }
            } else if ($field == 'present_address') {
                $body = str_replace($tag, $userDetails['current_address'], $body);
            } else if ($field == 'academic_session') {
                if (!empty($extendsData['schoolYear'])) {
                    $body = str_replace($tag, $extendsData['schoolYear'], $body);
                }
            } else if ($field == 'print_date') {
                if (!empty($extendsData['print_date'])) {
                    $body = str_replace($tag, _d($extendsData['print_date']), $body);
                }
            } else if ($field == 'exam_name') {
                if (!empty($extendsData['exam_name'])) {
                    $body = str_replace($tag, $extendsData['exam_name'], $body);
                }
            } else if ($field == 'principal_comments') {
                if (!empty($extendsData['principal_comments'])) {
                    $body = str_replace($tag, $extendsData['principal_comments'], $body);
                } else {
                    $body = str_replace($tag, "", $body);
                }
            } else if ($field == 'teacher_comments') {
                if (!empty($extendsData['teacher_comments'])) {
                    $body = str_replace($tag, $extendsData['teacher_comments'], $body);
                } else {
                    $body = str_replace($tag, "", $body);
                }
            } else {
                $body = str_replace($tag, $userDetails[$field], $body);
            }
        }
        return $body;
    }
    public function getTemplate($templateID = '', $branchID = '')
    {
        return $db->table('marksheet_template')->get('marksheet_template')->row_array();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/CustomFieldModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class CustomFieldModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function save($data, $defaultValue)
    {
        $branchID = $this->application_model->get_branch_id();
        $required = isset($_POST['chk_required']) ? 1 : 0;
        $show_table = isset($_POST['chk_show_table']) ? 1 : 0;
        $status = isset($_POST['chk_active']) ? 1 : 0;
        $insertData = array('form_to' => $data['belongs_to'], 'field_label' => $data['field_label'], 'field_type' => $data['field_type'], 'default_value' => $defaultValue, 'required' => $required, 'status' => $status, 'show_on_table' => $show_table, 'field_order' => $data['field_order'], 'bs_column' => $data['bs_column'], 'branch_id' => $branchID);
        if (isset($data['custom_field_id'])) {
            $builder->where('id', $data['custom_field_id']);
            $builder->update('custom_field', $insertData);
        } else {
            $builder->insert('custom_field', $insertData);
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class CustomFieldModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function save($data, $defaultValue)
    {
        $branchID = $this->applicationModel->get_branch_id();
        $required = isset($_POST['chk_required']) ? 1 : 0;
        $show_table = isset($_POST['chk_show_table']) ? 1 : 0;
        $status = isset($_POST['chk_active']) ? 1 : 0;
        $insertData = array('form_to' => $data['belongs_to'], 'field_label' => $data['field_label'], 'field_type' => $data['field_type'], 'default_value' => $defaultValue, 'required' => $required, 'status' => $status, 'show_on_table' => $show_table, 'field_order' => $data['field_order'], 'bs_column' => $data['bs_column'], 'branch_id' => $branchID);
        if (isset($data['custom_field_id'])) {
            $builder->where('id', $data['custom_field_id']);
            $builder->update('custom_field', $insertData);
        } else {
            $builder->insert('custom_field', $insertData);
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/FeesModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class FeesModel extends MYModel
{
    protected $db;
    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
        $this->model('sms_model');
    }
    public function getPreviousSessionBalance($enrollID = '', $session_id = '', $with_fine = 0)
    {
        $total_balance = 0;
        $total_fine = 0;
        $variable = $db->table('fee_allocation')->get('fee_allocation')->getResult();
        foreach ($variable as $key => $allocation) {
            $groupsDetails = $db->table('fee_groups_details')->get('fee_groups_details')->getResult();
            foreach ($groupsDetails as $k => $type) {
                $fine = $this->feeFineCalculation($allocation->id, $type->fee_type_id);
                $b = $this->getBalance($allocation->id, $type->fee_type_id);
                $total_balance += $b['balance'];
                $total_fine += abs($fine - $b['fine']);
            }
        }
        if ($with_fine == 1) {
            return round($total_balance + $total_fine);
        } else {
            return $total_balance;
        }
    }
    public function feeFineCalculation($allocationID, $typeID)
    {
        $builder->select('fd.amount,fd.due_date,f.*');
        $builder->from('fee_allocation as a');
        $builder->join('fee_groups_details as fd', 'fd.fee_groups_id = a.group_id and fd.fee_type_id = ' . $db->escape($typeID), 'left');
        $builder->join('fee_fine as f', 'f.group_id = fd.fee_groups_id and f.type_id = fd.fee_type_id', 'inner');
        $builder->where('a.id', $allocationID);
        $this->db->table('f.session_id', get_session_id())->where();
        $getDB = $builder->get()->row_array();
        if (is_array($getDB) && count($getDB)) {
            $dueDate = $getDB['due_date'];
            if (strtotime($dueDate) < strtotime(date('Y-m-d'))) {
                $feeAmount = $getDB['amount'];
                $feeFrequency = $getDB['fee_frequency'];
                $fineValue = $getDB['fine_value'];
                if ($getDB['fine_type'] == 1) {
                    $fineAmount = $fineValue;
                } else {
                    $fineAmount = $feeAmount / 100 * $fineValue;
                }
                $now = time();
                // or your date as well
                $dueDate = strtotime($dueDate);
                $datediff = $now - $dueDate;
                $overDay = round($datediff / (60 * 60 * 24));
                if ($feeFrequency != 0) {
                    $fineAmount = $overDay / $feeFrequency * $fineAmount;
                }
                return $fineAmount;
            } else {
                return 0;
            }
        } else {
            return 0;
        }
    }
    public function getStudentAllocationList($classID = '', $sectionID = '', $groupID = '', $branchID = '')
    {
        $sql = "SELECT e.*, s.photo, CONCAT_WS(' ',s.first_name, s.last_name) as fullname, s.gender, s.register_no, s.parent_id, s.email, s.mobileno, IFNULL(fa.id, 0) as allocation_id FROM enroll as e INNER JOIN student as s ON e.student_id = s.id LEFT JOIN login_credential as l ON l.user_id = s.id AND l.role = '7' LEFT JOIN fee_allocation as fa ON fa.student_id = e.id AND fa.group_id = " . $db->escape($groupID) . " AND fa.session_id= " . $db->escape(get_session_id()) . " WHERE e.class_id = " . $db->escape($classID) . " AND e.branch_id = " . $db->escape($branchID) . " AND e.session_id = " . $db->escape(get_session_id());
        if ($sectionID != 'all') {
            $sql .= " AND e.section_id =" . $db->escape($sectionID);
        }
        $sql .= " ORDER BY s.id ASC";
        return $db->query($sql)->result_array();
    }
    public function getInvoiceStatus($enrollID = '')
    {
        $status = "";
        $sql = "SELECT SUM(`fee_groups_details`.`amount` + `fee_allocation`.`prev_due`) as `total`, min(`fee_allocation`.`id`) as `inv_no` FROM `fee_allocation` LEFT JOIN `fee_groups_details` ON `fee_groups_details`.`fee_groups_id` = `fee_allocation`.`group_id` LEFT JOIN `fees_type` ON `fees_type`.`id` = `fee_groups_details`.`fee_type_id` WHERE `fee_allocation`.`student_id` = " . $db->escape($enrollID) . " AND `fee_allocation`.`session_id` = " . $db->escape(get_session_id());
        $balance = $db->query($sql)->row_array();
        $invNo = str_pad($balance['inv_no'], 4, '0', STR_PAD_LEFT);
        $sql = "SELECT IFNULL(SUM(`fee_payment_history`.`amount`), 0) as `amount`, IFNULL(SUM(`fee_payment_history`.`discount`), 0) as `discount`, IFNULL(SUM(`fee_payment_history`.`fine`), 0) as `fine` FROM `fee_payment_history` LEFT JOIN `fee_allocation` ON `fee_payment_history`.`allocation_id` = `fee_allocation`.`id` WHERE `fee_allocation`.`student_id` = " . $db->escape($enrollID) . " AND `fee_allocation`.`session_id` = " . $db->escape(get_session_id());
        $paid = $db->query($sql)->row_array();
        if ($paid['amount'] == 0) {
            $status = 'unpaid';
        } elseif ($balance['total'] == $paid['amount'] + $paid['discount']) {
            $status = 'total';
        } elseif ($paid['amount'] > 1) {
            $status = 'partly';
        }
        return array('status' => $status, 'invoice_no' => $invNo);
    }
    public function getInvoiceDetails($enrollID = '')
    {
        $sql = "SELECT `fee_allocation`.`group_id`,`fee_allocation`.`prev_due`,`fee_allocation`.`id` as `allocation_id`, `fees_type`.`name`, `fees_type`.`system`, `fee_groups_details`.`amount`, `fee_groups_details`.`due_date`, `fee_groups_details`.`fee_type_id` FROM `fee_allocation` LEFT JOIN\r\n        `fee_groups_details` ON `fee_groups_details`.`fee_groups_id` = `fee_allocation`.`group_id` LEFT JOIN `fees_type` ON `fees_type`.`id` = `fee_groups_details`.`fee_type_id` WHERE\r\n        `fee_allocation`.`student_id` = " . $db->escape($enrollID) . " AND `fee_allocation`.`session_id` = " . $db->escape(get_session_id()) . " ORDER BY `fee_allocation`.`group_id` ASC, `fees_type`.`id` ASC";
        $student = array();
        $r = $db->query($sql)->result_array();
        foreach ($r as $key => $value) {
            if ($value['system'] == 1) {
                $value['amount'] = $value['prev_due'];
            }
            $student[] = $value;
        }
        return $student;
    }
    public function getInvoiceBasic($enrollID = '')
    {
        $sessionID = get_session_id();
        $builder->select('s.id,s.register_no,e.branch_id,e.id as enroll_id,s.first_name,s.last_name,s.email as student_email,s.current_address as student_address,c.name as class_name,b.school_name,b.email as school_email,b.mobileno as school_mobileno,b.address as school_address,p.father_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 's.id = e.student_id', 'inner');
        $builder->join('class as c', 'c.id = e.class_id', 'left');
        $builder->join('section as se', 'se.id = e.section_id', 'left');
        $builder->join('parent as p', 'p.id = s.parent_id', 'left');
        $builder->join('branch as b', 'b.id = e.branch_id', 'left');
        $builder->where('e.id', $enrollID);
        $builder->where('e.session_id', $sessionID);
        return $builder->get()->row_array();
    }
    public function getStudentFeeDeposit($allocationID, $typeID)
    {
        $sqlDeposit = "SELECT IFNULL(SUM(`amount`), '0.00') as `total_amount`, IFNULL(SUM(`discount`), '0.00') as `total_discount`, IFNULL(SUM(`fine`), '0.00') as `total_fine` FROM `fee_payment_history` WHERE `allocation_id` = " . $db->escape($allocationID) . " AND `type_id` = " . $db->escape($typeID);
        return $db->query($sqlDeposit)->row_array();
    }
    public function getPaymentHistory($allocationID, $groupID)
    {
        $builder->select('h.*,t.name,t.fee_code,pt.name as payvia');
        $builder->from('fee_payment_history as h');
        $builder->join('fees_type as t', 't.id = h.type_id', 'left');
        $builder->join('payment_types as pt', 'pt.id = h.pay_via', 'left');
        $builder->where('h.allocation_id', $allocationID);
        $builder->order_by('h.id', 'asc');
        return $builder->get()->result_array();
    }
    public function typeSave($data = array())
    {
        $arrayData = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['type_name'], 'fee_code' => strtolower(str_replace(' ', '-', $data['type_name'])), 'description' => $data['description']);
        if (!isset($data['type_id'])) {
            $builder->insert('fees_type', $arrayData);
        } else {
            $builder->where('id', $data['type_id']);
            $builder->update('fees_type', $arrayData);
        }
    }
    // add partly of the fee
    public function add_fees($data = array(), $id = '')
    {
        $total_due = get_type_name_by_id('fee_invoice', $id, 'total_due');
        $payment_amount = $data['amount'];
        if ($payment_amount <= $total_due && $payment_amount > 0) {
            $arrayHistory = array('fee_invoice_id' => $id, 'collect_by' => get_user_stamp(), 'remarks' => $data['remarks'], 'method' => $data['method'], 'amount' => $payment_amount, 'date' => date("Y-m-d"), 'session_id' => get_session_id());
            $builder->insert('payment_history', $arrayHistory);
            if ($total_due <= $payment_amount) {
                $builder->where('id', $id);
                $this->db->table('fee_invoice', array('status' => 2))->update();
            } else {
                $builder->where('id', $id);
                $this->db->table('fee_invoice', array('status' => 1))->update();
            }
            $builder->where('id', $id);
            $builder->set('total_paid', 'total_paid + ' . $payment_amount, false);
            $builder->set('total_due', 'total_due - ' . $payment_amount, false);
            $builder->update('fee_invoice');
            // send payment confirmation sms
            $arrayHistory['student_id'] = $data['student_id'];
            $arrayHistory['timestamp'] = date("Y-m-d");
            $this->sms_model->send_sms($arrayHistory, 2);
            return true;
        } else {
            return false;
        }
    }
    public function getInvoiceList($class_id = '', $section_id = '', $branch_id = '')
    {
        $builder->select('e.id as enroll_id,e.student_id,e.roll,e.id as enroll_id,s.first_name,s.last_name,s.register_no,s.mobileno,c.name as class_name,se.name as section_name');
        $builder->from('fee_allocation as fa');
        $builder->join('enroll as e', 'e.id = fa.student_id and e.session_id = fa.session_id', 'inner');
        $builder->join('student as s', 's.id = e.student_id', 'left');
        $builder->join('class as c', 'c.id = e.class_id', 'left');
        $builder->join('section as se', 'se.id = e.section_id', 'left');
        $builder->where('fa.branch_id', $branch_id);
        $this->db->table('fa.session_id', get_session_id())->where();
        $builder->where('e.class_id', $class_id);
        if ($section_id != 'all') {
            $builder->where('e.section_id', $section_id);
        }
        $builder->group_by('fa.student_id');
        $builder->order_by('e.id', 'asc');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['feegroup'] = $this->getfeeGroup($value['enroll_id']);
        }
        return $result;
    }
    public function getDueInvoiceList($class_id = '', $section_id = '', $feegroup_id = '', $fee_feetype_id = '')
    {
        $sql = "SELECT IFNULL(SUM(h.amount), '0') as `total_amount`, IFNULL(SUM(h.discount), '0') as `total_discount`, gd.amount as `full_amount`, fa.prev_due as `prev_due`, gd.`due_date`, e.student_id, e.id as enroll_id,e.roll, s.first_name, s.last_name, s.register_no, s.mobileno, c.name as `class_name`, se.name as `section_name` FROM fee_allocation as fa LEFT JOIN fee_payment_history as h ON h.allocation_id = fa.id and h.type_id = " . $db->escape($fee_feetype_id) . " INNER JOIN fee_groups_details as gd ON gd.fee_groups_id = fa.group_id and gd.fee_type_id = " . $db->escape($fee_feetype_id) . " INNER JOIN\r\n        enroll as e ON e.id = fa.student_id LEFT JOIN student as s ON s.id = e.student_id LEFT JOIN class as c ON c.id = e.class_id LEFT JOIN section as se ON se.id = e.section_id WHERE\r\n        fa.group_id = " . $db->escape($feegroup_id) . " AND fa.session_id = " . $db->escape(get_session_id()) . " AND e.class_id = " . $db->escape($class_id);
        if ($section_id != 'all') {
            $sql .= " AND e.section_id = " . $db->escape($section_id);
        }
        $sql .= " GROUP BY  fa.student_id ORDER BY e.id ASC";
        $result = $db->query($sql)->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['feegroup'] = $this->getfeeGroup($value['enroll_id']);
        }
        return $result;
    }
    public function getDueReport($class_id = '', $section_id = '')
    {
        $builder->select('fa.id as allocation_id,sum(gd.amount + fa.prev_due) as total_fees,e.id as enroll_id,e.roll,s.first_name,s.last_name,s.register_no,s.mobileno,c.name as class_name,se.name as section_name');
        $builder->from('fee_allocation as fa');
        $builder->join('fee_groups_details as gd', 'gd.fee_groups_id = fa.group_id', 'left');
        $builder->join('enroll as e', 'e.id = fa.student_id and e.session_id = ' . $db->escape(get_session_id()), 'inner');
        $builder->join('student as s', 's.id = e.student_id', 'left');
        $builder->join('class as c', 'c.id = e.class_id', 'left');
        $builder->join('section as se', 'se.id = e.section_id', 'left');
        $this->db->table('fa.session_id', get_session_id())->where();
        $builder->where('e.class_id', $class_id);
        if (!empty($section_id)) {
            $builder->where('e.section_id', $section_id);
        }
        $builder->group_by('fa.student_id');
        $builder->order_by('e.roll', 'asc');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['payment'] = $this->getPaymentDetails($value['enroll_id']);
        }
        return $result;
    }
    public function getPaymentDetails($student_id = '')
    {
        $builder->select('IFNULL(SUM(amount), 0) as total_paid, IFNULL(SUM(discount), 0) as total_discount, IFNULL(SUM(fine), 0) as total_fine');
        $builder->from('fee_allocation');
        $builder->join('fee_payment_history', 'fee_payment_history.allocation_id = fee_allocation.id', 'left');
        $builder->where('fee_allocation.student_id', $student_id);
        return $builder->get()->row_array();
    }
    public function getStuPaymentHistory($classID = '', $SectionID = '', $paymentVia = '', $start = '', $end = '', $branchID = '', $onlyFine = false)
    {
        $builder->select('h.*,ft.name as type_name,e.student_id,e.roll,s.first_name,s.last_name,s.register_no,s.mobileno,c.name as class_name,se.name as section_name,pt.name as pay_via');
        $builder->from('fee_payment_history as h');
        $builder->join('fee_allocation as fa', 'fa.id = h.allocation_id', 'inner');
        $builder->join('fees_type as ft', 'ft.id = h.type_id', 'left');
        $builder->join('enroll as e', 'e.id = fa.student_id', 'inner');
        $builder->join('student as s', 's.id = e.student_id', 'inner');
        $builder->join('class as c', 'c.id = e.class_id', 'left');
        $builder->join('section as se', 'se.id = e.section_id', 'left');
        $builder->join('payment_types as pt', 'pt.id = h.pay_via', 'left');
        $this->db->table('fa.session_id', get_session_id())->where();
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->where('h.date  >=', $start);
        $builder->where('h.date <=', $end);
        $builder->where('e.branch_id', $branchID);
        if ($onlyFine == true) {
            $builder->where('h.fine !=', 0);
        }
        if (!empty($classID)) {
            $builder->where('e.class_id', $classID);
        }
        if (!empty($SectionID)) {
            $builder->where('e.section_id', $SectionID);
        }
        if ($paymentVia != 'all') {
            if ($paymentVia == 'online') {
                $builder->where('h.collect_by', 'online');
            } else {
                $builder->where('h.collect_by !=', 'online');
            }
        }
        $builder->order_by('h.id', 'asc');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function getStuPaymentReport($classID = '', $sectionID = '', $enrollID = '', $typeID = '', $start = '', $end = '', $branchID = '')
    {
        $builder->select('h.*,gd.due_date,ft.name as type_name,e.student_id,e.roll,s.first_name,s.last_name,s.register_no,pt.name as pay_via');
        $builder->from('fee_payment_history as h');
        $builder->join('fee_allocation as fa', 'fa.id = h.allocation_id', 'inner');
        $builder->join('fees_type as ft', 'ft.id = h.type_id', 'left');
        $builder->join('fee_groups_details as gd', 'gd.fee_groups_id = fa.group_id and gd.fee_type_id = h.type_id', 'left');
        $builder->join('enroll as e', 'e.id = fa.student_id and e.session_id =  ' . $db->escape(get_session_id()), 'inner');
        $builder->join('student as s', 's.id = e.student_id', 'inner');
        $builder->join('payment_types as pt', 'pt.id = h.pay_via', 'left');
        $this->db->table('fa.session_id', get_session_id())->where();
        $builder->where('h.date >=', $start);
        $builder->where('h.date <=', $end);
        $builder->where('e.branch_id', $branchID);
        $builder->where('e.class_id', $classID);
        if (!empty($typeID)) {
            $typeID = explode("|", $typeID);
            $builder->where('h.type_id', $typeID[1]);
        }
        if (!empty($enrollID)) {
            $builder->where('e.id', $enrollID);
        }
        $builder->where('e.section_id', $sectionID);
        $builder->order_by('h.id', 'asc');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function getfeeGroup($studentID = '')
    {
        $builder->select('g.name');
        $builder->from('fee_allocation as fa');
        $builder->join('fee_groups as g', 'g.id = fa.group_id', 'inner');
        $builder->where('fa.student_id', $studentID);
        $this->db->table('fa.session_id', get_session_id())->where();
        return $builder->get()->result_array();
    }
    public function reminderSave($data = array())
    {
        $arrayData = array('frequency' => $data['frequency'], 'days' => $data['days'], 'student' => isset($data['chk_student']) ? 1 : 0, 'guardian' => isset($data['chk_guardian']) ? 1 : 0, 'message' => $data['message'], 'dlt_template_id' => $data['dlt_template_id'], 'branch_id' => $data['branch_id']);
        if (!isset($data['reminder_id'])) {
            $builder->insert('fees_reminder', $arrayData);
        } else {
            $builder->where('id', $data['reminder_id']);
            $builder->update('fees_reminder', $arrayData);
        }
    }
    public function getFeeReminderByDate($date = '', $branch_id = '')
    {
        $builder->select('fee_groups_details.*,fees_type.name');
        $builder->from('fee_groups_details');
        $builder->join('fees_type', 'fees_type.id = fee_groups_details.fee_type_id', 'inner');
        $builder->where('fee_groups_details.due_date', $date);
        $builder->where('fees_type.branch_id', $branch_id);
        $builder->order_by('fee_groups_details.id', 'asc');
        return $builder->get()->result_array();
    }
    public function getStudentsListReminder($groupID = '', $typeID = '')
    {
        $sessionID = get_type_name_by_id('global_settings', 1, 'session_id');
        $builder->select('a.id as allocation_id,CONCAT_WS(" ",s.first_name, s.last_name) as child_name,s.mobileno as child_mobileno,pr.name as guardian_name,pr.mobileno as guardian_mobileno');
        $builder->from('fee_allocation as a');
        $builder->join('student as s', 's.id = a.student_id', 'inner');
        $builder->join('parent as pr', 'pr.id = s.parent_id', 'left');
        $builder->where('a.group_id', $groupID);
        $builder->where('a.session_id', $sessionID);
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['payment'] = $this->getPaymentDetailsByTypeID($value['allocation_id'], $typeID);
        }
        return $result;
    }
    public function getPaymentDetailsByTypeID($allocationID, $typeID)
    {
        $builder->select('IFNULL(SUM(amount), 0) as total_paid, IFNULL(SUM(discount), 0) as total_discount');
        $builder->from('fee_payment_history');
        $builder->where('allocation_id', $allocationID);
        $builder->where('type_id', $typeID);
        return $builder->get()->row_array();
    }
    public function depositAmountVerify($amount = '')
    {
        if ($amount != "") {
            $typeID = $this->request->getPost('fees_type');
            if (empty($typeID)) {
                return true;
            }
            $feesType = explode("|", $typeID);
            $remainAmount = $this->getBalance($feesType[0], $feesType[1]);
            if ($remainAmount['balance'] < $amount) {
                $this->form_validation->set_message('deposit_verify', '{field} cannot be greater than the remaining.');
                return false;
            } else {
                return true;
            }
        }
        return true;
    }
    public function getBalance($allocationID, $typeID)
    {
        $groupsID = get_type_name_by_id('fee_allocation', $allocationID, 'group_id');
        $systemFeesType = get_type_name_by_id('fees_type', $typeID, 'system');
        if ($systemFeesType == 1) {
            $totalAmount = get_type_name_by_id('fee_allocation', $allocationID, 'prev_due');
        } else {
            $totalAmount = $db->table('fee_groups_details')->get('fee_groups_details')->row_array();
            $totalAmount = $totalAmount['amount'];
        }
        $builder->select('IFNULL(sum(p.amount), 0) as total_amount,IFNULL(sum(p.discount), 0) as total_discount,IFNULL(sum(p.fine), 0) as total_fine');
        $builder->from('fee_payment_history as p');
        $builder->where('p.allocation_id', $allocationID);
        $builder->where('p.type_id', $typeID);
        $paid = $builder->get()->row_array();
        $balance = $totalAmount - ($paid['total_amount'] + $paid['total_discount']);
        $total_fine = $paid['total_fine'];
        return array('balance' => $balance, 'fine' => $total_fine);
    }
    // voucher transaction save function
    public function saveTransaction($data = array(), $payment_historyID = '')
    {
        $branchID = $this->application_model->get_branch_id();
        $accountID = $data['account_id'];
        $date = $data['date'];
        $amount = $data['amount'];
        // get the current balance of the selected account
        $qbal = $this->app_lib->get_table('accounts', $accountID, true);
        $cbal = $qbal['balance'];
        $bal = $cbal + $amount;
        // query system voucher head / insert
        $arrayHead = array('name' => 'Student Fees Collection', 'type' => 'income', 'system' => 1, 'branch_id' => $branchID);
        $builder->where($arrayHead);
        $query = $builder->get('voucher_head');
        if ($query->num_rows() > 0) {
            $voucher_headID = $query->row()->id;
        } else {
            $builder->insert('voucher_head', $arrayHead);
            $voucher_headID = $builder->insert_id();
        }
        // query system transactions / insert
        $arrayTransactions = array('account_id' => $accountID, 'voucher_head_id' => $voucher_headID, 'type' => 'deposit', 'system' => 1, 'date' => date("Y-m-d", strtotime($date)), 'branch_id' => $branchID);
        $builder->where($arrayTransactions);
        $query = $builder->get('transactions');
        if ($query->num_rows() == 1) {
            $transactionsID = $query->row()->id;
            $builder->set('amount', 'amount+' . $amount, false);
            $builder->set('cr', 'cr+' . $amount, false);
            $builder->set('bal', $bal);
            $builder->where('id', $transactionsID);
            $builder->update('transactions');
        } else {
            $arrayTransactions['ref'] = '';
            $arrayTransactions['amount'] = $amount;
            $arrayTransactions['dr'] = 0;
            $arrayTransactions['cr'] = $amount;
            $arrayTransactions['bal'] = $bal;
            $arrayTransactions['pay_via'] = 5;
            $arrayTransactions['description'] = date("d-M-Y", strtotime($date)) . " Total Fees Collection";
            $builder->insert('transactions', $arrayTransactions);
            $transactionsID = $builder->insert_id();
        }
        $builder->where('id', $accountID);
        $this->db->table('accounts', array('balance' => $bal))->update();
        // insert transactions links details in DB
        $arrayLinkDetails = array('payment_id' => $payment_historyID, 'transactions_id' => $transactionsID);
        $builder->insert('transactions_links_details', $arrayLinkDetails);
    }
    public function carryForwardDue($data = array())
    {
        $type_name = "Previous Session Balance";
        $group_name = "Due Record";
        $branchID = $data['branch_id'];
        $sessionID = $data['session_id'];
        $fee_type_id = 0;
        $fee_group_id = 0;
        $arrayType = array('name' => $type_name, 'branch_id' => $branchID, 'system' => 1);
        $fee_type_exists = $this->checkExistsData('fees_type', $arrayType);
        if (!$fee_type_exists) {
            $arrayType['fee_code'] = 'previous-balance';
            $builder->insert('fees_type', $arrayType);
            $fee_type_id = $builder->insert_id();
        } else {
            $fee_type_id = $fee_type_exists->id;
        }
        $arrayGroup = array('name' => $group_name, 'branch_id' => $branchID, 'session_id' => $sessionID, 'system' => 1);
        $fee_group_exists = $this->checkExistsData('fee_groups', $arrayGroup);
        if (!$fee_group_exists) {
            $builder->insert('fee_groups', $arrayGroup);
            $fee_group_id = $builder->insert_id();
        } else {
            $fee_group_id = $fee_group_exists->id;
        }
        $arrayGroupsDetails = array('fee_groups_id' => $fee_group_id, 'fee_type_id' => $fee_type_id);
        $fee_group_details_exists = $this->checkExistsData('fee_groups_details', $arrayGroupsDetails);
        if (!$fee_group_details_exists) {
            $arrayGroupsDetails['amount'] = 0;
            $arrayGroupsDetails['due_date'] = $data['due_date'];
            $builder->insert('fee_groups_details', $arrayGroupsDetails);
        }
        $arrayAllocation = array('student_id' => $data['student_id'], 'group_id' => $fee_group_id, 'branch_id' => $branchID, 'session_id' => $sessionID);
        $fee_allocation_exists = $this->checkExistsData('fee_allocation', $arrayAllocation);
        if (!$fee_allocation_exists) {
            $arrayAllocation['prev_due'] = $data['prev_due'];
            $builder->insert('fee_allocation', $arrayAllocation);
        } else {
            $arrayAllocation['prev_due'] = $data['prev_due'];
            $builder->where('id', $fee_allocation_exists->id);
            $builder->update('fee_allocation', $arrayAllocation);
        }
    }
    function checkExistsData($table = '', $data = array())
    {
        $builder->where($data);
        $query = $builder->get($table);
        if ($query->num_rows() > 0) {
            return $query->row();
        } else {
            return false;
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class FeesModel extends MYModel
{
    protected $db;
    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
        $this->model('sms_model');
    }
    public function getPreviousSessionBalance($enrollID = '', $session_id = '', $with_fine = 0)
    {
        $total_balance = 0;
        $total_fine = 0;
        $variable = $db->table('fee_allocation')->get('fee_allocation')->getResult();
        foreach ($variable as $key => $allocation) {
            $groupsDetails = $db->table('fee_groups_details')->get('fee_groups_details')->getResult();
            foreach ($groupsDetails as $k => $type) {
                $fine = $this->feeFineCalculation($allocation->id, $type->fee_type_id);
                $b = $this->getBalance($allocation->id, $type->fee_type_id);
                $total_balance += $b['balance'];
                $total_fine += abs($fine - $b['fine']);
            }
        }
        if ($with_fine == 1) {
            return round($total_balance + $total_fine);
        } else {
            return $total_balance;
        }
    }
    public function feeFineCalculation($allocationID, $typeID)
    {
        $builder->select('fd.amount,fd.due_date,f.*');
        $builder->from('fee_allocation as a');
        $builder->join('fee_groups_details as fd', 'fd.fee_groups_id = a.group_id and fd.fee_type_id = ' . $db->escape($typeID), 'left');
        $builder->join('fee_fine as f', 'f.group_id = fd.fee_groups_id and f.type_id = fd.fee_type_id', 'inner');
        $builder->where('a.id', $allocationID);
        $this->db->table('f.session_id', get_session_id())->where();
        $getDB = $builder->get()->row_array();
        if (is_array($getDB) && count($getDB)) {
            $dueDate = $getDB['due_date'];
            if (strtotime($dueDate) < strtotime(date('Y-m-d'))) {
                $feeAmount = $getDB['amount'];
                $feeFrequency = $getDB['fee_frequency'];
                $fineValue = $getDB['fine_value'];
                if ($getDB['fine_type'] == 1) {
                    $fineAmount = $fineValue;
                } else {
                    $fineAmount = $feeAmount / 100 * $fineValue;
                }
                $now = time();
                // or your date as well
                $dueDate = strtotime($dueDate);
                $datediff = $now - $dueDate;
                $overDay = round($datediff / (60 * 60 * 24));
                if ($feeFrequency != 0) {
                    $fineAmount = $overDay / $feeFrequency * $fineAmount;
                }
                return $fineAmount;
            } else {
                return 0;
            }
        } else {
            return 0;
        }
    }
    public function getStudentAllocationList($classID = '', $sectionID = '', $groupID = '', $branchID = '')
    {
        $sql = "SELECT e.*, s.photo, CONCAT_WS(' ',s.first_name, s.last_name) as fullname, s.gender, s.register_no, s.parent_id, s.email, s.mobileno, IFNULL(fa.id, 0) as allocation_id FROM enroll as e INNER JOIN student as s ON e.student_id = s.id LEFT JOIN login_credential as l ON l.user_id = s.id AND l.role = '7' LEFT JOIN fee_allocation as fa ON fa.student_id = e.id AND fa.group_id = " . $db->escape($groupID) . " AND fa.session_id= " . $db->escape(get_session_id()) . " WHERE e.class_id = " . $db->escape($classID) . " AND e.branch_id = " . $db->escape($branchID) . " AND e.session_id = " . $db->escape(get_session_id());
        if ($sectionID != 'all') {
            $sql .= " AND e.section_id =" . $db->escape($sectionID);
        }
        $sql .= " ORDER BY s.id ASC";
        return $db->query($sql)->result_array();
    }
    public function getInvoiceStatus($enrollID = '')
    {
        $status = "";
        $sql = "SELECT SUM(`fee_groups_details`.`amount` + `fee_allocation`.`prev_due`) as `total`, min(`fee_allocation`.`id`) as `inv_no` FROM `fee_allocation` LEFT JOIN `fee_groups_details` ON `fee_groups_details`.`fee_groups_id` = `fee_allocation`.`group_id` LEFT JOIN `fees_type` ON `fees_type`.`id` = `fee_groups_details`.`fee_type_id` WHERE `fee_allocation`.`student_id` = " . $db->escape($enrollID) . " AND `fee_allocation`.`session_id` = " . $db->escape(get_session_id());
        $balance = $db->query($sql)->row_array();
        $invNo = str_pad($balance['inv_no'], 4, '0', STR_PAD_LEFT);
        $sql = "SELECT IFNULL(SUM(`fee_payment_history`.`amount`), 0) as `amount`, IFNULL(SUM(`fee_payment_history`.`discount`), 0) as `discount`, IFNULL(SUM(`fee_payment_history`.`fine`), 0) as `fine` FROM `fee_payment_history` LEFT JOIN `fee_allocation` ON `fee_payment_history`.`allocation_id` = `fee_allocation`.`id` WHERE `fee_allocation`.`student_id` = " . $db->escape($enrollID) . " AND `fee_allocation`.`session_id` = " . $db->escape(get_session_id());
        $paid = $db->query($sql)->row_array();
        if ($paid['amount'] == 0) {
            $status = 'unpaid';
        } elseif ($balance['total'] == $paid['amount'] + $paid['discount']) {
            $status = 'total';
        } elseif ($paid['amount'] > 1) {
            $status = 'partly';
        }
        return array('status' => $status, 'invoice_no' => $invNo);
    }
    public function getInvoiceDetails($enrollID = '')
    {
        $sql = "SELECT `fee_allocation`.`group_id`,`fee_allocation`.`prev_due`,`fee_allocation`.`id` as `allocation_id`, `fees_type`.`name`, `fees_type`.`system`, `fee_groups_details`.`amount`, `fee_groups_details`.`due_date`, `fee_groups_details`.`fee_type_id` FROM `fee_allocation` LEFT JOIN\r\n        `fee_groups_details` ON `fee_groups_details`.`fee_groups_id` = `fee_allocation`.`group_id` LEFT JOIN `fees_type` ON `fees_type`.`id` = `fee_groups_details`.`fee_type_id` WHERE\r\n        `fee_allocation`.`student_id` = " . $db->escape($enrollID) . " AND `fee_allocation`.`session_id` = " . $db->escape(get_session_id()) . " ORDER BY `fee_allocation`.`group_id` ASC, `fees_type`.`id` ASC";
        $student = array();
        $r = $db->query($sql)->result_array();
        foreach ($r as $key => $value) {
            if ($value['system'] == 1) {
                $value['amount'] = $value['prev_due'];
            }
            $student[] = $value;
        }
        return $student;
    }
    public function getInvoiceBasic($enrollID = '')
    {
        $sessionID = get_session_id();
        $builder->select('s.id,s.register_no,e.branch_id,e.id as enroll_id,s.first_name,s.last_name,s.email as student_email,s.current_address as student_address,c.name as class_name,b.school_name,b.email as school_email,b.mobileno as school_mobileno,b.address as school_address,p.father_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 's.id = e.student_id', 'inner');
        $builder->join('class as c', 'c.id = e.class_id', 'left');
        $builder->join('section as se', 'se.id = e.section_id', 'left');
        $builder->join('parent as p', 'p.id = s.parent_id', 'left');
        $builder->join('branch as b', 'b.id = e.branch_id', 'left');
        $builder->where('e.id', $enrollID);
        $builder->where('e.session_id', $sessionID);
        return $builder->get()->row_array();
    }
    public function getStudentFeeDeposit($allocationID, $typeID)
    {
        $sqlDeposit = "SELECT IFNULL(SUM(`amount`), '0.00') as `total_amount`, IFNULL(SUM(`discount`), '0.00') as `total_discount`, IFNULL(SUM(`fine`), '0.00') as `total_fine` FROM `fee_payment_history` WHERE `allocation_id` = " . $db->escape($allocationID) . " AND `type_id` = " . $db->escape($typeID);
        return $db->query($sqlDeposit)->row_array();
    }
    public function getPaymentHistory($allocationID, $groupID)
    {
        $builder->select('h.*,t.name,t.fee_code,pt.name as payvia');
        $builder->from('fee_payment_history as h');
        $builder->join('fees_type as t', 't.id = h.type_id', 'left');
        $builder->join('payment_types as pt', 'pt.id = h.pay_via', 'left');
        $builder->where('h.allocation_id', $allocationID);
        $builder->order_by('h.id', 'asc');
        return $builder->get()->result_array();
    }
    public function typeSave($data = array())
    {
        $arrayData = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['type_name'], 'fee_code' => strtolower(str_replace(' ', '-', $data['type_name'])), 'description' => $data['description']);
        if (!isset($data['type_id'])) {
            $builder->insert('fees_type', $arrayData);
        } else {
            $builder->where('id', $data['type_id']);
            $builder->update('fees_type', $arrayData);
        }
    }
    // add partly of the fee
    public function add_fees($data = array(), $id = '')
    {
        $total_due = get_type_name_by_id('fee_invoice', $id, 'total_due');
        $payment_amount = $data['amount'];
        if ($payment_amount <= $total_due && $payment_amount > 0) {
            $arrayHistory = array('fee_invoice_id' => $id, 'collect_by' => get_user_stamp(), 'remarks' => $data['remarks'], 'method' => $data['method'], 'amount' => $payment_amount, 'date' => date("Y-m-d"), 'session_id' => get_session_id());
            $builder->insert('payment_history', $arrayHistory);
            if ($total_due <= $payment_amount) {
                $builder->where('id', $id);
                $this->db->table('fee_invoice', array('status' => 2))->update();
            } else {
                $builder->where('id', $id);
                $this->db->table('fee_invoice', array('status' => 1))->update();
            }
            $builder->where('id', $id);
            $builder->set('total_paid', 'total_paid + ' . $payment_amount, false);
            $builder->set('total_due', 'total_due - ' . $payment_amount, false);
            $builder->update('fee_invoice');
            // send payment confirmation sms
            $arrayHistory['student_id'] = $data['student_id'];
            $arrayHistory['timestamp'] = date("Y-m-d");
            $this->sms_model->send_sms($arrayHistory, 2);
            return true;
        } else {
            return false;
        }
    }
    public function getInvoiceList($class_id = '', $section_id = '', $branch_id = '')
    {
        $builder->select('e.id as enroll_id,e.student_id,e.roll,e.id as enroll_id,s.first_name,s.last_name,s.register_no,s.mobileno,c.name as class_name,se.name as section_name');
        $builder->from('fee_allocation as fa');
        $builder->join('enroll as e', 'e.id = fa.student_id and e.session_id = fa.session_id', 'inner');
        $builder->join('student as s', 's.id = e.student_id', 'left');
        $builder->join('class as c', 'c.id = e.class_id', 'left');
        $builder->join('section as se', 'se.id = e.section_id', 'left');
        $builder->where('fa.branch_id', $branch_id);
        $this->db->table('fa.session_id', get_session_id())->where();
        $builder->where('e.class_id', $class_id);
        if ($section_id != 'all') {
            $builder->where('e.section_id', $section_id);
        }
        $builder->group_by('fa.student_id');
        $builder->order_by('e.id', 'asc');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['feegroup'] = $this->getfeeGroup($value['enroll_id']);
        }
        return $result;
    }
    public function getDueInvoiceList($class_id = '', $section_id = '', $feegroup_id = '', $fee_feetype_id = '')
    {
        $sql = "SELECT IFNULL(SUM(h.amount), '0') as `total_amount`, IFNULL(SUM(h.discount), '0') as `total_discount`, gd.amount as `full_amount`, fa.prev_due as `prev_due`, gd.`due_date`, e.student_id, e.id as enroll_id,e.roll, s.first_name, s.last_name, s.register_no, s.mobileno, c.name as `class_name`, se.name as `section_name` FROM fee_allocation as fa LEFT JOIN fee_payment_history as h ON h.allocation_id = fa.id and h.type_id = " . $db->escape($fee_feetype_id) . " INNER JOIN fee_groups_details as gd ON gd.fee_groups_id = fa.group_id and gd.fee_type_id = " . $db->escape($fee_feetype_id) . " INNER JOIN\r\n        enroll as e ON e.id = fa.student_id LEFT JOIN student as s ON s.id = e.student_id LEFT JOIN class as c ON c.id = e.class_id LEFT JOIN section as se ON se.id = e.section_id WHERE\r\n        fa.group_id = " . $db->escape($feegroup_id) . " AND fa.session_id = " . $db->escape(get_session_id()) . " AND e.class_id = " . $db->escape($class_id);
        if ($section_id != 'all') {
            $sql .= " AND e.section_id = " . $db->escape($section_id);
        }
        $sql .= " GROUP BY  fa.student_id ORDER BY e.id ASC";
        $result = $db->query($sql)->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['feegroup'] = $this->getfeeGroup($value['enroll_id']);
        }
        return $result;
    }
    public function getDueReport($class_id = '', $section_id = '')
    {
        $builder->select('fa.id as allocation_id,sum(gd.amount + fa.prev_due) as total_fees,e.id as enroll_id,e.roll,s.first_name,s.last_name,s.register_no,s.mobileno,c.name as class_name,se.name as section_name');
        $builder->from('fee_allocation as fa');
        $builder->join('fee_groups_details as gd', 'gd.fee_groups_id = fa.group_id', 'left');
        $builder->join('enroll as e', 'e.id = fa.student_id and e.session_id = ' . $db->escape(get_session_id()), 'inner');
        $builder->join('student as s', 's.id = e.student_id', 'left');
        $builder->join('class as c', 'c.id = e.class_id', 'left');
        $builder->join('section as se', 'se.id = e.section_id', 'left');
        $this->db->table('fa.session_id', get_session_id())->where();
        $builder->where('e.class_id', $class_id);
        if (!empty($section_id)) {
            $builder->where('e.section_id', $section_id);
        }
        $builder->group_by('fa.student_id');
        $builder->order_by('e.roll', 'asc');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['payment'] = $this->getPaymentDetails($value['enroll_id']);
        }
        return $result;
    }
    public function getPaymentDetails($student_id = '')
    {
        $builder->select('IFNULL(SUM(amount), 0) as total_paid, IFNULL(SUM(discount), 0) as total_discount, IFNULL(SUM(fine), 0) as total_fine');
        $builder->from('fee_allocation');
        $builder->join('fee_payment_history', 'fee_payment_history.allocation_id = fee_allocation.id', 'left');
        $builder->where('fee_allocation.student_id', $student_id);
        return $builder->get()->row_array();
    }
    public function getStuPaymentHistory($classID = '', $SectionID = '', $paymentVia = '', $start = '', $end = '', $branchID = '', $onlyFine = false)
    {
        $builder->select('h.*,ft.name as type_name,e.student_id,e.roll,s.first_name,s.last_name,s.register_no,s.mobileno,c.name as class_name,se.name as section_name,pt.name as pay_via');
        $builder->from('fee_payment_history as h');
        $builder->join('fee_allocation as fa', 'fa.id = h.allocation_id', 'inner');
        $builder->join('fees_type as ft', 'ft.id = h.type_id', 'left');
        $builder->join('enroll as e', 'e.id = fa.student_id', 'inner');
        $builder->join('student as s', 's.id = e.student_id', 'inner');
        $builder->join('class as c', 'c.id = e.class_id', 'left');
        $builder->join('section as se', 'se.id = e.section_id', 'left');
        $builder->join('payment_types as pt', 'pt.id = h.pay_via', 'left');
        $this->db->table('fa.session_id', get_session_id())->where();
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->where('h.date  >=', $start);
        $builder->where('h.date <=', $end);
        $builder->where('e.branch_id', $branchID);
        if ($onlyFine == true) {
            $builder->where('h.fine !=', 0);
        }
        if (!empty($classID)) {
            $builder->where('e.class_id', $classID);
        }
        if (!empty($SectionID)) {
            $builder->where('e.section_id', $SectionID);
        }
        if ($paymentVia != 'all') {
            if ($paymentVia == 'online') {
                $builder->where('h.collect_by', 'online');
            } else {
                $builder->where('h.collect_by !=', 'online');
            }
        }
        $builder->order_by('h.id', 'asc');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function getStuPaymentReport($classID = '', $sectionID = '', $enrollID = '', $typeID = '', $start = '', $end = '', $branchID = '')
    {
        $builder->select('h.*,gd.due_date,ft.name as type_name,e.student_id,e.roll,s.first_name,s.last_name,s.register_no,pt.name as pay_via');
        $builder->from('fee_payment_history as h');
        $builder->join('fee_allocation as fa', 'fa.id = h.allocation_id', 'inner');
        $builder->join('fees_type as ft', 'ft.id = h.type_id', 'left');
        $builder->join('fee_groups_details as gd', 'gd.fee_groups_id = fa.group_id and gd.fee_type_id = h.type_id', 'left');
        $builder->join('enroll as e', 'e.id = fa.student_id and e.session_id =  ' . $db->escape(get_session_id()), 'inner');
        $builder->join('student as s', 's.id = e.student_id', 'inner');
        $builder->join('payment_types as pt', 'pt.id = h.pay_via', 'left');
        $this->db->table('fa.session_id', get_session_id())->where();
        $builder->where('h.date >=', $start);
        $builder->where('h.date <=', $end);
        $builder->where('e.branch_id', $branchID);
        $builder->where('e.class_id', $classID);
        if (!empty($typeID)) {
            $typeID = explode("|", $typeID);
            $builder->where('h.type_id', $typeID[1]);
        }
        if (!empty($enrollID)) {
            $builder->where('e.id', $enrollID);
        }
        $builder->where('e.section_id', $sectionID);
        $builder->order_by('h.id', 'asc');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function getfeeGroup($studentID = '')
    {
        $builder->select('g.name');
        $builder->from('fee_allocation as fa');
        $builder->join('fee_groups as g', 'g.id = fa.group_id', 'inner');
        $builder->where('fa.student_id', $studentID);
        $this->db->table('fa.session_id', get_session_id())->where();
        return $builder->get()->result_array();
    }
    public function reminderSave($data = array())
    {
        $arrayData = array('frequency' => $data['frequency'], 'days' => $data['days'], 'student' => isset($data['chk_student']) ? 1 : 0, 'guardian' => isset($data['chk_guardian']) ? 1 : 0, 'message' => $data['message'], 'dlt_template_id' => $data['dlt_template_id'], 'branch_id' => $data['branch_id']);
        if (!isset($data['reminder_id'])) {
            $builder->insert('fees_reminder', $arrayData);
        } else {
            $builder->where('id', $data['reminder_id']);
            $builder->update('fees_reminder', $arrayData);
        }
    }
    public function getFeeReminderByDate($date = '', $branch_id = '')
    {
        $builder->select('fee_groups_details.*,fees_type.name');
        $builder->from('fee_groups_details');
        $builder->join('fees_type', 'fees_type.id = fee_groups_details.fee_type_id', 'inner');
        $builder->where('fee_groups_details.due_date', $date);
        $builder->where('fees_type.branch_id', $branch_id);
        $builder->order_by('fee_groups_details.id', 'asc');
        return $builder->get()->result_array();
    }
    public function getStudentsListReminder($groupID = '', $typeID = '')
    {
        $sessionID = get_type_name_by_id('global_settings', 1, 'session_id');
        $builder->select('a.id as allocation_id,CONCAT_WS(" ",s.first_name, s.last_name) as child_name,s.mobileno as child_mobileno,pr.name as guardian_name,pr.mobileno as guardian_mobileno');
        $builder->from('fee_allocation as a');
        $builder->join('student as s', 's.id = a.student_id', 'inner');
        $builder->join('parent as pr', 'pr.id = s.parent_id', 'left');
        $builder->where('a.group_id', $groupID);
        $builder->where('a.session_id', $sessionID);
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['payment'] = $this->getPaymentDetailsByTypeID($value['allocation_id'], $typeID);
        }
        return $result;
    }
    public function getPaymentDetailsByTypeID($allocationID, $typeID)
    {
        $builder->select('IFNULL(SUM(amount), 0) as total_paid, IFNULL(SUM(discount), 0) as total_discount');
        $builder->from('fee_payment_history');
        $builder->where('allocation_id', $allocationID);
        $builder->where('type_id', $typeID);
        return $builder->get()->row_array();
    }
    public function depositAmountVerify($amount = '')
    {
        if ($amount != "") {
            $typeID = $this->request->getPost('fees_type');
            if (empty($typeID)) {
                return true;
            }
            $feesType = explode("|", $typeID);
            $remainAmount = $this->getBalance($feesType[0], $feesType[1]);
            if ($remainAmount['balance'] < $amount) {
                $this->form_validation->set_message('deposit_verify', '{field} cannot be greater than the remaining.');
                return false;
            } else {
                return true;
            }
        }
        return true;
    }
    public function getBalance($allocationID, $typeID)
    {
        $groupsID = get_type_name_by_id('fee_allocation', $allocationID, 'group_id');
        $systemFeesType = get_type_name_by_id('fees_type', $typeID, 'system');
        if ($systemFeesType == 1) {
            $totalAmount = get_type_name_by_id('fee_allocation', $allocationID, 'prev_due');
        } else {
            $totalAmount = $db->table('fee_groups_details')->get('fee_groups_details')->row_array();
            $totalAmount = $totalAmount['amount'];
        }
        $builder->select('IFNULL(sum(p.amount), 0) as total_amount,IFNULL(sum(p.discount), 0) as total_discount,IFNULL(sum(p.fine), 0) as total_fine');
        $builder->from('fee_payment_history as p');
        $builder->where('p.allocation_id', $allocationID);
        $builder->where('p.type_id', $typeID);
        $paid = $builder->get()->row_array();
        $balance = $totalAmount - ($paid['total_amount'] + $paid['total_discount']);
        $total_fine = $paid['total_fine'];
        return array('balance' => $balance, 'fine' => $total_fine);
    }
    // voucher transaction save function
    public function saveTransaction($data = array(), $payment_historyID = '')
    {
        $branchID = $this->applicationModel->get_branch_id();
        $accountID = $data['account_id'];
        $date = $data['date'];
        $amount = $data['amount'];
        // get the current balance of the selected account
        $qbal = $this->app_lib->get_table('accounts', $accountID, true);
        $cbal = $qbal['balance'];
        $bal = $cbal + $amount;
        // query system voucher head / insert
        $arrayHead = array('name' => 'Student Fees Collection', 'type' => 'income', 'system' => 1, 'branch_id' => $branchID);
        $builder->where($arrayHead);
        $query = $builder->get('voucher_head');
        if ($query->num_rows() > 0) {
            $voucher_headID = $query->row()->id;
        } else {
            $builder->insert('voucher_head', $arrayHead);
            $voucher_headID = $builder->insert_id();
        }
        // query system transactions / insert
        $arrayTransactions = array('account_id' => $accountID, 'voucher_head_id' => $voucher_headID, 'type' => 'deposit', 'system' => 1, 'date' => date("Y-m-d", strtotime($date)), 'branch_id' => $branchID);
        $builder->where($arrayTransactions);
        $query = $builder->get('transactions');
        if ($query->num_rows() == 1) {
            $transactionsID = $query->row()->id;
            $builder->set('amount', 'amount+' . $amount, false);
            $builder->set('cr', 'cr+' . $amount, false);
            $builder->set('bal', $bal);
            $builder->where('id', $transactionsID);
            $builder->update('transactions');
        } else {
            $arrayTransactions['ref'] = '';
            $arrayTransactions['amount'] = $amount;
            $arrayTransactions['dr'] = 0;
            $arrayTransactions['cr'] = $amount;
            $arrayTransactions['bal'] = $bal;
            $arrayTransactions['pay_via'] = 5;
            $arrayTransactions['description'] = date("d-M-Y", strtotime($date)) . " Total Fees Collection";
            $builder->insert('transactions', $arrayTransactions);
            $transactionsID = $builder->insert_id();
        }
        $builder->where('id', $accountID);
        $this->db->table('accounts', array('balance' => $bal))->update();
        // insert transactions links details in DB
        $arrayLinkDetails = array('payment_id' => $payment_historyID, 'transactions_id' => $transactionsID);
        $builder->insert('transactions_links_details', $arrayLinkDetails);
    }
    public function carryForwardDue($data = array())
    {
        $type_name = "Previous Session Balance";
        $group_name = "Due Record";
        $branchID = $data['branch_id'];
        $sessionID = $data['session_id'];
        $fee_type_id = 0;
        $fee_group_id = 0;
        $arrayType = array('name' => $type_name, 'branch_id' => $branchID, 'system' => 1);
        $fee_type_exists = $this->checkExistsData('fees_type', $arrayType);
        if (!$fee_type_exists) {
            $arrayType['fee_code'] = 'previous-balance';
            $builder->insert('fees_type', $arrayType);
            $fee_type_id = $builder->insert_id();
        } else {
            $fee_type_id = $fee_type_exists->id;
        }
        $arrayGroup = array('name' => $group_name, 'branch_id' => $branchID, 'session_id' => $sessionID, 'system' => 1);
        $fee_group_exists = $this->checkExistsData('fee_groups', $arrayGroup);
        if (!$fee_group_exists) {
            $builder->insert('fee_groups', $arrayGroup);
            $fee_group_id = $builder->insert_id();
        } else {
            $fee_group_id = $fee_group_exists->id;
        }
        $arrayGroupsDetails = array('fee_groups_id' => $fee_group_id, 'fee_type_id' => $fee_type_id);
        $fee_group_details_exists = $this->checkExistsData('fee_groups_details', $arrayGroupsDetails);
        if (!$fee_group_details_exists) {
            $arrayGroupsDetails['amount'] = 0;
            $arrayGroupsDetails['due_date'] = $data['due_date'];
            $builder->insert('fee_groups_details', $arrayGroupsDetails);
        }
        $arrayAllocation = array('student_id' => $data['student_id'], 'group_id' => $fee_group_id, 'branch_id' => $branchID, 'session_id' => $sessionID);
        $fee_allocation_exists = $this->checkExistsData('fee_allocation', $arrayAllocation);
        if (!$fee_allocation_exists) {
            $arrayAllocation['prev_due'] = $data['prev_due'];
            $builder->insert('fee_allocation', $arrayAllocation);
        } else {
            $arrayAllocation['prev_due'] = $data['prev_due'];
            $builder->where('id', $fee_allocation_exists->id);
            $builder->update('fee_allocation', $arrayAllocation);
        }
    }
    function checkExistsData($table = '', $data = array())
    {
        $builder->where($data);
        $query = $builder->get($table);
        if ($query->num_rows() > 0) {
            return $query->row();
        } else {
            return false;
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/HomeworkModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class HomeworkModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    public function getList($classID, $sectionID, $subjectID, $branchID)
    {
        $builder->select('homework.*,subject.name as subject_name,class.name as class_name,section.name as section_name,staff.name as creator_name');
        $builder->from('homework');
        $builder->join('subject', 'subject.id = homework.subject_id', 'left');
        $builder->join('class', 'class.id = homework.class_id', 'left');
        $builder->join('section', 'section.id = homework.section_id', 'left');
        $builder->join('staff', 'staff.id = homework.created_by', 'left');
        $builder->where('homework.class_id', $classID);
        $builder->where('homework.section_id', $sectionID);
        $builder->where('homework.subject_id', $subjectID);
        $builder->where('homework.branch_id', $branchID);
        $this->db->table('homework.session_id', get_session_id())->where();
        $builder->order_by('homework.id', 'desc');
        return $builder->get()->result_array();
    }
    public function evaluationCounter($classID, $sectionID, $homeworkID)
    {
        $countStu = $db->table('enroll')->get('enroll')->num_rows();
        $countEva = $db->table('homework_evaluation')->get('homework_evaluation')->num_rows();
        $incomplete = $countStu - $countEva;
        return array('total' => $countStu, 'complete' => $countEva, 'incomplete' => $incomplete);
    }
    public function getEvaluate($homeworkID)
    {
        $builder->select('homework.*,CONCAT_WS(" ",s.first_name, s.last_name) as fullname,s.register_no,e.student_id, e.roll,subject.name as subject_name,class.name as class_name,section.name as section_name,he.id as ev_id,he.status as ev_status,he.remark as ev_remarks,he.rank,hs.message,hs.enc_name');
        $builder->from('homework');
        $builder->join('enroll as e', 'e.class_id=homework.class_id and e.section_id = homework.section_id and e.session_id = homework.session_id', 'inner');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('homework_evaluation as he', 'he.homework_id = homework.id and he.student_id = e.student_id', 'left');
        $builder->join('homework_submit as hs', 'hs.homework_id = homework.id and hs.student_id = e.student_id', 'left');
        $builder->join('subject', 'subject.id = homework.subject_id', 'left');
        $builder->join('class', 'class.id = homework.class_id', 'left');
        $builder->join('section', 'section.id = homework.section_id', 'left');
        $builder->where('homework.id', $homeworkID);
        if (!is_superadmin_loggedin()) {
            $this->db->table('homework.branch_id', get_loggedin_branch_id())->where();
        }
        $this->db->table('homework.session_id', get_session_id())->where();
        $builder->order_by('homework.id', 'desc');
        return $builder->get()->result_array();
    }
    // save student homework in DB
    public function save($data)
    {
        $status = isset($data['published_later']) ? TRUE : FALSE;
        $sms_notification = isset($data['notification_sms']) ? TRUE : FALSE;
        $arrayHomework = array('branch_id' => $this->application_model->get_branch_id(), 'class_id' => $data['class_id'], 'section_id' => $data['section_id'], 'session_id' => get_session_id(), 'subject_id' => $data['subject_id'], 'date_of_homework' => date("Y-m-d", strtotime($data['date_of_homework'])), 'date_of_submission' => date("Y-m-d", strtotime($data['date_of_submission'])), 'description' => $data['homework'], 'created_by' => get_loggedin_user_id(), 'create_date' => date("Y-m-d"), 'status' => $status, 'sms_notification' => $sms_notification);
        if ($status == TRUE) {
            $arrayHomework['schedule_date'] = date("Y-m-d", strtotime($data['schedule_date']));
        } else {
            $arrayHomework['schedule_date'] = null;
        }
        if (isset($data['homework_id'])) {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['homework_id']);
            $builder->update('homework', $arrayHomework);
            $insert_id = $data['homework_id'];
        } else {
            $builder->insert('homework', $arrayHomework);
            $insert_id = $builder->insert_id();
        }
        if (isset($_FILES["attachment_file"]) && !empty($_FILES['attachment_file']['name'])) {
            $uploaddir = './uploads/attachments/homework/';
            if (!is_dir($uploaddir) && !mkdir($uploaddir)) {
                die("Error creating folder {$uploaddir}");
            }
            $fileInfo = pathinfo($_FILES["attachment_file"]["name"]);
            $document = basename($_FILES['attachment_file']['name']);
            $file_name = $insert_id . '.' . $fileInfo['extension'];
            move_uploaded_file($_FILES["attachment_file"]["tmp_name"], $uploaddir . $file_name);
        } else if (isset($data['old_document'])) {
            $document = $data['old_document'];
        } else {
            $document = "";
        }
        $builder->where('id', $insert_id);
        $this->db->table('homework', array('document' => $document))->update();
        //send homework sms notification
        if (isset($data['notification_sms'])) {
            $stuList = $this->application_model->getStudentListByClassSection($arrayHomework['class_id'], $arrayHomework['section_id'], $arrayHomework['branch_id']);
            foreach ($stuList as $row) {
                $row['date_of_homework'] = $arrayHomework['date_of_homework'];
                $row['date_of_submission'] = $arrayHomework['date_of_submission'];
                $row['subject_id'] = $arrayHomework['subject_id'];
                $this->sms_model->sendHomework($row);
            }
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class HomeworkModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    public function getList($classID, $sectionID, $subjectID, $branchID)
    {
        $builder->select('homework.*,subject.name as subject_name,class.name as class_name,section.name as section_name,staff.name as creator_name');
        $builder->from('homework');
        $builder->join('subject', 'subject.id = homework.subject_id', 'left');
        $builder->join('class', 'class.id = homework.class_id', 'left');
        $builder->join('section', 'section.id = homework.section_id', 'left');
        $builder->join('staff', 'staff.id = homework.created_by', 'left');
        $builder->where('homework.class_id', $classID);
        $builder->where('homework.section_id', $sectionID);
        $builder->where('homework.subject_id', $subjectID);
        $builder->where('homework.branch_id', $branchID);
        $this->db->table('homework.session_id', get_session_id())->where();
        $builder->order_by('homework.id', 'desc');
        return $builder->get()->result_array();
    }
    public function evaluationCounter($classID, $sectionID, $homeworkID)
    {
        $countStu = $db->table('enroll')->get('enroll')->num_rows();
        $countEva = $db->table('homework_evaluation')->get('homework_evaluation')->num_rows();
        $incomplete = $countStu - $countEva;
        return array('total' => $countStu, 'complete' => $countEva, 'incomplete' => $incomplete);
    }
    public function getEvaluate($homeworkID)
    {
        $builder->select('homework.*,CONCAT_WS(" ",s.first_name, s.last_name) as fullname,s.register_no,e.student_id, e.roll,subject.name as subject_name,class.name as class_name,section.name as section_name,he.id as ev_id,he.status as ev_status,he.remark as ev_remarks,he.rank,hs.message,hs.enc_name');
        $builder->from('homework');
        $builder->join('enroll as e', 'e.class_id=homework.class_id and e.section_id = homework.section_id and e.session_id = homework.session_id', 'inner');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('homework_evaluation as he', 'he.homework_id = homework.id and he.student_id = e.student_id', 'left');
        $builder->join('homework_submit as hs', 'hs.homework_id = homework.id and hs.student_id = e.student_id', 'left');
        $builder->join('subject', 'subject.id = homework.subject_id', 'left');
        $builder->join('class', 'class.id = homework.class_id', 'left');
        $builder->join('section', 'section.id = homework.section_id', 'left');
        $builder->where('homework.id', $homeworkID);
        if (!is_superadmin_loggedin()) {
            $this->db->table('homework.branch_id', get_loggedin_branch_id())->where();
        }
        $this->db->table('homework.session_id', get_session_id())->where();
        $builder->order_by('homework.id', 'desc');
        return $builder->get()->result_array();
    }
    // save student homework in DB
    public function save($data)
    {
        $status = isset($data['published_later']) ? TRUE : FALSE;
        $sms_notification = isset($data['notification_sms']) ? TRUE : FALSE;
        $arrayHomework = array('branch_id' => $this->applicationModel->get_branch_id(), 'class_id' => $data['class_id'], 'section_id' => $data['section_id'], 'session_id' => get_session_id(), 'subject_id' => $data['subject_id'], 'date_of_homework' => date("Y-m-d", strtotime($data['date_of_homework'])), 'date_of_submission' => date("Y-m-d", strtotime($data['date_of_submission'])), 'description' => $data['homework'], 'created_by' => get_loggedin_user_id(), 'create_date' => date("Y-m-d"), 'status' => $status, 'sms_notification' => $sms_notification);
        if ($status == TRUE) {
            $arrayHomework['schedule_date'] = date("Y-m-d", strtotime($data['schedule_date']));
        } else {
            $arrayHomework['schedule_date'] = null;
        }
        if (isset($data['homework_id'])) {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['homework_id']);
            $builder->update('homework', $arrayHomework);
            $insert_id = $data['homework_id'];
        } else {
            $builder->insert('homework', $arrayHomework);
            $insert_id = $builder->insert_id();
        }
        if (isset($_FILES["attachment_file"]) && !empty($_FILES['attachment_file']['name'])) {
            $uploaddir = './uploads/attachments/homework/';
            if (!is_dir($uploaddir) && !mkdir($uploaddir)) {
                die("Error creating folder {$uploaddir}");
            }
            $fileInfo = pathinfo($_FILES["attachment_file"]["name"]);
            $document = basename($_FILES['attachment_file']['name']);
            $file_name = $insert_id . '.' . $fileInfo['extension'];
            move_uploaded_file($_FILES["attachment_file"]["tmp_name"], $uploaddir . $file_name);
        } else if (isset($data['old_document'])) {
            $document = $data['old_document'];
        } else {
            $document = "";
        }
        $builder->where('id', $insert_id);
        $this->db->table('homework', array('document' => $document))->update();
        //send homework sms notification
        if (isset($data['notification_sms'])) {
            $stuList = $this->applicationModel->getStudentListByClassSection($arrayHomework['class_id'], $arrayHomework['section_id'], $arrayHomework['branch_id']);
            foreach ($stuList as $row) {
                $row['date_of_homework'] = $arrayHomework['date_of_homework'];
                $row['date_of_submission'] = $arrayHomework['date_of_submission'];
                $row['subject_id'] = $arrayHomework['subject_id'];
                $this->sms_model->sendHomework($row);
            }
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/FrontendModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class FrontendModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getBranchID()
    {
        if (is_superadmin_loggedin()) {
            $branchID = $this->request->getGet('branch_id', true);
            return empty($branchID) ? "" : urlencode($branchID);
        } else {
            return get_loggedin_branch_id();
        }
    }
    public function save_slider($data)
    {
        $elements_data = array('position' => $data['position'], 'button_text1' => $data['button_text_1'], 'button_url1' => $data['button_url_1'], 'button_text2' => $data['button_text_2'], 'button_url2' => $data['button_url_2'], 'image' => $this->upload_image());
        $slider_data = array('branch_id' => $this->application_model->get_branch_id(), 'title' => $data['title'], 'description' => $data['description'], 'item_type' => 'slider', 'elements' => json_encode($elements_data));
        if (isset($data['slider_id']) && !empty($data['slider_id'])) {
            $builder->where('id', $data['slider_id']);
            $builder->update('front_cms_home', $slider_data);
        } else {
            $builder->insert('front_cms_home', $slider_data);
        }
    }
    public function save_menus($data)
    {
        $title = $data['title'];
        $slug = strtolower(str_replace(' ', '-', $title));
        $publish = isset($data['publish']) ? 1 : 0;
        $new_tab = isset($data['new_tab']) ? 1 : 0;
        $external_url = isset($data['external_url']) ? 1 : 0;
        $external_link = isset($data['external_link']) ? $data['external_link'] : '';
        $parent_id = isset($data['parent_id']) ? $data['parent_id'] : 0;
        $menu_data = array('title' => $title, 'alias' => $slug, 'ordering' => $data['position'], 'open_new_tab' => $new_tab, 'ext_url' => $external_url, 'ext_url_address' => $external_link, 'parent_id' => $parent_id, 'publish' => $publish, 'branch_id' => $this->application_model->get_branch_id(), 'system' => 0);
        if (isset($data['menu_id']) && !empty($data['menu_id'])) {
            $isSystem = $builder->getWhere('front_cms_menu', array('id' => $data['menu_id']))->row()->system;
            if ($isSystem == 1) {
                $branch_id = $this->application_model->get_branch_id();
                $query = $builder->select('id')->from("front_cms_menu_visible")->where(array('menu_id' => $data['menu_id'], 'branch_id' => $branch_id))->get();
                $arraySysMenu = array('name' => $title, 'invisible' => isset($data['publish']) ? 0 : 1, 'menu_id' => $data['menu_id'], 'ordering' => $data['position'], 'parent_id' => $data['parent_id'], 'branch_id' => $branch_id);
                if ($query->num_rows() == 0) {
                    $builder->insert('front_cms_menu_visible', $arraySysMenu);
                } else {
                    $this->db->table('id', $query->row()->id)->where();
                    $builder->update('front_cms_menu_visible', $arraySysMenu);
                }
            } else {
                $builder->where('id', $data['menu_id']);
                $builder->update('front_cms_menu', $menu_data);
            }
        } else {
            $builder->insert('front_cms_menu', $menu_data);
        }
    }
    public function save_features($data)
    {
        $elements_data = array('button_text' => $data['button_text'], 'button_url' => $data['button_url'], 'icon' => $data['icon']);
        $slider_data = array('branch_id' => $this->application_model->get_branch_id(), 'title' => $data['title'], 'item_type' => 'features', 'description' => $data['description'], 'elements' => json_encode($elements_data));
        if (isset($data['features_id']) && !empty($data['features_id'])) {
            $builder->where('id', $data['features_id']);
            $builder->update('front_cms_home', $slider_data);
        } else {
            $builder->insert('front_cms_home', $slider_data);
        }
    }
    // testimonial save and update function
    public function save_testimonial($data)
    {
        $insert_testimonial = array('patient_name' => $data['patient_name'], 'surname' => $data['surname'], 'description' => $data['description'], 'rank' => $data['rank'], 'image' => $this->upload_image(), 'created_by' => get_loggedin_user_id());
        if (isset($data['testimonial_id']) && !empty($data['testimonial_id'])) {
            $builder->where('id', $data['testimonial_id']);
            $builder->update('front_cms_testimonial', $insert_testimonial);
        } else {
            $builder->insert('front_cms_testimonial', $insert_testimonial);
        }
    }
    public function save_services($data)
    {
        $services_data = array('branch_id' => $this->application_model->get_branch_id(), 'title' => $data['title'], 'description' => $data['description'], 'icon' => $data['icon']);
        if (isset($data['services_id']) && !empty($data['services_id'])) {
            $builder->where('id', $data['services_id']);
            $builder->update('front_cms_services_list', $services_data);
        } else {
            $builder->insert('front_cms_services_list', $services_data);
        }
    }
    public function save_faq($data)
    {
        $faq_data = array('title' => $data['title'], 'description' => $data['description'], 'branch_id' => $this->application_model->get_branch_id());
        if (isset($data['faq_id']) && !empty($data['faq_id'])) {
            $builder->where('id', $data['faq_id']);
            $builder->update('front_cms_faq_list', $faq_data);
        } else {
            $builder->insert('front_cms_faq_list', $faq_data);
        }
    }
    // upload home slider image
    public function upload_image()
    {
        $prev_image = $this->request->getPost('old_photo');
        $image = $_FILES['photo']['name'];
        $return_image = '';
        if ($image != '') {
            $destination = './uploads/frontend/slider/';
            $extension = pathinfo($image, PATHINFO_EXTENSION);
            $image_path = 'home-slider-' . time() . '.' . $extension;
            move_uploaded_file($_FILES['photo']['tmp_name'], $destination . $image_path);
            // need to unlink previous slider
            if ($prev_image != '') {
                if (file_exists($destination . $prev_image)) {
                    @unlink($destination . $prev_image);
                }
            }
            $return_image = $image_path;
        } else {
            $return_image = $prev_image;
        }
        return $return_image;
    }
    public function getMenuList($branchID = '')
    {
        $mainMenu = array();
        $subMenu = array();
        $mergeMenu = array();
        $builder->select('front_cms_menu.*,if(mv.name is null, front_cms_menu.title, mv.name) as title, if(mv.parent_id is null, front_cms_menu.parent_id, mv.parent_id) as parent_id, if(mv.ordering is null, front_cms_menu.ordering, mv.ordering) as ordering,mv.invisible');
        $builder->from('front_cms_menu');
        $builder->join('front_cms_menu_visible as mv', 'mv.menu_id = front_cms_menu.id and mv.branch_id = ' . $branchID, 'left');
        $builder->order_by('front_cms_menu.ordering', 'asc');
        $this->db->where_in('front_cms_menu.branch_id', array(0, $branchID));
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            if ($value['parent_id'] == 0) {
                $mainMenu[$key] = $value;
            } else {
                $subMenu[$key] = $value;
            }
        }
        foreach ($mainMenu as $key => $value) {
            $mergeMenu[$key] = $value;
            foreach ($subMenu as $key2 => $value2) {
                if ($value['id'] == $value2['parent_id']) {
                    $mergeMenu[$key]['submenu'][$key2] = $value2;
                }
            }
        }
        return $mergeMenu;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class FrontendModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getBranchID()
    {
        if (is_superadmin_loggedin()) {
            $branchID = $this->request->getGet('branch_id', true);
            return empty($branchID) ? "" : urlencode($branchID);
        } else {
            return get_loggedin_branch_id();
        }
    }
    public function save_slider($data)
    {
        $elements_data = array('position' => $data['position'], 'button_text1' => $data['button_text_1'], 'button_url1' => $data['button_url_1'], 'button_text2' => $data['button_text_2'], 'button_url2' => $data['button_url_2'], 'image' => $this->upload_image());
        $slider_data = array('branch_id' => $this->applicationModel->get_branch_id(), 'title' => $data['title'], 'description' => $data['description'], 'item_type' => 'slider', 'elements' => json_encode($elements_data));
        if (isset($data['slider_id']) && !empty($data['slider_id'])) {
            $builder->where('id', $data['slider_id']);
            $builder->update('front_cms_home', $slider_data);
        } else {
            $builder->insert('front_cms_home', $slider_data);
        }
    }
    public function save_menus($data)
    {
        $title = $data['title'];
        $slug = strtolower(str_replace(' ', '-', $title));
        $publish = isset($data['publish']) ? 1 : 0;
        $new_tab = isset($data['new_tab']) ? 1 : 0;
        $external_url = isset($data['external_url']) ? 1 : 0;
        $external_link = isset($data['external_link']) ? $data['external_link'] : '';
        $parent_id = isset($data['parent_id']) ? $data['parent_id'] : 0;
        $menu_data = array('title' => $title, 'alias' => $slug, 'ordering' => $data['position'], 'open_new_tab' => $new_tab, 'ext_url' => $external_url, 'ext_url_address' => $external_link, 'parent_id' => $parent_id, 'publish' => $publish, 'branch_id' => $this->applicationModel->get_branch_id(), 'system' => 0);
        if (isset($data['menu_id']) && !empty($data['menu_id'])) {
            $isSystem = $builder->getWhere('front_cms_menu', array('id' => $data['menu_id']))->row()->system;
            if ($isSystem == 1) {
                $branch_id = $this->applicationModel->get_branch_id();
                $query = $builder->select('id')->from("front_cms_menu_visible")->where(array('menu_id' => $data['menu_id'], 'branch_id' => $branch_id))->get();
                $arraySysMenu = array('name' => $title, 'invisible' => isset($data['publish']) ? 0 : 1, 'menu_id' => $data['menu_id'], 'ordering' => $data['position'], 'parent_id' => $data['parent_id'], 'branch_id' => $branch_id);
                if ($query->num_rows() == 0) {
                    $builder->insert('front_cms_menu_visible', $arraySysMenu);
                } else {
                    $this->db->table('id', $query->row()->id)->where();
                    $builder->update('front_cms_menu_visible', $arraySysMenu);
                }
            } else {
                $builder->where('id', $data['menu_id']);
                $builder->update('front_cms_menu', $menu_data);
            }
        } else {
            $builder->insert('front_cms_menu', $menu_data);
        }
    }
    public function save_features($data)
    {
        $elements_data = array('button_text' => $data['button_text'], 'button_url' => $data['button_url'], 'icon' => $data['icon']);
        $slider_data = array('branch_id' => $this->applicationModel->get_branch_id(), 'title' => $data['title'], 'item_type' => 'features', 'description' => $data['description'], 'elements' => json_encode($elements_data));
        if (isset($data['features_id']) && !empty($data['features_id'])) {
            $builder->where('id', $data['features_id']);
            $builder->update('front_cms_home', $slider_data);
        } else {
            $builder->insert('front_cms_home', $slider_data);
        }
    }
    // testimonial save and update function
    public function save_testimonial($data)
    {
        $insert_testimonial = array('patient_name' => $data['patient_name'], 'surname' => $data['surname'], 'description' => $data['description'], 'rank' => $data['rank'], 'image' => $this->upload_image(), 'created_by' => get_loggedin_user_id());
        if (isset($data['testimonial_id']) && !empty($data['testimonial_id'])) {
            $builder->where('id', $data['testimonial_id']);
            $builder->update('front_cms_testimonial', $insert_testimonial);
        } else {
            $builder->insert('front_cms_testimonial', $insert_testimonial);
        }
    }
    public function save_services($data)
    {
        $services_data = array('branch_id' => $this->applicationModel->get_branch_id(), 'title' => $data['title'], 'description' => $data['description'], 'icon' => $data['icon']);
        if (isset($data['services_id']) && !empty($data['services_id'])) {
            $builder->where('id', $data['services_id']);
            $builder->update('front_cms_services_list', $services_data);
        } else {
            $builder->insert('front_cms_services_list', $services_data);
        }
    }
    public function save_faq($data)
    {
        $faq_data = array('title' => $data['title'], 'description' => $data['description'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (isset($data['faq_id']) && !empty($data['faq_id'])) {
            $builder->where('id', $data['faq_id']);
            $builder->update('front_cms_faq_list', $faq_data);
        } else {
            $builder->insert('front_cms_faq_list', $faq_data);
        }
    }
    // upload home slider image
    public function upload_image()
    {
        $prev_image = $this->request->getPost('old_photo');
        $image = $_FILES['photo']['name'];
        $return_image = '';
        if ($image != '') {
            $destination = './uploads/frontend/slider/';
            $extension = pathinfo($image, PATHINFO_EXTENSION);
            $image_path = 'home-slider-' . time() . '.' . $extension;
            move_uploaded_file($_FILES['photo']['tmp_name'], $destination . $image_path);
            // need to unlink previous slider
            if ($prev_image != '') {
                if (file_exists($destination . $prev_image)) {
                    @unlink($destination . $prev_image);
                }
            }
            $return_image = $image_path;
        } else {
            $return_image = $prev_image;
        }
        return $return_image;
    }
    public function getMenuList($branchID = '')
    {
        $mainMenu = array();
        $subMenu = array();
        $mergeMenu = array();
        $builder->select('front_cms_menu.*,if(mv.name is null, front_cms_menu.title, mv.name) as title, if(mv.parent_id is null, front_cms_menu.parent_id, mv.parent_id) as parent_id, if(mv.ordering is null, front_cms_menu.ordering, mv.ordering) as ordering,mv.invisible');
        $builder->from('front_cms_menu');
        $builder->join('front_cms_menu_visible as mv', 'mv.menu_id = front_cms_menu.id and mv.branch_id = ' . $branchID, 'left');
        $builder->order_by('front_cms_menu.ordering', 'asc');
        $this->db->where_in('front_cms_menu.branch_id', array(0, $branchID));
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            if ($value['parent_id'] == 0) {
                $mainMenu[$key] = $value;
            } else {
                $subMenu[$key] = $value;
            }
        }
        foreach ($mainMenu as $key => $value) {
            $mergeMenu[$key] = $value;
            foreach ($subMenu as $key2 => $value2) {
                if ($value['id'] == $value2['parent_id']) {
                    $mergeMenu[$key]['submenu'][$key2] = $value2;
                }
            }
        }
        return $mergeMenu;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/CommunicationModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class CommunicationModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // mailbox compose
    public function mailbox_compose($data)
    {
        $id = '';
        $branchID = $this->application_model->get_branch_id();
        $sender = loggedin_role_id() . '-' . get_loggedin_user_id();
        $reciever = $data['role_id'] . '-' . $data['receiver_id'];
        $arrayMsg = array('body' => $data['message_body'], 'subject' => $data['subject'], 'sender' => $sender, 'reciever' => $reciever, 'created_at' => date('Y-m-d H:i:s'));
        if ($_FILES["attachment_file"]['name'] != "") {
            // uploading file using codeigniter upload library
            $config['upload_path'] = 'uploads/attachments/';
            $config['encrypt_name'] = true;
            $config['allowed_types'] = '*';
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attachment_file")) {
                $arrayMsg['file_name'] = $this->upload->data('orig_name');
                $arrayMsg['enc_name'] = $this->upload->data('file_name');
            }
        }
        $builder->insert('message', $arrayMsg);
        $id = $builder->insert_id();
        // send new message received email
        $this->db->table(array('branch_id' => $branchID, 'template_id' => 4))->where();
        $getTemplate = $builder->get('email_templates_details')->row_array();
        if ($getTemplate['notified'] == 1) {
            $user = $this->application_model->getUserNameByRoleID($data['role_id'], $data['receiver_id']);
            $message = $getTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{recipient}", $user['name'], $message);
            $message = str_replace("{message}", $data['message_body'], $message);
            $message = str_replace("{message_url}", base_url('communication/mailbox/read?type=inbox&id=' . $id), $message);
            $msg_data['recipient'] = $user['email'];
            $msg_data['subject'] = $getTemplate['subject'];
            $msg_data['message'] = $message;
            $this->model("email_model");
            $this->email_model->sendEmail($msg_data);
        }
        return $id;
    }
    public function mark_messages_read($message_id)
    {
        $activeUser = loggedin_role_id() . '-' . get_loggedin_user_id();
        $builder->where('reciever', $activeUser);
        $builder->where('id', $message_id);
        $this->db->table('message', array('read_status' => 1, 'updated_at' => date('Y-m-d H:i:s')))->update();
        $builder->where('sender', $activeUser);
        $builder->where('id', $message_id);
        $this->db->table('message', array('reply_status' => 0, 'updated_at' => date('Y-m-d H:i:s')))->update();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class CommunicationModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // mailbox compose
    public function mailbox_compose($data)
    {
        $id = '';
        $branchID = $this->applicationModel->get_branch_id();
        $sender = loggedin_role_id() . '-' . get_loggedin_user_id();
        $reciever = $data['role_id'] . '-' . $data['receiver_id'];
        $arrayMsg = array('body' => $data['message_body'], 'subject' => $data['subject'], 'sender' => $sender, 'reciever' => $reciever, 'created_at' => date('Y-m-d H:i:s'));
        if ($_FILES["attachment_file"]['name'] != "") {
            // uploading file using codeigniter upload library
            $config['upload_path'] = 'uploads/attachments/';
            $config['encrypt_name'] = true;
            $config['allowed_types'] = '*';
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attachment_file")) {
                $arrayMsg['file_name'] = $this->upload->data('orig_name');
                $arrayMsg['enc_name'] = $this->upload->data('file_name');
            }
        }
        $builder->insert('message', $arrayMsg);
        $id = $builder->insert_id();
        // send new message received email
        $this->db->table(array('branch_id' => $branchID, 'template_id' => 4))->where();
        $getTemplate = $builder->get('email_templates_details')->row_array();
        if ($getTemplate['notified'] == 1) {
            $user = $this->applicationModel->getUserNameByRoleID($data['role_id'], $data['receiver_id']);
            $message = $getTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{recipient}", $user['name'], $message);
            $message = str_replace("{message}", $data['message_body'], $message);
            $message = str_replace("{message_url}", base_url('communication/mailbox/read?type=inbox&id=' . $id), $message);
            $msg_data['recipient'] = $user['email'];
            $msg_data['subject'] = $getTemplate['subject'];
            $msg_data['message'] = $message;
            $this->model("email_model");
            $this->email_model->sendEmail($msg_data);
        }
        return $id;
    }
    public function mark_messages_read($message_id)
    {
        $activeUser = loggedin_role_id() . '-' . get_loggedin_user_id();
        $builder->where('reciever', $activeUser);
        $builder->where('id', $message_id);
        $this->db->table('message', array('read_status' => 1, 'updated_at' => date('Y-m-d H:i:s')))->update();
        $builder->where('sender', $activeUser);
        $builder->where('id', $message_id);
        $this->db->table('message', array('reply_status' => 0, 'updated_at' => date('Y-m-d H:i:s')))->update();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/SendsmsmailModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class SendsmsmailModel extends Model
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getStaff($branch_id, $role_id = '', $staff_id = '')
    {
        $builder->select('staff.id,staff.name,staff.mobileno,staff.email');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != "6" and login_credential.role != "7"', 'inner');
        $builder->where('staff.branch_id', $branch_id);
        if (!empty($role_id)) {
            $method = 'result_array';
            $builder->where('login_credential.role', $role_id);
            $builder->order_by('staff.id', 'ASC');
        }
        if (!empty($staff_id)) {
            $builder->where('staff.id', $staff_id);
            $method = 'row_array';
        }
        return $builder->get()->{$method}();
    }
    public function getParent($branch_id, $parent_id = '')
    {
        $builder->select('id,name,email,mobileno');
        $builder->where('branch_id', $branch_id);
        if (empty($parent_id)) {
            $method = 'result_array';
        } else {
            $builder->where('id', $parent_id);
            $method = 'row_array';
        }
        return $builder->get('parent')->{$method}();
    }
    public function getStudent($branch_id, $student_id = '')
    {
        $builder->select('e.student_id,CONCAT_WS(" ",s.first_name, s.last_name) as name,s.mobileno,s.email');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->where('e.branch_id', $branch_id);
        if (empty($student_id)) {
            $method = 'result_array';
            $this->db->table('e.session_id', get_session_id())->where();
            $builder->order_by('s.id', 'ASC');
        } else {
            $builder->where('s.id', $student_id);
            $method = 'row_array';
        }
        return $builder->get()->{$method}();
    }
    public function getStudentBySection($class_id, $section_id, $branch_id)
    {
        $builder->select('e.student_id,CONCAT_WS(" ",s.first_name, s.last_name) as name,s.mobileno,s.email');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->where('e.class_id', $class_id);
        $builder->where('e.section_id', $section_id);
        $builder->where('e.branch_id', $branch_id);
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->order_by('s.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function saveTemplate($data)
    {
        $insertData = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['template_name'], 'body' => $this->request->getPost('message', false), 'type' => $data['type']);
        if (!isset($data['template_id'])) {
            $builder->insert('bulk_msg_category', $insertData);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['template_id']);
            $builder->update('bulk_msg_category', $insertData);
        }
    }
    public function sendEmail($sendTo, $message, $name, $mobileNo, $emailSubject)
    {
        $message = str_replace('{name}', $name, $message);
        $message = str_replace('{email}', $sendTo, $message);
        $message = str_replace('{mobile_no}', $mobileNo, $message);
        $branchID = $this->application_model->get_branch_id();
        $data = array('branch_id' => $branchID, 'recipient' => $sendTo, 'subject' => $emailSubject, 'message' => $message);
        if ($this->mailer->send($data)) {
            return true;
        } else {
            return false;
        }
    }
    public function sendSMS($sendTo, $message, $name, $eMail, $smsGateway, $dlt_templateID)
    {
        $message = str_replace('{name}', $name, $message);
        $message = str_replace('{email}', $eMail, $message);
        $message = str_replace('{mobile_no}', $sendTo, $message);
        if ($smsGateway == 'twilio') {
            $this->twilio = service('twilio');
            $response = $this->twilio->sms($sendTo, $message);
            return true;
        }
        if ($smsGateway == 'clickatell') {
            $this->clickatell = service('clickatell');
            return $this->clickatell->send_message($sendTo, $message);
        }
        if ($smsGateway == 'msg91') {
            $this->msg91 = service('msg91');
            return $this->msg91->send($sendTo, $message, $dlt_templateID);
        }
        if ($smsGateway == 'bulksms') {
            $this->bulk = service('bulk');
            return $this->bulk->send($sendTo, $message);
        }
        if ($smsGateway == 'textlocal') {
            $this->textlocal = service('textlocal');
            return $this->textlocal->sendSms($sendTo, $message);
        }
        if ($smsGateway == 'smscountry') {
            $this->smscountry = service('smscountry');
            return $this->smscountry->send($sendTo, $message);
        }
        if ($smsGateway == 'bulksmsbd') {
            $this->bulksmsbd = service('bulksmsbd');
            return $this->bulksmsbd->send($sendTo, $message);
        }
        if ($smsGateway == 'customSms') {
            $this->custom_sms = service('customSms');
            $res = $this->custom_sms->send($sendTo, $message, $dlt_templateID);
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class SendsmsmailModel extends Model
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getStaff($branch_id, $role_id = '', $staff_id = '')
    {
        $builder->select('staff.id,staff.name,staff.mobileno,staff.email');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != "6" and login_credential.role != "7"', 'inner');
        $builder->where('staff.branch_id', $branch_id);
        if (!empty($role_id)) {
            $method = 'result_array';
            $builder->where('login_credential.role', $role_id);
            $builder->order_by('staff.id', 'ASC');
        }
        if (!empty($staff_id)) {
            $builder->where('staff.id', $staff_id);
            $method = 'row_array';
        }
        return $builder->get()->{$method}();
    }
    public function getParent($branch_id, $parent_id = '')
    {
        $builder->select('id,name,email,mobileno');
        $builder->where('branch_id', $branch_id);
        if (empty($parent_id)) {
            $method = 'result_array';
        } else {
            $builder->where('id', $parent_id);
            $method = 'row_array';
        }
        return $builder->get('parent')->{$method}();
    }
    public function getStudent($branch_id, $student_id = '')
    {
        $builder->select('e.student_id,CONCAT_WS(" ",s.first_name, s.last_name) as name,s.mobileno,s.email');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->where('e.branch_id', $branch_id);
        if (empty($student_id)) {
            $method = 'result_array';
            $this->db->table('e.session_id', get_session_id())->where();
            $builder->order_by('s.id', 'ASC');
        } else {
            $builder->where('s.id', $student_id);
            $method = 'row_array';
        }
        return $builder->get()->{$method}();
    }
    public function getStudentBySection($class_id, $section_id, $branch_id)
    {
        $builder->select('e.student_id,CONCAT_WS(" ",s.first_name, s.last_name) as name,s.mobileno,s.email');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->where('e.class_id', $class_id);
        $builder->where('e.section_id', $section_id);
        $builder->where('e.branch_id', $branch_id);
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->order_by('s.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function saveTemplate($data)
    {
        $insertData = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['template_name'], 'body' => $this->request->getPost('message', false), 'type' => $data['type']);
        if (!isset($data['template_id'])) {
            $builder->insert('bulk_msg_category', $insertData);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['template_id']);
            $builder->update('bulk_msg_category', $insertData);
        }
    }
    public function sendEmail($sendTo, $message, $name, $mobileNo, $emailSubject)
    {
        $message = str_replace('{name}', $name, $message);
        $message = str_replace('{email}', $sendTo, $message);
        $message = str_replace('{mobile_no}', $mobileNo, $message);
        $branchID = $this->applicationModel->get_branch_id();
        $data = array('branch_id' => $branchID, 'recipient' => $sendTo, 'subject' => $emailSubject, 'message' => $message);
        if ($this->mailer->send($data)) {
            return true;
        } else {
            return false;
        }
    }
    public function sendSMS($sendTo, $message, $name, $eMail, $smsGateway, $dlt_templateID)
    {
        $message = str_replace('{name}', $name, $message);
        $message = str_replace('{email}', $eMail, $message);
        $message = str_replace('{mobile_no}', $sendTo, $message);
        if ($smsGateway == 'twilio') {
            $this->twilio = service('twilio');
            $response = $this->twilio->sms($sendTo, $message);
            return true;
        }
        if ($smsGateway == 'clickatell') {
            $this->clickatell = service('clickatell');
            return $this->clickatell->send_message($sendTo, $message);
        }
        if ($smsGateway == 'msg91') {
            $this->msg91 = service('msg91');
            return $this->msg91->send($sendTo, $message, $dlt_templateID);
        }
        if ($smsGateway == 'bulksms') {
            $this->bulk = service('bulk');
            return $this->bulk->send($sendTo, $message);
        }
        if ($smsGateway == 'textlocal') {
            $this->textlocal = service('textlocal');
            return $this->textlocal->sendSms($sendTo, $message);
        }
        if ($smsGateway == 'smscountry') {
            $this->smscountry = service('smscountry');
            return $this->smscountry->send($sendTo, $message);
        }
        if ($smsGateway == 'bulksmsbd') {
            $this->bulksmsbd = service('bulksmsbd');
            return $this->bulksmsbd->send($sendTo, $message);
        }
        if ($smsGateway == 'customSms') {
            $this->custom_sms = service('customSms');
            $res = $this->custom_sms->send($sendTo, $message, $dlt_templateID);
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/TransportModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class TransportModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function route_save($data)
    {
        $arraRoute = array('name' => $data['route_name'], 'start_place' => $data['start_place'], 'stop_place' => $data['stop_place'], 'remarks' => $data['remarks'], 'branch_id' => $this->application_model->get_branch_id());
        if (!isset($data['route_id'])) {
            $builder->insert('transport_route', $arraRoute);
        } else {
            $builder->where('id', $data['route_id']);
            $builder->update('transport_route', $arraRoute);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function vehicle_save($data)
    {
        $arraVehicle = array('vehicle_no' => $data['vehicle_no'], 'capacity' => $data['capacity'], 'insurance_renewal' => $data['insurance_renewal'], 'driver_name' => $data['driver_name'], 'driver_phone' => $data['driver_phone'], 'driver_license' => $data['driver_license'], 'branch_id' => $this->application_model->get_branch_id());
        if (!isset($data['vehicle_id'])) {
            $builder->insert('transport_vehicle', $arraVehicle);
        } else {
            $builder->where('id', $data['vehicle_id']);
            $builder->update('transport_vehicle', $arraVehicle);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function stoppage_save($data)
    {
        $arraStoppage = array('stop_position' => $data['stop_position'], 'stop_time' => date("H:i", strtotime($data['stop_time'])), 'route_fare' => $data['route_fare'], 'branch_id' => $this->application_model->get_branch_id());
        if (!isset($data['stoppage_id'])) {
            $builder->insert('transport_stoppage', $arraStoppage);
        } else {
            $builder->where('id', $data['stoppage_id']);
            $builder->update('transport_stoppage', $arraStoppage);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    // allocation report with student name
    public function allocation_report($classID, $sectionID, $branchID)
    {
        $builder->select('ta.*,r.name as route_name,v.vehicle_no,sp.stop_position,sp.stop_time,sp.route_fare,s.first_name,s.last_name,s.register_no,e.id as enroll_id');
        $builder->from('transport_assign as ta');
        $builder->join('transport_route as r', 'r.id = ta.route_id', 'left');
        $builder->join('transport_vehicle as v', 'v.id = ta.vehicle_id', 'left');
        $builder->join('transport_stoppage as sp', 'sp.id = ta.stoppage_id', 'left');
        $builder->join('student as s', 's.route_id = ta.route_id AND s.vehicle_id = ta.vehicle_id', 'left');
        $builder->join('enroll as e', 'e.student_id = s.id', 'left');
        $builder->where('ta.branch_id', $branchID);
        $builder->where('e.class_id', $classID);
        $builder->where('e.section_id', $sectionID);
        return $builder->get()->result_array();
    }
    // get route,vehicle,stoppage assign list
    public function getAssignList($branch_id = '')
    {
        $builder->select('ta.route_id,ta.stoppage_id,ta.branch_id,r.name,r.start_place,r.stop_place,sp.stop_position,sp.stop_time,sp.route_fare');
        $builder->from('transport_assign as ta');
        $builder->join('transport_route as r', 'r.id = ta.route_id', 'left');
        $builder->join('transport_stoppage as sp', 'sp.id = ta.stoppage_id', 'left');
        $this->db->group_by(array('ta.route_id', 'ta.stoppage_id', 'ta.branch_id'));
        if (!empty($branch_id)) {
            $builder->where('ta.branch_id', $branch_id);
        }
        return $builder->get()->result_array();
    }
    public function getAssignEdit($id = '')
    {
        if (!is_superadmin_loggedin()) {
            $this->db->table('branch_id', get_loggedin_branch_id())->where();
        }
        $builder->where('route_id', $id);
        $builder->limit(1);
        return $builder->get('transport_assign')->row_array();
    }
    // get vehicle list by route_id
    public function get_vehicle_list($route_id)
    {
        $builder->select('ta.vehicle_id,v.vehicle_no');
        $builder->from('transport_assign as ta');
        $builder->join('transport_vehicle as v', 'v.id = ta.vehicle_id', 'left');
        $builder->where('ta.route_id', $route_id);
        $vehicles = $builder->get()->getResult();
        $name_list = '';
        foreach ($vehicles as $row) {
            $name_list .= '- ' . $row->vehicle_no . '<br>';
        }
        return $name_list;
    }
    // get route information by route id and vehicle id
    public function get_student_route($route_id, $vehicle_id)
    {
        $builder->select('ta.route_id,ta.stoppage_id,ta.vehicle_id,r.name as route_name,r.start_place,r.stop_place,sp.stop_position,sp.stop_time,sp.route_fare,v.vehicle_no,v.driver_name,v.driver_phone');
        $builder->from('transport_assign as ta');
        $builder->join('transport_route as r', 'r.id = ta.route_id', 'left');
        $builder->join('transport_vehicle as v', 'v.id = ta.vehicle_id', 'left');
        $builder->join('transport_stoppage as sp', 'sp.id = ta.stoppage_id', 'left');
        $builder->where('ta.route_id', $route_id);
        $builder->where('ta.vehicle_id', $vehicle_id);
        return $builder->get()->row();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class TransportModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function route_save($data)
    {
        $arraRoute = array('name' => $data['route_name'], 'start_place' => $data['start_place'], 'stop_place' => $data['stop_place'], 'remarks' => $data['remarks'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (!isset($data['route_id'])) {
            $builder->insert('transport_route', $arraRoute);
        } else {
            $builder->where('id', $data['route_id']);
            $builder->update('transport_route', $arraRoute);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function vehicle_save($data)
    {
        $arraVehicle = array('vehicle_no' => $data['vehicle_no'], 'capacity' => $data['capacity'], 'insurance_renewal' => $data['insurance_renewal'], 'driver_name' => $data['driver_name'], 'driver_phone' => $data['driver_phone'], 'driver_license' => $data['driver_license'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (!isset($data['vehicle_id'])) {
            $builder->insert('transport_vehicle', $arraVehicle);
        } else {
            $builder->where('id', $data['vehicle_id']);
            $builder->update('transport_vehicle', $arraVehicle);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function stoppage_save($data)
    {
        $arraStoppage = array('stop_position' => $data['stop_position'], 'stop_time' => date("H:i", strtotime($data['stop_time'])), 'route_fare' => $data['route_fare'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (!isset($data['stoppage_id'])) {
            $builder->insert('transport_stoppage', $arraStoppage);
        } else {
            $builder->where('id', $data['stoppage_id']);
            $builder->update('transport_stoppage', $arraStoppage);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    // allocation report with student name
    public function allocation_report($classID, $sectionID, $branchID)
    {
        $builder->select('ta.*,r.name as route_name,v.vehicle_no,sp.stop_position,sp.stop_time,sp.route_fare,s.first_name,s.last_name,s.register_no,e.id as enroll_id');
        $builder->from('transport_assign as ta');
        $builder->join('transport_route as r', 'r.id = ta.route_id', 'left');
        $builder->join('transport_vehicle as v', 'v.id = ta.vehicle_id', 'left');
        $builder->join('transport_stoppage as sp', 'sp.id = ta.stoppage_id', 'left');
        $builder->join('student as s', 's.route_id = ta.route_id AND s.vehicle_id = ta.vehicle_id', 'left');
        $builder->join('enroll as e', 'e.student_id = s.id', 'left');
        $builder->where('ta.branch_id', $branchID);
        $builder->where('e.class_id', $classID);
        $builder->where('e.section_id', $sectionID);
        return $builder->get()->result_array();
    }
    // get route,vehicle,stoppage assign list
    public function getAssignList($branch_id = '')
    {
        $builder->select('ta.route_id,ta.stoppage_id,ta.branch_id,r.name,r.start_place,r.stop_place,sp.stop_position,sp.stop_time,sp.route_fare');
        $builder->from('transport_assign as ta');
        $builder->join('transport_route as r', 'r.id = ta.route_id', 'left');
        $builder->join('transport_stoppage as sp', 'sp.id = ta.stoppage_id', 'left');
        $this->db->group_by(array('ta.route_id', 'ta.stoppage_id', 'ta.branch_id'));
        if (!empty($branch_id)) {
            $builder->where('ta.branch_id', $branch_id);
        }
        return $builder->get()->result_array();
    }
    public function getAssignEdit($id = '')
    {
        if (!is_superadmin_loggedin()) {
            $this->db->table('branch_id', get_loggedin_branch_id())->where();
        }
        $builder->where('route_id', $id);
        $builder->limit(1);
        return $builder->get('transport_assign')->row_array();
    }
    // get vehicle list by route_id
    public function get_vehicle_list($route_id)
    {
        $builder->select('ta.vehicle_id,v.vehicle_no');
        $builder->from('transport_assign as ta');
        $builder->join('transport_vehicle as v', 'v.id = ta.vehicle_id', 'left');
        $builder->where('ta.route_id', $route_id);
        $vehicles = $builder->get()->getResult();
        $name_list = '';
        foreach ($vehicles as $row) {
            $name_list .= '- ' . $row->vehicle_no . '<br>';
        }
        return $name_list;
    }
    // get route information by route id and vehicle id
    public function get_student_route($route_id, $vehicle_id)
    {
        $builder->select('ta.route_id,ta.stoppage_id,ta.vehicle_id,r.name as route_name,r.start_place,r.stop_place,sp.stop_position,sp.stop_time,sp.route_fare,v.vehicle_no,v.driver_name,v.driver_phone');
        $builder->from('transport_assign as ta');
        $builder->join('transport_route as r', 'r.id = ta.route_id', 'left');
        $builder->join('transport_vehicle as v', 'v.id = ta.vehicle_id', 'left');
        $builder->join('transport_stoppage as sp', 'sp.id = ta.stoppage_id', 'left');
        $builder->where('ta.route_id', $route_id);
        $builder->where('ta.vehicle_id', $vehicle_id);
        return $builder->get()->row();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/InventoryModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class InventoryModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function save_product($data)
    {
        $insert_product = array('name' => $data['product_name'], 'code' => $data['product_code'], 'category_id' => $data['product_category'], 'purchase_unit_id' => $data['purchase_unit'], 'sales_unit_id' => $data['sales_unit'], 'unit_ratio' => $data['unit_ratio'], 'purchase_price' => $data['purchase_price'], 'sales_price' => $data['sales_price'], 'remarks' => $data['remarks'], 'branch_id' => $this->application_model->get_branch_id());
        if (isset($data['product_id']) && !empty($data['product_id'])) {
            $builder->where('id', $data['product_id']);
            $builder->update('product', $insert_product);
        } else {
            $builder->insert('product', $insert_product);
        }
    }
    public function save_supplier($data)
    {
        $insertSupplier = array('name' => $data['supplier_name'], 'email' => $data['email_address'], 'mobileno' => $data['contact_number'], 'company_name' => $data['company_name'], 'product_list' => $data['product_list'], 'address' => $data['address'], 'branch_id' => $this->application_model->get_branch_id());
        if (isset($data['supplier_id']) && !empty($data['supplier_id'])) {
            $builder->where('id', $data['supplier_id']);
            $builder->update('product_supplier', $insertSupplier);
        } else {
            $builder->insert('product_supplier', $insertSupplier);
        }
    }
    public function get_product_list()
    {
        $builder->select('product.*,product_category.name as category_name,p_unit.name as p_unit_name,s_unit.name as s_unit_name');
        $builder->from('product');
        $builder->join('product_category', 'product_category.id = product.category_id', 'left');
        $builder->join('product_unit as p_unit', 'p_unit.id = product.purchase_unit_id', 'left');
        $builder->join('product_unit as s_unit', 's_unit.id = product.sales_unit_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('product.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('product.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function get_purchase_list()
    {
        $sql = "SELECT purchase_bill.*,product_supplier.name as supplier_name,staff.name as biller_name FROM purchase_bill LEFT JOIN product_supplier ON product_supplier.id = purchase_bill.supplier_id LEFT JOIN staff ON staff.id = purchase_bill.prepared_by";
        if (!is_superadmin_loggedin()) {
            $sql .= " WHERE product_supplier.branch_id = " . $db->escape(get_loggedin_branch_id());
        }
        $sql .= " ORDER BY purchase_bill.id ASC";
        $query = $db->query($sql);
        return $query->getResultArray();
    }
    public function get_invoice($id)
    {
        $builder->select('purchase_bill.*,product_supplier.name as supplier_name,product_supplier.address as supplier_address,product_supplier.company_name as supplier_company_name,product_supplier.mobileno as supplier_mobileno,staff.name as biller_name');
        $builder->from('purchase_bill');
        $builder->join('product_supplier', 'product_supplier.id = purchase_bill.supplier_id', 'left');
        $builder->join('staff', 'staff.id = purchase_bill.prepared_by', 'left');
        $builder->where('purchase_bill.id', $id);
        if (!is_superadmin_loggedin()) {
            $this->db->table('purchase_bill.branch_id', get_loggedin_branch_id())->where();
        }
        return $builder->get()->row_array();
    }
    public function save_purchase($data)
    {
        $arrayInvoice = array('supplier_id' => $data['supplier_id'], 'bill_no' => $data['bill_no'], 'store_id' => $data['store_id'], 'remarks' => $data['remarks'], 'total' => $data['grand_total'], 'discount' => $data['total_discount'], 'due' => $data['net_grand_total'], 'paid' => 0, 'payment_status' => 1, 'purchase_status' => $data['purchase_status'], 'date' => date('Y-m-d', strtotime($data['date'])), 'prepared_by' => get_loggedin_user_id(), 'modifier_id' => get_loggedin_user_id(), 'branch_id' => $this->application_model->get_branch_id());
        $builder->insert('purchase_bill', $arrayInvoice);
        $purchase_bill_id = $builder->insert_id();
        $arrayData = array();
        $purchases = $data['purchases'];
        foreach ($purchases as $key => $value) {
            $arrayproduct = array('purchase_bill_id' => $purchase_bill_id, 'product_id' => $value['product'], 'unit_price' => $value['unit_price'], 'discount' => $value['discount'], 'quantity' => $value['quantity'], 'sub_total' => $value['sub_total']);
            $arrayData[] = $arrayproduct;
            //update product available stock
            if ($data['purchase_status'] == 2) {
                $unit_ratio = $db->table('product')->get('product')->row()->unit_ratio;
                $stockQuantity = $value['quantity'] * $unit_ratio;
                $this->stock_upgrade($stockQuantity, $value['product']);
            }
        }
        $builder->insert_batch('purchase_bill_details', $arrayData);
    }
    // add partly of the purchase payment
    public function save_payment($data)
    {
        $payment_status = 1;
        $attach_orig_name = "";
        $attach_file_name = "";
        $purchase_bill_id = $data['purchase_bill_id'];
        $payment_amount = $data['payment_amount'];
        $paid_date = $data['paid_date'];
        // uploading file using codeigniter upload library
        if (isset($_FILES['attach_document']['name']) && !empty($_FILES['attach_document']['name'])) {
            $config['upload_path'] = './uploads/attachments/inventory_payment/';
            $config['allowed_types'] = '*';
            $config['encrypt_name'] = true;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attach_document")) {
                $attach_orig_name = $this->upload->data('orig_name');
                $attach_file_name = $this->upload->data('file_name');
            }
        }
        $array_history = array('purchase_bill_id' => $purchase_bill_id, 'payment_by' => get_loggedin_user_id(), 'amount' => $payment_amount, 'pay_via' => $this->request->getPost('pay_via'), 'remarks' => $this->request->getPost('remarks'), 'attach_orig_name' => $attach_orig_name, 'attach_file_name' => $attach_file_name, 'coll_type' => 1, 'paid_on' => date("Y-m-d", strtotime($paid_date)));
        $builder->insert('purchase_payment_history', $array_history);
        if ($data['getbill']['due'] <= $payment_amount) {
            $payment_status = 3;
        } else {
            $payment_status = 2;
        }
        $sql = "UPDATE `purchase_bill` SET `payment_status` = " . $payment_status . ", `paid` = `paid` + " . $payment_amount . ", `due` = `due` - " . $payment_amount . " WHERE `id` = " . $db->escape($purchase_bill_id);
        $db->query($sql);
    }
    public function get_stock_product_wisereport($branch_id, $category_id = '')
    {
        $builder->select('product.*,product_store.name as store_name,product_supplier.name as supplier_name,product_category.name as category_name, (SELECT sum(quantity) from product_issues_details JOIN product_issues ON product_issues.id = product_issues_details.issues_id where product.id=product_issues_details.product_id AND product_issues.status = 0) as total_issued, (SELECT sum(quantity) from sales_bill_details where product.id=sales_bill_details.product_id) as total_sales, IFNULL(SUM(purchase_bill_details.quantity),0) as in_stock');
        $builder->from('purchase_bill');
        $builder->join('purchase_bill_details', 'purchase_bill_details.purchase_bill_id = purchase_bill.id', 'inner');
        $builder->join('product', 'product.id = purchase_bill_details.product_id', 'inner');
        $builder->join('product_category', 'product_category.id = product.category_id', 'left');
        $builder->join('product_store', 'purchase_bill.store_id = product_store.id', 'left');
        $builder->join('product_supplier', 'purchase_bill.supplier_id = product_supplier.id', 'left');
        $builder->order_by('purchase_bill.id', 'ASC');
        $builder->where('purchase_bill.branch_id', $branch_id);
        if ($category_id != 'all') {
            $builder->where('product.category_id', $category_id);
        }
        $builder->group_by('purchase_bill_details.product_id');
        return $builder->get()->result_array();
    }
    public function get_purchase_report($branch_id, $supplier_id = '', $payment_status = '', $start = '', $end = '')
    {
        $builder->select('purchase_bill.*,product_store.name as store_name,IFNULL(SUM(purchase_bill.total - purchase_bill.discount),0) as net_payable,product_supplier.name as supplier_name');
        $builder->from('purchase_bill');
        $builder->join('product_supplier', 'product_supplier.id = purchase_bill.supplier_id', 'left');
        $builder->join('product_store', 'purchase_bill.store_id = product_store.id', 'left');
        if ($supplier_id != 'all') {
            $builder->where('purchase_bill.supplier_id', $supplier_id);
        }
        if ($payment_status != 'all') {
            $builder->where('purchase_bill.payment_status', $payment_status);
        }
        $builder->where('purchase_bill.date >=', $start);
        $builder->where('purchase_bill.date <=', $end);
        $builder->where('purchase_bill.branch_id', $branch_id);
        $builder->group_by('purchase_bill.id');
        $builder->order_by('purchase_bill.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function get_sales_report($branch_id, $payment_status = '', $start = '', $end = '')
    {
        $builder->select('sales_bill.*,roles.name as role_name,IFNULL(SUM(sales_bill.total - sales_bill.discount),0) as net_payable');
        $builder->from('sales_bill');
        $builder->join('roles', 'roles.id = sales_bill.role_id', 'left');
        if ($payment_status != 'all') {
            $builder->where('purchase_bill.payment_status', $payment_status);
        }
        $builder->where('sales_bill.date >=', $start);
        $builder->where('sales_bill.date <=', $end);
        $builder->where('sales_bill.branch_id', $branch_id);
        $builder->group_by('sales_bill.id');
        $builder->order_by('sales_bill.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function getIssuesreport($branchID = '', $start = '', $end = '')
    {
        $builder->select('product_issues.*,product.name as product_name,roles.name as role_name,product_issues_details.quantity,product_category.name as category_name');
        $builder->from('product_issues_details');
        $builder->join('product_issues', 'product_issues.id = product_issues_details.issues_id', 'inner');
        $builder->join('product', 'product.id = product_issues_details.product_id', 'left');
        $builder->join('product_category', 'product_category.id = product.category_id', 'left');
        $builder->join('roles', 'roles.id = product_issues.role_id', 'left');
        $builder->where('product_issues.date_of_issue >=', $start);
        $builder->where('product_issues.date_of_issue <=', $end);
        $builder->where('product_issues.branch_id', $branchID);
        $builder->order_by('product_issues.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function save_store($data)
    {
        $insertStore = array('name' => $data['store_name'], 'code' => $data['store_code'], 'mobileno' => $data['mobileno'], 'address' => $data['address'], 'description' => $data['description'], 'branch_id' => $this->application_model->get_branch_id());
        if (isset($data['store_id']) && !empty($data['store_id'])) {
            $builder->where('id', $data['store_id']);
            $builder->update('product_store', $insertStore);
        } else {
            $builder->insert('product_store', $insertStore);
        }
    }
    public function getProductByBranch($branch_id = '')
    {
        if (!empty($branch_id)) {
            $builder->where('branch_id', $branch_id);
            $result = $builder->get('product')->result_array();
            return $result;
        }
        return "";
    }
    public function save_sales($data)
    {
        $paid = 0;
        $paymentStatus = 1;
        $dueAmount = $data['net_amount'];
        if (!empty($data['payment_amount'])) {
            $paymentStatus = 2;
            $paid = $data['payment_amount'];
            $dueAmount = $data['net_amount'] - $paid;
            if ($data['net_amount'] == $paid) {
                $paymentStatus = 3;
            }
        }
        $arrayInvoice = array('bill_no' => $data['bill_no'], 'role_id' => $data['role_id'], 'user_id' => $data['sale_to'], 'remarks' => $data['payment_remarks'], 'total' => $data['grand_total'], 'discount' => $data['total_discount'], 'due' => $dueAmount, 'paid' => $paid, 'payment_status' => $paymentStatus, 'date' => date('Y-m-d', strtotime($data['date'])), 'prepared_by' => get_loggedin_user_id(), 'modifier_id' => get_loggedin_user_id(), 'branch_id' => $this->application_model->get_branch_id());
        $builder->insert('sales_bill', $arrayInvoice);
        $sales_bill_id = $builder->insert_id();
        $arrayData = array();
        $sales = $data['sales'];
        foreach ($sales as $key => $value) {
            $arrayproduct = array('sales_bill_id' => $sales_bill_id, 'product_id' => $value['product'], 'unit_price' => $value['unit_price'], 'discount' => $value['discount'], 'quantity' => $value['quantity'], 'sub_total' => $value['sub_total']);
            $arrayData[] = $arrayproduct;
            //update product available stock
            $this->stock_upgrade($value['quantity'], $value['product'], false);
        }
        $builder->insert_batch('sales_bill_details', $arrayData);
        if (!empty($data['payment_amount'])) {
            $arrayInvoice = array('sales_bill_id' => $sales_bill_id, 'amount' => $data['payment_amount'], 'pay_via' => $data['pay_via'], 'payment_by' => get_loggedin_user_id(), 'remarks' => $data['payment_remarks'], 'coll_type' => 1, 'attach_orig_name' => '', 'attach_file_name' => '', 'paid_on' => date("Y-m-d"));
            $builder->insert('sales_payment_history', $arrayInvoice);
        }
    }
    public function save_issue($data)
    {
        $arrayInvoice = array('role_id' => $data['role_id'], 'user_id' => $data['sale_to'], 'remarks' => $data['remarks'], 'date_of_issue' => date('Y-m-d', strtotime($data['date_of_issue'])), 'due_date' => date('Y-m-d', strtotime($data['due_date'])), 'prepared_by' => get_loggedin_user_id(), 'branch_id' => $this->application_model->get_branch_id());
        $builder->insert('product_issues', $arrayInvoice);
        $issues_id = $builder->insert_id();
        $arrayData = array();
        $sales = $data['sales'];
        foreach ($sales as $key => $value) {
            $arrayproduct = array('issues_id' => $issues_id, 'product_id' => $value['product'], 'quantity' => $value['quantity']);
            $arrayData[] = $arrayproduct;
            //update product available stock
            $this->stock_upgrade($value['quantity'], $value['product'], false);
        }
        $builder->insert_batch('product_issues_details', $arrayData);
    }
    public function getSalesList()
    {
        $builder->select('sales_bill.*,roles.name as role_name');
        $builder->from('sales_bill');
        $builder->join('roles', 'roles.id = sales_bill.role_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('sales_bill.id', 'asc');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function getSalesInvoice($id)
    {
        $builder->select('sales_bill.*,staff.name as biller_name,roles.name as role_name');
        $builder->from('sales_bill');
        $builder->join('roles', 'roles.id = sales_bill.role_id', 'left');
        $builder->join('staff', 'staff.id = sales_bill.prepared_by', 'left');
        $builder->where('sales_bill.id', $id);
        if (!is_superadmin_loggedin()) {
            $this->db->table('sales_bill.branch_id', get_loggedin_branch_id())->where();
        }
        return $builder->get()->row_array();
    }
    // add partly of the sales payment
    public function save_sales_payment($data)
    {
        $payment_status = 1;
        $attach_orig_name = "";
        $attach_file_name = "";
        $sales_bill_id = $data['sales_bill_id'];
        $payment_amount = $data['payment_amount'];
        $paid_date = $data['paid_date'];
        // uploading file using codeigniter upload library
        if (isset($_FILES['attach_document']['name']) && !empty($_FILES['attach_document']['name'])) {
            $config['upload_path'] = './uploads/attachments/inventory_payment/';
            $config['allowed_types'] = '*';
            $config['encrypt_name'] = true;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attach_document")) {
                $attach_orig_name = $this->upload->data('orig_name');
                $attach_file_name = $this->upload->data('file_name');
            }
        }
        $array_history = array('sales_bill_id' => $sales_bill_id, 'payment_by' => get_loggedin_user_id(), 'amount' => $payment_amount, 'pay_via' => $this->request->getPost('pay_via'), 'remarks' => $this->request->getPost('remarks'), 'attach_orig_name' => $attach_orig_name, 'attach_file_name' => $attach_file_name, 'coll_type' => 1, 'paid_on' => date("Y-m-d", strtotime($paid_date)));
        $builder->insert('sales_payment_history', $array_history);
        if ($data['getbill']['due'] <= $payment_amount) {
            $payment_status = 3;
        } else {
            $payment_status = 2;
        }
        $sql = "UPDATE `sales_bill` SET `payment_status` = " . $payment_status . ", `paid` = `paid` + " . $payment_amount . ", `due` = `due` - " . $payment_amount . " WHERE `id` = " . $db->escape($sales_bill_id);
        $db->query($sql);
    }
    public function stock_upgrade($quantity, $productID, $add = true)
    {
        if ($add == true) {
            $sql = "UPDATE `product` SET `available_stock` = `available_stock` + " . $quantity . " WHERE `id` = " . $db->escape($productID);
        } else {
            $sql = "UPDATE `product` SET `available_stock` = `available_stock` - " . $quantity . " WHERE `id` = " . $db->escape($productID);
        }
        $db->query($sql);
    }
    public function getIssueList()
    {
        $builder->select('product_issues.*,roles.name as role_name');
        $builder->from('product_issues');
        $builder->join('roles', 'roles.id = product_issues.role_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('product_issues.id', 'asc');
        $result = $builder->get()->result_array();
        return $result;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class InventoryModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function save_product($data)
    {
        $insert_product = array('name' => $data['product_name'], 'code' => $data['product_code'], 'category_id' => $data['product_category'], 'purchase_unit_id' => $data['purchase_unit'], 'sales_unit_id' => $data['sales_unit'], 'unit_ratio' => $data['unit_ratio'], 'purchase_price' => $data['purchase_price'], 'sales_price' => $data['sales_price'], 'remarks' => $data['remarks'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (isset($data['product_id']) && !empty($data['product_id'])) {
            $builder->where('id', $data['product_id']);
            $builder->update('product', $insert_product);
        } else {
            $builder->insert('product', $insert_product);
        }
    }
    public function save_supplier($data)
    {
        $insertSupplier = array('name' => $data['supplier_name'], 'email' => $data['email_address'], 'mobileno' => $data['contact_number'], 'company_name' => $data['company_name'], 'product_list' => $data['product_list'], 'address' => $data['address'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (isset($data['supplier_id']) && !empty($data['supplier_id'])) {
            $builder->where('id', $data['supplier_id']);
            $builder->update('product_supplier', $insertSupplier);
        } else {
            $builder->insert('product_supplier', $insertSupplier);
        }
    }
    public function get_product_list()
    {
        $builder->select('product.*,product_category.name as category_name,p_unit.name as p_unit_name,s_unit.name as s_unit_name');
        $builder->from('product');
        $builder->join('product_category', 'product_category.id = product.category_id', 'left');
        $builder->join('product_unit as p_unit', 'p_unit.id = product.purchase_unit_id', 'left');
        $builder->join('product_unit as s_unit', 's_unit.id = product.sales_unit_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('product.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('product.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function get_purchase_list()
    {
        $sql = "SELECT purchase_bill.*,product_supplier.name as supplier_name,staff.name as biller_name FROM purchase_bill LEFT JOIN product_supplier ON product_supplier.id = purchase_bill.supplier_id LEFT JOIN staff ON staff.id = purchase_bill.prepared_by";
        if (!is_superadmin_loggedin()) {
            $sql .= " WHERE product_supplier.branch_id = " . $db->escape(get_loggedin_branch_id());
        }
        $sql .= " ORDER BY purchase_bill.id ASC";
        $query = $db->query($sql);
        return $query->getResultArray();
    }
    public function get_invoice($id)
    {
        $builder->select('purchase_bill.*,product_supplier.name as supplier_name,product_supplier.address as supplier_address,product_supplier.company_name as supplier_company_name,product_supplier.mobileno as supplier_mobileno,staff.name as biller_name');
        $builder->from('purchase_bill');
        $builder->join('product_supplier', 'product_supplier.id = purchase_bill.supplier_id', 'left');
        $builder->join('staff', 'staff.id = purchase_bill.prepared_by', 'left');
        $builder->where('purchase_bill.id', $id);
        if (!is_superadmin_loggedin()) {
            $this->db->table('purchase_bill.branch_id', get_loggedin_branch_id())->where();
        }
        return $builder->get()->row_array();
    }
    public function save_purchase($data)
    {
        $arrayInvoice = array('supplier_id' => $data['supplier_id'], 'bill_no' => $data['bill_no'], 'store_id' => $data['store_id'], 'remarks' => $data['remarks'], 'total' => $data['grand_total'], 'discount' => $data['total_discount'], 'due' => $data['net_grand_total'], 'paid' => 0, 'payment_status' => 1, 'purchase_status' => $data['purchase_status'], 'date' => date('Y-m-d', strtotime($data['date'])), 'prepared_by' => get_loggedin_user_id(), 'modifier_id' => get_loggedin_user_id(), 'branch_id' => $this->applicationModel->get_branch_id());
        $builder->insert('purchase_bill', $arrayInvoice);
        $purchase_bill_id = $builder->insert_id();
        $arrayData = array();
        $purchases = $data['purchases'];
        foreach ($purchases as $key => $value) {
            $arrayproduct = array('purchase_bill_id' => $purchase_bill_id, 'product_id' => $value['product'], 'unit_price' => $value['unit_price'], 'discount' => $value['discount'], 'quantity' => $value['quantity'], 'sub_total' => $value['sub_total']);
            $arrayData[] = $arrayproduct;
            //update product available stock
            if ($data['purchase_status'] == 2) {
                $unit_ratio = $db->table('product')->get('product')->row()->unit_ratio;
                $stockQuantity = $value['quantity'] * $unit_ratio;
                $this->stock_upgrade($stockQuantity, $value['product']);
            }
        }
        $builder->insert_batch('purchase_bill_details', $arrayData);
    }
    // add partly of the purchase payment
    public function save_payment($data)
    {
        $payment_status = 1;
        $attach_orig_name = "";
        $attach_file_name = "";
        $purchase_bill_id = $data['purchase_bill_id'];
        $payment_amount = $data['payment_amount'];
        $paid_date = $data['paid_date'];
        // uploading file using codeigniter upload library
        if (isset($_FILES['attach_document']['name']) && !empty($_FILES['attach_document']['name'])) {
            $config['upload_path'] = './uploads/attachments/inventory_payment/';
            $config['allowed_types'] = '*';
            $config['encrypt_name'] = true;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attach_document")) {
                $attach_orig_name = $this->upload->data('orig_name');
                $attach_file_name = $this->upload->data('file_name');
            }
        }
        $array_history = array('purchase_bill_id' => $purchase_bill_id, 'payment_by' => get_loggedin_user_id(), 'amount' => $payment_amount, 'pay_via' => $this->request->getPost('pay_via'), 'remarks' => $this->request->getPost('remarks'), 'attach_orig_name' => $attach_orig_name, 'attach_file_name' => $attach_file_name, 'coll_type' => 1, 'paid_on' => date("Y-m-d", strtotime($paid_date)));
        $builder->insert('purchase_payment_history', $array_history);
        if ($data['getbill']['due'] <= $payment_amount) {
            $payment_status = 3;
        } else {
            $payment_status = 2;
        }
        $sql = "UPDATE `purchase_bill` SET `payment_status` = " . $payment_status . ", `paid` = `paid` + " . $payment_amount . ", `due` = `due` - " . $payment_amount . " WHERE `id` = " . $db->escape($purchase_bill_id);
        $db->query($sql);
    }
    public function get_stock_product_wisereport($branch_id, $category_id = '')
    {
        $builder->select('product.*,product_store.name as store_name,product_supplier.name as supplier_name,product_category.name as category_name, (SELECT sum(quantity) from product_issues_details JOIN product_issues ON product_issues.id = product_issues_details.issues_id where product.id=product_issues_details.product_id AND product_issues.status = 0) as total_issued, (SELECT sum(quantity) from sales_bill_details where product.id=sales_bill_details.product_id) as total_sales, IFNULL(SUM(purchase_bill_details.quantity),0) as in_stock');
        $builder->from('purchase_bill');
        $builder->join('purchase_bill_details', 'purchase_bill_details.purchase_bill_id = purchase_bill.id', 'inner');
        $builder->join('product', 'product.id = purchase_bill_details.product_id', 'inner');
        $builder->join('product_category', 'product_category.id = product.category_id', 'left');
        $builder->join('product_store', 'purchase_bill.store_id = product_store.id', 'left');
        $builder->join('product_supplier', 'purchase_bill.supplier_id = product_supplier.id', 'left');
        $builder->order_by('purchase_bill.id', 'ASC');
        $builder->where('purchase_bill.branch_id', $branch_id);
        if ($category_id != 'all') {
            $builder->where('product.category_id', $category_id);
        }
        $builder->group_by('purchase_bill_details.product_id');
        return $builder->get()->result_array();
    }
    public function get_purchase_report($branch_id, $supplier_id = '', $payment_status = '', $start = '', $end = '')
    {
        $builder->select('purchase_bill.*,product_store.name as store_name,IFNULL(SUM(purchase_bill.total - purchase_bill.discount),0) as net_payable,product_supplier.name as supplier_name');
        $builder->from('purchase_bill');
        $builder->join('product_supplier', 'product_supplier.id = purchase_bill.supplier_id', 'left');
        $builder->join('product_store', 'purchase_bill.store_id = product_store.id', 'left');
        if ($supplier_id != 'all') {
            $builder->where('purchase_bill.supplier_id', $supplier_id);
        }
        if ($payment_status != 'all') {
            $builder->where('purchase_bill.payment_status', $payment_status);
        }
        $builder->where('purchase_bill.date >=', $start);
        $builder->where('purchase_bill.date <=', $end);
        $builder->where('purchase_bill.branch_id', $branch_id);
        $builder->group_by('purchase_bill.id');
        $builder->order_by('purchase_bill.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function get_sales_report($branch_id, $payment_status = '', $start = '', $end = '')
    {
        $builder->select('sales_bill.*,roles.name as role_name,IFNULL(SUM(sales_bill.total - sales_bill.discount),0) as net_payable');
        $builder->from('sales_bill');
        $builder->join('roles', 'roles.id = sales_bill.role_id', 'left');
        if ($payment_status != 'all') {
            $builder->where('purchase_bill.payment_status', $payment_status);
        }
        $builder->where('sales_bill.date >=', $start);
        $builder->where('sales_bill.date <=', $end);
        $builder->where('sales_bill.branch_id', $branch_id);
        $builder->group_by('sales_bill.id');
        $builder->order_by('sales_bill.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function getIssuesreport($branchID = '', $start = '', $end = '')
    {
        $builder->select('product_issues.*,product.name as product_name,roles.name as role_name,product_issues_details.quantity,product_category.name as category_name');
        $builder->from('product_issues_details');
        $builder->join('product_issues', 'product_issues.id = product_issues_details.issues_id', 'inner');
        $builder->join('product', 'product.id = product_issues_details.product_id', 'left');
        $builder->join('product_category', 'product_category.id = product.category_id', 'left');
        $builder->join('roles', 'roles.id = product_issues.role_id', 'left');
        $builder->where('product_issues.date_of_issue >=', $start);
        $builder->where('product_issues.date_of_issue <=', $end);
        $builder->where('product_issues.branch_id', $branchID);
        $builder->order_by('product_issues.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function save_store($data)
    {
        $insertStore = array('name' => $data['store_name'], 'code' => $data['store_code'], 'mobileno' => $data['mobileno'], 'address' => $data['address'], 'description' => $data['description'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (isset($data['store_id']) && !empty($data['store_id'])) {
            $builder->where('id', $data['store_id']);
            $builder->update('product_store', $insertStore);
        } else {
            $builder->insert('product_store', $insertStore);
        }
    }
    public function getProductByBranch($branch_id = '')
    {
        if (!empty($branch_id)) {
            $builder->where('branch_id', $branch_id);
            $result = $builder->get('product')->result_array();
            return $result;
        }
        return "";
    }
    public function save_sales($data)
    {
        $paid = 0;
        $paymentStatus = 1;
        $dueAmount = $data['net_amount'];
        if (!empty($data['payment_amount'])) {
            $paymentStatus = 2;
            $paid = $data['payment_amount'];
            $dueAmount = $data['net_amount'] - $paid;
            if ($data['net_amount'] == $paid) {
                $paymentStatus = 3;
            }
        }
        $arrayInvoice = array('bill_no' => $data['bill_no'], 'role_id' => $data['role_id'], 'user_id' => $data['sale_to'], 'remarks' => $data['payment_remarks'], 'total' => $data['grand_total'], 'discount' => $data['total_discount'], 'due' => $dueAmount, 'paid' => $paid, 'payment_status' => $paymentStatus, 'date' => date('Y-m-d', strtotime($data['date'])), 'prepared_by' => get_loggedin_user_id(), 'modifier_id' => get_loggedin_user_id(), 'branch_id' => $this->applicationModel->get_branch_id());
        $builder->insert('sales_bill', $arrayInvoice);
        $sales_bill_id = $builder->insert_id();
        $arrayData = array();
        $sales = $data['sales'];
        foreach ($sales as $key => $value) {
            $arrayproduct = array('sales_bill_id' => $sales_bill_id, 'product_id' => $value['product'], 'unit_price' => $value['unit_price'], 'discount' => $value['discount'], 'quantity' => $value['quantity'], 'sub_total' => $value['sub_total']);
            $arrayData[] = $arrayproduct;
            //update product available stock
            $this->stock_upgrade($value['quantity'], $value['product'], false);
        }
        $builder->insert_batch('sales_bill_details', $arrayData);
        if (!empty($data['payment_amount'])) {
            $arrayInvoice = array('sales_bill_id' => $sales_bill_id, 'amount' => $data['payment_amount'], 'pay_via' => $data['pay_via'], 'payment_by' => get_loggedin_user_id(), 'remarks' => $data['payment_remarks'], 'coll_type' => 1, 'attach_orig_name' => '', 'attach_file_name' => '', 'paid_on' => date("Y-m-d"));
            $builder->insert('sales_payment_history', $arrayInvoice);
        }
    }
    public function save_issue($data)
    {
        $arrayInvoice = array('role_id' => $data['role_id'], 'user_id' => $data['sale_to'], 'remarks' => $data['remarks'], 'date_of_issue' => date('Y-m-d', strtotime($data['date_of_issue'])), 'due_date' => date('Y-m-d', strtotime($data['due_date'])), 'prepared_by' => get_loggedin_user_id(), 'branch_id' => $this->applicationModel->get_branch_id());
        $builder->insert('product_issues', $arrayInvoice);
        $issues_id = $builder->insert_id();
        $arrayData = array();
        $sales = $data['sales'];
        foreach ($sales as $key => $value) {
            $arrayproduct = array('issues_id' => $issues_id, 'product_id' => $value['product'], 'quantity' => $value['quantity']);
            $arrayData[] = $arrayproduct;
            //update product available stock
            $this->stock_upgrade($value['quantity'], $value['product'], false);
        }
        $builder->insert_batch('product_issues_details', $arrayData);
    }
    public function getSalesList()
    {
        $builder->select('sales_bill.*,roles.name as role_name');
        $builder->from('sales_bill');
        $builder->join('roles', 'roles.id = sales_bill.role_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('sales_bill.id', 'asc');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function getSalesInvoice($id)
    {
        $builder->select('sales_bill.*,staff.name as biller_name,roles.name as role_name');
        $builder->from('sales_bill');
        $builder->join('roles', 'roles.id = sales_bill.role_id', 'left');
        $builder->join('staff', 'staff.id = sales_bill.prepared_by', 'left');
        $builder->where('sales_bill.id', $id);
        if (!is_superadmin_loggedin()) {
            $this->db->table('sales_bill.branch_id', get_loggedin_branch_id())->where();
        }
        return $builder->get()->row_array();
    }
    // add partly of the sales payment
    public function save_sales_payment($data)
    {
        $payment_status = 1;
        $attach_orig_name = "";
        $attach_file_name = "";
        $sales_bill_id = $data['sales_bill_id'];
        $payment_amount = $data['payment_amount'];
        $paid_date = $data['paid_date'];
        // uploading file using codeigniter upload library
        if (isset($_FILES['attach_document']['name']) && !empty($_FILES['attach_document']['name'])) {
            $config['upload_path'] = './uploads/attachments/inventory_payment/';
            $config['allowed_types'] = '*';
            $config['encrypt_name'] = true;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attach_document")) {
                $attach_orig_name = $this->upload->data('orig_name');
                $attach_file_name = $this->upload->data('file_name');
            }
        }
        $array_history = array('sales_bill_id' => $sales_bill_id, 'payment_by' => get_loggedin_user_id(), 'amount' => $payment_amount, 'pay_via' => $this->request->getPost('pay_via'), 'remarks' => $this->request->getPost('remarks'), 'attach_orig_name' => $attach_orig_name, 'attach_file_name' => $attach_file_name, 'coll_type' => 1, 'paid_on' => date("Y-m-d", strtotime($paid_date)));
        $builder->insert('sales_payment_history', $array_history);
        if ($data['getbill']['due'] <= $payment_amount) {
            $payment_status = 3;
        } else {
            $payment_status = 2;
        }
        $sql = "UPDATE `sales_bill` SET `payment_status` = " . $payment_status . ", `paid` = `paid` + " . $payment_amount . ", `due` = `due` - " . $payment_amount . " WHERE `id` = " . $db->escape($sales_bill_id);
        $db->query($sql);
    }
    public function stock_upgrade($quantity, $productID, $add = true)
    {
        if ($add == true) {
            $sql = "UPDATE `product` SET `available_stock` = `available_stock` + " . $quantity . " WHERE `id` = " . $db->escape($productID);
        } else {
            $sql = "UPDATE `product` SET `available_stock` = `available_stock` - " . $quantity . " WHERE `id` = " . $db->escape($productID);
        }
        $db->query($sql);
    }
    public function getIssueList()
    {
        $builder->select('product_issues.*,roles.name as role_name');
        $builder->from('product_issues');
        $builder->join('roles', 'roles.id = product_issues.role_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('product_issues.id', 'asc');
        $result = $builder->get()->result_array();
        return $result;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/AwardModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AwardModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getList($id = '', $row = false)
    {
        $builder->select('award.*,roles.name as role_name');
        $builder->from('award');
        $builder->join('roles', 'roles.id = award.role_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('branch_id', get_loggedin_branch_id())->where();
        }
        $this->db->table('session_id', get_session_id())->where();
        if ($row == false) {
            $result = $builder->get()->result_array();
        } else {
            $builder->where('award.id', $id);
            $result = $builder->get()->row_array();
        }
        return $result;
    }
    public function save($data)
    {
        $insertData = array('name' => $data['award_name'], 'user_id' => $data['user_id'], 'role_id' => $data['role_id'], 'gift_item' => $data['gift_item'], 'award_amount' => $data['cash_price'], 'award_reason' => $data['award_reason'], 'given_date' => date("Y-m-d", strtotime($data['given_date'])), 'session_id' => get_session_id(), 'branch_id' => $this->application_model->get_branch_id());
        $award_id = $this->request->getPost('award_id');
        if (empty($award_id)) {
            $builder->insert('award', $insertData);
        } else {
            $builder->where('id', $award_id);
            $builder->update('award', $insertData);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AwardModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getList($id = '', $row = false)
    {
        $builder->select('award.*,roles.name as role_name');
        $builder->from('award');
        $builder->join('roles', 'roles.id = award.role_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('branch_id', get_loggedin_branch_id())->where();
        }
        $this->db->table('session_id', get_session_id())->where();
        if ($row == false) {
            $result = $builder->get()->result_array();
        } else {
            $builder->where('award.id', $id);
            $result = $builder->get()->row_array();
        }
        return $result;
    }
    public function save($data)
    {
        $insertData = array('name' => $data['award_name'], 'user_id' => $data['user_id'], 'role_id' => $data['role_id'], 'gift_item' => $data['gift_item'], 'award_amount' => $data['cash_price'], 'award_reason' => $data['award_reason'], 'given_date' => date("Y-m-d", strtotime($data['given_date'])), 'session_id' => get_session_id(), 'branch_id' => $this->applicationModel->get_branch_id());
        $award_id = $this->request->getPost('award_id');
        if (empty($award_id)) {
            $builder->insert('award', $insertData);
        } else {
            $builder->where('id', $award_id);
            $builder->update('award', $insertData);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/NewsModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class NewsModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // data save and update function
    public function save($data)
    {
        $insertGallery = array('branch_id' => $this->application_model->get_branch_id(), 'title' => $data['news_title'], 'description' => htmlspecialchars_decode($data['description']), 'date' => date("Y-m-d", strtotime($data['date'])), 'show_web' => isset($_POST['show_website']) ? 1 : 0, 'image' => $this->fileupload('image', './uploads/frontend/news/', $this->request->getPost('old_photo')));
        if (isset($data['news_id']) && !empty($data['news_id'])) {
            unset($insertGallery['elements']);
            $insertGallery['alias'] = $this->slug->create_uri($insertGallery, $data['news_id']);
            $builder->where('id', $data['news_id']);
            $builder->update('front_cms_news_list', $insertGallery);
        } else {
            $insertGallery['alias'] = $this->slug->create_uri($insertGallery);
            $builder->insert('front_cms_news_list', $insertGallery);
        }
    }
    public function get_image_url($file_path = '')
    {
        $path = 'uploads/frontend/news/' . $file_path;
        if (empty($file_path) || !file_exists($path)) {
            $image_url = base_url('uploads/frontend/news/defualt.png');
        } else {
            $image_url = base_url($path);
        }
        return $image_url;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class NewsModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // data save and update function
    public function save($data)
    {
        $insertGallery = array('branch_id' => $this->applicationModel->get_branch_id(), 'title' => $data['news_title'], 'description' => htmlspecialchars_decode($data['description']), 'date' => date("Y-m-d", strtotime($data['date'])), 'show_web' => isset($_POST['show_website']) ? 1 : 0, 'image' => $this->fileupload('image', './uploads/frontend/news/', $this->request->getPost('old_photo')));
        if (isset($data['news_id']) && !empty($data['news_id'])) {
            unset($insertGallery['elements']);
            $insertGallery['alias'] = $this->slug->create_uri($insertGallery, $data['news_id']);
            $builder->where('id', $data['news_id']);
            $builder->update('front_cms_news_list', $insertGallery);
        } else {
            $insertGallery['alias'] = $this->slug->create_uri($insertGallery);
            $builder->insert('front_cms_news_list', $insertGallery);
        }
    }
    public function get_image_url($file_path = '')
    {
        $path = 'uploads/frontend/news/' . $file_path;
        if (empty($file_path) || !file_exists($path)) {
            $image_url = base_url('uploads/frontend/news/defualt.png');
        } else {
            $image_url = base_url($path);
        }
        return $image_url;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/AuthenticationModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AuthenticationModel extends MYModel
{
    public function __construct()
    {
        $this->db = \Config\Database::connect();
    }

    protected $db;

    // checking login credential
    public function login_credential($username, $password)
    {

        $builder->select('*');
        $builder->from('login_credential');
        $builder->where('username', $username);
        $builder->limit(1);
        $query = $builder->get();
        if ($query->num_rows() == 1) {
            $verify_password = $this->app_lib->verify_password($password, $query->row()->password);
            if ($verify_password) {
                return $query->row();
            }
        }
        return false;
    }
    // password forgotten
    public function lose_password($username)
    {
        if (!empty($username)) {
            $builder->select('*');
            $builder->from('login_credential');
            $builder->where('username', $username);
            $builder->limit(1);
            $query = $builder->get();
            if ($query->num_rows() > 0) {
                $login_credential = $query->row();
                $getUser = $this->application_model->getUserNameByRoleID($login_credential->role, $login_credential->user_id);
                $key = hash('sha512', $login_credential->role . $login_credential->username . app_generate_hash());
                $query = $builder->getWhere('reset_password', array('login_credential_id' => $login_credential->id));
                if ($query->num_rows() > 0) {
                    $builder->where('login_credential_id', $login_credential->id);
                    $builder->delete('reset_password');
                }
                $arrayReset = array('key' => $key, 'login_credential_id' => $login_credential->id, 'username' => $login_credential->username);
                $builder->insert('reset_password', $arrayReset);
                // send email for forgot password
                $this->model('email_model');
                $arrayData = array('role' => $login_credential->role, 'branch_id' => $getUser['branch_id'], 'username' => $login_credential->username, 'name' => $getUser['name'], 'reset_url' => base_url('authentication/pwreset?key=' . $key), 'email' => $getUser['email']);
                $this->email_model->sentForgotPassword($arrayData);
                return true;
            }
        }
        return false;
    }
    public function urlaliasToBranch($url_alias)
    {
        $saasExisting = $this->app_lib->isExistingAddon('saas');
        if ($saasExisting && $this->db->table_exists("custom_domain")) {
            $getDomain = $this->getCurrentDomain();
            if (!empty($getDomain)) {
                return $getDomain->school_id;
            }
        }
        $get = $db->table('front_cms_setting')->get('front_cms_setting')->row_array();
        if (empty($url_alias) || empty($get)) {
            return null;
        } else {
            return $get['branch_id'];
        }
    }
    public function getSegment($id = '')
    {
        $segment = $this->uri->segment($id);
        if (empty($segment)) {
            return '';
        } else {
            return $segment . '/';
        }
    }
    public function getCurrentDomain()
    {
        $url = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://{$_SERVER['HTTP_HOST']}{$_SERVER['REQUEST_URI']}";
        $url = rtrim($url, '/');
        $domain = parse_url($url, PHP_URL_HOST);
        if (substr($domain, 0, 4) == 'www.') {
            $domain = str_replace('www.', '', $domain);
        }
        $getDomain = $builder->select('school_id')->get_where('custom_domain', array('status' => 1, 'url' => $domain))->row();
        return $getDomain;
    }
    public function getSchoolDeatls($url_alias = '')
    {
        if (!empty($url_alias)) {
            $builder->select('fs.facebook_url,fs.twitter_url,fs.linkedin_url,fs.youtube_url,branch.address,branch.school_name');
            $builder->from('front_cms_setting as fs');
            $builder->join('branch', 'branch.id = fs.branch_id', 'left');
            $builder->where('fs.url_alias', $url_alias);
            $get = $builder->get()->row();
            if (empty($get)) {
                return '';
            } else {
                return $get;
            }
        } else {
            return '';
        }
    }
    public function getStudentLoginStatus($id = '')
    {
        $get = $db->table('branch')->get('branch')->row()->login;
        return $get;
    }
    public function getParentLoginStatus($id = '')
    {
        $get = $db->table('branch')->get('branch')->row()->login;
        return $get;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AuthenticationModel extends MYModel
{
    public function __construct()
    {
        $this->db = \Config\Database::connect();
    }

    protected $db;

    // checking login credential
    public function login_credential($username, $password)
    {

        $builder->select('*');
        $builder->from('login_credential');
        $builder->where('username', $username);
        $builder->limit(1);
        $query = $builder->get();
        if ($query->num_rows() == 1) {
            $verify_password = $this->app_lib->verify_password($password, $query->row()->password);
            if ($verify_password) {
                return $query->row();
            }
        }
        return false;
    }
    // password forgotten
    public function lose_password($username)
    {
        if (!empty($username)) {
            $builder->select('*');
            $builder->from('login_credential');
            $builder->where('username', $username);
            $builder->limit(1);
            $query = $builder->get();
            if ($query->num_rows() > 0) {
                $login_credential = $query->row();
                $getUser = $this->applicationModel->getUserNameByRoleID($login_credential->role, $login_credential->user_id);
                $key = hash('sha512', $login_credential->role . $login_credential->username . app_generate_hash());
                $query = $builder->getWhere('reset_password', array('login_credential_id' => $login_credential->id));
                if ($query->num_rows() > 0) {
                    $builder->where('login_credential_id', $login_credential->id);
                    $builder->delete('reset_password');
                }
                $arrayReset = array('key' => $key, 'login_credential_id' => $login_credential->id, 'username' => $login_credential->username);
                $builder->insert('reset_password', $arrayReset);
                // send email for forgot password
                $this->model('email_model');
                $arrayData = array('role' => $login_credential->role, 'branch_id' => $getUser['branch_id'], 'username' => $login_credential->username, 'name' => $getUser['name'], 'reset_url' => base_url('authentication/pwreset?key=' . $key), 'email' => $getUser['email']);
                $this->email_model->sentForgotPassword($arrayData);
                return true;
            }
        }
        return false;
    }
    public function urlaliasToBranch($url_alias)
    {
        $saasExisting = $this->app_lib->isExistingAddon('saas');
        if ($saasExisting && $this->db->table_exists("custom_domain")) {
            $getDomain = $this->getCurrentDomain();
            if (!empty($getDomain)) {
                return $getDomain->school_id;
            }
        }
        $get = $db->table('front_cms_setting')->get('front_cms_setting')->row_array();
        if (empty($url_alias) || empty($get)) {
            return null;
        } else {
            return $get['branch_id'];
        }
    }
    public function getSegment($id = '')
    {
        $segment = $this->uri->segment($id);
        if (empty($segment)) {
            return '';
        } else {
            return $segment . '/';
        }
    }
    public function getCurrentDomain()
    {
        $url = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://{$_SERVER['HTTP_HOST']}{$_SERVER['REQUEST_URI']}";
        $url = rtrim($url, '/');
        $domain = parse_url($url, PHP_URL_HOST);
        if (substr($domain, 0, 4) == 'www.') {
            $domain = str_replace('www.', '', $domain);
        }
        $getDomain = $builder->select('school_id')->get_where('custom_domain', array('status' => 1, 'url' => $domain))->row();
        return $getDomain;
    }
    public function getSchoolDeatls($url_alias = '')
    {
        if (!empty($url_alias)) {
            $builder->select('fs.facebook_url,fs.twitter_url,fs.linkedin_url,fs.youtube_url,branch.address,branch.school_name');
            $builder->from('front_cms_setting as fs');
            $builder->join('branch', 'branch.id = fs.branch_id', 'left');
            $builder->where('fs.url_alias', $url_alias);
            $get = $builder->get()->row();
            if (empty($get)) {
                return '';
            } else {
                return $get;
            }
        } else {
            return '';
        }
    }
    public function getStudentLoginStatus($id = '')
    {
        $get = $db->table('branch')->get('branch')->row()->login;
        return $get;
    }
    public function getParentLoginStatus($id = '')
    {
        $get = $db->table('branch')->get('branch')->row()->login;
        return $get;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/EmailModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class EmailModel extends Model
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
        $this->mailer = service('mailer');
    }
    public function sentStaffRegisteredAccount($data)
    {
        $emailTemplate = $this->getEmailTemplates(1);
        if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
            $role_name = get_type_name_by_id('roles', $data['user_role']);
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{name}", $data['name'], $message);
            $message = str_replace("{login_username}", $data['username'], $message);
            $message = str_replace("{password}", $data['password'], $message);
            $message = str_replace("{user_role}", $role_name, $message);
            $message = str_replace("{login_url}", base_url(), $message);
            $msgData['recipient'] = $data['email'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function sentStaffSalaryPay($data)
    {
        $emailTemplate = $this->getEmailTemplates(5);
        if ($emailTemplate['notified'] == 1 && !empty($data['recipient'])) {
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_type_name_by_id('branch', $data['branch_id']), $message);
            $message = str_replace("{name}", $data['name'], $message);
            $message = str_replace("{month_year}", $data['month_year'], $message);
            $message = str_replace("{payslip_no}", $data['payslip_no'], $message);
            $message = str_replace("{payslip_url}", $data['payslip_url'], $message);
            $msgData['recipient'] = $data['recipient'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function sentAdvanceSalary($data)
    {
        $email_alert = false;
        if ($data['status'] == 2) {
            //send advance salary approve email
            $emailTemplate = $this->getEmailTemplates(9, $data['branch_id']);
            if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
                $email_alert = true;
            }
        } elseif ($data['status'] == 3) {
            //send advance salary reject email
            $emailTemplate = $this->getEmailTemplates(10, $data['branch_id']);
            if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
                $email_alert = true;
            }
        }
        if ($email_alert == true) {
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{applicant_name}", $data['staff_name'], $message);
            $message = str_replace("{deduct_motnh}", date("F Y", strtotime($data['deduct_motnh'])), $message);
            $message = str_replace("{comments}", $data['comments'], $message);
            $message = str_replace("{amount}", $data['amount'], $message);
            $msgData['branch_id'] = $data['branch_id'];
            $msgData['recipient'] = $data['email'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function sentLeaveRequest($data)
    {
        $email_alert = false;
        if ($data['status'] == 2) {
            //send leave salary approve email
            $emailTemplate = $this->getEmailTemplates(7);
            if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
                $email_alert = true;
            }
        } elseif ($data['status'] == 3) {
            //send leave salary reject email
            $emailTemplate = $this->getEmailTemplates(8);
            if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
                $email_alert = true;
            }
        }
        if ($email_alert == true) {
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{applicant_name}", $data['applicant'], $message);
            $message = str_replace("{start_date}", _d($data['start_date']), $message);
            $message = str_replace("{end_date}", _d($data['end_date']), $message);
            $message = str_replace("{comments}", $data['comments'], $message);
            $msgData['recipient'] = $data['email'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function sentAward($data)
    {
        $emailTemplate = $this->getEmailTemplates(6);
        if ($emailTemplate['notified'] == 1) {
            $userdata = $this->application_model->getUserNameByRoleID($data['role_id'], $data['user_id']);
            if (!empty($userdata['email'])) {
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
                $message = str_replace("{winner_name}", $userdata['name'], $message);
                $message = str_replace("{award_name}", $data['award_name'], $message);
                $message = str_replace("{gift_item}", $data['gift_item'], $message);
                $message = str_replace("{award_reason}", $data['award_reason'], $message);
                $message = str_replace("{given_date}", date("Y-m-d", strtotime($data['given_date'])), $message);
                $msgData['recipient'] = $userdata['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                return $this->sendEmail($msgData);
            }
        }
    }
    public function onlineExamPublish($data)
    {
        $emailTemplate = $this->getEmailTemplates(13, $data['branch_id']);
        if ($emailTemplate['notified'] == 1) {
            if (!empty($data['email'])) {
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $data['branch_id']), $message);
                $message = str_replace("{roll}", $data['roll'], $message);
                $message = str_replace("{student_name}", $data['fullname'], $message);
                $message = str_replace("{student_mobile}", $data['mobileno'], $message);
                $message = str_replace("{class}", $data['class_name'], $message);
                $message = str_replace("{section}", $data['section_name'], $message);
                $message = str_replace('{exam_title}', $data['exam_title'], $message);
                $message = str_replace('{start_time}', $data['start_time'], $message);
                $message = str_replace('{end_time}', $data['end_time'], $message);
                $message = str_replace('{time_duration}', $data['time_duration'], $message);
                $message = str_replace('{attempt}', $data['attempt'], $message);
                $message = str_replace('{passing_mark}', $data['passing_mark'], $message);
                $message = str_replace('{exam_fee}', $data['exam_fee'], $message);
                $msgData['recipient'] = $data['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                $msgData['branch_id'] = $data['branch_id'];
                return $this->sendEmail($msgData);
            }
        }
    }
    public function onlineAdmission($data)
    {
        $emailTemplate = $this->getEmailTemplates(11, $data['branch_id']);
        if ($emailTemplate['notified'] == 1) {
            if (!empty($data['email'])) {
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", $data['institute_name'], $message);
                $message = str_replace("{applicant_name}", $data['student_name'], $message);
                $message = str_replace("{reference_no}", $data['reference_no'], $message);
                $message = str_replace("{applicant_mobile}", $data['mobile_no'], $message);
                $message = str_replace("{class}", $data['class_name'], $message);
                $message = str_replace("{section}", $data['section_name'], $message);
                $message = str_replace("{apply_date}", date("Y-m-d", strtotime($data['apply_date'])), $message);
                $message = str_replace("{payment_url}", $data['payment_url'], $message);
                $message = str_replace("{admission_copy_url}", $data['admission_copy_url'], $message);
                $message = str_replace("{paid_amount}", $data['paid_amount'], $message);
                $msgData['recipient'] = $data['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                $msgData['branch_id'] = $data['branch_id'];
                return $this->sendEmail($msgData);
            }
        }
    }
    public function studentAdmission($data)
    {
        $emailTemplate = $this->getEmailTemplates(12);
        if ($emailTemplate['notified'] == 1) {
            if (!empty($data['email'])) {
                $student = $this->application_model->getStudentDetails($data['student_id']);
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $student['branch_id']), $message);
                $message = str_replace("{academic_year}", get_type_name_by_id('schoolyear', $student['session_id'], 'school_year'), $message);
                $message = str_replace("{admission_date}", $student['admission_date'], $message);
                $message = str_replace("{admission_no}", $student['register_no'], $message);
                $message = str_replace("{roll}", $student['roll'], $message);
                $message = str_replace("{category}", $student['category_name'], $message);
                $message = str_replace("{student_name}", $student['first_name'] . " " . $student['last_name'], $message);
                $message = str_replace("{student_mobile}", $student['mobileno'], $message);
                $message = str_replace("{login_username}", $data['username'], $message);
                $message = str_replace("{password}", $data['password'], $message);
                $message = str_replace("{login_url}", base_url(), $message);
                $message = str_replace("{class}", $student['class_name'], $message);
                $message = str_replace("{section}", $student['section_name'], $message);
                $msgData['recipient'] = $data['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                $msgData['branch_id'] = $data['branch_id'];
                return $this->sendEmail($msgData);
            }
        }
    }
    public function changePassword($data)
    {
        $emailTemplate = $this->getEmailTemplates(3, $data['branch_id']);
        if ($emailTemplate['notified'] == 1) {
            $user = $this->application_model->getUserNameByRoleID(loggedin_role_id(), get_loggedin_user_id());
            if (!empty($user['email'])) {
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $data['branch_id']), $message);
                $message = str_replace("{name}", $user['name'], $message);
                $message = str_replace("{email}", $user['email'], $message);
                $message = str_replace("{password}", $data['password'], $message);
                $msgData['recipient'] = $user['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                $msgData['branch_id'] = $data['branch_id'];
                return $this->sendEmail($msgData);
            }
        }
    }
    public function sentForgotPassword($data)
    {
        $emailTemplate = $db->table('email_templates_details')->get('email_templates_details')->row_array();
        if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{username}", $data['username'], $message);
            $message = str_replace("{name}", $data['name'], $message);
            $message = str_replace("{reset_url}", $data['reset_url'], $message);
            $message = str_replace("{email}", $data['email'], $message);
            $msgData['branch_id'] = $data['branch_id'];
            $msgData['recipient'] = $data['email'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function emailPDFexam_marksheet($data)
    {
        $emailTemplate = $this->getEmailTemplates(13);
        if ($emailTemplate['notified'] == 1) {
            $student = $this->application_model->getStudentDetails($data['enroll_id'], true);
            if (!empty($student['email'])) {
                $message = $emailTemplate['template_body'];
                $student_name = $student['first_name'] . " " . $student['last_name'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $student['branch_id']), $message);
                $message = str_replace("{academic_year}", get_type_name_by_id('schoolyear', $student['session_id'], 'school_year'), $message);
                $message = str_replace("{admission_date}", $student['admission_date'], $message);
                $message = str_replace("{admission_no}", $student['register_no'], $message);
                $message = str_replace("{roll}", $student['roll'], $message);
                $message = str_replace("{exam_name}", $data['exam_name'], $message);
                $message = str_replace("{student_name}", $student_name, $message);
                $message = str_replace("{class}", $student['class_name'], $message);
                $message = str_replace("{section}", $student['section_name'], $message);
                $msgData['recipient'] = $student['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['file'] = $data['file'];
                $msgData['file_name'] = $student_name . "_" . $student['register_no'] . "_" . $data['exam_name'] . ".pdf";
                $msgData['message'] = $message;
                return $this->sendEmail($msgData);
            }
        }
    }
    public function emailPDF_Fee_invoice($data)
    {
        $emailTemplate = $this->getEmailTemplates(14);
        if ($emailTemplate['notified'] == 1) {
            $student = $this->application_model->getStudentDetails($data['enroll_id'], true);
            if (!empty($student['email'])) {
                $message = $emailTemplate['template_body'];
                $student_name = $student['first_name'] . " " . $student['last_name'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $student['branch_id']), $message);
                $message = str_replace("{academic_year}", get_type_name_by_id('schoolyear', $student['session_id'], 'school_year'), $message);
                $message = str_replace("{admission_date}", $student['admission_date'], $message);
                $message = str_replace("{admission_no}", $student['register_no'], $message);
                $message = str_replace("{roll}", $student['roll'], $message);
                $message = str_replace("{today_date}", _d(date("Y-m-d")), $message);
                $message = str_replace("{student_name}", $student_name, $message);
                $message = str_replace("{class}", $student['class_name'], $message);
                $message = str_replace("{section}", $student['section_name'], $message);
                $msgData['recipient'] = $student['email'];
                $msgData['branch_id'] = $student['branch_id'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['file'] = $data['file'];
                $msgData['file_name'] = $student_name . "_" . $student['register_no'] . $student['class_name'] . " (" . $student['section_name'] . ")_Fee_Invoice.pdf";
                $msgData['message'] = $message;
                return $this->sendEmail($msgData);
            }
        }
    }
    public function sendEmail($data)
    {
        if (empty($data['branch_id'])) {
            $data['branch_id'] = $this->application_model->get_branch_id();
        }
        if ($this->mailer->send($data)) {
            return true;
        } else {
            return false;
        }
    }
    public function getEmailTemplates($id, $branchID = '')
    {
        if (empty($branchID)) {
            $branchID = $this->application_model->get_branch_id();
        }
        $builder->select('td.*');
        $builder->from('email_templates_details as td');
        $builder->where('td.template_id', $id);
        $builder->where('td.branch_id', $branchID);
        $result = $builder->get()->row_array();
        if (empty($result)) {
            $array = array('notified' => '', 'template_body' => '', 'subject' => '');
            return $array;
        } else {
            return $result;
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class EmailModel extends Model
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
        $this->mailer = service('mailer');
    }
    public function sentStaffRegisteredAccount($data)
    {
        $emailTemplate = $this->getEmailTemplates(1);
        if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
            $role_name = get_type_name_by_id('roles', $data['user_role']);
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{name}", $data['name'], $message);
            $message = str_replace("{login_username}", $data['username'], $message);
            $message = str_replace("{password}", $data['password'], $message);
            $message = str_replace("{user_role}", $role_name, $message);
            $message = str_replace("{login_url}", base_url(), $message);
            $msgData['recipient'] = $data['email'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function sentStaffSalaryPay($data)
    {
        $emailTemplate = $this->getEmailTemplates(5);
        if ($emailTemplate['notified'] == 1 && !empty($data['recipient'])) {
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_type_name_by_id('branch', $data['branch_id']), $message);
            $message = str_replace("{name}", $data['name'], $message);
            $message = str_replace("{month_year}", $data['month_year'], $message);
            $message = str_replace("{payslip_no}", $data['payslip_no'], $message);
            $message = str_replace("{payslip_url}", $data['payslip_url'], $message);
            $msgData['recipient'] = $data['recipient'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function sentAdvanceSalary($data)
    {
        $email_alert = false;
        if ($data['status'] == 2) {
            //send advance salary approve email
            $emailTemplate = $this->getEmailTemplates(9, $data['branch_id']);
            if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
                $email_alert = true;
            }
        } elseif ($data['status'] == 3) {
            //send advance salary reject email
            $emailTemplate = $this->getEmailTemplates(10, $data['branch_id']);
            if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
                $email_alert = true;
            }
        }
        if ($email_alert == true) {
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{applicant_name}", $data['staff_name'], $message);
            $message = str_replace("{deduct_motnh}", date("F Y", strtotime($data['deduct_motnh'])), $message);
            $message = str_replace("{comments}", $data['comments'], $message);
            $message = str_replace("{amount}", $data['amount'], $message);
            $msgData['branch_id'] = $data['branch_id'];
            $msgData['recipient'] = $data['email'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function sentLeaveRequest($data)
    {
        $email_alert = false;
        if ($data['status'] == 2) {
            //send leave salary approve email
            $emailTemplate = $this->getEmailTemplates(7);
            if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
                $email_alert = true;
            }
        } elseif ($data['status'] == 3) {
            //send leave salary reject email
            $emailTemplate = $this->getEmailTemplates(8);
            if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
                $email_alert = true;
            }
        }
        if ($email_alert == true) {
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{applicant_name}", $data['applicant'], $message);
            $message = str_replace("{start_date}", _d($data['start_date']), $message);
            $message = str_replace("{end_date}", _d($data['end_date']), $message);
            $message = str_replace("{comments}", $data['comments'], $message);
            $msgData['recipient'] = $data['email'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function sentAward($data)
    {
        $emailTemplate = $this->getEmailTemplates(6);
        if ($emailTemplate['notified'] == 1) {
            $userdata = $this->applicationModel->getUserNameByRoleID($data['role_id'], $data['user_id']);
            if (!empty($userdata['email'])) {
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
                $message = str_replace("{winner_name}", $userdata['name'], $message);
                $message = str_replace("{award_name}", $data['award_name'], $message);
                $message = str_replace("{gift_item}", $data['gift_item'], $message);
                $message = str_replace("{award_reason}", $data['award_reason'], $message);
                $message = str_replace("{given_date}", date("Y-m-d", strtotime($data['given_date'])), $message);
                $msgData['recipient'] = $userdata['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                return $this->sendEmail($msgData);
            }
        }
    }
    public function onlineExamPublish($data)
    {
        $emailTemplate = $this->getEmailTemplates(13, $data['branch_id']);
        if ($emailTemplate['notified'] == 1) {
            if (!empty($data['email'])) {
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $data['branch_id']), $message);
                $message = str_replace("{roll}", $data['roll'], $message);
                $message = str_replace("{student_name}", $data['fullname'], $message);
                $message = str_replace("{student_mobile}", $data['mobileno'], $message);
                $message = str_replace("{class}", $data['class_name'], $message);
                $message = str_replace("{section}", $data['section_name'], $message);
                $message = str_replace('{exam_title}', $data['exam_title'], $message);
                $message = str_replace('{start_time}', $data['start_time'], $message);
                $message = str_replace('{end_time}', $data['end_time'], $message);
                $message = str_replace('{time_duration}', $data['time_duration'], $message);
                $message = str_replace('{attempt}', $data['attempt'], $message);
                $message = str_replace('{passing_mark}', $data['passing_mark'], $message);
                $message = str_replace('{exam_fee}', $data['exam_fee'], $message);
                $msgData['recipient'] = $data['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                $msgData['branch_id'] = $data['branch_id'];
                return $this->sendEmail($msgData);
            }
        }
    }
    public function onlineAdmission($data)
    {
        $emailTemplate = $this->getEmailTemplates(11, $data['branch_id']);
        if ($emailTemplate['notified'] == 1) {
            if (!empty($data['email'])) {
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", $data['institute_name'], $message);
                $message = str_replace("{applicant_name}", $data['student_name'], $message);
                $message = str_replace("{reference_no}", $data['reference_no'], $message);
                $message = str_replace("{applicant_mobile}", $data['mobile_no'], $message);
                $message = str_replace("{class}", $data['class_name'], $message);
                $message = str_replace("{section}", $data['section_name'], $message);
                $message = str_replace("{apply_date}", date("Y-m-d", strtotime($data['apply_date'])), $message);
                $message = str_replace("{payment_url}", $data['payment_url'], $message);
                $message = str_replace("{admission_copy_url}", $data['admission_copy_url'], $message);
                $message = str_replace("{paid_amount}", $data['paid_amount'], $message);
                $msgData['recipient'] = $data['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                $msgData['branch_id'] = $data['branch_id'];
                return $this->sendEmail($msgData);
            }
        }
    }
    public function studentAdmission($data)
    {
        $emailTemplate = $this->getEmailTemplates(12);
        if ($emailTemplate['notified'] == 1) {
            if (!empty($data['email'])) {
                $student = $this->applicationModel->getStudentDetails($data['student_id']);
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $student['branch_id']), $message);
                $message = str_replace("{academic_year}", get_type_name_by_id('schoolyear', $student['session_id'], 'school_year'), $message);
                $message = str_replace("{admission_date}", $student['admission_date'], $message);
                $message = str_replace("{admission_no}", $student['register_no'], $message);
                $message = str_replace("{roll}", $student['roll'], $message);
                $message = str_replace("{category}", $student['category_name'], $message);
                $message = str_replace("{student_name}", $student['first_name'] . " " . $student['last_name'], $message);
                $message = str_replace("{student_mobile}", $student['mobileno'], $message);
                $message = str_replace("{login_username}", $data['username'], $message);
                $message = str_replace("{password}", $data['password'], $message);
                $message = str_replace("{login_url}", base_url(), $message);
                $message = str_replace("{class}", $student['class_name'], $message);
                $message = str_replace("{section}", $student['section_name'], $message);
                $msgData['recipient'] = $data['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                $msgData['branch_id'] = $data['branch_id'];
                return $this->sendEmail($msgData);
            }
        }
    }
    public function changePassword($data)
    {
        $emailTemplate = $this->getEmailTemplates(3, $data['branch_id']);
        if ($emailTemplate['notified'] == 1) {
            $user = $this->applicationModel->getUserNameByRoleID(loggedin_role_id(), get_loggedin_user_id());
            if (!empty($user['email'])) {
                $message = $emailTemplate['template_body'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $data['branch_id']), $message);
                $message = str_replace("{name}", $user['name'], $message);
                $message = str_replace("{email}", $user['email'], $message);
                $message = str_replace("{password}", $data['password'], $message);
                $msgData['recipient'] = $user['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['message'] = $message;
                $msgData['branch_id'] = $data['branch_id'];
                return $this->sendEmail($msgData);
            }
        }
    }
    public function sentForgotPassword($data)
    {
        $emailTemplate = $db->table('email_templates_details')->get('email_templates_details')->row_array();
        if ($emailTemplate['notified'] == 1 && !empty($data['email'])) {
            $message = $emailTemplate['template_body'];
            $message = str_replace("{institute_name}", get_global_setting('institute_name'), $message);
            $message = str_replace("{username}", $data['username'], $message);
            $message = str_replace("{name}", $data['name'], $message);
            $message = str_replace("{reset_url}", $data['reset_url'], $message);
            $message = str_replace("{email}", $data['email'], $message);
            $msgData['branch_id'] = $data['branch_id'];
            $msgData['recipient'] = $data['email'];
            $msgData['subject'] = $emailTemplate['subject'];
            $msgData['message'] = $message;
            return $this->sendEmail($msgData);
        }
    }
    public function emailPDFexam_marksheet($data)
    {
        $emailTemplate = $this->getEmailTemplates(13);
        if ($emailTemplate['notified'] == 1) {
            $student = $this->applicationModel->getStudentDetails($data['enroll_id'], true);
            if (!empty($student['email'])) {
                $message = $emailTemplate['template_body'];
                $student_name = $student['first_name'] . " " . $student['last_name'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $student['branch_id']), $message);
                $message = str_replace("{academic_year}", get_type_name_by_id('schoolyear', $student['session_id'], 'school_year'), $message);
                $message = str_replace("{admission_date}", $student['admission_date'], $message);
                $message = str_replace("{admission_no}", $student['register_no'], $message);
                $message = str_replace("{roll}", $student['roll'], $message);
                $message = str_replace("{exam_name}", $data['exam_name'], $message);
                $message = str_replace("{student_name}", $student_name, $message);
                $message = str_replace("{class}", $student['class_name'], $message);
                $message = str_replace("{section}", $student['section_name'], $message);
                $msgData['recipient'] = $student['email'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['file'] = $data['file'];
                $msgData['file_name'] = $student_name . "_" . $student['register_no'] . "_" . $data['exam_name'] . ".pdf";
                $msgData['message'] = $message;
                return $this->sendEmail($msgData);
            }
        }
    }
    public function emailPDF_Fee_invoice($data)
    {
        $emailTemplate = $this->getEmailTemplates(14);
        if ($emailTemplate['notified'] == 1) {
            $student = $this->applicationModel->getStudentDetails($data['enroll_id'], true);
            if (!empty($student['email'])) {
                $message = $emailTemplate['template_body'];
                $student_name = $student['first_name'] . " " . $student['last_name'];
                $message = str_replace("{institute_name}", get_type_name_by_id('branch', $student['branch_id']), $message);
                $message = str_replace("{academic_year}", get_type_name_by_id('schoolyear', $student['session_id'], 'school_year'), $message);
                $message = str_replace("{admission_date}", $student['admission_date'], $message);
                $message = str_replace("{admission_no}", $student['register_no'], $message);
                $message = str_replace("{roll}", $student['roll'], $message);
                $message = str_replace("{today_date}", _d(date("Y-m-d")), $message);
                $message = str_replace("{student_name}", $student_name, $message);
                $message = str_replace("{class}", $student['class_name'], $message);
                $message = str_replace("{section}", $student['section_name'], $message);
                $msgData['recipient'] = $student['email'];
                $msgData['branch_id'] = $student['branch_id'];
                $msgData['subject'] = $emailTemplate['subject'];
                $msgData['file'] = $data['file'];
                $msgData['file_name'] = $student_name . "_" . $student['register_no'] . $student['class_name'] . " (" . $student['section_name'] . ")_Fee_Invoice.pdf";
                $msgData['message'] = $message;
                return $this->sendEmail($msgData);
            }
        }
    }
    public function sendEmail($data)
    {
        if (empty($data['branch_id'])) {
            $data['branch_id'] = $this->applicationModel->get_branch_id();
        }
        if ($this->mailer->send($data)) {
            return true;
        } else {
            return false;
        }
    }
    public function getEmailTemplates($id, $branchID = '')
    {
        if (empty($branchID)) {
            $branchID = $this->applicationModel->get_branch_id();
        }
        $builder->select('td.*');
        $builder->from('email_templates_details as td');
        $builder->where('td.template_id', $id);
        $builder->where('td.branch_id', $branchID);
        $result = $builder->get()->row_array();
        if (empty($result)) {
            $array = array('notified' => '', 'template_body' => '', 'subject' => '');
            return $array;
        } else {
            return $result;
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/EmployeeModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class EmployeeModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // moderator employee all information
    public function save($data, $role = null, $id = null)
    {
        $inser_data1 = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['name'], 'sex' => $data['sex'], 'religion' => $data['religion'], 'blood_group' => $data['blood_group'], 'birthday' => $data["birthday"], 'mobileno' => $data['mobile_no'], 'present_address' => $data['present_address'], 'permanent_address' => $data['permanent_address'], 'photo' => $this->uploadImage('staff'), 'designation' => $data['designation_id'], 'department' => $data['department_id'], 'joining_date' => date("Y-m-d", strtotime($data['joining_date'])), 'qualification' => $data['qualification'], 'experience_details' => $data['experience_details'], 'total_experience' => $data['total_experience'], 'email' => $data['email'], 'facebook_url' => $data['facebook'], 'linkedin_url' => $data['linkedin'], 'twitter_url' => $data['twitter']);
        $inser_data2 = array('username' => $data["username"], 'role' => $data["user_role"]);
        if (!isset($data['staff_id']) && empty($data['staff_id'])) {
            // RANDOM STAFF ID GENERATE
            $inser_data1['staff_id'] = substr(app_generate_hash(), 3, 7);
            // SAVE EMPLOYEE INFORMATION IN THE DATABASE
            $builder->insert('staff', $inser_data1);
            $employeeID = $builder->insert_id();
            // SAVE EMPLOYEE LOGIN CREDENTIAL INFORMATION IN THE DATABASE
            $inser_data2['active'] = 1;
            $inser_data2['user_id'] = $employeeID;
            $inser_data2['password'] = $this->app_lib->pass_hashed($data["password"]);
            $builder->insert('login_credential', $inser_data2);
            // SAVE USER BANK INFORMATION IN THE DATABASE
            if (!isset($data['chkskipped'])) {
                $data['staff_id'] = $employeeID;
                $this->bankSave($data);
            }
            return $employeeID;
        } else {
            $inser_data1['staff_id'] = $data['staff_id_no'];
            // UPDATE ALL INFORMATION IN THE DATABASE
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['staff_id']);
            $builder->update('staff', $inser_data1);
            // UPDATE LOGIN CREDENTIAL INFORMATION IN THE DATABASE
            $builder->where('user_id', $data['staff_id']);
            $this->db->where_not_in('role', array(6, 7));
            $builder->update('login_credential', $inser_data2);
        }
    }
    // GET SINGLE EMPLOYEE DETAILS
    public function getSingleStaff($id = '')
    {
        $builder->select('staff.*,staff_designation.name as designation_name,staff_department.name as department_name,login_credential.role as role_id,login_credential.active,login_credential.username, roles.name as role');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != "6" and login_credential.role != "7"', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->where('staff.id', $id);
        if (!is_superadmin_loggedin()) {
            $this->db->table('staff.branch_id', get_loggedin_branch_id())->where();
        }
        $query = $builder->get();
        if ($query->num_rows() == 0) {
            show_404();
        }
        return $query->row_array();
    }
    // get staff all list
    public function getStaffList($branchID = '', $role_id = '', $active = 1)
    {
        $builder->select('staff.*,staff_designation.name as designation_name,staff_department.name as department_name,login_credential.role as role_id, roles.name as role');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != "6" and login_credential.role != "7"', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        if ($branchID != "") {
            $builder->where('staff.branch_id', $branchID);
        }
        $builder->where('login_credential.role', $role_id);
        $builder->where('login_credential.active', $active);
        $builder->order_by('staff.id', 'ASC');
        return $builder->get()->getResult();
    }
    public function get_schedule_by_id($id)
    {
        $builder->select('timetable_class.*,subject.name as subject_name,class.name as class_name,section.name as section_name');
        $builder->from('timetable_class');
        $builder->join('subject', 'subject.id = timetable_class.subject_id', 'inner');
        $builder->join('class', 'class.id = timetable_class.class_id', 'inner');
        $builder->join('section', 'section.id = timetable_class.section_id', 'inner');
        $builder->where('timetable_class.teacher_id', $id);
        $this->db->table('timetable_class.session_id', get_session_id())->where();
        return $builder->get();
    }
    public function bankSave($data)
    {
        $inser_data = array('staff_id' => $data['staff_id'], 'bank_name' => $data['bank_name'], 'holder_name' => $data['holder_name'], 'bank_branch' => $data['bank_branch'], 'bank_address' => $data['bank_address'], 'ifsc_code' => $data['ifsc_code'], 'account_no' => $data['account_no']);
        if (isset($data['bank_id'])) {
            $builder->where('id', $data['bank_id']);
            $builder->update('staff_bank_account', $inser_data);
        } else {
            $builder->insert('staff_bank_account', $inser_data);
        }
    }
    public function csvImport($row, $branchID, $userRole, $designationID, $departmentID)
    {
        $inser_data1 = array('name' => $row['Name'], 'sex' => $row['Gender'], 'religion' => $row['Religion'], 'blood_group' => $row['BloodGroup'], 'birthday' => date("Y-m-d", strtotime($row['DateOfBirth'])), 'joining_date' => date("Y-m-d", strtotime($row['JoiningDate'])), 'qualification' => $row['Qualification'], 'mobileno' => $row['MobileNo'], 'present_address' => $row['PresentAddress'], 'permanent_address' => $row['PermanentAddress'], 'email' => $row['Email'], 'designation' => $designationID, 'department' => $departmentID, 'branch_id' => $branchID, 'photo' => 'defualt.png');
        $inser_data2 = array('username' => $row["Email"], 'role' => $userRole);
        // RANDOM STAFF ID GENERATE
        $inser_data1['staff_id'] = substr(app_generate_hash(), 3, 7);
        // SAVE EMPLOYEE INFORMATION IN THE DATABASE
        $builder->insert('staff', $inser_data1);
        $employeeID = $builder->insert_id();
        // SAVE EMPLOYEE LOGIN CREDENTIAL INFORMATION IN THE DATABASE
        $inser_data2['active'] = 1;
        $inser_data2['user_id'] = $employeeID;
        $inser_data2['password'] = $this->app_lib->pass_hashed($row["Password"]);
        $builder->insert('login_credential', $inser_data2);
        return true;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class EmployeeModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // moderator employee all information
    public function save($data, $role = null, $id = null)
    {
        $inser_data1 = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['name'], 'sex' => $data['sex'], 'religion' => $data['religion'], 'blood_group' => $data['blood_group'], 'birthday' => $data["birthday"], 'mobileno' => $data['mobile_no'], 'present_address' => $data['present_address'], 'permanent_address' => $data['permanent_address'], 'photo' => $this->uploadImage('staff'), 'designation' => $data['designation_id'], 'department' => $data['department_id'], 'joining_date' => date("Y-m-d", strtotime($data['joining_date'])), 'qualification' => $data['qualification'], 'experience_details' => $data['experience_details'], 'total_experience' => $data['total_experience'], 'email' => $data['email'], 'facebook_url' => $data['facebook'], 'linkedin_url' => $data['linkedin'], 'twitter_url' => $data['twitter']);
        $inser_data2 = array('username' => $data["username"], 'role' => $data["user_role"]);
        if (!isset($data['staff_id']) && empty($data['staff_id'])) {
            // RANDOM STAFF ID GENERATE
            $inser_data1['staff_id'] = substr(app_generate_hash(), 3, 7);
            // SAVE EMPLOYEE INFORMATION IN THE DATABASE
            $builder->insert('staff', $inser_data1);
            $employeeID = $builder->insert_id();
            // SAVE EMPLOYEE LOGIN CREDENTIAL INFORMATION IN THE DATABASE
            $inser_data2['active'] = 1;
            $inser_data2['user_id'] = $employeeID;
            $inser_data2['password'] = $this->app_lib->pass_hashed($data["password"]);
            $builder->insert('login_credential', $inser_data2);
            // SAVE USER BANK INFORMATION IN THE DATABASE
            if (!isset($data['chkskipped'])) {
                $data['staff_id'] = $employeeID;
                $this->bankSave($data);
            }
            return $employeeID;
        } else {
            $inser_data1['staff_id'] = $data['staff_id_no'];
            // UPDATE ALL INFORMATION IN THE DATABASE
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['staff_id']);
            $builder->update('staff', $inser_data1);
            // UPDATE LOGIN CREDENTIAL INFORMATION IN THE DATABASE
            $builder->where('user_id', $data['staff_id']);
            $this->db->where_not_in('role', array(6, 7));
            $builder->update('login_credential', $inser_data2);
        }
    }
    // GET SINGLE EMPLOYEE DETAILS
    public function getSingleStaff($id = '')
    {
        $builder->select('staff.*,staff_designation.name as designation_name,staff_department.name as department_name,login_credential.role as role_id,login_credential.active,login_credential.username, roles.name as role');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != "6" and login_credential.role != "7"', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->where('staff.id', $id);
        if (!is_superadmin_loggedin()) {
            $this->db->table('staff.branch_id', get_loggedin_branch_id())->where();
        }
        $query = $builder->get();
        if ($query->num_rows() == 0) {
            show_404();
        }
        return $query->row_array();
    }
    // get staff all list
    public function getStaffList($branchID = '', $role_id = '', $active = 1)
    {
        $builder->select('staff.*,staff_designation.name as designation_name,staff_department.name as department_name,login_credential.role as role_id, roles.name as role');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != "6" and login_credential.role != "7"', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        if ($branchID != "") {
            $builder->where('staff.branch_id', $branchID);
        }
        $builder->where('login_credential.role', $role_id);
        $builder->where('login_credential.active', $active);
        $builder->order_by('staff.id', 'ASC');
        return $builder->get()->getResult();
    }
    public function get_schedule_by_id($id)
    {
        $builder->select('timetable_class.*,subject.name as subject_name,class.name as class_name,section.name as section_name');
        $builder->from('timetable_class');
        $builder->join('subject', 'subject.id = timetable_class.subject_id', 'inner');
        $builder->join('class', 'class.id = timetable_class.class_id', 'inner');
        $builder->join('section', 'section.id = timetable_class.section_id', 'inner');
        $builder->where('timetable_class.teacher_id', $id);
        $this->db->table('timetable_class.session_id', get_session_id())->where();
        return $builder->get();
    }
    public function bankSave($data)
    {
        $inser_data = array('staff_id' => $data['staff_id'], 'bank_name' => $data['bank_name'], 'holder_name' => $data['holder_name'], 'bank_branch' => $data['bank_branch'], 'bank_address' => $data['bank_address'], 'ifsc_code' => $data['ifsc_code'], 'account_no' => $data['account_no']);
        if (isset($data['bank_id'])) {
            $builder->where('id', $data['bank_id']);
            $builder->update('staff_bank_account', $inser_data);
        } else {
            $builder->insert('staff_bank_account', $inser_data);
        }
    }
    public function csvImport($row, $branchID, $userRole, $designationID, $departmentID)
    {
        $inser_data1 = array('name' => $row['Name'], 'sex' => $row['Gender'], 'religion' => $row['Religion'], 'blood_group' => $row['BloodGroup'], 'birthday' => date("Y-m-d", strtotime($row['DateOfBirth'])), 'joining_date' => date("Y-m-d", strtotime($row['JoiningDate'])), 'qualification' => $row['Qualification'], 'mobileno' => $row['MobileNo'], 'present_address' => $row['PresentAddress'], 'permanent_address' => $row['PermanentAddress'], 'email' => $row['Email'], 'designation' => $designationID, 'department' => $departmentID, 'branch_id' => $branchID, 'photo' => 'defualt.png');
        $inser_data2 = array('username' => $row["Email"], 'role' => $userRole);
        // RANDOM STAFF ID GENERATE
        $inser_data1['staff_id'] = substr(app_generate_hash(), 3, 7);
        // SAVE EMPLOYEE INFORMATION IN THE DATABASE
        $builder->insert('staff', $inser_data1);
        $employeeID = $builder->insert_id();
        // SAVE EMPLOYEE LOGIN CREDENTIAL INFORMATION IN THE DATABASE
        $inser_data2['active'] = 1;
        $inser_data2['user_id'] = $employeeID;
        $inser_data2['password'] = $this->app_lib->pass_hashed($row["Password"]);
        $builder->insert('login_credential', $inser_data2);
        return true;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/AccountingModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AccountingModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    // account save and update function
    public function saveAccounts($data)
    {
        $branchID = $this->application_model->get_branch_id();
        $obal = empty($data['opening_balance']) ? 0 : $data['opening_balance'];
        $insert_account = ['branch_id' => $branchID, 'name' => $data['account_name'], 'number' => $data['account_number'], 'description' => $data['description'], 'updated_at' => date('Y-m-d H:i:s')];
        if (isset($data['account_id']) && !empty($data['account_id'])) {
            $builder->where('id', $data['account_id']);
            $builder->update('accounts', $insert_account);
            $builder->where('id', $data['account_id']);
            $builder->update('transactions', ['branch_id' => $branchID]);
        } else {
            $insert_account['balance'] = $obal;
            $builder->insert('accounts', $insert_account);
            $insertID = $builder->insert_id();
            if ($obal > 0) {
                $insertTransaction = ['account_id' => $insertID, 'branch_id' => $branchID, 'voucher_head_id' => 0, 'type' => 'deposit', 'amount' => $obal, 'dr' => 0, 'cr' => $obal, 'bal' => $obal, 'date' => date('Y-m-d'), 'description' => 'Opening Balance'];
                $builder->insert('transactions', $insertTransaction);
            }
        }
    }
    // voucher save function
    public function saveVoucher($data)
    {
        $branchID = $this->application_model->get_branch_id();
        $accountID = $data['account_id'];
        $voucher_headID = $data['voucher_head_id'];
        $voucherType = $data['voucher_type'];
        $ref_no = $data['ref_no'];
        $amount = $data['amount'];
        $date = $data['date'];
        $pay_via = $data['pay_via'];
        $description = $data['description'];
        $qbal = $this->app_lib->get_table('accounts', $accountID, true);
        $cbal = $qbal['balance'];
        if ($voucherType == 'deposit') {
            $cr = $amount;
            $dr = 0;
            $bal = $cbal + $amount;
        } elseif ($voucherType == 'expense') {
            $cr = 0;
            $dr = $amount;
            $bal = $cbal - $amount;
        }
        $insertTransaction = ['account_id' => $accountID, 'voucher_head_id' => $voucher_headID, 'type' => $voucherType, 'ref' => $ref_no, 'amount' => $amount, 'dr' => $dr, 'cr' => $cr, 'bal' => $bal, 'date' => date("Y-m-d", strtotime((string) $date)), 'pay_via' => $pay_via, 'description' => $description, 'branch_id' => $branchID];
        $builder->insert('transactions', $insertTransaction);
        $insert_id = $builder->insert_id();
        $builder->where('id', $accountID);
        $builder->update('accounts', ['balance' => $bal]);
        return $insert_id;
    }
    // voucher update function
    public function voucherEdit($data)
    {
        $voucher_headID = $data['voucher_head_id'];
        $refNo = $data['ref_no'];
        $date = $data['date'];
        $payVia = $data['pay_via'];
        $description = $data['description'];
        $insertTransaction = ['voucher_head_id' => $voucher_headID, 'ref' => $refNo, 'date' => date("Y-m-d", strtotime((string) $date)), 'pay_via' => $payVia, 'description' => $description];
        if (isset($data['voucher_old_id']) && !empty($data['voucher_old_id'])) {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $insert_id = $data['voucher_old_id'];
            if (isset($_FILES["attachment_file"]) && !empty($_FILES['attachment_file']['name'])) {
                $ext = pathinfo((string) $_FILES["attachment_file"]["name"], PATHINFO_EXTENSION);
                $file_name = $insert_id . '.' . $ext;
                move_uploaded_file($_FILES["attachment_file"]["tmp_name"], "./uploads/attachments/voucher/" . $file_name);
                $builder->where('id', $insert_id);
                $builder->update('transactions', ['attachments' => $file_name]);
            }
            $builder->where('id', $insert_id);
            $builder->update('transactions', $insertTransaction);
        }
    }
    // get voucher list function
    public function getVoucherList($type = '')
    {
        $builder->select('transactions.*, accounts.name as ac_name, voucher_head.name as v_head, payment_types.name as via_name');
        $builder->from('transactions');
        $builder->join('accounts', 'accounts.id = transactions.account_id', 'left');
        $builder->join('voucher_head', 'voucher_head.id = transactions.voucher_head_id', 'left');
        $builder->join('payment_types', 'payment_types.id = transactions.pay_via', 'left');
        if (!empty($type)) {
            $builder->where('transactions.type', $type);
        }
        if (!is_superadmin_loggedin()) {
            $this->db->table('transactions.branch_id', get_loggedin_branch_id())->where();
        }
        return $builder->get()->result_array();
    }
    // get statement report function
    public function getStatementReport($account_id = '', $type = '', $start = '', $end = '')
    {
        $builder->select('transactions.*,voucher_head.name as v_head');
        $builder->from('transactions');
        $builder->join('voucher_head', 'voucher_head.id = transactions.voucher_head_id', 'left');
        $builder->where('transactions.account_id', $account_id);
        $builder->where('transactions.date >=', $start);
        $builder->where('transactions.date <=', $end);
        if ($type != 'all') {
            $builder->where('transactions.type', $type);
        }
        $builder->order_by('transactions.id', 'ASC');
        return $builder->get()->result_array();
    }
    // get income expense report function
    public function getIncomeExpenseRepots($branchID, $start = '', $end = '', $type = '')
    {
        $builder->select('transactions.*,accounts.name as ac_name,voucher_head.name as v_head,payment_types.name as via_name');
        $builder->from('transactions');
        $builder->join('accounts', 'accounts.id = transactions.account_id', 'left');
        $builder->join('voucher_head', 'voucher_head.id = transactions.voucher_head_id', 'left');
        $builder->join('payment_types', 'payment_types.id = transactions.pay_via', 'left');
        if ($type != '') {
            $builder->where('transactions.type', $type);
        }
        $builder->where('transactions.branch_id', $branchID);
        $builder->where('transactions.date >=', $start);
        $builder->where('transactions.date <=', $end);
        $builder->order_by('transactions.id', 'ASC');
        return $builder->get()->result_array();
    }
    // get account balance sheet report
    public function get_balance_sheet($branchID)
    {
        $builder->select('transactions.*,IFNULL(SUM(transactions.dr), 0) as total_dr,IFNULL(SUM(transactions.cr),0) as total_cr,accounts.name as ac_name,accounts.balance as fbalance');
        $builder->from('accounts');
        $builder->join('transactions', 'transactions.account_id = accounts.id', 'left');
        $builder->group_by('transactions.account_id');
        $builder->order_by('accounts.balance', 'DESC');
        $builder->where('accounts.branch_id', $branchID);
        return $builder->get()->result_array();
    }
    // get income vs expense report
    public function get_incomevsexpense($branchID, $start = '', $end = '')
    {
        $sql = "SELECT transactions.*, voucher_head.name as v_head, IFNULL(SUM(transactions.dr), 0) as total_dr, IFNULL(SUM(transactions.cr), 0) as total_cr FROM voucher_head LEFT JOIN\r\n        transactions ON transactions.voucher_head_id = voucher_head.id WHERE transactions.date >= " . $db->escape($start) . " AND transactions.date <= " . $db->escape($end) . " AND transactions.branch_id = " . $db->escape($branchID) . " GROUP BY transactions.voucher_head_id ORDER BY transactions.id ASC";
        return $db->query($sql)->result_array();
    }
    // get transitions repots
    public function getTransitionsRepots($branchID, $start = '', $end = '')
    {
        $sql = "SELECT transactions.*, accounts.name as ac_name, voucher_head.name as v_head, payment_types.name as via_name FROM transactions LEFT JOIN\r\n        accounts ON accounts.id = transactions.account_id LEFT JOIN voucher_head ON voucher_head.id = transactions.voucher_head_id LEFT JOIN\r\n        payment_types ON payment_types.id = transactions.pay_via WHERE transactions.date >= " . $db->escape($start) . " AND\r\n        transactions.date <= " . $db->escape($end) . " AND transactions.branch_id = " . $db->escape($branchID) . " ORDER BY transactions.id ASC";
        return $db->query($sql)->result_array();
    }
    // duplicate voucher head check in db
    public function unique_voucher_head($name)
    {
        $branchID = $this->application_model->get_branch_id();
        $voucher_head_id = $this->request->getPost('voucher_head_id');
        if (!empty($voucher_head_id)) {
            $builder->where_not_in('id', $voucher_head_id);
        }
        $builder->where(['name' => $name, 'branch_id' => $branchID]);
        $query = $builder->get('voucher_head');
        if ($query->num_rows() > 0) {
            $this->form_validation->set_message("unique_voucher_head", translate('already_taken'));
            return false;
        } else {
            return true;
        }
    }
    // duplicate account name check in db
    public function unique_account_name($name)
    {
        $account_id = $this->request->getPost('account_id');
        if (!empty($account_id)) {
            $builder->where_not_in('id', $account_id);
        }
        $builder->where('name', $name);
        $query = $builder->get('accounts');
        if ($query->num_rows() > 0) {
            $this->form_validation->set_message("unique_account_name", translate('already_taken'));
            return false;
        } else {
            return true;
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AccountingModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    // account save and update function
    public function saveAccounts($data)
    {
        $branchID = $this->applicationModel->get_branch_id();
        $obal = empty($data['opening_balance']) ? 0 : $data['opening_balance'];
        $insert_account = ['branch_id' => $branchID, 'name' => $data['account_name'], 'number' => $data['account_number'], 'description' => $data['description'], 'updated_at' => date('Y-m-d H:i:s')];
        if (isset($data['account_id']) && !empty($data['account_id'])) {
            $builder->where('id', $data['account_id']);
            $builder->update('accounts', $insert_account);
            $builder->where('id', $data['account_id']);
            $builder->update('transactions', ['branch_id' => $branchID]);
        } else {
            $insert_account['balance'] = $obal;
            $builder->insert('accounts', $insert_account);
            $insertID = $builder->insert_id();
            if ($obal > 0) {
                $insertTransaction = ['account_id' => $insertID, 'branch_id' => $branchID, 'voucher_head_id' => 0, 'type' => 'deposit', 'amount' => $obal, 'dr' => 0, 'cr' => $obal, 'bal' => $obal, 'date' => date('Y-m-d'), 'description' => 'Opening Balance'];
                $builder->insert('transactions', $insertTransaction);
            }
        }
    }
    // voucher save function
    public function saveVoucher($data)
    {
        $branchID = $this->applicationModel->get_branch_id();
        $accountID = $data['account_id'];
        $voucher_headID = $data['voucher_head_id'];
        $voucherType = $data['voucher_type'];
        $ref_no = $data['ref_no'];
        $amount = $data['amount'];
        $date = $data['date'];
        $pay_via = $data['pay_via'];
        $description = $data['description'];
        $qbal = $this->app_lib->get_table('accounts', $accountID, true);
        $cbal = $qbal['balance'];
        if ($voucherType == 'deposit') {
            $cr = $amount;
            $dr = 0;
            $bal = $cbal + $amount;
        } elseif ($voucherType == 'expense') {
            $cr = 0;
            $dr = $amount;
            $bal = $cbal - $amount;
        }
        $insertTransaction = ['account_id' => $accountID, 'voucher_head_id' => $voucher_headID, 'type' => $voucherType, 'ref' => $ref_no, 'amount' => $amount, 'dr' => $dr, 'cr' => $cr, 'bal' => $bal, 'date' => date("Y-m-d", strtotime((string) $date)), 'pay_via' => $pay_via, 'description' => $description, 'branch_id' => $branchID];
        $builder->insert('transactions', $insertTransaction);
        $insert_id = $builder->insert_id();
        $builder->where('id', $accountID);
        $builder->update('accounts', ['balance' => $bal]);
        return $insert_id;
    }
    // voucher update function
    public function voucherEdit($data)
    {
        $voucher_headID = $data['voucher_head_id'];
        $refNo = $data['ref_no'];
        $date = $data['date'];
        $payVia = $data['pay_via'];
        $description = $data['description'];
        $insertTransaction = ['voucher_head_id' => $voucher_headID, 'ref' => $refNo, 'date' => date("Y-m-d", strtotime((string) $date)), 'pay_via' => $payVia, 'description' => $description];
        if (isset($data['voucher_old_id']) && !empty($data['voucher_old_id'])) {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $insert_id = $data['voucher_old_id'];
            if (isset($_FILES["attachment_file"]) && !empty($_FILES['attachment_file']['name'])) {
                $ext = pathinfo((string) $_FILES["attachment_file"]["name"], PATHINFO_EXTENSION);
                $file_name = $insert_id . '.' . $ext;
                move_uploaded_file($_FILES["attachment_file"]["tmp_name"], "./uploads/attachments/voucher/" . $file_name);
                $builder->where('id', $insert_id);
                $builder->update('transactions', ['attachments' => $file_name]);
            }
            $builder->where('id', $insert_id);
            $builder->update('transactions', $insertTransaction);
        }
    }
    // get voucher list function
    public function getVoucherList($type = '')
    {
        $builder->select('transactions.*, accounts.name as ac_name, voucher_head.name as v_head, payment_types.name as via_name');
        $builder->from('transactions');
        $builder->join('accounts', 'accounts.id = transactions.account_id', 'left');
        $builder->join('voucher_head', 'voucher_head.id = transactions.voucher_head_id', 'left');
        $builder->join('payment_types', 'payment_types.id = transactions.pay_via', 'left');
        if (!empty($type)) {
            $builder->where('transactions.type', $type);
        }
        if (!is_superadmin_loggedin()) {
            $this->db->table('transactions.branch_id', get_loggedin_branch_id())->where();
        }
        return $builder->get()->result_array();
    }
    // get statement report function
    public function getStatementReport($account_id = '', $type = '', $start = '', $end = '')
    {
        $builder->select('transactions.*,voucher_head.name as v_head');
        $builder->from('transactions');
        $builder->join('voucher_head', 'voucher_head.id = transactions.voucher_head_id', 'left');
        $builder->where('transactions.account_id', $account_id);
        $builder->where('transactions.date >=', $start);
        $builder->where('transactions.date <=', $end);
        if ($type != 'all') {
            $builder->where('transactions.type', $type);
        }
        $builder->order_by('transactions.id', 'ASC');
        return $builder->get()->result_array();
    }
    // get income expense report function
    public function getIncomeExpenseRepots($branchID, $start = '', $end = '', $type = '')
    {
        $builder->select('transactions.*,accounts.name as ac_name,voucher_head.name as v_head,payment_types.name as via_name');
        $builder->from('transactions');
        $builder->join('accounts', 'accounts.id = transactions.account_id', 'left');
        $builder->join('voucher_head', 'voucher_head.id = transactions.voucher_head_id', 'left');
        $builder->join('payment_types', 'payment_types.id = transactions.pay_via', 'left');
        if ($type != '') {
            $builder->where('transactions.type', $type);
        }
        $builder->where('transactions.branch_id', $branchID);
        $builder->where('transactions.date >=', $start);
        $builder->where('transactions.date <=', $end);
        $builder->order_by('transactions.id', 'ASC');
        return $builder->get()->result_array();
    }
    // get account balance sheet report
    public function get_balance_sheet($branchID)
    {
        $builder->select('transactions.*,IFNULL(SUM(transactions.dr), 0) as total_dr,IFNULL(SUM(transactions.cr),0) as total_cr,accounts.name as ac_name,accounts.balance as fbalance');
        $builder->from('accounts');
        $builder->join('transactions', 'transactions.account_id = accounts.id', 'left');
        $builder->group_by('transactions.account_id');
        $builder->order_by('accounts.balance', 'DESC');
        $builder->where('accounts.branch_id', $branchID);
        return $builder->get()->result_array();
    }
    // get income vs expense report
    public function get_incomevsexpense($branchID, $start = '', $end = '')
    {
        $sql = "SELECT transactions.*, voucher_head.name as v_head, IFNULL(SUM(transactions.dr), 0) as total_dr, IFNULL(SUM(transactions.cr), 0) as total_cr FROM voucher_head LEFT JOIN\r\n        transactions ON transactions.voucher_head_id = voucher_head.id WHERE transactions.date >= " . $db->escape($start) . " AND transactions.date <= " . $db->escape($end) . " AND transactions.branch_id = " . $db->escape($branchID) . " GROUP BY transactions.voucher_head_id ORDER BY transactions.id ASC";
        return $db->query($sql)->result_array();
    }
    // get transitions repots
    public function getTransitionsRepots($branchID, $start = '', $end = '')
    {
        $sql = "SELECT transactions.*, accounts.name as ac_name, voucher_head.name as v_head, payment_types.name as via_name FROM transactions LEFT JOIN\r\n        accounts ON accounts.id = transactions.account_id LEFT JOIN voucher_head ON voucher_head.id = transactions.voucher_head_id LEFT JOIN\r\n        payment_types ON payment_types.id = transactions.pay_via WHERE transactions.date >= " . $db->escape($start) . " AND\r\n        transactions.date <= " . $db->escape($end) . " AND transactions.branch_id = " . $db->escape($branchID) . " ORDER BY transactions.id ASC";
        return $db->query($sql)->result_array();
    }
    // duplicate voucher head check in db
    public function unique_voucher_head($name)
    {
        $branchID = $this->applicationModel->get_branch_id();
        $voucher_head_id = $this->request->getPost('voucher_head_id');
        if (!empty($voucher_head_id)) {
            $builder->where_not_in('id', $voucher_head_id);
        }
        $builder->where(['name' => $name, 'branch_id' => $branchID]);
        $query = $builder->get('voucher_head');
        if ($query->num_rows() > 0) {
            $this->form_validation->set_message("unique_voucher_head", translate('already_taken'));
            return false;
        } else {
            return true;
        }
    }
    // duplicate account name check in db
    public function unique_account_name($name)
    {
        $account_id = $this->request->getPost('account_id');
        if (!empty($account_id)) {
            $builder->where_not_in('id', $account_id);
        }
        $builder->where('name', $name);
        $query = $builder->get('accounts');
        if ($query->num_rows() > 0) {
            $this->form_validation->set_message("unique_account_name", translate('already_taken'));
            return false;
        } else {
            return true;
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/LiveClassModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class LiveClassModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getList($branch_id = '')
    {
        $builder->select('live_class.*,class.name as class_name,staff.name as staffname,branch.name as branchname');
        $builder->from('live_class');
        $builder->join('branch', 'branch.id = live_class.branch_id', 'left');
        $builder->join('class', 'class.id = live_class.class_id', 'left');
        $builder->join('staff', 'staff.id = live_class.created_by', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('live_class.branch_id', get_loggedin_branch_id())->where();
        }
        if (!is_superadmin_loggedin() && !is_admin_loggedin()) {
            $this->db->table('live_class.created_by', get_loggedin_user_id())->where();
        }
        $builder->order_by('live_class.id', 'ASC');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['section_details'] = $this->getSectionDetails($value['section_id']);
        }
        return $result;
    }
    public function getReports($class_id = '', $section_id = '', $method = '', $start = '', $end = '', $branch_id = '')
    {
        $builder->select('live_class.*,class.name as class_name,staff.name as staffname,branch.name as branchname');
        $builder->from('live_class');
        $builder->join('branch', 'branch.id = live_class.branch_id', 'left');
        $builder->join('class', 'class.id = live_class.class_id', 'left');
        $builder->join('staff', 'staff.id = live_class.created_by', 'left');
        $builder->where('live_class.branch_id', $branch_id);
        if ($method !== '') {
            $builder->where('live_class.live_class_method', $method);
        }
        $builder->where('live_class.date >=', $start);
        $builder->where('live_class.date <=', $end);
        $builder->order_by('live_class.id', 'ASC');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            if (!empty($section_id)) {
                $array = json_decode($value['section_id'], true);
                if (!in_array($section_id, $array)) {
                    unset($result[$key]);
                    continue;
                }
            }
            $result[$key]['section_details'] = $this->getSectionDetails($value['section_id']);
        }
        return $result;
    }
    function getSectionDetails($data)
    {
        $array = json_decode($data, true);
        $nameList = '';
        if (json_last_error() == JSON_ERROR_NONE) {
            foreach ($array as $key => $value) {
                $nameList .= get_type_name_by_id('section', $value) . '<br>';
            }
        }
        return $nameList;
    }
    function save($data)
    {
        if (!isset($data['live_id'])) {
            $builder->insert('live_class', $data);
        } else {
            $builder->where('id', $data['live_id']);
            $builder->update('live_class', $data);
        }
    }
    function bbb_class_save($post = array())
    {
        $branchID = $this->application_model->get_branch_id();
        $arrayBBB = array('attendee_password' => $post['attendee_password'], 'moderator_password' => $post['moderator_password'], 'max_participants' => $post['max_participants'], 'mute_on_start' => isset($post['set_mute_on_start']) ? 1 : 0, 'set_record' => isset($post['set_record']) ? 1 : 0);
        $arrayLive = array('live_class_method' => $post['live_class_method'], 'title' => $post['title'], 'meeting_id' => $post['meeting_id'], 'meeting_password' => "", 'own_api_key' => "", 'duration' => $post['duration'], 'bbb' => json_encode($arrayBBB), 'class_id' => $post['class_id'], 'section_id' => json_encode($this->request->getPost('section')), 'remarks' => $post['remarks'], 'date' => date("Y-m-d", strtotime($post['date'])), 'start_time' => date("H:i", strtotime($post['time_start'])), 'end_time' => date("H:i", strtotime($post['time_end'])), 'created_by' => get_loggedin_user_id(), 'branch_id' => $branchID);
        $this->save($arrayLive);
    }
    function gmeet_save($post = array())
    {
        $branchID = $this->application_model->get_branch_id();
        $arrayBBB = json_encode(array('join_url' => $post['gmeet_url']));
        $arrayLive = array('live_class_method' => $post['live_class_method'], 'title' => $post['title'], 'meeting_id' => "", 'meeting_password' => "", 'own_api_key' => "", 'duration' => $post['duration'], 'bbb' => $arrayBBB, 'class_id' => $post['class_id'], 'section_id' => json_encode($this->request->getPost('section')), 'remarks' => $post['remarks'], 'date' => date("Y-m-d", strtotime($post['date'])), 'start_time' => date("H:i", strtotime($post['time_start'])), 'end_time' => date("H:i", strtotime($post['time_end'])), 'created_by' => get_loggedin_user_id(), 'branch_id' => $branchID);
        $this->save($arrayLive);
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class LiveClassModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getList($branch_id = '')
    {
        $builder->select('live_class.*,class.name as class_name,staff.name as staffname,branch.name as branchname');
        $builder->from('live_class');
        $builder->join('branch', 'branch.id = live_class.branch_id', 'left');
        $builder->join('class', 'class.id = live_class.class_id', 'left');
        $builder->join('staff', 'staff.id = live_class.created_by', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('live_class.branch_id', get_loggedin_branch_id())->where();
        }
        if (!is_superadmin_loggedin() && !is_admin_loggedin()) {
            $this->db->table('live_class.created_by', get_loggedin_user_id())->where();
        }
        $builder->order_by('live_class.id', 'ASC');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['section_details'] = $this->getSectionDetails($value['section_id']);
        }
        return $result;
    }
    public function getReports($class_id = '', $section_id = '', $method = '', $start = '', $end = '', $branch_id = '')
    {
        $builder->select('live_class.*,class.name as class_name,staff.name as staffname,branch.name as branchname');
        $builder->from('live_class');
        $builder->join('branch', 'branch.id = live_class.branch_id', 'left');
        $builder->join('class', 'class.id = live_class.class_id', 'left');
        $builder->join('staff', 'staff.id = live_class.created_by', 'left');
        $builder->where('live_class.branch_id', $branch_id);
        if ($method !== '') {
            $builder->where('live_class.live_class_method', $method);
        }
        $builder->where('live_class.date >=', $start);
        $builder->where('live_class.date <=', $end);
        $builder->order_by('live_class.id', 'ASC');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            if (!empty($section_id)) {
                $array = json_decode($value['section_id'], true);
                if (!in_array($section_id, $array)) {
                    unset($result[$key]);
                    continue;
                }
            }
            $result[$key]['section_details'] = $this->getSectionDetails($value['section_id']);
        }
        return $result;
    }
    function getSectionDetails($data)
    {
        $array = json_decode($data, true);
        $nameList = '';
        if (json_last_error() == JSON_ERROR_NONE) {
            foreach ($array as $key => $value) {
                $nameList .= get_type_name_by_id('section', $value) . '<br>';
            }
        }
        return $nameList;
    }
    function save($data)
    {
        if (!isset($data['live_id'])) {
            $builder->insert('live_class', $data);
        } else {
            $builder->where('id', $data['live_id']);
            $builder->update('live_class', $data);
        }
    }
    function bbb_class_save($post = array())
    {
        $branchID = $this->applicationModel->get_branch_id();
        $arrayBBB = array('attendee_password' => $post['attendee_password'], 'moderator_password' => $post['moderator_password'], 'max_participants' => $post['max_participants'], 'mute_on_start' => isset($post['set_mute_on_start']) ? 1 : 0, 'set_record' => isset($post['set_record']) ? 1 : 0);
        $arrayLive = array('live_class_method' => $post['live_class_method'], 'title' => $post['title'], 'meeting_id' => $post['meeting_id'], 'meeting_password' => "", 'own_api_key' => "", 'duration' => $post['duration'], 'bbb' => json_encode($arrayBBB), 'class_id' => $post['class_id'], 'section_id' => json_encode($this->request->getPost('section')), 'remarks' => $post['remarks'], 'date' => date("Y-m-d", strtotime($post['date'])), 'start_time' => date("H:i", strtotime($post['time_start'])), 'end_time' => date("H:i", strtotime($post['time_end'])), 'created_by' => get_loggedin_user_id(), 'branch_id' => $branchID);
        $this->save($arrayLive);
    }
    function gmeet_save($post = array())
    {
        $branchID = $this->applicationModel->get_branch_id();
        $arrayBBB = json_encode(array('join_url' => $post['gmeet_url']));
        $arrayLive = array('live_class_method' => $post['live_class_method'], 'title' => $post['title'], 'meeting_id' => "", 'meeting_password' => "", 'own_api_key' => "", 'duration' => $post['duration'], 'bbb' => $arrayBBB, 'class_id' => $post['class_id'], 'section_id' => json_encode($this->request->getPost('section')), 'remarks' => $post['remarks'], 'date' => date("Y-m-d", strtotime($post['date'])), 'start_time' => date("H:i", strtotime($post['time_start'])), 'end_time' => date("H:i", strtotime($post['time_end'])), 'created_by' => get_loggedin_user_id(), 'branch_id' => $branchID);
        $this->save($arrayLive);
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/AttachmentsModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AttachmentsModel extends MYModel
{
    protected $db;
    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function save($data)
    {
        $classID = !isset($data['all_class_set']) ? $data['class_id'] : 'unfiltered';
        $arrayData = array('branch_id' => $this->application_model->get_branch_id(), 'title' => $data['title'], 'type_id' => $data['type_id'], 'remarks' => $data['remarks'], 'date' => date("Y-m-d", strtotime($data['date'])), 'session_id' => get_session_id(), 'uploader_id' => get_loggedin_user_id(), 'class_id' => $classID, 'subject_id' => get_loggedin_user_id(), 'updated_at' => date("Y-m-d H:i:s"));
        if (!isset($data['all_class_set']) && !isset($data['subject_wise'])) {
            $arrayData['subject_id'] = $data['subject_id'];
        } else {
            $arrayData['subject_id'] = 'unfiltered';
        }
        if (!isset($data['attachment_id'])) {
            // uploading file using codeigniter upload library
            $config['upload_path'] = 'uploads/attachments/';
            $config['encrypt_name'] = true;
            $config['allowed_types'] = '*';
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attachment_file")) {
                $arrayData['file_name'] = $this->upload->data('orig_name');
                $arrayData['enc_name'] = $this->upload->data('file_name');
                $builder->insert('attachments', $arrayData);
            } else {
                return ['error' => $this->upload->display_errors()];
            }
        } else if ($_FILES['attachment_file']['name'] != "") {
            $config['upload_path'] = 'uploads/attachments/';
            $config['encrypt_name'] = true;
            $config['allowed_types'] = '*';
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attachment_file")) {
                $encrypt_name = $db->table('attachments')->get('attachments')->row()->enc_name;
                $file_name = 'uploads/attachments/' . $encrypt_name;
                if (file_exists($file_name)) {
                    unlink($file_name);
                }
                $arrayData['file_name'] = $this->upload->data('orig_name');
                $arrayData['enc_name'] = $this->upload->data('file_name');
                $builder->where('id', $data['attachment_id']);
                $builder->update('attachments', $arrayData);
            } else {
                return ['error' => $this->upload->display_errors()];
            }
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['attachment_id']);
            $builder->update('attachments', $arrayData);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function type_save($data, $id = null)
    {
        $arrayType = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['type_name']);
        if ($id == null) {
            $builder->insert('attachments_type', $arrayType);
        } else {
            $builder->where('id', $id);
            $builder->update('attachments_type', $arrayType);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    // get attachments list
    public function getAttachmentsList()
    {
        $builder->select('a.*,b.name as branch_name,at.name as type_name,c.name as class_name,s.name as subject_name');
        $builder->from('attachments as a');
        $builder->join('attachments_type as at', 'at.id = a.type_id', 'left');
        $builder->join('class as c', 'c.id = a.class_id', 'left');
        $builder->join('branch as b', 'b.id = a.branch_id', 'left');
        $builder->join('subject as s', 's.id = a.subject_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('a.branch_id', get_loggedin_branch_id())->where();
        }
        if (loggedin_role_id() == 6) {
            $classID = $db->table('enroll')->get('enroll')->row()->class_id;
            $this->db->table('class_id', $classID)->or_where('class_id', 'unfiltered')->where();
        }
        if (loggedin_role_id() == 7) {
            $classID = $db->table('enroll')->get('enroll')->row()->class_id;
            $this->db->table('class_id', $classID)->or_where('class_id', 'unfiltered')->where();
        }
        $builder->order_by('a.id', 'desc');
        $result = $builder->get()->result_array();
        return $result;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AttachmentsModel extends MYModel
{
    protected $db;
    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function save($data)
    {
        $classID = !isset($data['all_class_set']) ? $data['class_id'] : 'unfiltered';
        $arrayData = array('branch_id' => $this->applicationModel->get_branch_id(), 'title' => $data['title'], 'type_id' => $data['type_id'], 'remarks' => $data['remarks'], 'date' => date("Y-m-d", strtotime($data['date'])), 'session_id' => get_session_id(), 'uploader_id' => get_loggedin_user_id(), 'class_id' => $classID, 'subject_id' => get_loggedin_user_id(), 'updated_at' => date("Y-m-d H:i:s"));
        if (!isset($data['all_class_set']) && !isset($data['subject_wise'])) {
            $arrayData['subject_id'] = $data['subject_id'];
        } else {
            $arrayData['subject_id'] = 'unfiltered';
        }
        if (!isset($data['attachment_id'])) {
            // uploading file using codeigniter upload library
            $config['upload_path'] = 'uploads/attachments/';
            $config['encrypt_name'] = true;
            $config['allowed_types'] = '*';
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attachment_file")) {
                $arrayData['file_name'] = $this->upload->data('orig_name');
                $arrayData['enc_name'] = $this->upload->data('file_name');
                $builder->insert('attachments', $arrayData);
            } else {
                return ['error' => $this->upload->display_errors()];
            }
        } else if ($_FILES['attachment_file']['name'] != "") {
            $config['upload_path'] = 'uploads/attachments/';
            $config['encrypt_name'] = true;
            $config['allowed_types'] = '*';
            $this->upload->initialize($config);
            if ($this->upload->do_upload("attachment_file")) {
                $encrypt_name = $db->table('attachments')->get('attachments')->row()->enc_name;
                $file_name = 'uploads/attachments/' . $encrypt_name;
                if (file_exists($file_name)) {
                    unlink($file_name);
                }
                $arrayData['file_name'] = $this->upload->data('orig_name');
                $arrayData['enc_name'] = $this->upload->data('file_name');
                $builder->where('id', $data['attachment_id']);
                $builder->update('attachments', $arrayData);
            } else {
                return ['error' => $this->upload->display_errors()];
            }
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['attachment_id']);
            $builder->update('attachments', $arrayData);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function type_save($data, $id = null)
    {
        $arrayType = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['type_name']);
        if ($id == null) {
            $builder->insert('attachments_type', $arrayType);
        } else {
            $builder->where('id', $id);
            $builder->update('attachments_type', $arrayType);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    // get attachments list
    public function getAttachmentsList()
    {
        $builder->select('a.*,b.name as branch_name,at.name as type_name,c.name as class_name,s.name as subject_name');
        $builder->from('attachments as a');
        $builder->join('attachments_type as at', 'at.id = a.type_id', 'left');
        $builder->join('class as c', 'c.id = a.class_id', 'left');
        $builder->join('branch as b', 'b.id = a.branch_id', 'left');
        $builder->join('subject as s', 's.id = a.subject_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('a.branch_id', get_loggedin_branch_id())->where();
        }
        if (loggedin_role_id() == 6) {
            $classID = $db->table('enroll')->get('enroll')->row()->class_id;
            $this->db->table('class_id', $classID)->or_where('class_id', 'unfiltered')->where();
        }
        if (loggedin_role_id() == 7) {
            $classID = $db->table('enroll')->get('enroll')->row()->class_id;
            $this->db->table('class_id', $classID)->or_where('class_id', 'unfiltered')->where();
        }
        $builder->order_by('a.id', 'desc');
        $result = $builder->get()->result_array();
        return $result;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/PayrollModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class PayrollModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    // employee basic salary validation by salary template
    public function get_basic_salary($staff_id, $amount = 0)
    {
        $q = $builder->getWhere('staff', array('id' => $staff_id))->row_array();
        if (empty($q['salary_template_id']) || $q['salary_template_id'] == 0) {
            return 1;
        } else {
            $basic_salary = $builder->getWhere("salary_template", array('id' => $q['salary_template_id']))->row()->basic_salary;
            if ($amount > $basic_salary) {
                return 2;
            }
        }
        return 3;
    }
    // employee advance salary validation by month
    public function get_advance_valid_month($staff_id, $month)
    {
        $get_advance_month = $builder->getWhere("advance_salary", array("staff_id" => $staff_id, "deduct_month" => date("m", strtotime($month)), "year" => date("Y", strtotime($month)), "status" => 2))->num_rows();
        $get_salary_month = $builder->getWhere("payslip", array("staff_id" => $staff_id, "month" => date("m", strtotime($month)), "year" => date("Y", strtotime($month))))->num_rows();
        if ($get_advance_month == 0 && $get_salary_month == 0) {
            return true;
        } else {
            return false;
        }
    }
    // payslip save and update function
    public function save_payslip($data)
    {
        $staff_id = $data['staff_id'];
        $month = $data['month'];
        $year = $data['year'];
        $total_allowance = $data['total_allowance'];
        $total_deduction = $data['total_deduction'];
        $net_salary = $data['net_salary'];
        $overtime_hour = $data['overtime_total_hour'];
        $overtime_amount = $data['overtime_amount'];
        $salary_template_id = $data['salary_template_id'];
        $branchID = $this->application_model->get_branch_id();
        $ad_salary = $db->table('advance_salary')->get('advance_salary')->row_array();
        $exist_verify = $db->table('payslip')->get('payslip')->num_rows();
        if ($exist_verify == 0) {
            $arrayPayslip = array('staff_id' => $staff_id, 'month' => $month, 'year' => $year, 'basic_salary' => $data['basic_salary'], 'total_allowance' => $total_allowance, 'total_deduction' => $total_deduction, 'net_salary' => $net_salary, 'bill_no' => $this->app_lib->get_bill_no('payslip'), 'remarks' => $data['remarks'], 'hash' => app_generate_hash(), 'pay_via' => $data['pay_via'], 'branch_id' => $branchID, 'paid_by' => get_loggedin_user_id());
            $builder->insert('payslip', $arrayPayslip);
            $payslip_id = $builder->insert_id();
            $payslipData = array();
            $getTemplate = $this->get("salary_template_details", array('salary_template_id' => $salary_template_id));
            foreach ($getTemplate as $row) {
                if ($row['type'] == 1) {
                    $payslipData[] = array('payslip_id' => $payslip_id, 'name' => $row['name'], 'amount' => $row['amount'], 'type' => 1);
                } else {
                    $payslipData[] = array('payslip_id' => $payslip_id, 'name' => $row['name'], 'amount' => $row['amount'], 'type' => 2);
                }
            }
            if (!empty($overtime_hour) && $overtime_hour != 0) {
                $payslipData[] = array('payslip_id' => $payslip_id, 'name' => "Overtime Salary (" . $overtime_hour . " Hour)", 'amount' => $overtime_amount, 'type' => 1);
            }
            if (!empty($ad_salary)) {
                $payslipData[] = array('payslip_id' => $payslip_id, 'name' => "Advance Salary", 'amount' => $ad_salary['amount'], 'type' => 2);
            }
            $builder->insert_batch('payslip_details', $payslipData);
            // voucher transaction save function
            if (isset($data['account_id'])) {
                $arrayTransaction = array('account_id' => $data['account_id'], 'date' => $data['account_id'], 'amount' => $net_salary, 'month' => $month, 'year' => $year);
                $this->saveTransaction($arrayTransaction);
            }
            $payslip_url = base_url('payroll/invoice/' . $payslip_id . '/' . $arrayPayslip['hash']);
            // pay-slip confirmation email
            $arrayEmail = array('branch_id' => $branchID, 'name' => get_type_name_by_id('staff', $staff_id), 'month_year' => date('F', strtotime($year . '-' . $month)), 'payslip_no' => $arrayPayslip['bill_no'], 'payslip_url' => $payslip_url, 'recipient' => get_type_name_by_id('staff', $staff_id, 'email'));
            $this->email_model->sentStaffSalaryPay($arrayEmail);
            return ['status' => 'success', 'uri' => $payslip_url];
        } else {
            return ['status' => 'failed'];
        }
    }
    // voucher transaction save function
    public function saveTransaction($data)
    {
        $branchID = $this->application_model->get_branch_id();
        $accountID = $data['account_id'];
        $amount = $data['amount'];
        $month = $data['month'];
        $year = $data['year'];
        $description = date("M-Y", strtotime($year . '-' . $month)) . " Paying Employees Salaries";
        // get the current balance of the selected account
        $qbal = $this->app_lib->get_table('accounts', $accountID, true);
        $cbal = $qbal['balance'];
        $bal = $cbal - $amount;
        // query system voucher head / insert
        $arrayHead = array('name' => 'Employees Salary Payment', 'type' => 'expense', 'system' => 1, 'branch_id' => $branchID);
        $builder->where($arrayHead);
        $query = $builder->get('voucher_head');
        if ($query->num_rows() == 1) {
            $voucher_headID = $query->row()->id;
        } else {
            $builder->insert('voucher_head', $arrayHead);
            $voucher_headID = $builder->insert_id();
        }
        // query system transactions / insert
        $arrayTransactions = array('account_id' => $accountID, 'voucher_head_id' => $voucher_headID, 'type' => 'expense', 'system' => 1, 'branch_id' => $branchID);
        $builder->where($arrayTransactions);
        $builder->where('description', $description);
        $query = $builder->get('transactions');
        if ($query->num_rows() > 0) {
            $builder->set('amount', 'amount+' . $amount, FALSE);
            $builder->set('dr', 'dr+' . $amount, FALSE);
            $builder->set('bal', $bal);
            $this->db->table('id', $query->row()->id)->where();
            $builder->update('transactions');
        } else {
            $arrayTransactions['date'] = date("Y-m-d");
            $arrayTransactions['ref'] = '';
            $arrayTransactions['amount'] = $amount;
            $arrayTransactions['dr'] = $amount;
            $arrayTransactions['cr'] = 0;
            $arrayTransactions['bal'] = $bal;
            $arrayTransactions['pay_via'] = 5;
            $arrayTransactions['description'] = $description;
            $builder->insert('transactions', $arrayTransactions);
        }
        $builder->where('id', $accountID);
        $this->db->table('accounts', array('balance' => $bal))->update();
    }
    public function getInvoice($id)
    {
        $builder->select('payslip.*,staff.name as staff_name,staff.mobileno,IFNULL(staff_designation.name, "N/A") as designation_name,IFNULL(staff_department.name, "N/A") as department_name,branch.school_name,branch.email as school_email,branch.mobileno as school_mobileno,branch.address as school_address');
        $builder->from('payslip');
        $builder->join('staff', 'staff.id = payslip.staff_id', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->join('branch', 'branch.id = staff.branch_id', 'left');
        $builder->where('payslip.id', $id);
        return $builder->get()->row_array();
    }
    // get staff all details
    public function getEmployeeList($branch_id, $role_id, $designation)
    {
        $builder->select('staff.*,staff_designation.name as designation_name,staff_department.name as department_name,login_credential.role as role_id, roles.name as role');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != 6 and login_credential.role != 7', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->where('login_credential.role', $role_id);
        $builder->where('login_credential.active', 1);
        $builder->where('staff.branch_id', $branch_id);
        $builder->where('staff.designation', $designation);
        return $builder->get()->getResult();
    }
    // get employee payment list
    public function getEmployeePaymentList($branch_id = '', $role_id, $month, $year)
    {
        $builder->select('staff.*,staff_designation.name as designation_name,staff_department.name as department_name,login_credential.role as role_id, roles.name as role, IFNULL(payslip.id, 0) as salary_id, payslip.hash as salary_hash,salary_template.name as template_name, salary_template.basic_salary');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->join('payslip', 'payslip.staff_id = staff.id and payslip.month = ' . $db->escape($month) . ' and payslip.year = ' . $db->escape($year), 'left');
        $builder->join('salary_template', 'salary_template.id = staff.salary_template_id', 'left');
        $builder->where('staff.branch_id', $branch_id);
        $builder->where('login_credential.role', $role_id);
        $builder->where('login_credential.active', 1);
        $builder->where('staff.salary_template_id !=', 0);
        return $builder->get()->getResult();
    }
    // get employee payment list
    public function getEmployeePayment($staff_id, $month, $year)
    {
        $sql = "SELECT `staff`.*, `staff_designation`.`name` as `designation_name`, `staff_department`.`name` as `department_name`, `login_credential`.`role` as `role_id`, `roles`.`name` as `role`,\r\n        `salary_template`.`name` as `template_name`, `salary_template`.`basic_salary`, `salary_template`.`overtime_salary`, `advance_salary`.`amount` as `advance_amount` FROM `staff` INNER JOIN\r\n        `login_credential` ON `login_credential`.`user_id` = `staff`.`id` LEFT JOIN `roles` ON `roles`.`id` = `login_credential`.`role` LEFT JOIN `staff_designation` ON\r\n        `staff_designation`.`id` = `staff`.`designation` LEFT JOIN `staff_department` ON `staff_department`.`id` = `staff`.`department` LEFT JOIN `salary_template` ON\r\n        `salary_template`.`id` = `staff`.`salary_template_id` LEFT JOIN `advance_salary` ON `advance_salary`.`staff_id` = `staff`.`id` AND \r\n        `advance_salary`.`deduct_month` = " . $db->escape($month) . " AND `advance_salary`.`year` = " . $db->escape($year) . " WHERE\r\n        `staff`.`id` = " . $db->escape($staff_id);
        return $db->query($sql)->row_array();
    }
    public function getAdvanceSalaryList($month = '', $year = '', $branch_id = '')
    {
        $builder->select('advance_salary.*,staff.name,staff.photo,login_credential.role as role_id,roles.name as role');
        $builder->from('advance_salary');
        $builder->join('staff', 'staff.id = advance_salary.staff_id', 'inner');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != 6 and login_credential.role != 7', 'left');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        if (!empty($month)) {
            $builder->where('advance_salary.deduct_month', $month);
            $builder->where('advance_salary.year', $year);
        }
        if (!empty($branch_id)) {
            $builder->where('advance_salary.branch_id', $branch_id);
        }
        return $builder->get()->result_array();
    }
    // get summary report function
    public function get_summary($branch_id = '', $month = '', $year = '', $staffID)
    {
        $builder->select('payslip.*,staff.name as staff_name,staff.mobileno,IFNULL(staff_designation.name, "N/A") as designation_name,IFNULL(staff_department.name, "N/A") as department_name,payment_types.name as payvia');
        $builder->from('payslip');
        $builder->join('staff', 'staff.id = payslip.staff_id', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->join('payment_types', 'payment_types.id = payslip.pay_via', 'left');
        if (!empty($staffID)) {
            $this->db->table('payslip.staff_id', get_loggedin_user_id())->where();
        }
        $builder->where('payslip.branch_id', $branch_id);
        $builder->where('payslip.month', $month);
        $builder->where('payslip.year', $year);
        return $builder->get()->result_array();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class PayrollModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    // employee basic salary validation by salary template
    public function get_basic_salary($staff_id, $amount = 0)
    {
        $q = $builder->getWhere('staff', array('id' => $staff_id))->row_array();
        if (empty($q['salary_template_id']) || $q['salary_template_id'] == 0) {
            return 1;
        } else {
            $basic_salary = $builder->getWhere("salary_template", array('id' => $q['salary_template_id']))->row()->basic_salary;
            if ($amount > $basic_salary) {
                return 2;
            }
        }
        return 3;
    }
    // employee advance salary validation by month
    public function get_advance_valid_month($staff_id, $month)
    {
        $get_advance_month = $builder->getWhere("advance_salary", array("staff_id" => $staff_id, "deduct_month" => date("m", strtotime($month)), "year" => date("Y", strtotime($month)), "status" => 2))->num_rows();
        $get_salary_month = $builder->getWhere("payslip", array("staff_id" => $staff_id, "month" => date("m", strtotime($month)), "year" => date("Y", strtotime($month))))->num_rows();
        if ($get_advance_month == 0 && $get_salary_month == 0) {
            return true;
        } else {
            return false;
        }
    }
    // payslip save and update function
    public function save_payslip($data)
    {
        $staff_id = $data['staff_id'];
        $month = $data['month'];
        $year = $data['year'];
        $total_allowance = $data['total_allowance'];
        $total_deduction = $data['total_deduction'];
        $net_salary = $data['net_salary'];
        $overtime_hour = $data['overtime_total_hour'];
        $overtime_amount = $data['overtime_amount'];
        $salary_template_id = $data['salary_template_id'];
        $branchID = $this->applicationModel->get_branch_id();
        $ad_salary = $db->table('advance_salary')->get('advance_salary')->row_array();
        $exist_verify = $db->table('payslip')->get('payslip')->num_rows();
        if ($exist_verify == 0) {
            $arrayPayslip = array('staff_id' => $staff_id, 'month' => $month, 'year' => $year, 'basic_salary' => $data['basic_salary'], 'total_allowance' => $total_allowance, 'total_deduction' => $total_deduction, 'net_salary' => $net_salary, 'bill_no' => $this->app_lib->get_bill_no('payslip'), 'remarks' => $data['remarks'], 'hash' => app_generate_hash(), 'pay_via' => $data['pay_via'], 'branch_id' => $branchID, 'paid_by' => get_loggedin_user_id());
            $builder->insert('payslip', $arrayPayslip);
            $payslip_id = $builder->insert_id();
            $payslipData = array();
            $getTemplate = $this->get("salary_template_details", array('salary_template_id' => $salary_template_id));
            foreach ($getTemplate as $row) {
                if ($row['type'] == 1) {
                    $payslipData[] = array('payslip_id' => $payslip_id, 'name' => $row['name'], 'amount' => $row['amount'], 'type' => 1);
                } else {
                    $payslipData[] = array('payslip_id' => $payslip_id, 'name' => $row['name'], 'amount' => $row['amount'], 'type' => 2);
                }
            }
            if (!empty($overtime_hour) && $overtime_hour != 0) {
                $payslipData[] = array('payslip_id' => $payslip_id, 'name' => "Overtime Salary (" . $overtime_hour . " Hour)", 'amount' => $overtime_amount, 'type' => 1);
            }
            if (!empty($ad_salary)) {
                $payslipData[] = array('payslip_id' => $payslip_id, 'name' => "Advance Salary", 'amount' => $ad_salary['amount'], 'type' => 2);
            }
            $builder->insert_batch('payslip_details', $payslipData);
            // voucher transaction save function
            if (isset($data['account_id'])) {
                $arrayTransaction = array('account_id' => $data['account_id'], 'date' => $data['account_id'], 'amount' => $net_salary, 'month' => $month, 'year' => $year);
                $this->saveTransaction($arrayTransaction);
            }
            $payslip_url = base_url('payroll/invoice/' . $payslip_id . '/' . $arrayPayslip['hash']);
            // pay-slip confirmation email
            $arrayEmail = array('branch_id' => $branchID, 'name' => get_type_name_by_id('staff', $staff_id), 'month_year' => date('F', strtotime($year . '-' . $month)), 'payslip_no' => $arrayPayslip['bill_no'], 'payslip_url' => $payslip_url, 'recipient' => get_type_name_by_id('staff', $staff_id, 'email'));
            $this->email_model->sentStaffSalaryPay($arrayEmail);
            return ['status' => 'success', 'uri' => $payslip_url];
        } else {
            return ['status' => 'failed'];
        }
    }
    // voucher transaction save function
    public function saveTransaction($data)
    {
        $branchID = $this->applicationModel->get_branch_id();
        $accountID = $data['account_id'];
        $amount = $data['amount'];
        $month = $data['month'];
        $year = $data['year'];
        $description = date("M-Y", strtotime($year . '-' . $month)) . " Paying Employees Salaries";
        // get the current balance of the selected account
        $qbal = $this->app_lib->get_table('accounts', $accountID, true);
        $cbal = $qbal['balance'];
        $bal = $cbal - $amount;
        // query system voucher head / insert
        $arrayHead = array('name' => 'Employees Salary Payment', 'type' => 'expense', 'system' => 1, 'branch_id' => $branchID);
        $builder->where($arrayHead);
        $query = $builder->get('voucher_head');
        if ($query->num_rows() == 1) {
            $voucher_headID = $query->row()->id;
        } else {
            $builder->insert('voucher_head', $arrayHead);
            $voucher_headID = $builder->insert_id();
        }
        // query system transactions / insert
        $arrayTransactions = array('account_id' => $accountID, 'voucher_head_id' => $voucher_headID, 'type' => 'expense', 'system' => 1, 'branch_id' => $branchID);
        $builder->where($arrayTransactions);
        $builder->where('description', $description);
        $query = $builder->get('transactions');
        if ($query->num_rows() > 0) {
            $builder->set('amount', 'amount+' . $amount, FALSE);
            $builder->set('dr', 'dr+' . $amount, FALSE);
            $builder->set('bal', $bal);
            $this->db->table('id', $query->row()->id)->where();
            $builder->update('transactions');
        } else {
            $arrayTransactions['date'] = date("Y-m-d");
            $arrayTransactions['ref'] = '';
            $arrayTransactions['amount'] = $amount;
            $arrayTransactions['dr'] = $amount;
            $arrayTransactions['cr'] = 0;
            $arrayTransactions['bal'] = $bal;
            $arrayTransactions['pay_via'] = 5;
            $arrayTransactions['description'] = $description;
            $builder->insert('transactions', $arrayTransactions);
        }
        $builder->where('id', $accountID);
        $this->db->table('accounts', array('balance' => $bal))->update();
    }
    public function getInvoice($id)
    {
        $builder->select('payslip.*,staff.name as staff_name,staff.mobileno,IFNULL(staff_designation.name, "N/A") as designation_name,IFNULL(staff_department.name, "N/A") as department_name,branch.school_name,branch.email as school_email,branch.mobileno as school_mobileno,branch.address as school_address');
        $builder->from('payslip');
        $builder->join('staff', 'staff.id = payslip.staff_id', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->join('branch', 'branch.id = staff.branch_id', 'left');
        $builder->where('payslip.id', $id);
        return $builder->get()->row_array();
    }
    // get staff all details
    public function getEmployeeList($branch_id, $role_id, $designation)
    {
        $builder->select('staff.*,staff_designation.name as designation_name,staff_department.name as department_name,login_credential.role as role_id, roles.name as role');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != 6 and login_credential.role != 7', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->where('login_credential.role', $role_id);
        $builder->where('login_credential.active', 1);
        $builder->where('staff.branch_id', $branch_id);
        $builder->where('staff.designation', $designation);
        return $builder->get()->getResult();
    }
    // get employee payment list
    public function getEmployeePaymentList($branch_id = '', $role_id, $month, $year)
    {
        $builder->select('staff.*,staff_designation.name as designation_name,staff_department.name as department_name,login_credential.role as role_id, roles.name as role, IFNULL(payslip.id, 0) as salary_id, payslip.hash as salary_hash,salary_template.name as template_name, salary_template.basic_salary');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->join('payslip', 'payslip.staff_id = staff.id and payslip.month = ' . $db->escape($month) . ' and payslip.year = ' . $db->escape($year), 'left');
        $builder->join('salary_template', 'salary_template.id = staff.salary_template_id', 'left');
        $builder->where('staff.branch_id', $branch_id);
        $builder->where('login_credential.role', $role_id);
        $builder->where('login_credential.active', 1);
        $builder->where('staff.salary_template_id !=', 0);
        return $builder->get()->getResult();
    }
    // get employee payment list
    public function getEmployeePayment($staff_id, $month, $year)
    {
        $sql = "SELECT `staff`.*, `staff_designation`.`name` as `designation_name`, `staff_department`.`name` as `department_name`, `login_credential`.`role` as `role_id`, `roles`.`name` as `role`,\r\n        `salary_template`.`name` as `template_name`, `salary_template`.`basic_salary`, `salary_template`.`overtime_salary`, `advance_salary`.`amount` as `advance_amount` FROM `staff` INNER JOIN\r\n        `login_credential` ON `login_credential`.`user_id` = `staff`.`id` LEFT JOIN `roles` ON `roles`.`id` = `login_credential`.`role` LEFT JOIN `staff_designation` ON\r\n        `staff_designation`.`id` = `staff`.`designation` LEFT JOIN `staff_department` ON `staff_department`.`id` = `staff`.`department` LEFT JOIN `salary_template` ON\r\n        `salary_template`.`id` = `staff`.`salary_template_id` LEFT JOIN `advance_salary` ON `advance_salary`.`staff_id` = `staff`.`id` AND \r\n        `advance_salary`.`deduct_month` = " . $db->escape($month) . " AND `advance_salary`.`year` = " . $db->escape($year) . " WHERE\r\n        `staff`.`id` = " . $db->escape($staff_id);
        return $db->query($sql)->row_array();
    }
    public function getAdvanceSalaryList($month = '', $year = '', $branch_id = '')
    {
        $builder->select('advance_salary.*,staff.name,staff.photo,login_credential.role as role_id,roles.name as role');
        $builder->from('advance_salary');
        $builder->join('staff', 'staff.id = advance_salary.staff_id', 'inner');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != 6 and login_credential.role != 7', 'left');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        if (!empty($month)) {
            $builder->where('advance_salary.deduct_month', $month);
            $builder->where('advance_salary.year', $year);
        }
        if (!empty($branch_id)) {
            $builder->where('advance_salary.branch_id', $branch_id);
        }
        return $builder->get()->result_array();
    }
    // get summary report function
    public function get_summary($branch_id = '', $month = '', $year = '', $staffID)
    {
        $builder->select('payslip.*,staff.name as staff_name,staff.mobileno,IFNULL(staff_designation.name, "N/A") as designation_name,IFNULL(staff_department.name, "N/A") as department_name,payment_types.name as payvia');
        $builder->from('payslip');
        $builder->join('staff', 'staff.id = payslip.staff_id', 'left');
        $builder->join('staff_designation', 'staff_designation.id = staff.designation', 'left');
        $builder->join('staff_department', 'staff_department.id = staff.department', 'left');
        $builder->join('payment_types', 'payment_types.id = payslip.pay_via', 'left');
        if (!empty($staffID)) {
            $this->db->table('payslip.staff_id', get_loggedin_user_id())->where();
        }
        $builder->where('payslip.branch_id', $branch_id);
        $builder->where('payslip.month', $month);
        $builder->where('payslip.year', $year);
        return $builder->get()->result_array();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/LibraryModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class LibraryModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    public function book_save($data)
    {
        $arraybook = array('branch_id' => $this->application_model->get_branch_id(), 'title' => $data['book_title'], 'isbn_no' => $data['isbn_no'], 'author' => $data['author'], 'edition' => $data['edition'], 'purchase_date' => date('Y-m-d', strtotime($data['purchase_date'])), 'category_id' => $data['category_id'], 'publisher' => $data['publisher'], 'description' => $data['description'], 'price' => $data['price'], 'total_stock' => $data['total_stock']);
        if ($_FILES['cover_image']['name'] != "") {
            $config['upload_path'] = 'uploads/book_cover/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $config['file_name'] = 'cover_image_' . app_generate_hash();
            $this->upload->initialize($config);
            if ($this->upload->do_upload("cover_image")) {
                $arraybook['cover'] = $this->upload->data('file_name');
            }
        }
        if (!isset($data['book_id'])) {
            $builder->insert('book', $arraybook);
        } else {
            if ($_FILES['cover_image']['name'] != "") {
                if (!empty($data['old_file'])) {
                    $file = 'uploads/book_cover/' . $data['old_file'];
                    if (file_exists($file)) {
                        @unlink($file);
                    }
                }
            }
            $builder->where('id', $data['book_id']);
            $builder->update('book', $arraybook);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function category_save($data)
    {
        $arrayData = array('name' => $data['name'], 'branch_id' => $this->application_model->get_branch_id());
        if (!isset($arrayData['category_id'])) {
            $builder->insert('book_category', $arrayData);
        } else {
            $builder->where('id', $arrayData['category_id']);
            $builder->update('book_category', $arrayData);
        }
    }
    // book issue information storage
    public function issued_save($data)
    {
        $arrayIssue = array('branch_id' => $this->application_model->get_branch_id(), 'book_id' => $data['book_id'], 'user_id' => $data['user_id'], 'role_id' => $data['role_id'], 'date_of_issue' => date("Y-m-d"), 'date_of_expiry' => date("Y-m-d", strtotime($data['date_of_expiry'])), 'issued_by' => get_loggedin_user_id(), 'status' => 1, 'session_id' => get_session_id());
        $builder->insert('book_issues', $arrayIssue);
        // update book issued copies value
        $builder->set('issued_copies', 'issued_copies+1', FALSE);
        $builder->where('id', $arrayIssue['book_id']);
        $builder->update('book');
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    // get book issue list
    public function getBookIssueList($id = '')
    {
        $builder->select('bi.*,b.title,b.cover,b.isbn_no,b.edition,b.author,br.name as branch_name,c.name as category_name,roles.name as role_name');
        $builder->from('book_issues as bi');
        $builder->join('book as b', 'b.id = bi.book_id', 'left');
        $builder->join('branch as br', 'br.id = bi.branch_id', 'left');
        $builder->join('roles', 'roles.id = bi.role_id', 'left');
        $builder->join('book_category as c', 'c.id = b.category_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('bi.branch_id', get_loggedin_branch_id())->where();
        }
        $this->db->table('bi.session_id', get_session_id())->where();
        if ($id != '') {
            $builder->where('bi.id', $id);
            return $builder->get()->row_array();
        } else {
            $builder->order_by('bi.id', 'desc');
            return $builder->get()->result_array();
        }
    }
    // get book issue list
    public function get_book_issue_list()
    {
        $builder->select('bi.*,b.title,b.cover,b.isbn_no,b.edition,c.name as category_name');
        $builder->from('book_issues as bi');
        $builder->join('book as b', 'b.id = bi.book_id', 'left');
        $builder->join('book_category as c', 'c.id = b.category_id', 'left');
        if (is_parent_loggedin()) {
            $builder->where('bi.user_role', 'student');
            $this->db->table('bi.user_id', get_activeChildren_id())->where();
        } else {
            $this->db->table('bi.user_role', get_loggedin_user_type())->where();
            $this->db->table('bi.user_id', get_loggedin_user_id())->where();
        }
        $this->db->table('bi.session_id', get_session_id())->where();
        $builder->order_by('bi.id', 'desc');
        return $builder->get();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class LibraryModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();

        parent::__construct();
    }
    public function book_save($data)
    {
        $arraybook = array('branch_id' => $this->applicationModel->get_branch_id(), 'title' => $data['book_title'], 'isbn_no' => $data['isbn_no'], 'author' => $data['author'], 'edition' => $data['edition'], 'purchase_date' => date('Y-m-d', strtotime($data['purchase_date'])), 'category_id' => $data['category_id'], 'publisher' => $data['publisher'], 'description' => $data['description'], 'price' => $data['price'], 'total_stock' => $data['total_stock']);
        if ($_FILES['cover_image']['name'] != "") {
            $config['upload_path'] = 'uploads/book_cover/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $config['file_name'] = 'cover_image_' . app_generate_hash();
            $this->upload->initialize($config);
            if ($this->upload->do_upload("cover_image")) {
                $arraybook['cover'] = $this->upload->data('file_name');
            }
        }
        if (!isset($data['book_id'])) {
            $builder->insert('book', $arraybook);
        } else {
            if ($_FILES['cover_image']['name'] != "") {
                if (!empty($data['old_file'])) {
                    $file = 'uploads/book_cover/' . $data['old_file'];
                    if (file_exists($file)) {
                        @unlink($file);
                    }
                }
            }
            $builder->where('id', $data['book_id']);
            $builder->update('book', $arraybook);
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function category_save($data)
    {
        $arrayData = array('name' => $data['name'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (!isset($arrayData['category_id'])) {
            $builder->insert('book_category', $arrayData);
        } else {
            $builder->where('id', $arrayData['category_id']);
            $builder->update('book_category', $arrayData);
        }
    }
    // book issue information storage
    public function issued_save($data)
    {
        $arrayIssue = array('branch_id' => $this->applicationModel->get_branch_id(), 'book_id' => $data['book_id'], 'user_id' => $data['user_id'], 'role_id' => $data['role_id'], 'date_of_issue' => date("Y-m-d"), 'date_of_expiry' => date("Y-m-d", strtotime($data['date_of_expiry'])), 'issued_by' => get_loggedin_user_id(), 'status' => 1, 'session_id' => get_session_id());
        $builder->insert('book_issues', $arrayIssue);
        // update book issued copies value
        $builder->set('issued_copies', 'issued_copies+1', FALSE);
        $builder->where('id', $arrayIssue['book_id']);
        $builder->update('book');
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    // get book issue list
    public function getBookIssueList($id = '')
    {
        $builder->select('bi.*,b.title,b.cover,b.isbn_no,b.edition,b.author,br.name as branch_name,c.name as category_name,roles.name as role_name');
        $builder->from('book_issues as bi');
        $builder->join('book as b', 'b.id = bi.book_id', 'left');
        $builder->join('branch as br', 'br.id = bi.branch_id', 'left');
        $builder->join('roles', 'roles.id = bi.role_id', 'left');
        $builder->join('book_category as c', 'c.id = b.category_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('bi.branch_id', get_loggedin_branch_id())->where();
        }
        $this->db->table('bi.session_id', get_session_id())->where();
        if ($id != '') {
            $builder->where('bi.id', $id);
            return $builder->get()->row_array();
        } else {
            $builder->order_by('bi.id', 'desc');
            return $builder->get()->result_array();
        }
    }
    // get book issue list
    public function get_book_issue_list()
    {
        $builder->select('bi.*,b.title,b.cover,b.isbn_no,b.edition,c.name as category_name');
        $builder->from('book_issues as bi');
        $builder->join('book as b', 'b.id = bi.book_id', 'left');
        $builder->join('book_category as c', 'c.id = b.category_id', 'left');
        if (is_parent_loggedin()) {
            $builder->where('bi.user_role', 'student');
            $this->db->table('bi.user_id', get_activeChildren_id())->where();
        } else {
            $this->db->table('bi.user_role', get_loggedin_user_type())->where();
            $this->db->table('bi.user_id', get_loggedin_user_id())->where();
        }
        $this->db->table('bi.session_id', get_session_id())->where();
        $builder->order_by('bi.id', 'desc');
        return $builder->get();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/CertificateModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class CertificateModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getList()
    {
        $builder->select('certificates_templete.*,branch.name as branchname');
        $builder->from('certificates_templete');
        $builder->join('branch', 'branch.id = certificates_templete.branch_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('certificates_templete.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('certificates_templete.id', 'ASC');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function save($data)
    {
        $background_file = '';
        $oldBackground_file = $this->request->getPost('old_background_file');
        if (isset($_FILES["background_file"]) && !empty($_FILES['background_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("background_file")) {
                // need to unlink previous photo
                if (!empty($oldBackground_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldBackground_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $background_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldBackground_file)) {
            $background_file = $oldBackground_file;
        }
        $logo_file = '';
        $oldLogo_file = $this->request->getPost('old_logo_file');
        if (isset($_FILES["logo_file"]) && !empty($_FILES['logo_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("logo_file")) {
                // need to unlink previous photo
                if (!empty($oldLogo_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldLogo_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $logo_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldLogo_file)) {
            $logo_file = $oldLogo_file;
        }
        $signature_file = '';
        $oldSignature_file = $this->request->getPost('old_signature_file');
        if (isset($_FILES["signature_file"]) && !empty($_FILES['signature_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("signature_file")) {
                // need to unlink previous photo
                if (!empty($oldSignature_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldSignature_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $signature_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldSignature_file)) {
            $signature_file = $oldSignature_file;
        }
        if ($data['user_type'] == 1) {
            $qrCode = $data['stu_qr_code'];
        } else {
            $qrCode = $data['emp_qr_code'];
        }
        $arrayLive = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['certificate_name'], 'user_type' => $data['user_type'], 'page_layout' => $data['page_layout'], 'qr_code' => $qrCode, 'photo_style' => $data['photo_style'], 'photo_size' => empty($data['photo_size']) ? 100 : $data['photo_size'], 'top_space' => empty($data['top_space']) ? 0 : $data['top_space'], 'bottom_space' => empty($data['bottom_space']) ? 0 : $data['bottom_space'], 'right_space' => empty($data['right_space']) ? 0 : $data['right_space'], 'left_space' => empty($data['left_space']) ? 0 : $data['left_space'], 'background' => $background_file, 'logo' => $logo_file, 'signature' => $signature_file, 'content' => $this->request->getPost('content', false));
        if (!isset($data['certificate_id'])) {
            $builder->insert('certificates_templete', $arrayLive);
        } else {
            $builder->where('id', $data['certificate_id']);
            $builder->update('certificates_templete', $arrayLive);
        }
    }
    public function tagsList($roleID = "")
    {
        $arrayTags = array();
        $arrayTags[] = '{name}';
        $arrayTags[] = '{gender}';
        if ($roleID == 1) {
            $arrayTags[] = '{father_name}';
            $arrayTags[] = '{mother_name}';
            $arrayTags[] = '{student_photo}';
            $arrayTags[] = '{register_no}';
            $arrayTags[] = '{roll}';
            $arrayTags[] = '{admission_date}';
            $arrayTags[] = '{class}';
            $arrayTags[] = '{section}';
            $arrayTags[] = '{category}';
            $arrayTags[] = '{caste}';
        }
        if ($roleID == 2) {
            $arrayTags[] = '{staff_photo}';
            $arrayTags[] = '{staff_id}';
            $arrayTags[] = '{joining_date}';
            $arrayTags[] = '{designation}';
            $arrayTags[] = '{department}';
            $arrayTags[] = '{qualification}';
            $arrayTags[] = '{total_experience}';
        }
        $arrayTags[] = '{religion}';
        $arrayTags[] = '{blood_group}';
        $arrayTags[] = '{birthday}';
        $arrayTags[] = '{email}';
        $arrayTags[] = '{mobileno}';
        $arrayTags[] = '{present_address}';
        $arrayTags[] = '{permanent_address}';
        $arrayTags[] = '{logo}';
        $arrayTags[] = '{signature}';
        $arrayTags[] = '{qr_code}';
        $arrayTags[] = '{institute_name}';
        $arrayTags[] = '{institute_email}';
        $arrayTags[] = '{institute_address}';
        $arrayTags[] = '{institute_mobile_no}';
        $arrayTags[] = '{print_date}';
        return $arrayTags;
    }
    public function tagsReplace($roleID, $userID, $templete, $print_date)
    {
        $body = $templete['content'];
        $photo_size = $templete['photo_size'];
        $photo_style = $templete['photo_style'];
        $tags = $this->tagsList($roleID);
        if ($roleID == 1) {
            $userDetails = $this->getStudent($userID);
        } else if ($roleID == 2) {
            $userDetails = $this->getStaff($userID);
        }
        $arr = array('{', '}');
        foreach ($tags as $tag) {
            $field = str_replace($arr, '', $tag);
            if ($roleID == 1) {
                if ($field == 'student_photo') {
                    $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('student', $userDetails['photo']) . '" width="' . $photo_size . '">';
                    $body = str_replace($tag, $photo, $body);
                } else if ($field == 'logo') {
                    if (!empty($templete['logo'])) {
                        $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                        $body = str_replace($tag, $logo_ph, $body);
                    }
                } else if ($field == 'signature') {
                    if (!empty($templete['signature'])) {
                        $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                        $body = str_replace($tag, $signature_ph, $body);
                    }
                } else if ($field == 'qr_code') {
                    if (!empty($templete['qr_code'])) {
                        $qr_code = $templete['qr_code'];
                        $params['savename'] = 'uploads/qr_code/stu_' . $userDetails['id'] . '.png';
                        $params['level'] = 'M';
                        $params['size'] = 4;
                        $params['data'] = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                        $qrCode = $this->ciqrcode->generate($params);
                        $photo = '<img src="' . base_url($qrCode) . '">';
                        $body = str_replace($tag, $photo, $body);
                    }
                } else if ($field == 'present_address') {
                    $body = str_replace($tag, $userDetails['current_address'], $body);
                } else if ($field == 'print_date') {
                    $body = str_replace($tag, _d($print_date), $body);
                } else {
                    $body = str_replace($tag, $userDetails[$field], $body);
                }
            }
            if ($roleID == 2) {
                if ($field == 'staff_photo') {
                    $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('staff', $userDetails['photo']) . '" width="' . $photo_size . '">';
                    $body = str_replace($tag, $photo, $body);
                } else if ($field == 'logo') {
                    if (!empty($templete['logo'])) {
                        $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                        $body = str_replace($tag, $logo_ph, $body);
                    }
                } else if ($field == 'signature') {
                    if (!empty($templete['signature'])) {
                        $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                        $body = str_replace($tag, $signature_ph, $body);
                    }
                } else if ($field == 'print_date') {
                    $body = str_replace($tag, _d($print_date), $body);
                } else if ($field == 'qr_code') {
                    if (!empty($templete['qr_code'])) {
                        $qr_code = $templete['qr_code'];
                        $params['savename'] = 'uploads/qr_code/sta_' . $userDetails['id'] . '.png';
                        $params['level'] = 'M';
                        $params['size'] = 4;
                        $params['data'] = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                        $qrCode = $this->ciqrcode->generate($params);
                        $photo = '<img src="' . base_url($qrCode) . '">';
                        $body = str_replace($tag, $photo, $body);
                    }
                } else if ($field == 'gender') {
                    $body = str_replace($tag, $userDetails['sex'], $body);
                } else {
                    $body = str_replace($tag, $userDetails[$field], $body);
                }
            }
        }
        return $body;
    }
    public function getStudent($id)
    {
        $builder->select('s.*,CONCAT_WS(" ",s.first_name, s.last_name) as name,e.roll,e.branch_id,e.session_id,c.name as class,se.name as section,sc.name as category,p.father_name,p.mother_name,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'left');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->join('student_category as sc', 's.category_id=sc.id', 'left');
        $builder->join('parent as p', 'p.id=s.parent_id', 'left');
        $builder->join('branch as br', 'br.id = e.branch_id', 'left');
        $builder->where('s.id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
    public function getStaff($id)
    {
        $builder->select('s.*,s.department as deid,s.designation as desid,staff_department.name as department,staff_designation.name as designation,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('staff as s');
        $builder->join('staff_department', 'staff_department.id = s.department', 'left');
        $builder->join('staff_designation', 'staff_designation.id = s.designation', 'left');
        $builder->join('branch as br', 'br.id = s.branch_id', 'left');
        $builder->where('s.id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class CertificateModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getList()
    {
        $builder->select('certificates_templete.*,branch.name as branchname');
        $builder->from('certificates_templete');
        $builder->join('branch', 'branch.id = certificates_templete.branch_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('certificates_templete.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('certificates_templete.id', 'ASC');
        $result = $builder->get()->result_array();
        return $result;
    }
    public function save($data)
    {
        $background_file = '';
        $oldBackground_file = $this->request->getPost('old_background_file');
        if (isset($_FILES["background_file"]) && !empty($_FILES['background_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("background_file")) {
                // need to unlink previous photo
                if (!empty($oldBackground_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldBackground_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $background_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldBackground_file)) {
            $background_file = $oldBackground_file;
        }
        $logo_file = '';
        $oldLogo_file = $this->request->getPost('old_logo_file');
        if (isset($_FILES["logo_file"]) && !empty($_FILES['logo_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("logo_file")) {
                // need to unlink previous photo
                if (!empty($oldLogo_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldLogo_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $logo_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldLogo_file)) {
            $logo_file = $oldLogo_file;
        }
        $signature_file = '';
        $oldSignature_file = $this->request->getPost('old_signature_file');
        if (isset($_FILES["signature_file"]) && !empty($_FILES['signature_file']['name'])) {
            $config['upload_path'] = './uploads/certificate/';
            $config['allowed_types'] = 'jpg|png';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("signature_file")) {
                // need to unlink previous photo
                if (!empty($oldSignature_file)) {
                    $unlink_path = 'uploads/certificate/' . $oldSignature_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $signature_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldSignature_file)) {
            $signature_file = $oldSignature_file;
        }
        if ($data['user_type'] == 1) {
            $qrCode = $data['stu_qr_code'];
        } else {
            $qrCode = $data['emp_qr_code'];
        }
        $arrayLive = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['certificate_name'], 'user_type' => $data['user_type'], 'page_layout' => $data['page_layout'], 'qr_code' => $qrCode, 'photo_style' => $data['photo_style'], 'photo_size' => empty($data['photo_size']) ? 100 : $data['photo_size'], 'top_space' => empty($data['top_space']) ? 0 : $data['top_space'], 'bottom_space' => empty($data['bottom_space']) ? 0 : $data['bottom_space'], 'right_space' => empty($data['right_space']) ? 0 : $data['right_space'], 'left_space' => empty($data['left_space']) ? 0 : $data['left_space'], 'background' => $background_file, 'logo' => $logo_file, 'signature' => $signature_file, 'content' => $this->request->getPost('content', false));
        if (!isset($data['certificate_id'])) {
            $builder->insert('certificates_templete', $arrayLive);
        } else {
            $builder->where('id', $data['certificate_id']);
            $builder->update('certificates_templete', $arrayLive);
        }
    }
    public function tagsList($roleID = "")
    {
        $arrayTags = array();
        $arrayTags[] = '{name}';
        $arrayTags[] = '{gender}';
        if ($roleID == 1) {
            $arrayTags[] = '{father_name}';
            $arrayTags[] = '{mother_name}';
            $arrayTags[] = '{student_photo}';
            $arrayTags[] = '{register_no}';
            $arrayTags[] = '{roll}';
            $arrayTags[] = '{admission_date}';
            $arrayTags[] = '{class}';
            $arrayTags[] = '{section}';
            $arrayTags[] = '{category}';
            $arrayTags[] = '{caste}';
        }
        if ($roleID == 2) {
            $arrayTags[] = '{staff_photo}';
            $arrayTags[] = '{staff_id}';
            $arrayTags[] = '{joining_date}';
            $arrayTags[] = '{designation}';
            $arrayTags[] = '{department}';
            $arrayTags[] = '{qualification}';
            $arrayTags[] = '{total_experience}';
        }
        $arrayTags[] = '{religion}';
        $arrayTags[] = '{blood_group}';
        $arrayTags[] = '{birthday}';
        $arrayTags[] = '{email}';
        $arrayTags[] = '{mobileno}';
        $arrayTags[] = '{present_address}';
        $arrayTags[] = '{permanent_address}';
        $arrayTags[] = '{logo}';
        $arrayTags[] = '{signature}';
        $arrayTags[] = '{qr_code}';
        $arrayTags[] = '{institute_name}';
        $arrayTags[] = '{institute_email}';
        $arrayTags[] = '{institute_address}';
        $arrayTags[] = '{institute_mobile_no}';
        $arrayTags[] = '{print_date}';
        return $arrayTags;
    }
    public function tagsReplace($roleID, $userID, $templete, $print_date)
    {
        $body = $templete['content'];
        $photo_size = $templete['photo_size'];
        $photo_style = $templete['photo_style'];
        $tags = $this->tagsList($roleID);
        if ($roleID == 1) {
            $userDetails = $this->getStudent($userID);
        } else if ($roleID == 2) {
            $userDetails = $this->getStaff($userID);
        }
        $arr = array('{', '}');
        foreach ($tags as $tag) {
            $field = str_replace($arr, '', $tag);
            if ($roleID == 1) {
                if ($field == 'student_photo') {
                    $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('student', $userDetails['photo']) . '" width="' . $photo_size . '">';
                    $body = str_replace($tag, $photo, $body);
                } else if ($field == 'logo') {
                    if (!empty($templete['logo'])) {
                        $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                        $body = str_replace($tag, $logo_ph, $body);
                    }
                } else if ($field == 'signature') {
                    if (!empty($templete['signature'])) {
                        $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                        $body = str_replace($tag, $signature_ph, $body);
                    }
                } else if ($field == 'qr_code') {
                    if (!empty($templete['qr_code'])) {
                        $qr_code = $templete['qr_code'];
                        $params['savename'] = 'uploads/qr_code/stu_' . $userDetails['id'] . '.png';
                        $params['level'] = 'M';
                        $params['size'] = 4;
                        $params['data'] = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                        $qrCode = $this->ciqrcode->generate($params);
                        $photo = '<img src="' . base_url($qrCode) . '">';
                        $body = str_replace($tag, $photo, $body);
                    }
                } else if ($field == 'present_address') {
                    $body = str_replace($tag, $userDetails['current_address'], $body);
                } else if ($field == 'print_date') {
                    $body = str_replace($tag, _d($print_date), $body);
                } else {
                    $body = str_replace($tag, $userDetails[$field], $body);
                }
            }
            if ($roleID == 2) {
                if ($field == 'staff_photo') {
                    $photo = '<img class="' . ($photo_style == 1 ? '' : 'rounded') . '" src="' . get_image_url('staff', $userDetails['photo']) . '" width="' . $photo_size . '">';
                    $body = str_replace($tag, $photo, $body);
                } else if ($field == 'logo') {
                    if (!empty($templete['logo'])) {
                        $logo_ph = '<img src="' . base_url('uploads/certificate/' . $templete['logo']) . '">';
                        $body = str_replace($tag, $logo_ph, $body);
                    }
                } else if ($field == 'signature') {
                    if (!empty($templete['signature'])) {
                        $signature_ph = '<img src="' . base_url('uploads/certificate/' . $templete['signature']) . '">';
                        $body = str_replace($tag, $signature_ph, $body);
                    }
                } else if ($field == 'print_date') {
                    $body = str_replace($tag, _d($print_date), $body);
                } else if ($field == 'qr_code') {
                    if (!empty($templete['qr_code'])) {
                        $qr_code = $templete['qr_code'];
                        $params['savename'] = 'uploads/qr_code/sta_' . $userDetails['id'] . '.png';
                        $params['level'] = 'M';
                        $params['size'] = 4;
                        $params['data'] = ucfirst($qr_code) . " - " . $userDetails[$qr_code];
                        $qrCode = $this->ciqrcode->generate($params);
                        $photo = '<img src="' . base_url($qrCode) . '">';
                        $body = str_replace($tag, $photo, $body);
                    }
                } else if ($field == 'gender') {
                    $body = str_replace($tag, $userDetails['sex'], $body);
                } else {
                    $body = str_replace($tag, $userDetails[$field], $body);
                }
            }
        }
        return $body;
    }
    public function getStudent($id)
    {
        $builder->select('s.*,CONCAT_WS(" ",s.first_name, s.last_name) as name,e.roll,e.branch_id,e.session_id,c.name as class,se.name as section,sc.name as category,p.father_name,p.mother_name,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'left');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->join('student_category as sc', 's.category_id=sc.id', 'left');
        $builder->join('parent as p', 'p.id=s.parent_id', 'left');
        $builder->join('branch as br', 'br.id = e.branch_id', 'left');
        $builder->where('s.id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
    public function getStaff($id)
    {
        $builder->select('s.*,s.department as deid,s.designation as desid,staff_department.name as department,staff_designation.name as designation,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('staff as s');
        $builder->join('staff_department', 'staff_department.id = s.department', 'left');
        $builder->join('staff_designation', 'staff_designation.id = s.designation', 'left');
        $builder->join('branch as br', 'br.id = s.branch_id', 'left');
        $builder->where('s.id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/ParentsModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class ParentsModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    // moderator parents all information
    public function save($data, $getBranch = array())
    {
        $inser_data1 = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['name'], 'relation' => $data['relation'], 'father_name' => $data['father_name'], 'mother_name' => $data['mother_name'], 'occupation' => $data['occupation'], 'income' => $data['income'], 'education' => $data['education'], 'email' => $data['email'], 'mobileno' => $data['mobileno'], 'address' => $data['address'], 'city' => $data['city'], 'state' => $data['state'], 'photo' => $this->uploadImage('parent'), 'facebook_url' => $data['facebook'], 'linkedin_url' => $data['linkedin'], 'twitter_url' => $data['twitter']);
        if (!isset($data['parent_id']) && empty($data['parent_id'])) {
            // save employee information in the database
            $builder->insert('parent', $inser_data1);
            $parent_id = $builder->insert_id();
            // save guardian login credential information in the database
            if ($getBranch['grd_generate'] == 1) {
                $username = $getBranch['grd_username_prefix'] . $parent_id;
                $password = $getBranch['grd_default_password'];
            } else {
                $username = $data['username'];
                $password = $data['password'];
            }
            $inser_data2 = array('username' => $username, 'role' => 6, 'active' => 1, 'user_id' => $parent_id, 'password' => $this->app_lib->pass_hashed($password));
            $builder->insert('login_credential', $inser_data2);
            // send account activate email
            $emailData = array('name' => $data['name'], 'username' => $username, 'password' => $password, 'user_role' => 6, 'email' => $data['email']);
            $this->email_model->sentStaffRegisteredAccount($emailData);
            return $parent_id;
        } else {
            $builder->where('id', $data['parent_id']);
            $builder->update('parent', $inser_data1);
            // update login credential information in the database
            $this->db->table(array('role' => 6, 'user_id' => $data['parent_id']))->where();
            $this->db->table('login_credential', array('username' => $data['username']))->update();
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function getSingleParent($id)
    {
        $builder->select('parent.*,login_credential.role as role_id,login_credential.active,login_credential.username,login_credential.id as login_id, roles.name as role');
        $builder->from('parent');
        $builder->join('login_credential', 'login_credential.user_id = parent.id and login_credential.role = "6"', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->where('parent.id', $id);
        if (!is_superadmin_loggedin()) {
            $this->db->table('parent.branch_id', get_loggedin_branch_id())->where();
        }
        $query = $builder->get();
        if ($query->num_rows() == 0) {
            show_404();
        }
        return $query->row_array();
    }
    public function childsResult($parent_id)
    {
        $builder->select('s.id,s.photo, CONCAT_WS(" ",s.first_name, s.last_name) as fullname,c.name as class_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('login_credential as l', 'l.user_id = s.id and l.role = 7', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id=se.id', 'left');
        $builder->where('s.parent_id', $parent_id);
        $builder->where('l.active', 1);
        $this->db->table('e.session_id', get_session_id())->where();
        return $builder->get()->result_array();
    }
    // get parent all details
    public function getParentList($branchID = null, $active = 1)
    {
        $builder->select('parent.*,login_credential.active as active');
        $builder->from('parent');
        $builder->join('login_credential', 'login_credential.user_id = parent.id and login_credential.role = "6"', 'inner');
        $builder->where('login_credential.active', $active);
        if (!empty($branchID)) {
            $builder->where('parent.branch_id', $branchID);
        }
        $builder->order_by('parent.id', 'ASC');
        return $builder->get()->getResult();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class ParentsModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    // moderator parents all information
    public function save($data, $getBranch = array())
    {
        $inser_data1 = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['name'], 'relation' => $data['relation'], 'father_name' => $data['father_name'], 'mother_name' => $data['mother_name'], 'occupation' => $data['occupation'], 'income' => $data['income'], 'education' => $data['education'], 'email' => $data['email'], 'mobileno' => $data['mobileno'], 'address' => $data['address'], 'city' => $data['city'], 'state' => $data['state'], 'photo' => $this->uploadImage('parent'), 'facebook_url' => $data['facebook'], 'linkedin_url' => $data['linkedin'], 'twitter_url' => $data['twitter']);
        if (!isset($data['parent_id']) && empty($data['parent_id'])) {
            // save employee information in the database
            $builder->insert('parent', $inser_data1);
            $parent_id = $builder->insert_id();
            // save guardian login credential information in the database
            if ($getBranch['grd_generate'] == 1) {
                $username = $getBranch['grd_username_prefix'] . $parent_id;
                $password = $getBranch['grd_default_password'];
            } else {
                $username = $data['username'];
                $password = $data['password'];
            }
            $inser_data2 = array('username' => $username, 'role' => 6, 'active' => 1, 'user_id' => $parent_id, 'password' => $this->app_lib->pass_hashed($password));
            $builder->insert('login_credential', $inser_data2);
            // send account activate email
            $emailData = array('name' => $data['name'], 'username' => $username, 'password' => $password, 'user_role' => 6, 'email' => $data['email']);
            $this->email_model->sentStaffRegisteredAccount($emailData);
            return $parent_id;
        } else {
            $builder->where('id', $data['parent_id']);
            $builder->update('parent', $inser_data1);
            // update login credential information in the database
            $this->db->table(array('role' => 6, 'user_id' => $data['parent_id']))->where();
            $this->db->table('login_credential', array('username' => $data['username']))->update();
        }
        if ($db->affectedRows() > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function getSingleParent($id)
    {
        $builder->select('parent.*,login_credential.role as role_id,login_credential.active,login_credential.username,login_credential.id as login_id, roles.name as role');
        $builder->from('parent');
        $builder->join('login_credential', 'login_credential.user_id = parent.id and login_credential.role = "6"', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        $builder->where('parent.id', $id);
        if (!is_superadmin_loggedin()) {
            $this->db->table('parent.branch_id', get_loggedin_branch_id())->where();
        }
        $query = $builder->get();
        if ($query->num_rows() == 0) {
            show_404();
        }
        return $query->row_array();
    }
    public function childsResult($parent_id)
    {
        $builder->select('s.id,s.photo, CONCAT_WS(" ",s.first_name, s.last_name) as fullname,c.name as class_name,se.name as section_name');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('login_credential as l', 'l.user_id = s.id and l.role = 7', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id=se.id', 'left');
        $builder->where('s.parent_id', $parent_id);
        $builder->where('l.active', 1);
        $this->db->table('e.session_id', get_session_id())->where();
        return $builder->get()->result_array();
    }
    // get parent all details
    public function getParentList($branchID = null, $active = 1)
    {
        $builder->select('parent.*,login_credential.active as active');
        $builder->from('parent');
        $builder->join('login_credential', 'login_credential.user_id = parent.id and login_credential.role = "6"', 'inner');
        $builder->where('login_credential.active', $active);
        if (!empty($branchID)) {
            $builder->where('parent.branch_id', $branchID);
        }
        $builder->order_by('parent.id', 'ASC');
        return $builder->get()->getResult();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/GalleryModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class GalleryModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // test save and update function
    public function save($data)
    {
        $alias = strtolower(str_replace(' ', '-', $data['gallery_title']));
        $insertGallery = array('branch_id' => $this->application_model->get_branch_id(), 'title' => $data['gallery_title'], 'description' => $data['description'], 'date' => date("Y-m-d"), 'category_id' => $data['category_id'], 'added_by' => get_loggedin_user_id(), 'elements' => json_encode([]), 'show_web' => isset($_POST['show_website']) ? 1 : 0, 'created_at' => date("Y-m-d"), 'thumb_image' => $this->upload_image());
        if (isset($data['gallery_id']) && !empty($data['gallery_id'])) {
            unset($insertGallery['elements']);
            $insertGallery['alias'] = $this->slug->create_uri($insertGallery, $data['gallery_id']);
            $builder->where('id', $data['gallery_id']);
            $builder->update('front_cms_gallery_content', $insertGallery);
        } else {
            $insertGallery['alias'] = $this->slug->create_uri($insertGallery);
            $builder->insert('front_cms_gallery_content', $insertGallery);
        }
    }
    // upload home slider image
    public function upload_image($name = 'gallery')
    {
        $prev_image = $this->request->getPost('old_photo');
        $image = $_FILES['thumb_image']['name'];
        $return_image = '';
        if ($image != '') {
            $destination = './uploads/frontend/gallery/';
            $extension = pathinfo($image, PATHINFO_EXTENSION);
            $image_path = $name . '-' . time() . '.' . $extension;
            move_uploaded_file($_FILES['thumb_image']['tmp_name'], $destination . $image_path);
            // need to unlink previous gallery image
            if ($prev_image != '') {
                if (file_exists($destination . $prev_image)) {
                    @unlink($destination . $prev_image);
                }
            }
            $return_image = $image_path;
        } else {
            $return_image = $prev_image;
        }
        return $return_image;
    }
    public function get_image_url($file_path = '')
    {
        $path = 'uploads/frontend/gallery/' . $file_path;
        if (empty($file_path) || !file_exists($path)) {
            $image_url = base_url('uploads/frontend/gallery/defualt.png');
        } else {
            $image_url = base_url($path);
        }
        return $image_url;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class GalleryModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    // test save and update function
    public function save($data)
    {
        $alias = strtolower(str_replace(' ', '-', $data['gallery_title']));
        $insertGallery = array('branch_id' => $this->applicationModel->get_branch_id(), 'title' => $data['gallery_title'], 'description' => $data['description'], 'date' => date("Y-m-d"), 'category_id' => $data['category_id'], 'added_by' => get_loggedin_user_id(), 'elements' => json_encode([]), 'show_web' => isset($_POST['show_website']) ? 1 : 0, 'created_at' => date("Y-m-d"), 'thumb_image' => $this->upload_image());
        if (isset($data['gallery_id']) && !empty($data['gallery_id'])) {
            unset($insertGallery['elements']);
            $insertGallery['alias'] = $this->slug->create_uri($insertGallery, $data['gallery_id']);
            $builder->where('id', $data['gallery_id']);
            $builder->update('front_cms_gallery_content', $insertGallery);
        } else {
            $insertGallery['alias'] = $this->slug->create_uri($insertGallery);
            $builder->insert('front_cms_gallery_content', $insertGallery);
        }
    }
    // upload home slider image
    public function upload_image($name = 'gallery')
    {
        $prev_image = $this->request->getPost('old_photo');
        $image = $_FILES['thumb_image']['name'];
        $return_image = '';
        if ($image != '') {
            $destination = './uploads/frontend/gallery/';
            $extension = pathinfo($image, PATHINFO_EXTENSION);
            $image_path = $name . '-' . time() . '.' . $extension;
            move_uploaded_file($_FILES['thumb_image']['tmp_name'], $destination . $image_path);
            // need to unlink previous gallery image
            if ($prev_image != '') {
                if (file_exists($destination . $prev_image)) {
                    @unlink($destination . $prev_image);
                }
            }
            $return_image = $image_path;
        } else {
            $return_image = $prev_image;
        }
        return $return_image;
    }
    public function get_image_url($file_path = '')
    {
        $path = 'uploads/frontend/gallery/' . $file_path;
        if (empty($file_path) || !file_exists($path)) {
            $image_url = base_url('uploads/frontend/gallery/defualt.png');
        } else {
            $image_url = base_url($path);
        }
        return $image_url;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/ExamModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class ExamModel extends Model
{
    protected $db;
    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getExamByID($id = null)
    {
        $sql = "SELECT `e`.*, `exam_term`.`name` as `term_name`, `b`.`name` as `branch_name` FROM `exam` as `e` INNER JOIN `branch` as `b` ON `b`.`id` = `e`.`branch_id` LEFT JOIN `exam_term` ON `exam_term`.`id` = `e`.`term_id` WHERE `e`.`id` = {$db->escape($id)}";
        return $db->query($sql)->row();
    }
    public function searchExamStudentsByRank($class_ID = '', $section_ID = '', $session_ID = '', $exam_ID = '', $branch_id = '')
    {
        $builder->select('e.*,CONCAT_WS(" ",first_name, last_name) as fullname,register_no,c.name as class_name,se.name as section_name,exam_rank.rank,exam_rank.principal_comments,exam_rank.teacher_comments');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('login_credential as l', 'l.user_id = s.id and l.role = 7', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id=se.id', 'left');
        $builder->join('exam_rank', 'exam_rank.enroll_id=e.id and exam_rank.exam_id = ' . $db->escape($exam_ID), 'left');
        $builder->where('e.class_id', $class_ID);
        if (!empty($section_ID)) {
            $builder->where('e.section_id', $section_ID);
        }
        $builder->where('e.branch_id', $branch_id);
        $builder->where('e.session_id', $session_ID);
        $builder->order_by('exam_rank.rank', 'ASC');
        $builder->where('l.active', 1);
        return $builder->get()->getResult();
    }
    public function getExamList()
    {
        $builder->select('e.*,b.name as branch_name');
        $builder->from('exam as e');
        $builder->join('branch as b', 'b.id = e.branch_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('e.branch_id', get_loggedin_branch_id())->where();
        }
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->order_by('e.id', 'asc');
        return $builder->get()->result_array();
    }
    public function exam_save($data)
    {
        $arrayExam = array('name' => $data['name'], 'branch_id' => $this->application_model->get_branch_id(), 'term_id' => $data['term_id'], 'type_id' => $data['type_id'], 'mark_distribution' => json_encode($data['mark_distribution']), 'remark' => $data['remark'], 'session_id' => get_session_id(), 'status' => isset($_POST['exam_publish']) ? 1 : 0, 'publish_result' => 0);
        if (!isset($data['exam_id'])) {
            $builder->insert('exam', $arrayExam);
        } else {
            $builder->where('id', $data['exam_id']);
            $builder->update('exam', $arrayExam);
        }
    }
    public function termSave($post)
    {
        $arrayTerm = array('name' => $post['term_name'], 'branch_id' => $this->application_model->get_branch_id(), 'session_id' => get_session_id());
        if (!isset($post['term_id'])) {
            $builder->insert('exam_term', $arrayTerm);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $post['term_id']);
            $builder->update('exam_term', $arrayTerm);
        }
    }
    public function hallSave($post)
    {
        $arrayHall = array('hall_no' => $post['hall_no'], 'seats' => $post['no_of_seats'], 'branch_id' => $this->application_model->get_branch_id());
        if (!isset($post['hall_id'])) {
            $builder->insert('exam_hall', $arrayHall);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $post['hall_id']);
            $builder->update('exam_hall', $arrayHall);
        }
    }
    public function gradeSave($data)
    {
        $arrayData = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['name'], 'grade_point' => $data['grade_point'], 'lower_mark' => $data['lower_mark'], 'upper_mark' => $data['upper_mark'], 'remark' => $data['remark']);
        // posted all data XSS filtering
        if (!isset($data['grade_id'])) {
            $builder->insert('grade', $arrayData);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['grade_id']);
            $builder->update('grade', $arrayData);
        }
    }
    public function get_grade($mark, $branch_id)
    {
        $builder->where('branch_id', $branch_id);
        $query = $builder->get('grade');
        $grades = $query->getResultArray();
        foreach ($grades as $row) {
            if ($mark >= $row['lower_mark'] && $mark <= $row['upper_mark']) {
                return $row;
            }
        }
    }
    public function getSubjectList($examID, $classID, $sectionID, $sessionID)
    {
        $branchID = $this->application_model->get_branch_id();
        $builder->select('t.*,s.name as subject_name');
        $builder->from('timetable_exam as t');
        $builder->join('subject as s', 's.id = t.subject_id', 'inner');
        $builder->where('t.exam_id', $examID);
        $builder->where('t.class_id', $classID);
        $builder->where('t.section_id', $sectionID);
        $builder->where('t.session_id', $sessionID);
        $builder->where('t.branch_id', $branchID);
        $builder->group_by('t.subject_id');
        return $builder->get()->result_array();
    }
    public function getTimetableDetail($classID, $sectionID, $examID, $subjectID)
    {
        $builder->select('timetable_exam.mark_distribution');
        $builder->where('class_id', $classID);
        $builder->where('section_id', $sectionID);
        $builder->where('exam_id', $examID);
        $builder->where('subject_id', $subjectID);
        $this->db->table('session_id', get_session_id())->where();
        return $builder->get('timetable_exam')->row_array();
    }
    public function getMarkAndStudent($branchID, $classID, $sectionID, $examID, $subjectID)
    {
        $builder->select('en.*,st.first_name,st.last_name,st.register_no,st.category_id,m.mark as get_mark,IFNULL(m.absent, 0) as get_abs,subject.name as subject_name');
        $builder->from('enroll as en');
        $builder->join('student as st', 'st.id = en.student_id', 'inner');
        $builder->join('mark as m', 'm.student_id = en.student_id and m.class_id = en.class_id and m.section_id = en.section_id and m.exam_id = ' . $db->escape($examID) . ' and m.subject_id = ' . $db->escape($subjectID), 'left');
        $builder->join('subject', 'subject.id = m.subject_id', 'left');
        $builder->where('en.class_id', $classID);
        $builder->where('en.section_id', $sectionID);
        $builder->where('en.branch_id', $branchID);
        $this->db->table('en.session_id', get_session_id())->where();
        $builder->order_by('en.roll', 'ASC');
        return $builder->get()->result_array();
    }
    public function getStudentReportCard($studentID, $examID, $sessionID, $classID = '', $sectionID = '')
    {
        $result = array();
        $builder->select('s.*,CONCAT_WS(" ",s.first_name, s.last_name) as name,e.id as enrollID,e.roll,e.branch_id,e.session_id,e.class_id,e.section_id,c.name as class,se.name as section,sc.name as category,IFNULL(p.father_name,"N/A") as father_name,IFNULL(p.mother_name,"N/A") as mother_name,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->join('student_category as sc', 's.category_id=sc.id', 'left');
        $builder->join('parent as p', 'p.id=s.parent_id', 'left');
        $builder->join('branch as br', 'br.id = e.branch_id', 'left');
        $builder->where('e.student_id', $studentID);
        $builder->where('e.session_id', $sessionID);
        if (!empty($classID)) {
            $builder->where('e.class_id', $classID);
        }
        if (!empty($sectionID)) {
            $builder->where('e.section_id', $sectionID);
        }
        $result['student'] = $builder->get()->row_array();
        $builder->select('m.mark as get_mark,IFNULL(m.absent, 0) as get_abs,subject.name as subject_name, te.mark_distribution, m.subject_id');
        $builder->from('mark as m');
        $builder->join('subject', 'subject.id = m.subject_id', 'left');
        $builder->join('timetable_exam as te', 'te.exam_id = m.exam_id and te.class_id = m.class_id and te.section_id = m.section_id and te.subject_id = m.subject_id', 'left');
        $builder->where('m.exam_id', $examID);
        $builder->where('m.student_id', $studentID);
        $builder->where('m.session_id', $sessionID);
        if (!empty($classID)) {
            $builder->where('m.class_id', $classID);
        }
        if (!empty($sectionID)) {
            $builder->where('m.section_id', $sectionID);
        }
        $builder->group_by('m.subject_id');
        $builder->order_by('subject.id', 'ASC');
        $result['exam'] = $builder->get()->result_array();
        return $result;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class ExamModel extends Model
{
    protected $db;
    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getExamByID($id = null)
    {
        $sql = "SELECT `e`.*, `exam_term`.`name` as `term_name`, `b`.`name` as `branch_name` FROM `exam` as `e` INNER JOIN `branch` as `b` ON `b`.`id` = `e`.`branch_id` LEFT JOIN `exam_term` ON `exam_term`.`id` = `e`.`term_id` WHERE `e`.`id` = {$db->escape($id)}";
        return $db->query($sql)->row();
    }
    public function searchExamStudentsByRank($class_ID = '', $section_ID = '', $session_ID = '', $exam_ID = '', $branch_id = '')
    {
        $builder->select('e.*,CONCAT_WS(" ",first_name, last_name) as fullname,register_no,c.name as class_name,se.name as section_name,exam_rank.rank,exam_rank.principal_comments,exam_rank.teacher_comments');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('login_credential as l', 'l.user_id = s.id and l.role = 7', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id=se.id', 'left');
        $builder->join('exam_rank', 'exam_rank.enroll_id=e.id and exam_rank.exam_id = ' . $db->escape($exam_ID), 'left');
        $builder->where('e.class_id', $class_ID);
        if (!empty($section_ID)) {
            $builder->where('e.section_id', $section_ID);
        }
        $builder->where('e.branch_id', $branch_id);
        $builder->where('e.session_id', $session_ID);
        $builder->order_by('exam_rank.rank', 'ASC');
        $builder->where('l.active', 1);
        return $builder->get()->getResult();
    }
    public function getExamList()
    {
        $builder->select('e.*,b.name as branch_name');
        $builder->from('exam as e');
        $builder->join('branch as b', 'b.id = e.branch_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('e.branch_id', get_loggedin_branch_id())->where();
        }
        $this->db->table('e.session_id', get_session_id())->where();
        $builder->order_by('e.id', 'asc');
        return $builder->get()->result_array();
    }
    public function exam_save($data)
    {
        $arrayExam = array('name' => $data['name'], 'branch_id' => $this->applicationModel->get_branch_id(), 'term_id' => $data['term_id'], 'type_id' => $data['type_id'], 'mark_distribution' => json_encode($data['mark_distribution']), 'remark' => $data['remark'], 'session_id' => get_session_id(), 'status' => isset($_POST['exam_publish']) ? 1 : 0, 'publish_result' => 0);
        if (!isset($data['exam_id'])) {
            $builder->insert('exam', $arrayExam);
        } else {
            $builder->where('id', $data['exam_id']);
            $builder->update('exam', $arrayExam);
        }
    }
    public function termSave($post)
    {
        $arrayTerm = array('name' => $post['term_name'], 'branch_id' => $this->applicationModel->get_branch_id(), 'session_id' => get_session_id());
        if (!isset($post['term_id'])) {
            $builder->insert('exam_term', $arrayTerm);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $post['term_id']);
            $builder->update('exam_term', $arrayTerm);
        }
    }
    public function hallSave($post)
    {
        $arrayHall = array('hall_no' => $post['hall_no'], 'seats' => $post['no_of_seats'], 'branch_id' => $this->applicationModel->get_branch_id());
        if (!isset($post['hall_id'])) {
            $builder->insert('exam_hall', $arrayHall);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $post['hall_id']);
            $builder->update('exam_hall', $arrayHall);
        }
    }
    public function gradeSave($data)
    {
        $arrayData = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['name'], 'grade_point' => $data['grade_point'], 'lower_mark' => $data['lower_mark'], 'upper_mark' => $data['upper_mark'], 'remark' => $data['remark']);
        // posted all data XSS filtering
        if (!isset($data['grade_id'])) {
            $builder->insert('grade', $arrayData);
        } else {
            if (!is_superadmin_loggedin()) {
                $this->db->table('branch_id', get_loggedin_branch_id())->where();
            }
            $builder->where('id', $data['grade_id']);
            $builder->update('grade', $arrayData);
        }
    }
    public function get_grade($mark, $branch_id)
    {
        $builder->where('branch_id', $branch_id);
        $query = $builder->get('grade');
        $grades = $query->getResultArray();
        foreach ($grades as $row) {
            if ($mark >= $row['lower_mark'] && $mark <= $row['upper_mark']) {
                return $row;
            }
        }
    }
    public function getSubjectList($examID, $classID, $sectionID, $sessionID)
    {
        $branchID = $this->applicationModel->get_branch_id();
        $builder->select('t.*,s.name as subject_name');
        $builder->from('timetable_exam as t');
        $builder->join('subject as s', 's.id = t.subject_id', 'inner');
        $builder->where('t.exam_id', $examID);
        $builder->where('t.class_id', $classID);
        $builder->where('t.section_id', $sectionID);
        $builder->where('t.session_id', $sessionID);
        $builder->where('t.branch_id', $branchID);
        $builder->group_by('t.subject_id');
        return $builder->get()->result_array();
    }
    public function getTimetableDetail($classID, $sectionID, $examID, $subjectID)
    {
        $builder->select('timetable_exam.mark_distribution');
        $builder->where('class_id', $classID);
        $builder->where('section_id', $sectionID);
        $builder->where('exam_id', $examID);
        $builder->where('subject_id', $subjectID);
        $this->db->table('session_id', get_session_id())->where();
        return $builder->get('timetable_exam')->row_array();
    }
    public function getMarkAndStudent($branchID, $classID, $sectionID, $examID, $subjectID)
    {
        $builder->select('en.*,st.first_name,st.last_name,st.register_no,st.category_id,m.mark as get_mark,IFNULL(m.absent, 0) as get_abs,subject.name as subject_name');
        $builder->from('enroll as en');
        $builder->join('student as st', 'st.id = en.student_id', 'inner');
        $builder->join('mark as m', 'm.student_id = en.student_id and m.class_id = en.class_id and m.section_id = en.section_id and m.exam_id = ' . $db->escape($examID) . ' and m.subject_id = ' . $db->escape($subjectID), 'left');
        $builder->join('subject', 'subject.id = m.subject_id', 'left');
        $builder->where('en.class_id', $classID);
        $builder->where('en.section_id', $sectionID);
        $builder->where('en.branch_id', $branchID);
        $this->db->table('en.session_id', get_session_id())->where();
        $builder->order_by('en.roll', 'ASC');
        return $builder->get()->result_array();
    }
    public function getStudentReportCard($studentID, $examID, $sessionID, $classID = '', $sectionID = '')
    {
        $result = array();
        $builder->select('s.*,CONCAT_WS(" ",s.first_name, s.last_name) as name,e.id as enrollID,e.roll,e.branch_id,e.session_id,e.class_id,e.section_id,c.name as class,se.name as section,sc.name as category,IFNULL(p.father_name,"N/A") as father_name,IFNULL(p.mother_name,"N/A") as mother_name,br.name as institute_name,br.email as institute_email,br.address as institute_address,br.mobileno as institute_mobile_no');
        $builder->from('enroll as e');
        $builder->join('student as s', 'e.student_id = s.id', 'inner');
        $builder->join('class as c', 'e.class_id = c.id', 'left');
        $builder->join('section as se', 'e.section_id = se.id', 'left');
        $builder->join('student_category as sc', 's.category_id=sc.id', 'left');
        $builder->join('parent as p', 'p.id=s.parent_id', 'left');
        $builder->join('branch as br', 'br.id = e.branch_id', 'left');
        $builder->where('e.student_id', $studentID);
        $builder->where('e.session_id', $sessionID);
        if (!empty($classID)) {
            $builder->where('e.class_id', $classID);
        }
        if (!empty($sectionID)) {
            $builder->where('e.section_id', $sectionID);
        }
        $result['student'] = $builder->get()->row_array();
        $builder->select('m.mark as get_mark,IFNULL(m.absent, 0) as get_abs,subject.name as subject_name, te.mark_distribution, m.subject_id');
        $builder->from('mark as m');
        $builder->join('subject', 'subject.id = m.subject_id', 'left');
        $builder->join('timetable_exam as te', 'te.exam_id = m.exam_id and te.class_id = m.class_id and te.section_id = m.section_id and te.subject_id = m.subject_id', 'left');
        $builder->where('m.exam_id', $examID);
        $builder->where('m.student_id', $studentID);
        $builder->where('m.session_id', $sessionID);
        if (!empty($classID)) {
            $builder->where('m.class_id', $classID);
        }
        if (!empty($sectionID)) {
            $builder->where('m.section_id', $sectionID);
        }
        $builder->group_by('m.subject_id');
        $builder->order_by('subject.id', 'ASC');
        $result['exam'] = $builder->get()->result_array();
        return $result;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/ReceptionModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class ReceptionModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function postalSave($data = [])
    {
        $attachment_file = "";
        $oldAttachment_file = $this->request->getPost('old_document_file');
        if (isset($_FILES["document_file"]) && !empty($_FILES['document_file']['name'])) {
            $config['upload_path'] = './uploads/reception/postal/';
            $config['allowed_types'] = '*';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("document_file")) {
                // need to unlink previous photo
                if (!empty($oldAttachment_file)) {
                    $unlink_path = 'uploads/reception/postal/' . $oldAttachment_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $attachment_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldAttachment_file)) {
            $attachment_file = $oldAttachment_file;
        }
        $arrayInsert = array('sender_title' => $data['sender_title'], 'receiver_title' => $data['receiver_title'], 'reference_no' => $data['reference_no'], 'address' => $data['address'], 'date' => date("Y-m-d", strtotime($data['date'])), 'note' => $data['note'], 'file' => $attachment_file, 'confidential' => isset($data['confidential']) ? 1 : 0, 'type' => $data['type'], 'branch_id' => $this->application_model->get_branch_id(), 'created_by' => get_loggedin_user_id(), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('postal_record', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('postal_record', $arrayInsert);
        }
    }
    public function enquirySave($data = [])
    {
        $arrayInsert = array('name' => $data['name'], 'father_name' => $data['father_name'], 'mother_name' => $data['mother_name'], 'mobile_no' => $data['mobile_no'], 'email' => $data['email'], 'date' => date("Y-m-d", strtotime($data['date'])), 'birthday' => empty($data['birthday']) ? NULL : date("Y-m-d", strtotime($data['birthday'])), 'gender' => $data['gender'], 'address' => $data['address'], 'previous_school' => $data['previous_school'], 'reference_id' => $data['reference'], 'response_id' => $data['response_id'], 'response' => $data['response'], 'note' => $data['note'], 'no_of_child' => $data['no_of_child'], 'class_id' => $data['class_id'], 'branch_id' => $this->application_model->get_branch_id(), 'assigned_id' => $data['staff_id'], 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_by'] = get_loggedin_user_id();
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('enquiry', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('enquiry', $arrayInsert);
        }
    }
    public function call_logSave($data = [])
    {
        $arrayInsert = array('name' => $data['name'], 'number' => $data['phone_number'], 'purpose_id' => $data['purpose_id'], 'call_type' => $data['call_type'], 'date' => date("Y-m-d", strtotime($data['date'])), 'follow_up' => empty($data['follow_up_date']) ? NULL : date("Y-m-d", strtotime($data['follow_up_date'])), 'start_time' => date("H:i:s", strtotime($data['start_time'])), 'end_time' => date("H:i:s", strtotime($data['end_time'])), 'note' => $data['note'], 'branch_id' => $this->application_model->get_branch_id(), 'created_by' => get_loggedin_user_id(), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('call_log', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('call_log', $arrayInsert);
        }
    }
    public function visitor_logSave($data = [])
    {
        $arrayInsert = array('name' => $data['name'], 'number' => $data['phone_number'], 'purpose_id' => $data['purpose_id'], 'date' => date("Y-m-d", strtotime($data['date'])), 'entry_time' => date("H:i:s", strtotime($data['entry_time'])), 'exit_time' => date("H:i:s", strtotime($data['exit_time'])), 'number_of_visitor' => $data['number_of_visitor'], 'id_number' => $data['id_number'], 'token_pass' => $data['token_pass'], 'note' => $data['note'], 'branch_id' => $this->application_model->get_branch_id(), 'created_by' => get_loggedin_user_id(), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('visitor_log', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('visitor_log', $arrayInsert);
        }
    }
    public function complaintSave($data = [])
    {
        $attachment_file = "";
        $oldAttachment_file = $this->request->getPost('old_document_file');
        if (isset($_FILES["document_file"]) && !empty($_FILES['document_file']['name'])) {
            $config['upload_path'] = './uploads/reception/complaint/';
            $config['allowed_types'] = '*';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("document_file")) {
                // need to unlink previous photo
                if (!empty($oldAttachment_file)) {
                    $unlink_path = 'uploads/reception/complaint/' . $oldAttachment_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $attachment_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldAttachment_file)) {
            $attachment_file = $oldAttachment_file;
        }
        $arrayInsert = array('name' => $data['complainant_name'], 'number' => $data['phone_number'], 'type_id' => $data['type_id'], 'date' => date("Y-m-d", strtotime($data['date'])), 'assigned_id' => $data['staff_id'], 'date_of_solution' => isset($data['date_of_solution']) ? date("Y-m-d", strtotime($data['date_of_solution'])) : '', 'action' => isset($data['action']) ? $data['action'] : '', 'file' => $attachment_file, 'note' => $data['note'], 'branch_id' => $this->application_model->get_branch_id(), 'created_by' => get_loggedin_user_id(), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('complaint', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('complaint', $arrayInsert);
        }
    }
    public function getStatus()
    {
        $date = array("" => "Select", "1" => "Active", "2" => "Partially Closed", "3" => "Missed", "4" => "Closed");
        return $date;
    }
    public function follow_up_details($enquiryID)
    {
        $query = $db->table('enquiry_follow_up')->get('enquiry_follow_up');
        $id = $query->row()->id;
        $builder->select('*');
        $builder->from('enquiry_follow_up');
        $builder->where('id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class ReceptionModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function postalSave($data = [])
    {
        $attachment_file = "";
        $oldAttachment_file = $this->request->getPost('old_document_file');
        if (isset($_FILES["document_file"]) && !empty($_FILES['document_file']['name'])) {
            $config['upload_path'] = './uploads/reception/postal/';
            $config['allowed_types'] = '*';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("document_file")) {
                // need to unlink previous photo
                if (!empty($oldAttachment_file)) {
                    $unlink_path = 'uploads/reception/postal/' . $oldAttachment_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $attachment_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldAttachment_file)) {
            $attachment_file = $oldAttachment_file;
        }
        $arrayInsert = array('sender_title' => $data['sender_title'], 'receiver_title' => $data['receiver_title'], 'reference_no' => $data['reference_no'], 'address' => $data['address'], 'date' => date("Y-m-d", strtotime($data['date'])), 'note' => $data['note'], 'file' => $attachment_file, 'confidential' => isset($data['confidential']) ? 1 : 0, 'type' => $data['type'], 'branch_id' => $this->applicationModel->get_branch_id(), 'created_by' => get_loggedin_user_id(), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('postal_record', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('postal_record', $arrayInsert);
        }
    }
    public function enquirySave($data = [])
    {
        $arrayInsert = array('name' => $data['name'], 'father_name' => $data['father_name'], 'mother_name' => $data['mother_name'], 'mobile_no' => $data['mobile_no'], 'email' => $data['email'], 'date' => date("Y-m-d", strtotime($data['date'])), 'birthday' => empty($data['birthday']) ? NULL : date("Y-m-d", strtotime($data['birthday'])), 'gender' => $data['gender'], 'address' => $data['address'], 'previous_school' => $data['previous_school'], 'reference_id' => $data['reference'], 'response_id' => $data['response_id'], 'response' => $data['response'], 'note' => $data['note'], 'no_of_child' => $data['no_of_child'], 'class_id' => $data['class_id'], 'branch_id' => $this->applicationModel->get_branch_id(), 'assigned_id' => $data['staff_id'], 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_by'] = get_loggedin_user_id();
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('enquiry', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('enquiry', $arrayInsert);
        }
    }
    public function call_logSave($data = [])
    {
        $arrayInsert = array('name' => $data['name'], 'number' => $data['phone_number'], 'purpose_id' => $data['purpose_id'], 'call_type' => $data['call_type'], 'date' => date("Y-m-d", strtotime($data['date'])), 'follow_up' => empty($data['follow_up_date']) ? NULL : date("Y-m-d", strtotime($data['follow_up_date'])), 'start_time' => date("H:i:s", strtotime($data['start_time'])), 'end_time' => date("H:i:s", strtotime($data['end_time'])), 'note' => $data['note'], 'branch_id' => $this->applicationModel->get_branch_id(), 'created_by' => get_loggedin_user_id(), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('call_log', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('call_log', $arrayInsert);
        }
    }
    public function visitor_logSave($data = [])
    {
        $arrayInsert = array('name' => $data['name'], 'number' => $data['phone_number'], 'purpose_id' => $data['purpose_id'], 'date' => date("Y-m-d", strtotime($data['date'])), 'entry_time' => date("H:i:s", strtotime($data['entry_time'])), 'exit_time' => date("H:i:s", strtotime($data['exit_time'])), 'number_of_visitor' => $data['number_of_visitor'], 'id_number' => $data['id_number'], 'token_pass' => $data['token_pass'], 'note' => $data['note'], 'branch_id' => $this->applicationModel->get_branch_id(), 'created_by' => get_loggedin_user_id(), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('visitor_log', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('visitor_log', $arrayInsert);
        }
    }
    public function complaintSave($data = [])
    {
        $attachment_file = "";
        $oldAttachment_file = $this->request->getPost('old_document_file');
        if (isset($_FILES["document_file"]) && !empty($_FILES['document_file']['name'])) {
            $config['upload_path'] = './uploads/reception/complaint/';
            $config['allowed_types'] = '*';
            $config['overwrite'] = false;
            $this->upload->initialize($config);
            if ($this->upload->do_upload("document_file")) {
                // need to unlink previous photo
                if (!empty($oldAttachment_file)) {
                    $unlink_path = 'uploads/reception/complaint/' . $oldAttachment_file;
                    if (file_exists($unlink_path)) {
                        @unlink($unlink_path);
                    }
                }
                $attachment_file = $this->upload->data('file_name');
            }
        } else if (!empty($oldAttachment_file)) {
            $attachment_file = $oldAttachment_file;
        }
        $arrayInsert = array('name' => $data['complainant_name'], 'number' => $data['phone_number'], 'type_id' => $data['type_id'], 'date' => date("Y-m-d", strtotime($data['date'])), 'assigned_id' => $data['staff_id'], 'date_of_solution' => isset($data['date_of_solution']) ? date("Y-m-d", strtotime($data['date_of_solution'])) : '', 'action' => isset($data['action']) ? $data['action'] : '', 'file' => $attachment_file, 'note' => $data['note'], 'branch_id' => $this->applicationModel->get_branch_id(), 'created_by' => get_loggedin_user_id(), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($data['id'])) {
            $arrayInsert['created_at'] = date('Y-m-d H:i:s');
            $builder->insert('complaint', $arrayInsert);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('complaint', $arrayInsert);
        }
    }
    public function getStatus()
    {
        $date = array("" => "Select", "1" => "Active", "2" => "Partially Closed", "3" => "Missed", "4" => "Closed");
        return $date;
    }
    public function follow_up_details($enquiryID)
    {
        $query = $db->table('enquiry_follow_up')->get('enquiry_follow_up');
        $id = $query->row()->id;
        $builder->select('*');
        $builder->from('enquiry_follow_up');
        $builder->where('id', $id);
        $query = $builder->get();
        return $query->row_array();
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/AttendanceModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AttendanceModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getStudentAttendence($classID, $sectionID, $date, $branchID)
    {
        $sql = "SELECT `enroll`.`id` as `enroll_id`,`enroll`.`roll`,`student`.`first_name`,`student`.`last_name`,`student`.`id` as `student_id`,`student`.`register_no`,`student_attendance`.`id` as `att_id`,`student_attendance`.`status` as `att_status`,`student_attendance`.`remark` as `att_remark` FROM `enroll` INNER JOIN `student` ON `student`.`id` = `enroll`.`student_id` LEFT JOIN `student_attendance` ON `student_attendance`.`enroll_id` = `enroll`.`id` AND `student_attendance`.`date` = " . $db->escape($date) . " WHERE `enroll`.`class_id` = " . $db->escape($classID) . " AND `enroll`.`section_id` = " . $db->escape($sectionID) . " AND `enroll`.`branch_id` = " . $db->escape($branchID) . " AND `enroll`.`session_id` = " . $db->escape(get_session_id());
        return $db->query($sql)->result_array();
    }
    public function getStaffAttendence($roleID, $date, $branchID)
    {
        $sql = "SELECT `staff`.*, `lc`.`role`, `sa`.`id` as `atten_id`, IFNULL(`sa`.`status`, 0) as `att_status`, `sa`.`remark` as `att_remark` FROM `staff` LEFT JOIN `login_credential` as `lc` ON `lc`.`user_id` = `staff`.`id` and `lc`.`role` != '6' and `lc`.`role` != '7' LEFT JOIN `staff_attendance` as `sa` ON `sa`.`staff_id` = `staff`.`id` and `sa`.`date` = " . $db->escape($date) . " WHERE `staff`.`branch_id` = " . $db->escape($branchID) . " AND `lc`.`role` = " . $db->escape($roleID) . " AND `lc`.`active` = '1' ORDER BY `staff`.`id` ASC";
        return $db->query($sql)->result_array();
    }
    public function getExamAttendence($classID, $sectionID, $examID, $subjectID, $branchID)
    {
        $sql = "SELECT enroll.student_id,enroll.roll,student.first_name,student.last_name,student.register_no,exam_attendance.id as `atten_id`, exam_attendance.status as `att_status`,exam_attendance.remark as `att_remark` FROM `enroll` LEFT JOIN student ON student.id = enroll.student_id LEFT JOIN exam_attendance ON exam_attendance.student_id = student.id AND exam_attendance.exam_id = " . $db->escape($examID) . " AND exam_attendance.subject_id = " . $db->escape($subjectID) . " WHERE enroll.class_id = " . $db->escape($classID) . " AND enroll.section_id = " . $db->escape($sectionID) . " AND enroll.branch_id = " . $db->escape($branchID) . " AND enroll.session_id = " . $db->escape(get_session_id());
        return $db->query($sql)->result_array();
    }
    public function getStudentList($branch_id, $class_id, $section_id)
    {
        $builder->select('e.id as enroll_id,e.roll,s.first_name,s.last_name,s.register_no');
        $builder->from('enroll as e');
        $builder->join('student as s', 's.id = e.student_id', 'inner');
        $builder->join('login_credential', 'login_credential.user_id = s.id and login_credential.role = "7"', 'inner');
        $builder->where('e.class_id', $class_id);
        $builder->where('e.section_id', $section_id);
        $builder->where('e.branch_id', $branch_id);
        $builder->where('login_credential.active', 1);
        $this->db->table('e.session_id', get_session_id())->where();
        return $builder->get()->result_array();
    }
    // GET STAFF ALL DETAILS
    public function getStaffList($branch_id = '', $role_id = '', $active = 1)
    {
        $builder->select('staff.*,login_credential.role as role_id, roles.name as role');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != "6" and login_credential.role != "7"', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        if (!empty($branch_id)) {
            $builder->where('staff.branch_id', $branch_id);
        }
        $builder->where('login_credential.role', $role_id);
        $builder->where('login_credential.active', $active);
        $builder->order_by('staff.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function getExamReport($data)
    {
        $sql = "SELECT `ea`.*, `s`.`first_name`, `s`.`last_name`, `s`.`register_no`, `s`.`category_id`, `e`.`roll`, `sb`.`name` as `subject_name` FROM `exam_attendance` as `ea` LEFT JOIN `enroll` as `e` ON `e`.`student_id` = `ea`.`student_id` LEFT JOIN `student` as `s` ON `s`.`id` = `ea`.`student_id` LEFT JOIN `subject` as `sb` ON `sb`.`id` = `ea`.`subject_id` WHERE `ea`.`exam_id` = " . $db->escape($data['exam_id']) . " AND `ea`.`subject_id` = " . $db->escape($data['subject_id']) . " AND `ea`.`branch_id` = " . $db->escape($data['branch_id']) . " AND `e`.`class_id` = " . $db->escape($data['class_id']) . " AND `e`.`section_id` = " . $db->escape($data['section_id']) . " AND `e`.`session_id` = " . $db->escape(get_session_id());
        return $db->query($sql)->result_array();
    }
    // check attendance by staff id and date
    public function get_attendance_by_date($studentID, $date)
    {
        $sql = "SELECT `student_attendance`.* FROM `student_attendance` WHERE `enroll_id` = " . $db->escape($studentID) . " AND DATE(`date`) = " . $db->escape($date);
        return $db->query($sql)->row_array();
    }
    public function getWeekendDaysSession($branch_id = '')
    {
        $date_from = strtotime(date("Y-01-01"));
        $date_to = strtotime(date("Y-12-31"));
        $oneDay = 60 * 60 * 24;
        $allDays = array('0' => 'Sunday', '1' => 'Monday', '2' => 'Tuesday', '3' => 'Wednesday', '4' => 'Thursday', '5' => 'Friday', '6' => 'Saturday');
        $weekendDay = $this->application_model->getWeekends($branch_id);
        $weekendArrays = explode(',', $weekendDay);
        $weekendDateArrays = array();
        for ($i = $date_from; $i <= $date_to; $i = $i + $oneDay) {
            if ($weekendDay != "") {
                foreach ($weekendArrays as $weekendValue) {
                    if ($weekendValue >= 0 && $weekendValue <= 6) {
                        if (date('l', $i) == $allDays[$weekendValue]) {
                            $weekendDateArrays[] = date('Y-m-d', $i);
                        }
                    }
                }
            }
        }
        return $weekendDateArrays;
    }
    public function getHolidays($school_id = '')
    {
        $builder->where('branch_id', $school_id);
        $this->db->table('session_id', get_session_id())->where();
        $builder->where(['status' => 1, 'type' => 'holiday']);
        $builder->order_by('start_date', 'asc');
        $holidays = $builder->get('event')->getResult();
        $allHolidayList = array();
        if (!empty($holidays)) {
            foreach ($holidays as $holiday) {
                $from_date = strtotime($holiday->start_date);
                $to_date = strtotime($holiday->end_date);
                $oneday = 60 * 60 * 24;
                for ($i = $from_date; $i <= $to_date; $i = $i + $oneday) {
                    $allHolidayList[] = date('Y-m-d', $i);
                }
            }
        }
        $uniqueHolidays = array_unique($allHolidayList);
        if (!empty($uniqueHolidays)) {
            $uniqueHolidays = implode('","', $uniqueHolidays);
        } else {
            $uniqueHolidays = '';
        }
        return $uniqueHolidays;
    }
    public function getDailyStudentReport($branchID = '', $date = '')
    {
        $sql = "SELECT class.name as `class_name`,section.name as `section_name`, SUM(CASE WHEN `status` = 'P' THEN 1 ELSE 0 END) AS 'present',SUM(CASE WHEN `status` = 'A' THEN 1 ELSE 0 END) AS 'absent',SUM(CASE WHEN `status` = 'L' THEN 1 ELSE 0 END) AS 'late',SUM(CASE WHEN `status` = 'HD' THEN 1 ELSE 0 END) AS 'half_day' FROM `student_attendance` JOIN `enroll` on student_attendance.enroll_id=enroll.id INNER JOIN `sections_allocation` on (enroll.class_id=sections_allocation.class_id and enroll.section_id=sections_allocation.section_id) inner join `class` on class.id=sections_allocation.class_id INNER JOIN `section` on section.id=sections_allocation.section_id WHERE `enroll`.`session_id`=" . $db->escape(get_session_id()) . " AND enroll.branch_id = " . $db->escape($branchID) . " AND student_attendance.date = " . $db->escape($date) . " GROUP BY sections_allocation.id ORDER BY sections_allocation.class_id";
        $query = $db->query($sql);
        $count_studentattendance = $query->getResult();
        return $count_studentattendance;
    }
    public function stuAttendanceCount_by_date($enroll_id = '', $start = '', $end = '', $type = '')
    {
        $sql = "SELECT count(`student_attendance`.`id`) as `status_count` FROM `student_attendance` WHERE `enroll_id` = " . $db->escape($enroll_id) . " AND DATE(`date`) >= " . $db->escape($start) . " AND DATE(`date`) <= " . $db->escape($end) . " AND `status` = " . $db->escape($type);
        return $db->query($sql)->row()->status_count;
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class AttendanceModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function getStudentAttendence($classID, $sectionID, $date, $branchID)
    {
        $sql = "SELECT `enroll`.`id` as `enroll_id`,`enroll`.`roll`,`student`.`first_name`,`student`.`last_name`,`student`.`id` as `student_id`,`student`.`register_no`,`student_attendance`.`id` as `att_id`,`student_attendance`.`status` as `att_status`,`student_attendance`.`remark` as `att_remark` FROM `enroll` INNER JOIN `student` ON `student`.`id` = `enroll`.`student_id` LEFT JOIN `student_attendance` ON `student_attendance`.`enroll_id` = `enroll`.`id` AND `student_attendance`.`date` = " . $db->escape($date) . " WHERE `enroll`.`class_id` = " . $db->escape($classID) . " AND `enroll`.`section_id` = " . $db->escape($sectionID) . " AND `enroll`.`branch_id` = " . $db->escape($branchID) . " AND `enroll`.`session_id` = " . $db->escape(get_session_id());
        return $db->query($sql)->result_array();
    }
    public function getStaffAttendence($roleID, $date, $branchID)
    {
        $sql = "SELECT `staff`.*, `lc`.`role`, `sa`.`id` as `atten_id`, IFNULL(`sa`.`status`, 0) as `att_status`, `sa`.`remark` as `att_remark` FROM `staff` LEFT JOIN `login_credential` as `lc` ON `lc`.`user_id` = `staff`.`id` and `lc`.`role` != '6' and `lc`.`role` != '7' LEFT JOIN `staff_attendance` as `sa` ON `sa`.`staff_id` = `staff`.`id` and `sa`.`date` = " . $db->escape($date) . " WHERE `staff`.`branch_id` = " . $db->escape($branchID) . " AND `lc`.`role` = " . $db->escape($roleID) . " AND `lc`.`active` = '1' ORDER BY `staff`.`id` ASC";
        return $db->query($sql)->result_array();
    }
    public function getExamAttendence($classID, $sectionID, $examID, $subjectID, $branchID)
    {
        $sql = "SELECT enroll.student_id,enroll.roll,student.first_name,student.last_name,student.register_no,exam_attendance.id as `atten_id`, exam_attendance.status as `att_status`,exam_attendance.remark as `att_remark` FROM `enroll` LEFT JOIN student ON student.id = enroll.student_id LEFT JOIN exam_attendance ON exam_attendance.student_id = student.id AND exam_attendance.exam_id = " . $db->escape($examID) . " AND exam_attendance.subject_id = " . $db->escape($subjectID) . " WHERE enroll.class_id = " . $db->escape($classID) . " AND enroll.section_id = " . $db->escape($sectionID) . " AND enroll.branch_id = " . $db->escape($branchID) . " AND enroll.session_id = " . $db->escape(get_session_id());
        return $db->query($sql)->result_array();
    }
    public function getStudentList($branch_id, $class_id, $section_id)
    {
        $builder->select('e.id as enroll_id,e.roll,s.first_name,s.last_name,s.register_no');
        $builder->from('enroll as e');
        $builder->join('student as s', 's.id = e.student_id', 'inner');
        $builder->join('login_credential', 'login_credential.user_id = s.id and login_credential.role = "7"', 'inner');
        $builder->where('e.class_id', $class_id);
        $builder->where('e.section_id', $section_id);
        $builder->where('e.branch_id', $branch_id);
        $builder->where('login_credential.active', 1);
        $this->db->table('e.session_id', get_session_id())->where();
        return $builder->get()->result_array();
    }
    // GET STAFF ALL DETAILS
    public function getStaffList($branch_id = '', $role_id = '', $active = 1)
    {
        $builder->select('staff.*,login_credential.role as role_id, roles.name as role');
        $builder->from('staff');
        $builder->join('login_credential', 'login_credential.user_id = staff.id and login_credential.role != "6" and login_credential.role != "7"', 'inner');
        $builder->join('roles', 'roles.id = login_credential.role', 'left');
        if (!empty($branch_id)) {
            $builder->where('staff.branch_id', $branch_id);
        }
        $builder->where('login_credential.role', $role_id);
        $builder->where('login_credential.active', $active);
        $builder->order_by('staff.id', 'ASC');
        return $builder->get()->result_array();
    }
    public function getExamReport($data)
    {
        $sql = "SELECT `ea`.*, `s`.`first_name`, `s`.`last_name`, `s`.`register_no`, `s`.`category_id`, `e`.`roll`, `sb`.`name` as `subject_name` FROM `exam_attendance` as `ea` LEFT JOIN `enroll` as `e` ON `e`.`student_id` = `ea`.`student_id` LEFT JOIN `student` as `s` ON `s`.`id` = `ea`.`student_id` LEFT JOIN `subject` as `sb` ON `sb`.`id` = `ea`.`subject_id` WHERE `ea`.`exam_id` = " . $db->escape($data['exam_id']) . " AND `ea`.`subject_id` = " . $db->escape($data['subject_id']) . " AND `ea`.`branch_id` = " . $db->escape($data['branch_id']) . " AND `e`.`class_id` = " . $db->escape($data['class_id']) . " AND `e`.`section_id` = " . $db->escape($data['section_id']) . " AND `e`.`session_id` = " . $db->escape(get_session_id());
        return $db->query($sql)->result_array();
    }
    // check attendance by staff id and date
    public function get_attendance_by_date($studentID, $date)
    {
        $sql = "SELECT `student_attendance`.* FROM `student_attendance` WHERE `enroll_id` = " . $db->escape($studentID) . " AND DATE(`date`) = " . $db->escape($date);
        return $db->query($sql)->row_array();
    }
    public function getWeekendDaysSession($branch_id = '')
    {
        $date_from = strtotime(date("Y-01-01"));
        $date_to = strtotime(date("Y-12-31"));
        $oneDay = 60 * 60 * 24;
        $allDays = array('0' => 'Sunday', '1' => 'Monday', '2' => 'Tuesday', '3' => 'Wednesday', '4' => 'Thursday', '5' => 'Friday', '6' => 'Saturday');
        $weekendDay = $this->applicationModel->getWeekends($branch_id);
        $weekendArrays = explode(',', $weekendDay);
        $weekendDateArrays = array();
        for ($i = $date_from; $i <= $date_to; $i = $i + $oneDay) {
            if ($weekendDay != "") {
                foreach ($weekendArrays as $weekendValue) {
                    if ($weekendValue >= 0 && $weekendValue <= 6) {
                        if (date('l', $i) == $allDays[$weekendValue]) {
                            $weekendDateArrays[] = date('Y-m-d', $i);
                        }
                    }
                }
            }
        }
        return $weekendDateArrays;
    }
    public function getHolidays($school_id = '')
    {
        $builder->where('branch_id', $school_id);
        $this->db->table('session_id', get_session_id())->where();
        $builder->where(['status' => 1, 'type' => 'holiday']);
        $builder->order_by('start_date', 'asc');
        $holidays = $builder->get('event')->getResult();
        $allHolidayList = array();
        if (!empty($holidays)) {
            foreach ($holidays as $holiday) {
                $from_date = strtotime($holiday->start_date);
                $to_date = strtotime($holiday->end_date);
                $oneday = 60 * 60 * 24;
                for ($i = $from_date; $i <= $to_date; $i = $i + $oneday) {
                    $allHolidayList[] = date('Y-m-d', $i);
                }
            }
        }
        $uniqueHolidays = array_unique($allHolidayList);
        if (!empty($uniqueHolidays)) {
            $uniqueHolidays = implode('","', $uniqueHolidays);
        } else {
            $uniqueHolidays = '';
        }
        return $uniqueHolidays;
    }
    public function getDailyStudentReport($branchID = '', $date = '')
    {
        $sql = "SELECT class.name as `class_name`,section.name as `section_name`, SUM(CASE WHEN `status` = 'P' THEN 1 ELSE 0 END) AS 'present',SUM(CASE WHEN `status` = 'A' THEN 1 ELSE 0 END) AS 'absent',SUM(CASE WHEN `status` = 'L' THEN 1 ELSE 0 END) AS 'late',SUM(CASE WHEN `status` = 'HD' THEN 1 ELSE 0 END) AS 'half_day' FROM `student_attendance` JOIN `enroll` on student_attendance.enroll_id=enroll.id INNER JOIN `sections_allocation` on (enroll.class_id=sections_allocation.class_id and enroll.section_id=sections_allocation.section_id) inner join `class` on class.id=sections_allocation.class_id INNER JOIN `section` on section.id=sections_allocation.section_id WHERE `enroll`.`session_id`=" . $db->escape(get_session_id()) . " AND enroll.branch_id = " . $db->escape($branchID) . " AND student_attendance.date = " . $db->escape($date) . " GROUP BY sections_allocation.id ORDER BY sections_allocation.class_id";
        $query = $db->query($sql);
        $count_studentattendance = $query->getResult();
        return $count_studentattendance;
    }
    public function stuAttendanceCount_by_date($enroll_id = '', $start = '', $end = '', $type = '')
    {
        $sql = "SELECT count(`student_attendance`.`id`) as `status_count` FROM `student_attendance` WHERE `enroll_id` = " . $db->escape($enroll_id) . " AND DATE(`date`) >= " . $db->escape($start) . " AND DATE(`date`) <= " . $db->escape($end) . " AND `status` = " . $db->escape($type);
        return $db->query($sql)->row()->status_count;
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/OfflinePaymentsModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class OfflinePaymentsModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function typeSave($data = array())
    {
        $arrayData = array('branch_id' => $this->application_model->get_branch_id(), 'name' => $data['type_name'], 'note' => $data['note']);
        if (!isset($data['type_id'])) {
            $builder->insert('offline_payment_types', $arrayData);
        } else {
            $builder->where('id', $data['type_id']);
            $builder->update('offline_payment_types', $arrayData);
        }
    }
    public function getOfflinePaymentsList($where = array(), $single = false)
    {
        $builder->select('op.*,CONCAT_WS(" ",student.first_name, student.last_name) as fullname,student.email,student.mobileno,student.register_no,class.name as class_name,section.name as section_name,branch.name as branchname');
        $builder->from('offline_fees_payments as op');
        $builder->join('enroll', 'enroll.id = op.student_enroll_id', 'left');
        $builder->join('branch', 'branch.id = enroll.branch_id', 'left');
        $builder->join('student', 'student.id = enroll.student_id', 'left');
        $builder->join('class', 'class.id = enroll.class_id', 'left');
        $builder->join('section', 'section.id = enroll.section_id', 'left');
        if (!empty($where)) {
            $builder->where($where);
        }
        if ($single == true) {
            $result = $builder->get()->row_array();
        } else {
            $builder->order_by('op.id', 'ASC');
            $result = $builder->get()->getResult();
        }
        return $result;
    }
    public function update($id = '')
    {
        $r = $db->table('offline_fees_payments')->get('offline_fees_payments')->row();
        $arrayFees = array('allocation_id' => $r->fees_allocation_id, 'type_id' => $r->fees_type_id, 'amount' => $r->amount, 'fine' => $r->fine, 'collect_by' => "", 'discount' => 0, 'pay_via' => 15, 'collect_by' => 'online', 'remarks' => "Fees deposits via offline Payments Trx ID: " . $id, 'date' => date("Y-m-d"));
        // insert in DB
        $builder->insert('fee_payment_history', $arrayFees);
        // transaction voucher save function
        $getSeeting = $this->fees_model->get('transactions_links', array('branch_id' => get_loggedin_branch_id()), true);
        if ($getSeeting['status']) {
            $arrayTransaction = array('account_id' => $getSeeting['deposit'], 'amount' => $arrayFees['amount'] + $arrayFees['fine'], 'date' => $arrayFees['date']);
            $this->fees_model->saveTransaction($arrayTransaction);
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class OfflinePaymentsModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    public function typeSave($data = array())
    {
        $arrayData = array('branch_id' => $this->applicationModel->get_branch_id(), 'name' => $data['type_name'], 'note' => $data['note']);
        if (!isset($data['type_id'])) {
            $builder->insert('offline_payment_types', $arrayData);
        } else {
            $builder->where('id', $data['type_id']);
            $builder->update('offline_payment_types', $arrayData);
        }
    }
    public function getOfflinePaymentsList($where = array(), $single = false)
    {
        $builder->select('op.*,CONCAT_WS(" ",student.first_name, student.last_name) as fullname,student.email,student.mobileno,student.register_no,class.name as class_name,section.name as section_name,branch.name as branchname');
        $builder->from('offline_fees_payments as op');
        $builder->join('enroll', 'enroll.id = op.student_enroll_id', 'left');
        $builder->join('branch', 'branch.id = enroll.branch_id', 'left');
        $builder->join('student', 'student.id = enroll.student_id', 'left');
        $builder->join('class', 'class.id = enroll.class_id', 'left');
        $builder->join('section', 'section.id = enroll.section_id', 'left');
        if (!empty($where)) {
            $builder->where($where);
        }
        if ($single == true) {
            $result = $builder->get()->row_array();
        } else {
            $builder->order_by('op.id', 'ASC');
            $result = $builder->get()->getResult();
        }
        return $result;
    }
    public function update($id = '')
    {
        $r = $db->table('offline_fees_payments')->get('offline_fees_payments')->row();
        $arrayFees = array('allocation_id' => $r->fees_allocation_id, 'type_id' => $r->fees_type_id, 'amount' => $r->amount, 'fine' => $r->fine, 'collect_by' => "", 'discount' => 0, 'pay_via' => 15, 'collect_by' => 'online', 'remarks' => "Fees deposits via offline Payments Trx ID: " . $id, 'date' => date("Y-m-d"));
        // insert in DB
        $builder->insert('fee_payment_history', $arrayFees);
        // transaction voucher save function
        $getSeeting = $this->fees_model->get('transactions_links', array('branch_id' => get_loggedin_branch_id()), true);
        if ($getSeeting['status']) {
            $arrayTransaction = array('account_id' => $getSeeting['deposit'], 'amount' => $arrayFees['amount'] + $arrayFees['fine'], 'date' => $arrayFees['date']);
            $this->fees_model->saveTransaction($arrayTransaction);
        }
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/OnlineexamModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class OnlineexamModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    // online exam save and update function
    public function saveExam($data, $branchID)
    {
        $onlineExam = array('title' => $data['title'], 'class_id' => $data['class_id'], 'section_id' => json_encode($this->request->getPost('section')), 'subject_id' => json_encode($this->request->getPost('subject')), 'limits_participation' => $data['participation_limit'], 'exam_start' => date('Y-m-d H:i:s', strtotime($data['start_date'] . " " . $data['start_time'])), 'exam_end' => date('Y-m-d H:i:s', strtotime($data['end_date'] . " " . $data['end_time'])), 'duration' => date('H:i:s', strtotime($data['duration'])), 'mark_type' => $data['mark_type'], 'passing_mark' => $data['passing_mark'], 'instruction' => $data['instruction'], 'session_id' => get_session_id(), 'publish_result' => $data['publish_result'], 'marks_display' => 0, 'neg_mark' => isset($data['negative_marking']) ? 1 : 0, 'marks_display' => isset($data['marks_display']) ? 1 : 0, 'question_type' => $data['question_type'], 'fee' => $data['exam_type'] == 1 ? $data['exam_fee'] : 0, 'exam_type' => $data['exam_type'], 'branch_id' => $branchID, 'created_at' => date('Y-m-d H:i:s'), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($_POST['id'])) {
            $onlineExam['publish_status'] = 0;
            $onlineExam['created_by'] = get_loggedin_user_id();
            $builder->insert('online_exam', $onlineExam);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('online_exam', $onlineExam);
        }
    }
    public function examList()
    {
        $builder->select('online_exam.*,class.name as class_name,branch.name as branchname');
        $builder->from('online_exam');
        $builder->join('branch', 'branch.id = online_exam.branch_id', 'inner');
        $builder->join('class', 'class.id = online_exam.class_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('online_exam.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('online_exam.id', 'DESC');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['section_details'] = $this->getSectionDetails($value['section_id']);
        }
        return $result;
    }
    public function examListDT($postData, $currency_symbol = '')
    {
        $response = array();
        $sessionID = get_session_id();
        // read value
        $draw = $postData['draw'];
        $start = $postData['start'];
        $rowperpage = $postData['length'];
        // Rows display per page
        $searchValue = $postData['search']['value'];
        // Search value
        // order
        $columnIndex = empty($postData['order'][0]['column']) ? 0 : $postData['order'][0]['column'];
        // Column index
        $columnSortOrder = empty($postData['order'][0]['dir']) ? 'DESC' : $postData['order'][0]['dir'];
        // asc or desc
        $column_order = array('`online_exam`.`id`');
        $search_arr = array();
        $searchQuery = "";
        if ($searchValue != '') {
            $search_arr[] = " (`online_exam`.`title` like '%" . $searchValue . "%' OR `online_exam`.`exam_start` like '%" . $searchValue . "%' OR `online_exam`.`exam_end` like '%" . $searchValue . "%') ";
        }
        if (!is_superadmin_loggedin()) {
            $branchID = $db->escape(get_loggedin_branch_id());
            $search_arr[] = " `online_exam`.`branch_id` = {$branchID} ";
            if (!is_superadmin_loggedin() && !is_admin_loggedin()) {
                $search_arr[] = " `online_exam`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        } else {
            $column_order[] = '`online_exam`.`id`';
        }
        // order
        $column_order[] = '`online_exam`.`title`';
        $column_order[] = '`class`.`id`';
        $column_order[] = '`questions_qty`';
        $column_order[] = '`online_exam`.`exam_start`';
        $column_order[] = '`online_exam`.`exam_end`';
        $column_order[] = '`online_exam`.`duration`';
        if (count($search_arr) > 0) {
            $searchQuery = implode("AND", $search_arr);
        }
        // Total number of records without filtering
        if (is_superadmin_loggedin()) {
            $sql = "SELECT `id` FROM `online_exam` WHERE `session_id` = '{$sessionID}'";
        } else {
            $branchID = $db->escape(get_loggedin_branch_id());
            $sql = "SELECT `id` FROM `online_exam` WHERE `branch_id` = {$branchID} AND `session_id` = '{$sessionID}'";
            if (!is_superadmin_loggedin() && !is_admin_loggedin()) {
                $sql .= " AND `created_by` = " . $db->escape(get_loggedin_user_id());
            }
        }
        $records = $db->query($sql)->result();
        $totalRecords = count($records);
        // Total number of record with filtering
        $sql = "SELECT `id` FROM `online_exam` WHERE `session_id` = '{$sessionID}'";
        if (!empty($searchQuery)) {
            $sql .= " AND " . $searchQuery;
        }
        $records = $db->query($sql)->result();
        $totalRecordwithFilter = count($records);
        // Fetch records
        $sql = "SELECT `online_exam`.*, `class`.`name` as `class_name`,(SELECT COUNT(`id`) FROM `questions_manage` WHERE `questions_manage`.`onlineexam_id`=`online_exam`.`id`) as `questions_qty`, `branch`.`name` as `branchname` FROM `online_exam` INNER JOIN `branch` ON `branch`.`id` = `online_exam`.`branch_id` LEFT JOIN `class` ON `class`.`id` = `online_exam`.`class_id` WHERE `online_exam`.`session_id` = '{$sessionID}'";
        if (!empty($searchQuery)) {
            $sql .= " AND " . $searchQuery;
        }
        $sql .= " ORDER BY " . $column_order[$columnIndex] . " {$columnSortOrder} LIMIT {$start}, {$rowperpage}";
        $records = $db->query($sql)->result();
        $data = array();
        $count = $start + 1;
        foreach ($records as $record) {
            if ($record->publish_status == 0) {
                $status = '';
            } else {
                $status = 'checked';
            }
            $row = array();
            $action = "";
            if (get_permission('add_questions', 'is_add')) {
                if ($record->publish_result == 0 && $record->publish_status == 1) {
                    $action .= '<button onclick="confirmModal(' . $db->escape(base_url('onlineexam/make_result_publish/' . $record->id)) . ')" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('make') . " " . translate('result_publish') . '"> <i class="far fa-square-poll-vertical"></i></button>';
                }
            }
            $action .= '<a href="' . base_url('onlineexam/question_list/' . $record->id) . '" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('view') . " " . translate('question') . '"> <i class="far fa-list-check"></i></a>';
            if ($record->publish_status == 0) {
                $action .= '<a href="' . base_url('onlineexam/manage_question/' . $record->id) . '" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('add_questions') . '"> <i class="far fa-question"></i></a>';
            }
            if (get_permission('online_exam', 'is_edit')) {
                $action .= '<a href="' . base_url('onlineexam/edit/' . $record->id) . '" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('edit') . '"> <i class="far fa-pen-nib"></i></a>';
            }
            if (get_permission('online_exam', 'is_delete')) {
                $action .= btn_delete('onlineexam/delete/' . $record->id);
            }
            $row[] = $count++;
            if (is_superadmin_loggedin()) {
                $row[] = $record->branchname;
            }
            $row[] = $record->title;
            $row[] = $record->class_name . " (" . $this->getSectionDetails($record->section_id) . ")";
            $row[] = $record->questions_qty;
            $row[] = _d($record->exam_start) . "<p class='text-muted'>" . date("h:i A", strtotime($record->exam_start)) . "</p>";
            $row[] = _d($record->exam_end) . "<p class='text-muted'>" . date("h:i A", strtotime($record->exam_end)) . "</p>";
            $row[] = $record->duration;
            $row[] = $record->exam_type == 0 ? translate('free') : $currency_symbol . $record->fee;
            $row[] = '<div class="material-switch ml-xs">
                        <input class="exam-status" id="examstatus_' . $record->id . '" data-id="' . $record->id . '" name="exam_status' . $record->id . '"
                        type="checkbox" ' . $status . ' />
                        <label for="examstatus_' . $record->id . '" class="label-primary"></label>
                        <span class="visible-print-block">' . ($status == 'checked' ? translate('yes') : translate('no')) . '</span>
                    </div>';
            $row[] = get_type_name_by_id('staff', $record->created_by);
            $row[] = $action;
            $data[] = $row;
        }
        // Response
        $response = array("draw" => intval($draw), "recordsTotal" => $totalRecords, "recordsFiltered" => $totalRecordwithFilter, "data" => $data);
        return json_encode($response);
    }
    public function getSelectExamList($class_id)
    {
        $arrayData = array("" => translate('select'));
        if (!is_superadmin_loggedin() && !is_admin_loggedin()) {
            $this->db->table('created_by', get_loggedin_user_id())->where();
        }
        $builder->where('class_id', $class_id);
        $this->db->table('session_id', get_session_id())->where();
        $builder->where('publish_status', 1);
        $builder->where('publish_result', 1);
        $result = $builder->get('online_exam')->getResult();
        foreach ($result as $row) {
            $arrayData[$row->id] = $row->title;
        }
        return $arrayData;
    }
    public function getSectionDetails($data)
    {
        $array = json_decode($data, true);
        $nameList = [];
        if (json_last_error() == JSON_ERROR_NONE) {
            foreach ($array as $key => $value) {
                $nameList[] = get_type_name_by_id('section', $value);
            }
        }
        $nameList = implode(', ', $nameList);
        return $nameList;
    }
    public function getSubjectDetails($data)
    {
        $array = json_decode($data, true);
        $nameList = [];
        if (json_last_error() == JSON_ERROR_NONE) {
            foreach ($array as $key => $value) {
                $nameList[] = get_type_name_by_id('subject', $value);
            }
        }
        $nameList = implode(',<br>', $nameList);
        return $nameList;
    }
    // questions save and update function
    public function saveQuestions()
    {
        $branchID = $this->application_model->get_branch_id();
        $questionType = $this->request->getPost('question_type');
        if ($questionType == 2) {
            $answer = json_encode($this->request->getPost('answer'));
        } else {
            $answer = $this->request->getPost('answer');
        }
        $questionID = $this->request->getPost('question_id');
        $classID = $this->request->getPost('class_id');
        $sectionID = $this->request->getPost('section_id');
        $subjectID = $this->request->getPost('subject_id');
        $groupID = $this->request->getPost('group_id');
        $questionsExam = array('type' => $questionType, 'level' => $this->request->getPost('question_level'), 'group_id' => $groupID, 'question' => $this->request->getPost('question', false), 'opt_1' => $this->tagRemove($this->request->getPost('option1', false)), 'opt_2' => $this->tagRemove($this->request->getPost('option2', false)), 'opt_3' => $this->tagRemove($this->request->getPost('option3', false)), 'opt_4' => $this->tagRemove($this->request->getPost('option4', false)), 'answer' => $answer, 'mark' => $this->request->getPost('mark'));
        if (!empty($classID)) {
            $questionsExam['class_id'] = $classID;
        }
        if (!empty($sectionID)) {
            $questionsExam['section_id'] = $sectionID;
        }
        if (!empty($subjectID)) {
            $questionsExam['subject_id'] = $subjectID;
        }
        if (!empty($branchID)) {
            $questionsExam['branch_id'] = $branchID;
        }
        if (empty($questionID)) {
            $questionsExam['created_by'] = get_loggedin_user_id();
            $builder->insert('questions', $questionsExam);
        } else {
            $builder->where('id', $questionID);
            $builder->update('questions', $questionsExam);
        }
    }
    private function tagRemove($text = "")
    {
        $text = str_replace("<p>", "", $text);
        $text = str_replace("</p>", "", $text);
        return $text;
    }
    public function question_level()
    {
        $arrayLevel = array('' => translate("select"), '1' => translate("easy"), '2' => translate("medium"), '3' => translate("hard"));
        return $arrayLevel;
    }
    public function question_group($branch_id = '')
    {
        if (empty($branch_id)) {
            $array = array('' => translate('select_branch_first'));
        } else {
            $builder->where('branch_id', $branch_id);
            $result = $builder->get('question_group')->getResult();
            $array = array('' => translate('select'));
            foreach ($result as $row) {
                $array[$row->id] = $row->name;
            }
        }
        return $array;
    }
    public function question_type()
    {
        $arrayType = array('1' => translate("single_choice"), '2' => translate("multiple_choice"), '3' => translate("true/false"), '4' => translate("descriptive"));
        return $arrayType;
    }
    public function questionList($postData)
    {
        $response = array();
        // read value
        $draw = $postData['draw'];
        $start = $postData['start'];
        $rowperpage = $postData['length'];
        // Rows display per page
        $searchValue = $postData['search']['value'];
        // Search value
        // Search
        $branchID = $db->escape($postData['branch_id']);
        $examID = $db->escape($postData['examID']);
        $negMark = $postData['negMark'];
        $search_arr = array();
        $searchQuery = "";
        if ($searchValue != '') {
            $search_arr[] = " (`questions`.`question` like '%" . $searchValue . "%' OR `question_group`.`name` like '%" . $searchValue . "%') ";
        }
        if (!is_superadmin_loggedin()) {
            $showOwnquestion = $this->app_lib->getSchoolConfig($postData['branch_id'], 'show_own_question');
            if (!empty($showOwnquestion->show_own_question) && $showOwnquestion->show_own_question == 1) {
                $search_arr[] = " `questions`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        }
        $questionGroup = $postData['questionGroup'];
        if ($questionGroup != '') {
            $questionGroup = $db->escape($questionGroup);
            $search_arr[] = " `questions`.`group_id` = {$questionGroup} ";
        }
        $questionType = $postData['questionType'];
        if ($questionType != '') {
            $questionType = $db->escape($questionType);
            $search_arr[] = " `questions`.`type` = {$questionType} ";
        }
        $questionLevel = $postData['questionLevel'];
        if ($questionLevel != '') {
            $questionLevel = $db->escape($questionLevel);
            $search_arr[] = " `questions`.`level` = {$questionLevel} ";
        }
        $classID = $postData['classID'];
        if ($classID != '') {
            $classID = $db->escape($classID);
            $search_arr[] = " `questions`.`class_id` = {$classID} ";
        }
        $sectionID = $postData['sectionID'];
        if ($sectionID != '') {
            $sectionID = $db->escape($sectionID);
            $search_arr[] = " `questions`.`section_id` = {$sectionID} ";
        }
        $subjectID = $postData['subjectID'];
        if ($subjectID != '') {
            $subjectID = $db->escape($subjectID);
            $search_arr[] = " `questions`.`subject_id` = {$subjectID} ";
        }
        if (count($search_arr) > 0) {
            $searchQuery = implode("AND", $search_arr);
        }
        // Total number of records without filtering
        $userID = $db->escape(get_loggedin_user_id());
        $sql = "SELECT `questions`.`id` FROM `questions` WHERE `questions`.`branch_id` = {$branchID}";
        if (!is_superadmin_loggedin()) {
            if (!empty($showOwnquestion->show_own_question) && $showOwnquestion->show_own_question == 1) {
                $sql .= " AND `questions`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        }
        $records = $db->query($sql)->result();
        $totalRecords = count($records);
        // Total number of record with filtering
        $sql = "SELECT `questions`.`id`,`question_group`.`name` as `group_name` FROM `questions` LEFT JOIN `question_group` ON `question_group`.`id` = `questions`.`group_id` WHERE `questions`.`branch_id` = {$branchID}";
        if (!empty($searchQuery)) {
            $sql .= " AND " . $searchQuery;
        }
        $records = $db->query($sql)->result();
        $totalRecordwithFilter = count($records);
        // Fetch records
        $sql = "SELECT `questions`.*, IFNULL(`questions_manage`.`marks`, `questions`.`mark`) as `marks`, IFNULL(`questions_manage`.`neg_marks`, 1) as `neg_marks`, `questions_manage`.`id` as `manage_id`, `branch`.`name`, `subject`.`name` as `subject_name`, `class`.`name` as `class_name`, `section`.`name` as `section_name`, `question_group`.`name` as `group_name` FROM `questions` INNER JOIN `branch` ON `branch`.`id` = `questions`.`branch_id` LEFT JOIN `questions_manage` ON `questions_manage`.`question_id` = `questions`.`id` and `questions_manage`.`onlineexam_id` = {$examID} LEFT JOIN `class` ON `class`.`id` = `questions`.`class_id` LEFT JOIN `section` ON `section`.`id` = `questions`.`section_id` LEFT JOIN `subject` ON `subject`.`id` = `questions`.`subject_id` LEFT JOIN `question_group` ON `question_group`.`id` = `questions`.`group_id` WHERE `questions`.`branch_id` = {$branchID}";
        if (!empty($searchQuery)) {
            $sql .= " AND " . $searchQuery;
        }
        $sql .= " ORDER BY `questions`.`id` ASC LIMIT {$start}, {$rowperpage}";
        $records = $db->query($sql)->result();
        $data = array();
        $count = $start + 1;
        $question_type = $this->onlineexam_model->question_type();
        $arrayLevel = $this->onlineexam_model->question_level();
        foreach ($records as $key => $record) {
            $checkbox_status = "";
            if (!empty($record->manage_id)) {
                $checkbox_status = "checked";
            }
            $row = array();
            $cb_row = '';
            $cb_row .= '<input type="hidden" name="question[' . $key . '][id]" value="' . $record->id . '">';
            $cb_row .= '<div class="checkbox-replace"><label class="i-checks">';
            $cb_row .= '<input type="checkbox" class="cb_question" name="question[' . $key . '][cb_id]" value="' . $record->id . '"' . $checkbox_status . '><i></i>';
            $cb_row .= '</label></div>';
            $row[] = $cb_row;
            $row[] = $count++;
            $row[] = strip_tags($record->question);
            $row[] = $record->group_name;
            $row[] = $record->class_name . " (" . $record->section_name . ")";
            $row[] = $record->subject_name;
            $row[] = $question_type[$record->type];
            $row[] = $arrayLevel[$record->level];
            $row[] = '<div class="form-group"><input type="text" class="form-control" name="question[' . $key . '][marks]" value="' . $record->marks . '"><span class="error"></span></div>';
            if ($negMark == 1) {
                $row[] = '<div class="form-group"><input type="text" class="form-control" name="question[' . $key . '][negative_marks]" value="' . $record->neg_marks . '"><span class="error"></span></div>';
            }
            $data[] = $row;
        }
        // Response
        $response = array("draw" => intval($draw), "recordsTotal" => $totalRecords, "recordsFiltered" => $totalRecordwithFilter, "data" => $data);
        return json_encode($response);
    }
    public function questionListDT($postData)
    {
        $response = array();
        // read value
        $draw = $postData['draw'];
        $start = $postData['start'];
        $rowperpage = $postData['length'];
        // Rows display per page
        $searchValue = $postData['search']['value'];
        // Search value
        // order
        $columnIndex = empty($postData['order'][0]['column']) ? 0 : $postData['order'][0]['column'];
        // Column index
        $columnSortOrder = empty($postData['order'][0]['dir']) ? 'asc' : $postData['order'][0]['dir'];
        // asc or desc
        $column_order = array('`questions`.`id`');
        $search_arr = array();
        $searchQuery = "";
        if ($searchValue != '') {
            $search_arr[] = " (`questions`.`question` like '%" . $searchValue . "%') ";
        }
        if (!is_superadmin_loggedin()) {
            $showOwnquestion = $this->app_lib->getSchoolConfig('', 'show_own_question');
            $branch_id = $db->escape(get_loggedin_branch_id());
            $search_arr[] = " `questions`.`branch_id` = {$branch_id} ";
            if (!empty($showOwnquestion->show_own_question) && $showOwnquestion->show_own_question == 1) {
                $search_arr[] = " `questions`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        } else {
            $column_order[] = '`questions`.`branch_id`';
        }
        // order
        $column_order[] = '`questions`.`question`';
        $column_order[] = '`group_name`';
        $column_order[] = '`class`.`id`';
        $column_order[] = '`subject`.`id`';
        $column_order[] = '`questions`.`type`';
        $column_order[] = '`questions`.`level`';
        if (count($search_arr) > 0) {
            $searchQuery = implode("AND", $search_arr);
        }
        // Total number of records without filtering
        if (is_superadmin_loggedin()) {
            $sql = "SELECT `questions`.`id` FROM `questions`";
        } else {
            $branchID = $db->escape(get_loggedin_branch_id());
            $sql = "SELECT `questions`.`id` FROM `questions` WHERE `questions`.`branch_id` = {$branchID}";
            if (!empty($showOwnquestion->show_own_question) && $showOwnquestion->show_own_question == 1) {
                $sql .= " AND `questions`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        }
        $records = $db->query($sql)->result();
        $totalRecords = count($records);
        // Total number of record with filtering
        $sql = "SELECT `questions`.`id` FROM `questions`";
        if (!empty($searchQuery)) {
            $sql .= " WHERE " . $searchQuery;
        }
        $records = $db->query($sql)->result();
        $totalRecordwithFilter = count($records);
        // Fetch records
        $sql = "SELECT `questions`.`id`, `questions`.`question`, `questions`.`type`, `questions`.`level`, `branch`.`name`, `subject`.`name` as `subject_name`, `class`.`name` as `class_name`, `section`.`name` as `section_name`, `question_group`.`name` as `group_name` FROM `questions` INNER JOIN `branch` ON `branch`.`id` = `questions`.`branch_id` LEFT JOIN `class` ON `class`.`id` = `questions`.`class_id` LEFT JOIN `section` ON `section`.`id` = `questions`.`section_id` LEFT JOIN `subject` ON `subject`.`id` = `questions`.`subject_id` LEFT JOIN `question_group` ON `question_group`.`id` = `questions`.`group_id`";
        if (!empty($searchQuery)) {
            $sql .= " WHERE " . $searchQuery;
        }
        $sql .= " ORDER BY " . $column_order[$columnIndex] . " {$columnSortOrder} LIMIT {$start}, {$rowperpage}";
        $records = $db->query($sql)->result();
        $data = array();
        $count = $start + 1;
        $question_type = $this->onlineexam_model->question_type();
        $arrayLevel = $this->onlineexam_model->question_level();
        foreach ($records as $record) {
            $row = array();
            $action = "";
            $action .= '<button data-loading-text="<i class=' . "'far fa-spinner fa-spin'" . '></i>" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('view') . '" onclick="getQuestion(' . $db->escape($record->id) . ', this);"><i class="far fa-bars"></i></button>';
            $action .= '<a href="' . base_url('onlineexam/question_edit/' . $record->id) . '" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('edit') . '"><i class="far fa-pen-nib"></i></a>';
            $action .= btn_delete('onlineexam/question_delete/' . $record->id);
            $row[] = $count++;
            if (is_superadmin_loggedin()) {
                $row[] = $record->name;
            }
            $row[] = strip_tags($record->question);
            $row[] = $record->group_name;
            $row[] = $record->class_name . " (" . $record->section_name . ")";
            $row[] = $record->subject_name;
            $row[] = $question_type[$record->type];
            $row[] = $arrayLevel[$record->level];
            $row[] = $action;
            $data[] = $row;
        }
        // Response
        $response = array("draw" => intval($draw), "recordsTotal" => $totalRecords, "recordsFiltered" => $totalRecordwithFilter, "data" => $data);
        return json_encode($response);
    }
    public function getStudentSubmitted($online_examID = null)
    {
        $r = $db->table('online_exam_submitted')->get('online_exam_submitted')->row();
        return $r;
    }
    public function getExamQuestions($onlineexamID = null, $random_type = 0)
    {
        $builder->select('questions_manage.*,questions.id as qus_id,questions.*')->from('questions_manage');
        $builder->join('questions', 'questions.id = questions_manage.question_id');
        $builder->where('questions_manage.onlineexam_id', $onlineexamID);
        if ($random_type == 1) {
            $this->db->order_by('rand()');
        } else {
            $builder->order_by('questions_manage.id', 'DESC');
        }
        $query = $builder->get();
        return $query->getResult();
    }
    public function getExamResults($onlineexamID = null, $studentID = 0)
    {
        $sql = "SELECT `questions_manage`.*, `questions`.`id` as `qus_id`, `questions`.*, `online_exam_answer`.`answer` as `sb_ans` FROM `questions_manage` INNER JOIN `questions` ON `questions`.`id` = `questions_manage`.`question_id` LEFT JOIN `online_exam_answer` ON `online_exam_answer`.`online_exam_id` = `questions_manage`.`onlineexam_id` and `online_exam_answer`.`question_id` = `questions`.`id` and `online_exam_answer`.`student_id` = " . $db->escape($studentID) . " WHERE `questions_manage`.`onlineexam_id` = " . $db->escape($onlineexamID) . " ORDER BY `questions_manage`.`id` ASC";
        $query = $db->query($sql);
        return $query->getResult();
    }
    public function getExamDetails($onlineexamID, $status = true)
    {
        $onlineexamID = $db->escape($onlineexamID);
        $sessionID = $db->escape(get_session_id());
        $branchID = $db->escape(get_loggedin_branch_id());
        $sql = "SELECT `online_exam`.*, `class`.`name` as `class_name`,(SELECT COUNT(`id`) FROM `questions_manage` WHERE `questions_manage`.`onlineexam_id`=`online_exam`.`id`) as `questions_qty`, `branch`.`name` as `branchname` FROM `online_exam` INNER JOIN `branch` ON `branch`.`id` = `online_exam`.`branch_id` LEFT JOIN `class` ON `class`.`id` = `online_exam`.`class_id` WHERE `online_exam`.`session_id` = {$sessionID} AND `online_exam`.`id` = " . $onlineexamID;
        if ($status == true) {
            $sql .= " AND `online_exam`.`publish_status` = '1'";
        }
        if (!is_superadmin_loggedin()) {
            $sql .= " AND `online_exam`.`branch_id` = {$branchID}";
        }
        $records = $db->query($sql)->row();
        return $records;
    }
    public function getStudentAttempt($onlineexamID)
    {
        $builder->select('IFNULL(SUM(count), 0) as att');
        $this->db->table(array('student_id' => get_loggedin_user_id(), 'online_exam_id' => $onlineexamID))->where();
        $r = $builder->get('online_exam_attempts')->row();
        return $r->att;
    }
    public function addStudentAttemts($onlineexamID)
    {
        $query = $db->table('online_exam_attempts')->get('online_exam_attempts');
        if ($query->num_rows() > 0) {
            $builder->set('count', 'count+1', false);
            $this->db->table('id', $query->row()->id)->where();
            $builder->update('online_exam_attempts');
        } else {
            $this->db->table('online_exam_attempts', ['student_id' => get_loggedin_user_id(), 'online_exam_id' => $onlineexamID, 'count' => 1])->insert();
        }
    }
    public function getSubjectByClass($classID = '', $sectionID = '')
    {
        if (loggedin_role_id() == 3) {
            $restricted = $this->getSingle('branch', get_loggedin_branch_id(), true)->teacher_restricted;
            if ($restricted == 1) {
                $getClassTeacher = $this->getClassTeacherByClassSection($classID);
                if ($getClassTeacher == true) {
                    $query = $this->getSubjectList($classID, $sectionID);
                } else {
                    $builder->select('timetable_class.subject_id,subject.name as subjectname');
                    $builder->from('timetable_class');
                    $builder->join('section', 'section.id = timetable_class.section_id', 'left');
                    $builder->join('subject', 'subject.id = timetable_class.subject_id', 'left');
                    $this->db->table(array('timetable_class.teacher_id' => get_loggedin_user_id(), 'timetable_class.session_id' => get_session_id(), 'timetable_class.class_id' => $classID))->where();
                    $builder->group_by('timetable_class.subject_id');
                    $query = $builder->get();
                }
            } else {
                $query = $this->getSubjectList($classID, $sectionID);
            }
        } else {
            $query = $this->getSubjectList($classID, $sectionID);
        }
        return $query;
    }
    public function getSubjectList($classID = '')
    {
        $builder->select('subject_assign.subject_id, subject.name as subjectname');
        $builder->from('subject_assign');
        $builder->join('subject', 'subject.id = subject_assign.subject_id', 'left');
        $builder->where('class_id', $classID);
        $this->db->table('session_id', get_session_id())->where();
        $query = $builder->get();
        return $query;
    }
    public function getClassTeacherByClassSection($classID = '')
    {
        $builder->select('teacher_allocation.id');
        $builder->from('teacher_allocation');
        $this->db->table('teacher_allocation.teacher_id', get_loggedin_user_id())->where();
        $this->db->table('teacher_allocation.session_id', get_session_id())->where();
        $builder->where('teacher_allocation.class_id', $classID);
        $q = $builder->get()->num_rows();
        if ($q > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function examReport($examID = '', $classID = '', $branchID = '', $order_by_position = 0)
    {
        $builder->select('online_exam_submitted.student_id,online_exam_submitted.remark,online_exam_submitted.position,online_exam.id,online_exam.neg_mark,online_exam.mark_type,online_exam.passing_mark,student.first_name,student.last_name,student.register_no,student.mobileno,online_exam.title,online_exam.section_id,online_exam.subject_id,class.name as class_name');
        $builder->from('online_exam_submitted');
        $builder->join('online_exam', 'online_exam.id = online_exam_submitted.online_exam_id', 'inner');
        $builder->join('class', 'class.id = online_exam.class_id', 'left');
        $builder->join('student', 'student.id = online_exam_submitted.student_id', 'left');
        $builder->where('online_exam_submitted.online_exam_id', $examID);
        $this->db->table('online_exam.session_id', get_session_id())->where();
        $builder->where('online_exam.class_id', $classID);
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $examResult = $this->examResult($value['id'], $value['student_id']);
            $status = 0;
            $mark = 0;
            $score = 0;
            $total_neg_marks = $value['neg_mark'] == 0 ? 0 : $examResult['total_neg_marks'];
            if ($examResult['total_obtain_marks'] != 0) {
                if ($value['mark_type'] == 1) {
                    $obtain = ($examResult['total_obtain_marks'] - $total_neg_marks) * 100 / $examResult['total_marks'];
                    if ($obtain >= $value['passing_mark']) {
                        $status = 1;
                    } else {
                        $status = 0;
                    }
                } else {
                    $obtain = $examResult['total_obtain_marks'] - $total_neg_marks;
                    if ($obtain >= $value['passing_mark']) {
                        $status = 1;
                    } else {
                        $status = 0;
                    }
                }
                $mark = $examResult['total_obtain_marks'] - $total_neg_marks;
            }
            $score = $examResult['total_marks'] === 0 ? '0.00' : number_format(($examResult['total_obtain_marks'] - $total_neg_marks) * 100 / $examResult['total_marks'], 2, '.', '');
            $result[$key]['result'] = $status;
            $result[$key]['mark'] = $mark;
            $result[$key]['totalmark'] = $examResult['total_marks'];
            $result[$key]['score'] = $score;
        }
        if ($order_by_position == 1) {
            array_multisort(array_column($result, 'position'), SORT_ASC, $result);
        } else {
            array_multisort(array_column($result, 'score'), SORT_DESC, $result);
        }
        return $result;
    }
    public function examResult($examID, $studentID)
    {
        $result = $this->getExamResults($examID, $studentID);
        $correct_ans = 0;
        $total_question = 0;
        $total_neg_marks = 0;
        $total_marks = 0;
        $total_obtain_marks = 0;
        $wrong_ans = 0;
        $total_answered = 0;
        if (!empty($result)) {
            $total_question = count($result);
            foreach ($result as $key => $value) {
                $total_marks = $total_marks + $value->marks;
                if (!empty($value->sb_ans)) {
                    $total_answered++;
                    if ($value->type == 1 || $value->type == 3) {
                        if ($value->sb_ans == $value->answer) {
                            $correct_ans++;
                            $total_obtain_marks = $total_obtain_marks + $value->marks;
                        } else {
                            $total_neg_marks = $total_neg_marks + $value->neg_marks;
                            $wrong_ans++;
                        }
                    } elseif ($value->type == 2) {
                        if ($this->array_equal(json_decode($value->answer), json_decode($value->sb_ans))) {
                            $correct_ans++;
                            $total_obtain_marks = $total_obtain_marks + $value->marks;
                        } else {
                            $total_neg_marks = $total_neg_marks + $value->neg_marks;
                            $wrong_ans++;
                        }
                    } elseif ($value->type == 4) {
                        $correctAns = str_replace(" ", "_", $value->answer);
                        $studentAns = str_replace(" ", "_", $value->sb_ans);
                        if (strtolower($correctAns) == strtolower($studentAns)) {
                            $correct_ans++;
                            $total_obtain_marks = $total_obtain_marks + $value->marks;
                        } else {
                            $total_neg_marks = $total_neg_marks + $value->neg_marks;
                            $wrong_ans++;
                        }
                    }
                }
            }
        }
        return ['total_marks' => $total_marks, 'total_obtain_marks' => $total_obtain_marks, 'correct_ans' => $correct_ans, 'total_question' => $total_question, 'total_neg_marks' => $total_neg_marks, 'wrong_ans' => $wrong_ans, 'total_answered' => $total_answered];
    }
    public function array_equal($a, $b)
    {
        return is_array($a) && is_array($b) && count($a) == count($b) && array_diff($a, $b) === array_diff($b, $a);
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class OnlineexamModel extends MYModel
{
    protected $db;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        parent::__construct();
    }
    // online exam save and update function
    public function saveExam($data, $branchID)
    {
        $onlineExam = array('title' => $data['title'], 'class_id' => $data['class_id'], 'section_id' => json_encode($this->request->getPost('section')), 'subject_id' => json_encode($this->request->getPost('subject')), 'limits_participation' => $data['participation_limit'], 'exam_start' => date('Y-m-d H:i:s', strtotime($data['start_date'] . " " . $data['start_time'])), 'exam_end' => date('Y-m-d H:i:s', strtotime($data['end_date'] . " " . $data['end_time'])), 'duration' => date('H:i:s', strtotime($data['duration'])), 'mark_type' => $data['mark_type'], 'passing_mark' => $data['passing_mark'], 'instruction' => $data['instruction'], 'session_id' => get_session_id(), 'publish_result' => $data['publish_result'], 'marks_display' => 0, 'neg_mark' => isset($data['negative_marking']) ? 1 : 0, 'marks_display' => isset($data['marks_display']) ? 1 : 0, 'question_type' => $data['question_type'], 'fee' => $data['exam_type'] == 1 ? $data['exam_fee'] : 0, 'exam_type' => $data['exam_type'], 'branch_id' => $branchID, 'created_at' => date('Y-m-d H:i:s'), 'updated_at' => date('Y-m-d H:i:s'));
        if (!isset($_POST['id'])) {
            $onlineExam['publish_status'] = 0;
            $onlineExam['created_by'] = get_loggedin_user_id();
            $builder->insert('online_exam', $onlineExam);
        } else {
            $builder->where('id', $data['id']);
            $builder->update('online_exam', $onlineExam);
        }
    }
    public function examList()
    {
        $builder->select('online_exam.*,class.name as class_name,branch.name as branchname');
        $builder->from('online_exam');
        $builder->join('branch', 'branch.id = online_exam.branch_id', 'inner');
        $builder->join('class', 'class.id = online_exam.class_id', 'left');
        if (!is_superadmin_loggedin()) {
            $this->db->table('online_exam.branch_id', get_loggedin_branch_id())->where();
        }
        $builder->order_by('online_exam.id', 'DESC');
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $result[$key]['section_details'] = $this->getSectionDetails($value['section_id']);
        }
        return $result;
    }
    public function examListDT($postData, $currency_symbol = '')
    {
        $response = array();
        $sessionID = get_session_id();
        // read value
        $draw = $postData['draw'];
        $start = $postData['start'];
        $rowperpage = $postData['length'];
        // Rows display per page
        $searchValue = $postData['search']['value'];
        // Search value
        // order
        $columnIndex = empty($postData['order'][0]['column']) ? 0 : $postData['order'][0]['column'];
        // Column index
        $columnSortOrder = empty($postData['order'][0]['dir']) ? 'DESC' : $postData['order'][0]['dir'];
        // asc or desc
        $column_order = array('`online_exam`.`id`');
        $search_arr = array();
        $searchQuery = "";
        if ($searchValue != '') {
            $search_arr[] = " (`online_exam`.`title` like '%" . $searchValue . "%' OR `online_exam`.`exam_start` like '%" . $searchValue . "%' OR `online_exam`.`exam_end` like '%" . $searchValue . "%') ";
        }
        if (!is_superadmin_loggedin()) {
            $branchID = $db->escape(get_loggedin_branch_id());
            $search_arr[] = " `online_exam`.`branch_id` = {$branchID} ";
            if (!is_superadmin_loggedin() && !is_admin_loggedin()) {
                $search_arr[] = " `online_exam`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        } else {
            $column_order[] = '`online_exam`.`id`';
        }
        // order
        $column_order[] = '`online_exam`.`title`';
        $column_order[] = '`class`.`id`';
        $column_order[] = '`questions_qty`';
        $column_order[] = '`online_exam`.`exam_start`';
        $column_order[] = '`online_exam`.`exam_end`';
        $column_order[] = '`online_exam`.`duration`';
        if (count($search_arr) > 0) {
            $searchQuery = implode("AND", $search_arr);
        }
        // Total number of records without filtering
        if (is_superadmin_loggedin()) {
            $sql = "SELECT `id` FROM `online_exam` WHERE `session_id` = '{$sessionID}'";
        } else {
            $branchID = $db->escape(get_loggedin_branch_id());
            $sql = "SELECT `id` FROM `online_exam` WHERE `branch_id` = {$branchID} AND `session_id` = '{$sessionID}'";
            if (!is_superadmin_loggedin() && !is_admin_loggedin()) {
                $sql .= " AND `created_by` = " . $db->escape(get_loggedin_user_id());
            }
        }
        $records = $db->query($sql)->result();
        $totalRecords = count($records);
        // Total number of record with filtering
        $sql = "SELECT `id` FROM `online_exam` WHERE `session_id` = '{$sessionID}'";
        if (!empty($searchQuery)) {
            $sql .= " AND " . $searchQuery;
        }
        $records = $db->query($sql)->result();
        $totalRecordwithFilter = count($records);
        // Fetch records
        $sql = "SELECT `online_exam`.*, `class`.`name` as `class_name`,(SELECT COUNT(`id`) FROM `questions_manage` WHERE `questions_manage`.`onlineexam_id`=`online_exam`.`id`) as `questions_qty`, `branch`.`name` as `branchname` FROM `online_exam` INNER JOIN `branch` ON `branch`.`id` = `online_exam`.`branch_id` LEFT JOIN `class` ON `class`.`id` = `online_exam`.`class_id` WHERE `online_exam`.`session_id` = '{$sessionID}'";
        if (!empty($searchQuery)) {
            $sql .= " AND " . $searchQuery;
        }
        $sql .= " ORDER BY " . $column_order[$columnIndex] . " {$columnSortOrder} LIMIT {$start}, {$rowperpage}";
        $records = $db->query($sql)->result();
        $data = array();
        $count = $start + 1;
        foreach ($records as $record) {
            if ($record->publish_status == 0) {
                $status = '';
            } else {
                $status = 'checked';
            }
            $row = array();
            $action = "";
            if (get_permission('add_questions', 'is_add')) {
                if ($record->publish_result == 0 && $record->publish_status == 1) {
                    $action .= '<button onclick="confirmModal(' . $db->escape(base_url('onlineexam/make_result_publish/' . $record->id)) . ')" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('make') . " " . translate('result_publish') . '"> <i class="far fa-square-poll-vertical"></i></button>';
                }
            }
            $action .= '<a href="' . base_url('onlineexam/question_list/' . $record->id) . '" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('view') . " " . translate('question') . '"> <i class="far fa-list-check"></i></a>';
            if ($record->publish_status == 0) {
                $action .= '<a href="' . base_url('onlineexam/manage_question/' . $record->id) . '" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('add_questions') . '"> <i class="far fa-question"></i></a>';
            }
            if (get_permission('online_exam', 'is_edit')) {
                $action .= '<a href="' . base_url('onlineexam/edit/' . $record->id) . '" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('edit') . '"> <i class="far fa-pen-nib"></i></a>';
            }
            if (get_permission('online_exam', 'is_delete')) {
                $action .= btn_delete('onlineexam/delete/' . $record->id);
            }
            $row[] = $count++;
            if (is_superadmin_loggedin()) {
                $row[] = $record->branchname;
            }
            $row[] = $record->title;
            $row[] = $record->class_name . " (" . $this->getSectionDetails($record->section_id) . ")";
            $row[] = $record->questions_qty;
            $row[] = _d($record->exam_start) . "<p class='text-muted'>" . date("h:i A", strtotime($record->exam_start)) . "</p>";
            $row[] = _d($record->exam_end) . "<p class='text-muted'>" . date("h:i A", strtotime($record->exam_end)) . "</p>";
            $row[] = $record->duration;
            $row[] = $record->exam_type == 0 ? translate('free') : $currency_symbol . $record->fee;
            $row[] = '<div class="material-switch ml-xs">
                        <input class="exam-status" id="examstatus_' . $record->id . '" data-id="' . $record->id . '" name="exam_status' . $record->id . '"
                        type="checkbox" ' . $status . ' />
                        <label for="examstatus_' . $record->id . '" class="label-primary"></label>
                        <span class="visible-print-block">' . ($status == 'checked' ? translate('yes') : translate('no')) . '</span>
                    </div>';
            $row[] = get_type_name_by_id('staff', $record->created_by);
            $row[] = $action;
            $data[] = $row;
        }
        // Response
        $response = array("draw" => intval($draw), "recordsTotal" => $totalRecords, "recordsFiltered" => $totalRecordwithFilter, "data" => $data);
        return json_encode($response);
    }
    public function getSelectExamList($class_id)
    {
        $arrayData = array("" => translate('select'));
        if (!is_superadmin_loggedin() && !is_admin_loggedin()) {
            $this->db->table('created_by', get_loggedin_user_id())->where();
        }
        $builder->where('class_id', $class_id);
        $this->db->table('session_id', get_session_id())->where();
        $builder->where('publish_status', 1);
        $builder->where('publish_result', 1);
        $result = $builder->get('online_exam')->getResult();
        foreach ($result as $row) {
            $arrayData[$row->id] = $row->title;
        }
        return $arrayData;
    }
    public function getSectionDetails($data)
    {
        $array = json_decode($data, true);
        $nameList = [];
        if (json_last_error() == JSON_ERROR_NONE) {
            foreach ($array as $key => $value) {
                $nameList[] = get_type_name_by_id('section', $value);
            }
        }
        $nameList = implode(', ', $nameList);
        return $nameList;
    }
    public function getSubjectDetails($data)
    {
        $array = json_decode($data, true);
        $nameList = [];
        if (json_last_error() == JSON_ERROR_NONE) {
            foreach ($array as $key => $value) {
                $nameList[] = get_type_name_by_id('subject', $value);
            }
        }
        $nameList = implode(',<br>', $nameList);
        return $nameList;
    }
    // questions save and update function
    public function saveQuestions()
    {
        $branchID = $this->applicationModel->get_branch_id();
        $questionType = $this->request->getPost('question_type');
        if ($questionType == 2) {
            $answer = json_encode($this->request->getPost('answer'));
        } else {
            $answer = $this->request->getPost('answer');
        }
        $questionID = $this->request->getPost('question_id');
        $classID = $this->request->getPost('class_id');
        $sectionID = $this->request->getPost('section_id');
        $subjectID = $this->request->getPost('subject_id');
        $groupID = $this->request->getPost('group_id');
        $questionsExam = array('type' => $questionType, 'level' => $this->request->getPost('question_level'), 'group_id' => $groupID, 'question' => $this->request->getPost('question', false), 'opt_1' => $this->tagRemove($this->request->getPost('option1', false)), 'opt_2' => $this->tagRemove($this->request->getPost('option2', false)), 'opt_3' => $this->tagRemove($this->request->getPost('option3', false)), 'opt_4' => $this->tagRemove($this->request->getPost('option4', false)), 'answer' => $answer, 'mark' => $this->request->getPost('mark'));
        if (!empty($classID)) {
            $questionsExam['class_id'] = $classID;
        }
        if (!empty($sectionID)) {
            $questionsExam['section_id'] = $sectionID;
        }
        if (!empty($subjectID)) {
            $questionsExam['subject_id'] = $subjectID;
        }
        if (!empty($branchID)) {
            $questionsExam['branch_id'] = $branchID;
        }
        if (empty($questionID)) {
            $questionsExam['created_by'] = get_loggedin_user_id();
            $builder->insert('questions', $questionsExam);
        } else {
            $builder->where('id', $questionID);
            $builder->update('questions', $questionsExam);
        }
    }
    private function tagRemove($text = "")
    {
        $text = str_replace("<p>", "", $text);
        $text = str_replace("</p>", "", $text);
        return $text;
    }
    public function question_level()
    {
        $arrayLevel = array('' => translate("select"), '1' => translate("easy"), '2' => translate("medium"), '3' => translate("hard"));
        return $arrayLevel;
    }
    public function question_group($branch_id = '')
    {
        if (empty($branch_id)) {
            $array = array('' => translate('select_branch_first'));
        } else {
            $builder->where('branch_id', $branch_id);
            $result = $builder->get('question_group')->getResult();
            $array = array('' => translate('select'));
            foreach ($result as $row) {
                $array[$row->id] = $row->name;
            }
        }
        return $array;
    }
    public function question_type()
    {
        $arrayType = array('1' => translate("single_choice"), '2' => translate("multiple_choice"), '3' => translate("true/false"), '4' => translate("descriptive"));
        return $arrayType;
    }
    public function questionList($postData)
    {
        $response = array();
        // read value
        $draw = $postData['draw'];
        $start = $postData['start'];
        $rowperpage = $postData['length'];
        // Rows display per page
        $searchValue = $postData['search']['value'];
        // Search value
        // Search
        $branchID = $db->escape($postData['branch_id']);
        $examID = $db->escape($postData['examID']);
        $negMark = $postData['negMark'];
        $search_arr = array();
        $searchQuery = "";
        if ($searchValue != '') {
            $search_arr[] = " (`questions`.`question` like '%" . $searchValue . "%' OR `question_group`.`name` like '%" . $searchValue . "%') ";
        }
        if (!is_superadmin_loggedin()) {
            $showOwnquestion = $this->app_lib->getSchoolConfig($postData['branch_id'], 'show_own_question');
            if (!empty($showOwnquestion->show_own_question) && $showOwnquestion->show_own_question == 1) {
                $search_arr[] = " `questions`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        }
        $questionGroup = $postData['questionGroup'];
        if ($questionGroup != '') {
            $questionGroup = $db->escape($questionGroup);
            $search_arr[] = " `questions`.`group_id` = {$questionGroup} ";
        }
        $questionType = $postData['questionType'];
        if ($questionType != '') {
            $questionType = $db->escape($questionType);
            $search_arr[] = " `questions`.`type` = {$questionType} ";
        }
        $questionLevel = $postData['questionLevel'];
        if ($questionLevel != '') {
            $questionLevel = $db->escape($questionLevel);
            $search_arr[] = " `questions`.`level` = {$questionLevel} ";
        }
        $classID = $postData['classID'];
        if ($classID != '') {
            $classID = $db->escape($classID);
            $search_arr[] = " `questions`.`class_id` = {$classID} ";
        }
        $sectionID = $postData['sectionID'];
        if ($sectionID != '') {
            $sectionID = $db->escape($sectionID);
            $search_arr[] = " `questions`.`section_id` = {$sectionID} ";
        }
        $subjectID = $postData['subjectID'];
        if ($subjectID != '') {
            $subjectID = $db->escape($subjectID);
            $search_arr[] = " `questions`.`subject_id` = {$subjectID} ";
        }
        if (count($search_arr) > 0) {
            $searchQuery = implode("AND", $search_arr);
        }
        // Total number of records without filtering
        $userID = $db->escape(get_loggedin_user_id());
        $sql = "SELECT `questions`.`id` FROM `questions` WHERE `questions`.`branch_id` = {$branchID}";
        if (!is_superadmin_loggedin()) {
            if (!empty($showOwnquestion->show_own_question) && $showOwnquestion->show_own_question == 1) {
                $sql .= " AND `questions`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        }
        $records = $db->query($sql)->result();
        $totalRecords = count($records);
        // Total number of record with filtering
        $sql = "SELECT `questions`.`id`,`question_group`.`name` as `group_name` FROM `questions` LEFT JOIN `question_group` ON `question_group`.`id` = `questions`.`group_id` WHERE `questions`.`branch_id` = {$branchID}";
        if (!empty($searchQuery)) {
            $sql .= " AND " . $searchQuery;
        }
        $records = $db->query($sql)->result();
        $totalRecordwithFilter = count($records);
        // Fetch records
        $sql = "SELECT `questions`.*, IFNULL(`questions_manage`.`marks`, `questions`.`mark`) as `marks`, IFNULL(`questions_manage`.`neg_marks`, 1) as `neg_marks`, `questions_manage`.`id` as `manage_id`, `branch`.`name`, `subject`.`name` as `subject_name`, `class`.`name` as `class_name`, `section`.`name` as `section_name`, `question_group`.`name` as `group_name` FROM `questions` INNER JOIN `branch` ON `branch`.`id` = `questions`.`branch_id` LEFT JOIN `questions_manage` ON `questions_manage`.`question_id` = `questions`.`id` and `questions_manage`.`onlineexam_id` = {$examID} LEFT JOIN `class` ON `class`.`id` = `questions`.`class_id` LEFT JOIN `section` ON `section`.`id` = `questions`.`section_id` LEFT JOIN `subject` ON `subject`.`id` = `questions`.`subject_id` LEFT JOIN `question_group` ON `question_group`.`id` = `questions`.`group_id` WHERE `questions`.`branch_id` = {$branchID}";
        if (!empty($searchQuery)) {
            $sql .= " AND " . $searchQuery;
        }
        $sql .= " ORDER BY `questions`.`id` ASC LIMIT {$start}, {$rowperpage}";
        $records = $db->query($sql)->result();
        $data = array();
        $count = $start + 1;
        $question_type = $this->onlineexam_model->question_type();
        $arrayLevel = $this->onlineexam_model->question_level();
        foreach ($records as $key => $record) {
            $checkbox_status = "";
            if (!empty($record->manage_id)) {
                $checkbox_status = "checked";
            }
            $row = array();
            $cb_row = '';
            $cb_row .= '<input type="hidden" name="question[' . $key . '][id]" value="' . $record->id . '">';
            $cb_row .= '<div class="checkbox-replace"><label class="i-checks">';
            $cb_row .= '<input type="checkbox" class="cb_question" name="question[' . $key . '][cb_id]" value="' . $record->id . '"' . $checkbox_status . '><i></i>';
            $cb_row .= '</label></div>';
            $row[] = $cb_row;
            $row[] = $count++;
            $row[] = strip_tags($record->question);
            $row[] = $record->group_name;
            $row[] = $record->class_name . " (" . $record->section_name . ")";
            $row[] = $record->subject_name;
            $row[] = $question_type[$record->type];
            $row[] = $arrayLevel[$record->level];
            $row[] = '<div class="form-group"><input type="text" class="form-control" name="question[' . $key . '][marks]" value="' . $record->marks . '"><span class="error"></span></div>';
            if ($negMark == 1) {
                $row[] = '<div class="form-group"><input type="text" class="form-control" name="question[' . $key . '][negative_marks]" value="' . $record->neg_marks . '"><span class="error"></span></div>';
            }
            $data[] = $row;
        }
        // Response
        $response = array("draw" => intval($draw), "recordsTotal" => $totalRecords, "recordsFiltered" => $totalRecordwithFilter, "data" => $data);
        return json_encode($response);
    }
    public function questionListDT($postData)
    {
        $response = array();
        // read value
        $draw = $postData['draw'];
        $start = $postData['start'];
        $rowperpage = $postData['length'];
        // Rows display per page
        $searchValue = $postData['search']['value'];
        // Search value
        // order
        $columnIndex = empty($postData['order'][0]['column']) ? 0 : $postData['order'][0]['column'];
        // Column index
        $columnSortOrder = empty($postData['order'][0]['dir']) ? 'asc' : $postData['order'][0]['dir'];
        // asc or desc
        $column_order = array('`questions`.`id`');
        $search_arr = array();
        $searchQuery = "";
        if ($searchValue != '') {
            $search_arr[] = " (`questions`.`question` like '%" . $searchValue . "%') ";
        }
        if (!is_superadmin_loggedin()) {
            $showOwnquestion = $this->app_lib->getSchoolConfig('', 'show_own_question');
            $branch_id = $db->escape(get_loggedin_branch_id());
            $search_arr[] = " `questions`.`branch_id` = {$branch_id} ";
            if (!empty($showOwnquestion->show_own_question) && $showOwnquestion->show_own_question == 1) {
                $search_arr[] = " `questions`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        } else {
            $column_order[] = '`questions`.`branch_id`';
        }
        // order
        $column_order[] = '`questions`.`question`';
        $column_order[] = '`group_name`';
        $column_order[] = '`class`.`id`';
        $column_order[] = '`subject`.`id`';
        $column_order[] = '`questions`.`type`';
        $column_order[] = '`questions`.`level`';
        if (count($search_arr) > 0) {
            $searchQuery = implode("AND", $search_arr);
        }
        // Total number of records without filtering
        if (is_superadmin_loggedin()) {
            $sql = "SELECT `questions`.`id` FROM `questions`";
        } else {
            $branchID = $db->escape(get_loggedin_branch_id());
            $sql = "SELECT `questions`.`id` FROM `questions` WHERE `questions`.`branch_id` = {$branchID}";
            if (!empty($showOwnquestion->show_own_question) && $showOwnquestion->show_own_question == 1) {
                $sql .= " AND `questions`.`created_by` = " . $db->escape(get_loggedin_user_id());
            }
        }
        $records = $db->query($sql)->result();
        $totalRecords = count($records);
        // Total number of record with filtering
        $sql = "SELECT `questions`.`id` FROM `questions`";
        if (!empty($searchQuery)) {
            $sql .= " WHERE " . $searchQuery;
        }
        $records = $db->query($sql)->result();
        $totalRecordwithFilter = count($records);
        // Fetch records
        $sql = "SELECT `questions`.`id`, `questions`.`question`, `questions`.`type`, `questions`.`level`, `branch`.`name`, `subject`.`name` as `subject_name`, `class`.`name` as `class_name`, `section`.`name` as `section_name`, `question_group`.`name` as `group_name` FROM `questions` INNER JOIN `branch` ON `branch`.`id` = `questions`.`branch_id` LEFT JOIN `class` ON `class`.`id` = `questions`.`class_id` LEFT JOIN `section` ON `section`.`id` = `questions`.`section_id` LEFT JOIN `subject` ON `subject`.`id` = `questions`.`subject_id` LEFT JOIN `question_group` ON `question_group`.`id` = `questions`.`group_id`";
        if (!empty($searchQuery)) {
            $sql .= " WHERE " . $searchQuery;
        }
        $sql .= " ORDER BY " . $column_order[$columnIndex] . " {$columnSortOrder} LIMIT {$start}, {$rowperpage}";
        $records = $db->query($sql)->result();
        $data = array();
        $count = $start + 1;
        $question_type = $this->onlineexam_model->question_type();
        $arrayLevel = $this->onlineexam_model->question_level();
        foreach ($records as $record) {
            $row = array();
            $action = "";
            $action .= '<button data-loading-text="<i class=' . "'far fa-spinner fa-spin'" . '></i>" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('view') . '" onclick="getQuestion(' . $db->escape($record->id) . ', this);"><i class="far fa-bars"></i></button>';
            $action .= '<a href="' . base_url('onlineexam/question_edit/' . $record->id) . '" class="btn btn-circle btn-default icon" data-toggle="tooltip" data-original-title="' . translate('edit') . '"><i class="far fa-pen-nib"></i></a>';
            $action .= btn_delete('onlineexam/question_delete/' . $record->id);
            $row[] = $count++;
            if (is_superadmin_loggedin()) {
                $row[] = $record->name;
            }
            $row[] = strip_tags($record->question);
            $row[] = $record->group_name;
            $row[] = $record->class_name . " (" . $record->section_name . ")";
            $row[] = $record->subject_name;
            $row[] = $question_type[$record->type];
            $row[] = $arrayLevel[$record->level];
            $row[] = $action;
            $data[] = $row;
        }
        // Response
        $response = array("draw" => intval($draw), "recordsTotal" => $totalRecords, "recordsFiltered" => $totalRecordwithFilter, "data" => $data);
        return json_encode($response);
    }
    public function getStudentSubmitted($online_examID = null)
    {
        $r = $db->table('online_exam_submitted')->get('online_exam_submitted')->row();
        return $r;
    }
    public function getExamQuestions($onlineexamID = null, $random_type = 0)
    {
        $builder->select('questions_manage.*,questions.id as qus_id,questions.*')->from('questions_manage');
        $builder->join('questions', 'questions.id = questions_manage.question_id');
        $builder->where('questions_manage.onlineexam_id', $onlineexamID);
        if ($random_type == 1) {
            $this->db->order_by('rand()');
        } else {
            $builder->order_by('questions_manage.id', 'DESC');
        }
        $query = $builder->get();
        return $query->getResult();
    }
    public function getExamResults($onlineexamID = null, $studentID = 0)
    {
        $sql = "SELECT `questions_manage`.*, `questions`.`id` as `qus_id`, `questions`.*, `online_exam_answer`.`answer` as `sb_ans` FROM `questions_manage` INNER JOIN `questions` ON `questions`.`id` = `questions_manage`.`question_id` LEFT JOIN `online_exam_answer` ON `online_exam_answer`.`online_exam_id` = `questions_manage`.`onlineexam_id` and `online_exam_answer`.`question_id` = `questions`.`id` and `online_exam_answer`.`student_id` = " . $db->escape($studentID) . " WHERE `questions_manage`.`onlineexam_id` = " . $db->escape($onlineexamID) . " ORDER BY `questions_manage`.`id` ASC";
        $query = $db->query($sql);
        return $query->getResult();
    }
    public function getExamDetails($onlineexamID, $status = true)
    {
        $onlineexamID = $db->escape($onlineexamID);
        $sessionID = $db->escape(get_session_id());
        $branchID = $db->escape(get_loggedin_branch_id());
        $sql = "SELECT `online_exam`.*, `class`.`name` as `class_name`,(SELECT COUNT(`id`) FROM `questions_manage` WHERE `questions_manage`.`onlineexam_id`=`online_exam`.`id`) as `questions_qty`, `branch`.`name` as `branchname` FROM `online_exam` INNER JOIN `branch` ON `branch`.`id` = `online_exam`.`branch_id` LEFT JOIN `class` ON `class`.`id` = `online_exam`.`class_id` WHERE `online_exam`.`session_id` = {$sessionID} AND `online_exam`.`id` = " . $onlineexamID;
        if ($status == true) {
            $sql .= " AND `online_exam`.`publish_status` = '1'";
        }
        if (!is_superadmin_loggedin()) {
            $sql .= " AND `online_exam`.`branch_id` = {$branchID}";
        }
        $records = $db->query($sql)->row();
        return $records;
    }
    public function getStudentAttempt($onlineexamID)
    {
        $builder->select('IFNULL(SUM(count), 0) as att');
        $this->db->table(array('student_id' => get_loggedin_user_id(), 'online_exam_id' => $onlineexamID))->where();
        $r = $builder->get('online_exam_attempts')->row();
        return $r->att;
    }
    public function addStudentAttemts($onlineexamID)
    {
        $query = $db->table('online_exam_attempts')->get('online_exam_attempts');
        if ($query->num_rows() > 0) {
            $builder->set('count', 'count+1', false);
            $this->db->table('id', $query->row()->id)->where();
            $builder->update('online_exam_attempts');
        } else {
            $this->db->table('online_exam_attempts', ['student_id' => get_loggedin_user_id(), 'online_exam_id' => $onlineexamID, 'count' => 1])->insert();
        }
    }
    public function getSubjectByClass($classID = '', $sectionID = '')
    {
        if (loggedin_role_id() == 3) {
            $restricted = $this->getSingle('branch', get_loggedin_branch_id(), true)->teacher_restricted;
            if ($restricted == 1) {
                $getClassTeacher = $this->getClassTeacherByClassSection($classID);
                if ($getClassTeacher == true) {
                    $query = $this->getSubjectList($classID, $sectionID);
                } else {
                    $builder->select('timetable_class.subject_id,subject.name as subjectname');
                    $builder->from('timetable_class');
                    $builder->join('section', 'section.id = timetable_class.section_id', 'left');
                    $builder->join('subject', 'subject.id = timetable_class.subject_id', 'left');
                    $this->db->table(array('timetable_class.teacher_id' => get_loggedin_user_id(), 'timetable_class.session_id' => get_session_id(), 'timetable_class.class_id' => $classID))->where();
                    $builder->group_by('timetable_class.subject_id');
                    $query = $builder->get();
                }
            } else {
                $query = $this->getSubjectList($classID, $sectionID);
            }
        } else {
            $query = $this->getSubjectList($classID, $sectionID);
        }
        return $query;
    }
    public function getSubjectList($classID = '')
    {
        $builder->select('subject_assign.subject_id, subject.name as subjectname');
        $builder->from('subject_assign');
        $builder->join('subject', 'subject.id = subject_assign.subject_id', 'left');
        $builder->where('class_id', $classID);
        $this->db->table('session_id', get_session_id())->where();
        $query = $builder->get();
        return $query;
    }
    public function getClassTeacherByClassSection($classID = '')
    {
        $builder->select('teacher_allocation.id');
        $builder->from('teacher_allocation');
        $this->db->table('teacher_allocation.teacher_id', get_loggedin_user_id())->where();
        $this->db->table('teacher_allocation.session_id', get_session_id())->where();
        $builder->where('teacher_allocation.class_id', $classID);
        $q = $builder->get()->num_rows();
        if ($q > 0) {
            return true;
        } else {
            return false;
        }
    }
    public function examReport($examID = '', $classID = '', $branchID = '', $order_by_position = 0)
    {
        $builder->select('online_exam_submitted.student_id,online_exam_submitted.remark,online_exam_submitted.position,online_exam.id,online_exam.neg_mark,online_exam.mark_type,online_exam.passing_mark,student.first_name,student.last_name,student.register_no,student.mobileno,online_exam.title,online_exam.section_id,online_exam.subject_id,class.name as class_name');
        $builder->from('online_exam_submitted');
        $builder->join('online_exam', 'online_exam.id = online_exam_submitted.online_exam_id', 'inner');
        $builder->join('class', 'class.id = online_exam.class_id', 'left');
        $builder->join('student', 'student.id = online_exam_submitted.student_id', 'left');
        $builder->where('online_exam_submitted.online_exam_id', $examID);
        $this->db->table('online_exam.session_id', get_session_id())->where();
        $builder->where('online_exam.class_id', $classID);
        $result = $builder->get()->result_array();
        foreach ($result as $key => $value) {
            $examResult = $this->examResult($value['id'], $value['student_id']);
            $status = 0;
            $mark = 0;
            $score = 0;
            $total_neg_marks = $value['neg_mark'] == 0 ? 0 : $examResult['total_neg_marks'];
            if ($examResult['total_obtain_marks'] != 0) {
                if ($value['mark_type'] == 1) {
                    $obtain = ($examResult['total_obtain_marks'] - $total_neg_marks) * 100 / $examResult['total_marks'];
                    if ($obtain >= $value['passing_mark']) {
                        $status = 1;
                    } else {
                        $status = 0;
                    }
                } else {
                    $obtain = $examResult['total_obtain_marks'] - $total_neg_marks;
                    if ($obtain >= $value['passing_mark']) {
                        $status = 1;
                    } else {
                        $status = 0;
                    }
                }
                $mark = $examResult['total_obtain_marks'] - $total_neg_marks;
            }
            $score = $examResult['total_marks'] === 0 ? '0.00' : number_format(($examResult['total_obtain_marks'] - $total_neg_marks) * 100 / $examResult['total_marks'], 2, '.', '');
            $result[$key]['result'] = $status;
            $result[$key]['mark'] = $mark;
            $result[$key]['totalmark'] = $examResult['total_marks'];
            $result[$key]['score'] = $score;
        }
        if ($order_by_position == 1) {
            array_multisort(array_column($result, 'position'), SORT_ASC, $result);
        } else {
            array_multisort(array_column($result, 'score'), SORT_DESC, $result);
        }
        return $result;
    }
    public function examResult($examID, $studentID)
    {
        $result = $this->getExamResults($examID, $studentID);
        $correct_ans = 0;
        $total_question = 0;
        $total_neg_marks = 0;
        $total_marks = 0;
        $total_obtain_marks = 0;
        $wrong_ans = 0;
        $total_answered = 0;
        if (!empty($result)) {
            $total_question = count($result);
            foreach ($result as $key => $value) {
                $total_marks = $total_marks + $value->marks;
                if (!empty($value->sb_ans)) {
                    $total_answered++;
                    if ($value->type == 1 || $value->type == 3) {
                        if ($value->sb_ans == $value->answer) {
                            $correct_ans++;
                            $total_obtain_marks = $total_obtain_marks + $value->marks;
                        } else {
                            $total_neg_marks = $total_neg_marks + $value->neg_marks;
                            $wrong_ans++;
                        }
                    } elseif ($value->type == 2) {
                        if ($this->array_equal(json_decode($value->answer), json_decode($value->sb_ans))) {
                            $correct_ans++;
                            $total_obtain_marks = $total_obtain_marks + $value->marks;
                        } else {
                            $total_neg_marks = $total_neg_marks + $value->neg_marks;
                            $wrong_ans++;
                        }
                    } elseif ($value->type == 4) {
                        $correctAns = str_replace(" ", "_", $value->answer);
                        $studentAns = str_replace(" ", "_", $value->sb_ans);
                        if (strtolower($correctAns) == strtolower($studentAns)) {
                            $correct_ans++;
                            $total_obtain_marks = $total_obtain_marks + $value->marks;
                        } else {
                            $total_neg_marks = $total_neg_marks + $value->neg_marks;
                            $wrong_ans++;
                        }
                    }
                }
            }
        }
        return ['total_marks' => $total_marks, 'total_obtain_marks' => $total_obtain_marks, 'correct_ans' => $correct_ans, 'total_question' => $total_question, 'total_neg_marks' => $total_neg_marks, 'wrong_ans' => $wrong_ans, 'total_answered' => $total_answered];
    }
    public function array_equal($a, $b)
    {
        return is_array($a) && is_array($b) && count($a) == count($b) && array_diff($a, $b) === array_diff($b, $a);
    }
}




Updated: /home/994924.cloudwaysapps.com/tdjkddfbdk/public_html/ci4_application/app/Models/ClassesModel.php
Before:
<?php

namespace App\Models;

use CodeIgniter\Model;
class ClassesModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getTeacherAllocation($branch_id = '')
    {
        $builder->select('ta.*,st.name as teacher_name,st.staff_id as teacher_id,c.name as class_name,c.branch_id,s.name as section_name');
        $builder->from('teacher_allocation as ta');
        $builder->join('staff as st', 'st.id = ta.teacher_id', 'left');
        $builder->join('class as c', 'c.id = ta.class_id', 'left');
        $builder->join('section as s', 's.id = ta.section_id', 'left');
        $builder->order_by('ta.id', 'ASC');
        $this->db->table('ta.session_id', get_session_id())->where();
        if (!empty($branch_id)) {
            $builder->where('c.branch_id', $branch_id);
        }
        return $builder->get();
    }
    public function teacherAllocationSave($data)
    {
        $arrayData = array('branch_id' => $this->application_model->get_branch_id(), 'session_id' => get_session_id(), 'class_id' => $data['class_id'], 'section_id' => $data['section_id'], 'teacher_id' => $data['staff_id']);
        if (!isset($data['allocation_id'])) {
            if (get_permission('assign_class_teacher', 'is_add')) {
                $builder->insert('teacher_allocation', $arrayData);
            }
            set_alert('success', translate('information_has_been_saved_successfully'));
        } else {
            if (get_permission('assign_class_teacher', 'is_edit')) {
                $builder->where('id', $data['allocation_id']);
                $builder->update('teacher_allocation', $arrayData);
            }
            set_alert('success', translate('information_has_been_updated_successfully'));
        }
    }
}




After:
<?php

namespace App\Models;

use CodeIgniter\Model;
class ClassesModel extends MYModel
{
    public function __construct()
    {
        parent::__construct();
    }
    public function getTeacherAllocation($branch_id = '')
    {
        $builder->select('ta.*,st.name as teacher_name,st.staff_id as teacher_id,c.name as class_name,c.branch_id,s.name as section_name');
        $builder->from('teacher_allocation as ta');
        $builder->join('staff as st', 'st.id = ta.teacher_id', 'left');
        $builder->join('class as c', 'c.id = ta.class_id', 'left');
        $builder->join('section as s', 's.id = ta.section_id', 'left');
        $builder->order_by('ta.id', 'ASC');
        $this->db->table('ta.session_id', get_session_id())->where();
        if (!empty($branch_id)) {
            $builder->where('c.branch_id', $branch_id);
        }
        return $builder->get();
    }
    public function teacherAllocationSave($data)
    {
        $arrayData = array('branch_id' => $this->applicationModel->get_branch_id(), 'session_id' => get_session_id(), 'class_id' => $data['class_id'], 'section_id' => $data['section_id'], 'teacher_id' => $data['staff_id']);
        if (!isset($data['allocation_id'])) {
            if (get_permission('assign_class_teacher', 'is_add')) {
                $builder->insert('teacher_allocation', $arrayData);
            }
            set_alert('success', translate('information_has_been_saved_successfully'));
        } else {
            if (get_permission('assign_class_teacher', 'is_edit')) {
                $builder->where('id', $data['allocation_id']);
                $builder->update('teacher_allocation', $arrayData);
            }
            set_alert('success', translate('information_has_been_updated_successfully'));
        }
    }
}




